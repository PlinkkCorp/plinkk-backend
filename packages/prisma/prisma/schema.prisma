// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum ThemeStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  ARCHIVED
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum PlinkkEventType {
  CREATED
  DELETED
}

model User {
  id                 String  @id @unique
  userName           String
  password           String
  email              String  @unique
  publicEmail        String?
  mustChangePassword Boolean @default(false)
  twoFactorEnabled   Boolean @default(false)
  twoFactorSecret    String?

  name          String
  emailVerified Boolean  @default(false)
  image         String?
  lastLogin     DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  roleId        String?
  role          Role?     @relation(fields: [roleId], references: [id])
  rankScore     Int       @default(0)
  bumpedAt      DateTime?
  bumpExpiresAt DateTime?
  bumpPaidUntil DateTime?

  cosmetics Cosmetic?
  isPublic  Boolean   @default(true)
  views     Int       @default(0)
  isVerified Boolean  @default(false)
  isPartner  Boolean  @default(false)
<<<<<<< Updated upstream
=======
  isPremium  Boolean  @default(false)
  premiumUntil DateTime?
  stripeCustomerId String? @unique
  extraPlinkks     Int     @default(0)
  extraRedirects   Int     @default(0)
>>>>>>> Stashed changes
  
  hasPassword Boolean @default(true)

  themes       Theme[]
  announcement AnnouncementTarget[]

  // Thème personnalisé sélectionné pour usage privé
  selectedCustomThemeId String?

  plinkks          Plinkk[]
  // Relations vers d'autres modèles
  links            Link[]
  labels           Label[]
  socialIcons      SocialIcon[]
  backgroundColors BackgroundColor[]
  neonColors       NeonColor[]
  statusbar        Statusbar?

  slags Json @default("[]")

  // Relations pour les signalements
  reportsMade     Report[] @relation("Reporter")
  reportsReceived Report[] @relation("ReportedUser")
  
  // Relations pour les sessions
  sessions        Session[]
  connections     Connection[]
  redirects       Redirect[]
  purchases       Purchase[]

  apiKey          String? @unique
}

model Connection {
  id           String   @id @default(nanoid(16))
  provider     String   // "google", "discord", "github", "spotify"
  providerId   String
  email        String?
  name         String?
  accessToken  String?  @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime?
  isIdentity   Boolean  @default(false) 

  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@unique([provider, providerId])
  @@unique([provider, userId])
}

model Session {
  id        String   @id @default(nanoid(16))
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ip        String?
  userAgent String?
  currentPath String?
  lastActiveAt DateTime @default(now())
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model Report {
  id        String   @id @default(nanoid(16))
  reason    String
  message   String?
  status    String   @default("PENDING") // PENDING, RESOLVED, DISMISSED

  reporterId String
  reporter   User   @relation("Reporter", fields: [reporterId], references: [id])

  // Cibles optionnelles
  reportedUserId String?
  reportedUser   User?   @relation("ReportedUser", fields: [reportedUserId], references: [id])

  reportedPlinkkId String?
  reportedPlinkk   Plinkk? @relation(fields: [reportedPlinkkId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Role {
  id          String @id @default(nanoid(16))
  name        String @unique
  users       User[]
  isStaff     Boolean @default(false)
  priority    Int     @default(0) // pour l'ordre d'affichage
  color       String?            // couleur d'accent éventuelle
  maxPlinkks  Int?    @default(1)
  maxThemes   Int?    @default(0)
  maxRedirects Int?   @default(5)
  limits      Json?              // structure libre pour futures quotas
  meta        Json?              // infos supplémentaires (badges, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  permissions RolePermission[]
  AnnouncementRoleTarget AnnouncementRoleTarget[]
}

/// Définition d'une permission atomique, modulaire, catégorisée.
model Permission {
  key        String @id            // identifiant unique (ex: MANAGE_USERS)
  category   String                // catégorie ergonomique (ex: Administration)
  description String?              // description lisible
  system     Boolean @default(true) // true: fournie par le code, false: personnalisée
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  roles RolePermission[]
}

/// Table de jointure N-N entre Role et Permission
model RolePermission {
  roleId        String
  permissionKey String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionKey], references: [key], onDelete: Cascade)

  grantedAt DateTime @default(now())

  @@id([roleId, permissionKey])
}

model Cosmetic {
  id        String  @id @default(nanoid(16))
  flair     String? @default("OG")
  frame     String? @default("none")
  theme     String? @default("system")
  bannerUrl String? @default("")
  banner    String? @default("")
  data      Json?

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Link {
  id                     String   @id @default(nanoid(16))
  icon                   String?  @default("https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png")
  url                    String   @default("https://github.com/link")
  text                   String?  @default("Link")
  name                   String?  @default("Github")
  description            String?  @default("Ma description")
  showDescriptionOnHover Boolean? @default(true)
  showDescription        Boolean? @default(true)
  clicks                 Int      @default(0)

  // Scheduled links (premium) : programmation d'activation/désactivation
  scheduledAt  DateTime?  // Date à partir de laquelle le lien est visible
  expiresAt    DateTime?  // Date à laquelle le lien disparaît

  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plinkkId String?
  plinkk   Plinkk? @relation(fields: [plinkkId], references: [id], onDelete: Cascade)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
}

model Category {
  id        String   @id @default(nanoid(16))
  name      String
  order     Int      @default(0)
  plinkkId  String
  plinkk    Plinkk   @relation(fields: [plinkkId], references: [id], onDelete: Cascade)
  links     Link[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Host {
  id          String  @id
  verified    Boolean @default(false)
  verifyToken String  @unique

  plinkkId String @unique
  plinkk   Plinkk @relation(fields: [plinkkId], references: [id], onDelete: Cascade)
}

model Label {
  id        String @id @default(nanoid(16))
  data      String @default("Developer")
  color     String @default("#FF6384")
  fontColor String @default("#FFFFFF")

  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plinkkId String?
  plinkk   Plinkk? @relation(fields: [plinkkId], references: [id], onDelete: Cascade)
}

model SocialIcon {
  id   String @id @default(nanoid(16))
  url  String @default("https://github.com")
  icon String @default("Github")

  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plinkkId String?
  plinkk   Plinkk? @relation(fields: [plinkkId], references: [id], onDelete: Cascade)
}

model BackgroundColor {
  id    String @id @default(nanoid(16))
  color String @default("#FF5733")

  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plinkkId String?
  plinkk   Plinkk? @relation(fields: [plinkkId], references: [id], onDelete: Cascade)
}

model NeonColor {
  id    String @id @default(nanoid(16))
  color String @default("#7289DA")

  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plinkkId String?
  plinkk   Plinkk? @relation(fields: [plinkkId], references: [id], onDelete: Cascade)
}

model Statusbar {
  id            String  @id @default(nanoid(16))
  text          String? @default("Hello World!")
  colorBg       String? @default("#222222")
  colorText     String? @default("#cccccc")
  fontTextColor Int?    @default(1)
  statusText    String? @default("busy")

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PlinkkStatusbar {
  id            String  @id @default(nanoid(16))
  text          String? @default("Hello World!")
  colorBg       String? @default("#222222")
  colorText     String? @default("#cccccc")
  fontTextColor Int?    @default(1)
  statusText    String? @default("busy")

  plinkkId String @unique
  plinkk   Plinkk @relation(fields: [plinkkId], references: [id], onDelete: Cascade)
}

model Announcement {
  id          String    @id @default(nanoid(16))
  level       String    @default("info")
  text        String
  dismissible Boolean   @default(true)
  startAt     DateTime?
  endAt       DateTime?
  createdAt   DateTime  @default(now())
  global      Boolean   @default(false)

  targets     AnnouncementTarget[]
  roleTargets AnnouncementRoleTarget[]
}

model AnnouncementTarget {
  announcementId String
  userId         String

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([announcementId, userId])
}

model AnnouncementRoleTarget {
  announcementId String
  roleId         String
  role           Role   @relation(fields: [roleId], references: [id])

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@id([announcementId, roleId])
}

model Theme {
  id          String      @id @default(nanoid(16))
  name        String
  description String?
  data        Json
  status      ThemeStatus @default(DRAFT)
  isPrivate   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt

  pendingUpdate        Json?
  pendingUpdateAt      DateTime?
  pendingUpdateMessage String?

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Plinkk {
  id     String @id @default(nanoid(16))
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  slug         String
  index        Int        @default(0)
  isDefault    Boolean    @default(false)
  isPublic     Boolean    @default(true)
  visibility   Visibility @default(PUBLIC)
  isActive     Boolean    @default(true)
  views        Int        @default(0)
  passwordHash String?    // Mot de passe pour accès protégé (premium)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now()) @updatedAt

  links       Link[]
  categories  Category[]
  labels      Label[]
  socialIcons SocialIcon[]
  background  BackgroundColor[]
  neonColors  NeonColor[]
  statusbar   PlinkkStatusbar?
  settings    PlinkkSettings?
  pageStats   PageStat[]        @relation("PageStats")
  reports     Report[]

  host Host?

  @@unique([userId, slug])
  @@unique([userId, index])
}

model PlinkkSettings {
  id       String @id @default(nanoid(16))
  plinkkId String @unique
  plinkk   Plinkk @relation(fields: [plinkkId], references: [id], onDelete: Cascade)

  profileLink                      String?
  profileImage                     String?
  profileIcon                      String?
  profileSiteText                  String?
  userName                         String?
  iconUrl                          String?
  description                      String?
  profileHoverColor                String?
  // affichageEmail spécifique à cette Plinkk (email affiché publiquement pour cette page)
  affichageEmail                   String?
  publicPhone                      String?
  showVerifiedBadge                Boolean @default(true)
  showPartnerBadge                 Boolean @default(true)
  enableVCard                      Boolean @default(true)
  enableLinkCategories             Boolean @default(false)

  degBackgroundColor               Int?
  neonEnable                       Int?
  buttonThemeEnable                Int?
  EnableAnimationArticle           Int?
  EnableAnimationButton            Int?
  EnableAnimationBackground        Int?
  backgroundSize                   Int?
  selectedThemeIndex               Int?
  selectedAnimationIndex           Int?
  selectedAnimationButtonIndex     Int?
  selectedAnimationBackgroundIndex Int?
  animationDurationBackground      Int?
  delayAnimationButton             Float?
  canvaEnable                      Int?
  selectedCanvasIndex              Int?
  // Ordre d'agencement des sections (déplacement visuel dans le dashboard)
  layoutOrder                      Json?   @default("[\"profile\",\"username\",\"statusbar\",\"labels\",\"social\",\"email\",\"links\"]")
}

model PlinkkEvent {
  id        String          @id @default(nanoid(16))
  type      PlinkkEventType
  userId    String
  plinkkId  String
  createdAt DateTime        @default(now())
}

model UserViewDaily {
  userId String
  date   DateTime @default(now())
  count  Int

  @@id([userId, date])
  @@map("UserViewDaily")
}

model LinkClickDaily {
  linkId String
  date   DateTime @default(now())
  count  Int

  @@id([linkId, date])
  @@map("LinkClickDaily")
}

model PlinkkViewDaily {
  plinkkId String
  date     DateTime @default(now())
  count    Int

  @@id([plinkkId, date])
  @@map("PlinkkViewDaily")
}

model PageStat {
  id        String   @id @default(nanoid(16))
  plinkkId  String
  plinkk    Plinkk   @relation("PageStats", fields: [plinkkId], references: [id], onDelete: Cascade)
  eventType String
  meta      Json?
  ip        String?
  createdAt DateTime @default(now())

  @@index([plinkkId, eventType, createdAt])
}

model BannedSlug {
  slug      String   @id
  reason    String?
  createdAt DateTime @default(now())
}

model BannedEmail {
  email        String    @id
  reason       String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt
  deletePlinkk Boolean   @default(false)
  time         Int?      @default(-1)
  revoquedAt   DateTime?
}

model AdminLog {
  id        String   @id @default(nanoid(16))
  adminId   String
  action    String
  targetId  String?
  details   Json?
  createdAt DateTime @default(now())
  ip        String?
}

// ─────────────────────────────────────────────────────────────────────────────
// Redirections (plinkk.fr/r/slug)
// ─────────────────────────────────────────────────────────────────────────────

model Redirect {
  id          String   @id @default(nanoid(16))
  slug        String   @unique
  targetUrl   String
  title       String?
  description String?
  clicks      Int      @default(0)
  isActive    Boolean  @default(true)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  expiresAt   DateTime?
  
  dailyStats  RedirectClickDaily[]
  
  @@index([userId])
  @@index([slug])
}

model RedirectClickDaily {
  redirectId String
  redirect   Redirect @relation(fields: [redirectId], references: [id], onDelete: Cascade)
  date       DateTime @default(now())
  count      Int
  
  @@id([redirectId, date])
  @@map("RedirectClickDaily")
}

// ─────────────────────────────────────────────────────────────────────────────
// Achats Stripe (plinkks et redirections supplémentaires)
// ─────────────────────────────────────────────────────────────────────────────

model Purchase {
  id              String   @id @default(nanoid(16))
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String   // "extra_plinkk", "extra_redirects"
  amount          Int      @default(100) // montant en centimes
  quantity        Int      @default(1)
  stripeSessionId String?  @unique
  stripePaymentId String?
  createdAt       DateTime @default(now())

  @@index([userId])
}