<% if (typeof pages !== 'undefined' && Array.isArray(pages) && pages.length > 1) { %>
  <!-- Trigger Button -->
  <button onclick="document.getElementById('plinkkSelectorModal').classList.remove('hidden')" type="button" class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl bg-slate-800 hover:bg-slate-700 text-white border border-slate-700 transition-colors">
    <span><%= (typeof plinkk !== 'undefined' && plinkk) ? (plinkk.name || plinkk.slug) : 'Choisir un Plinkk' %></span>
    <svg class="text-slate-400" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
  </button>

  <!-- Modal -->
  <div id="plinkkSelectorModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="document.getElementById('plinkkSelectorModal').classList.add('hidden')"></div>
    
    <div class="relative z-10 w-full max-w-2xl mx-auto mt-20 px-4">
      <div class="bg-slate-900 border border-slate-800 rounded-3xl shadow-2xl overflow-hidden animate-scale-in">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-slate-800">
          <h3 class="text-xl font-bold text-white">Changer de Plinkk</h3>
          <button onclick="document.getElementById('plinkkSelectorModal').classList.add('hidden')" class="p-2 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>

        <!-- Search -->
        <div class="p-4 border-b border-slate-800 bg-slate-900/50">
          <div class="relative">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="plinkkSelectorSearch" placeholder="Rechercher un Plinkk..." class="w-full pl-12 pr-4 py-3 rounded-xl bg-slate-950 border border-slate-800 text-white placeholder-slate-500 focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-all outline-none" />
          </div>
        </div>

        <!-- List -->
        <div class="max-h-[60vh] overflow-y-auto p-4 space-y-2" id="plinkkSelectorList">
          <% pages.forEach(p => { %>
            <a href="?plinkkId=<%= p.id %>" class="plinkk-item flex items-center justify-between p-4 rounded-2xl hover:bg-slate-800 border border-transparent hover:border-slate-700 transition-all group <%= (typeof plinkk !== 'undefined' && plinkk && plinkk.id === p.id) ? 'bg-slate-800/50 border-violet-500/30' : '' %>">
              <div class="flex items-center gap-4">
                <div class="h-10 w-10 rounded-xl bg-slate-800 border border-slate-700 flex items-center justify-center text-lg font-bold text-slate-400 group-hover:text-white group-hover:border-slate-600 transition-colors">
                  <%= p.slug.substring(0, 1).toUpperCase() %>
                </div>
                <div>
                  <div class="font-medium text-white group-hover:text-violet-400 transition-colors"><%= p.name || p.slug %></div>
                  <div class="text-sm text-slate-500">plinkk.fr/<%= p.slug %></div>
                </div>
              </div>
              <% if (typeof plinkk !== 'undefined' && plinkk && plinkk.id === p.id) { %>
                <div class="px-3 py-1 rounded-lg bg-violet-500/10 text-violet-400 text-xs font-medium border border-violet-500/20">Actif</div>
              <% } %>
            </a>
          <% }) %>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('plinkkSelectorSearch')?.addEventListener('input', (e) => {
      const val = e.target.value.toLowerCase();
      document.querySelectorAll('.plinkk-item').forEach(el => {
        const text = el.textContent.toLowerCase();
        el.style.display = text.includes(val) ? 'flex' : 'none';
      });
    });
  </script>
<% } %>
<script>
(function(){
  try {
    const params = new URLSearchParams(location.search);
    if (params.get('autoRedirect') === '1') {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 z-50 max-w-xs w-auto px-4 py-2 rounded-md text-sm bg-indigo-700 text-white shadow-lg flex items-center gap-3 transition-opacity duration-200';
        toast.setAttribute('role','status');
        toast.setAttribute('aria-live','polite');
        toast.innerHTML = '<div class="truncate">Vous avez été redirigé(e) vers votre plinkk par défaut.</div>';
        const closeBtn = document.createElement('button');
        closeBtn.className = 'ml-2 px-2 py-1 rounded bg-indigo-800/30 hover:bg-indigo-800 text-xs';
        closeBtn.setAttribute('aria-label','Fermer la notification');
        closeBtn.textContent = 'Fermer';
        closeBtn.addEventListener('click', () => { toast.remove(); });
        toast.appendChild(closeBtn);
        document.body.appendChild(toast);
        setTimeout(() => {
          try { toast.style.opacity = '0'; } catch (e) {}
          setTimeout(() => { try { toast.remove(); } catch (e) {} }, 300);
        }, 5000);
      params.delete('autoRedirect');
      const base = location.pathname + (params.toString() ? '?' + params.toString() : '') + location.hash;
      history.replaceState(null, '', base);
    }
  } catch (e) {}
})();
</script>
