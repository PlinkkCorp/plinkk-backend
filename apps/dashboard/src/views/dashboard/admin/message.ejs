<%- include('partials/head.ejs', { title: 'Message Global - Administration', description: 'Gérez les annonces globales du site.', robots: 'noindex,nofollow' }) %>

<%- include('partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
    <%- include('partials/admin-nav.ejs', { user: user, active: 'message' }) %>

    <main class="col-span-12 lg:col-span-10 space-y-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-gradient-to-r from-slate-900 to-slate-800 p-8 rounded-3xl border border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-violet-600/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="relative z-10">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Message Global</h1>
                <p class="text-slate-400 text-lg">Diffusez des annonces, alertes ou maintenances à vos utilisateurs.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Form -->
            <div class="xl:col-span-2 space-y-8">
                <div class="bg-slate-900 border border-slate-800 rounded-3xl p-8 relative overflow-hidden">
                    <form id="siteMessageForm" class="space-y-6 relative z-10">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Niveau</label>
                                <div class="relative">
                                    <select name="level" class="w-full appearance-none rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors cursor-pointer">
                                        <option value="info">Info (Bleu)</option>
                                        <option value="success">Succès (Vert)</option>
                                        <option value="warning">Alerte (Jaune)</option>
                                        <option value="error">Erreur (Rouge)</option>
                                        <option value="maintenance">Maintenance (Violet)</option>
                                    </select>
                                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Début (Optionnel)</label>
                                <input type="datetime-local" name="startAt" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors [color-scheme:dark]" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Fin (Optionnel)</label>
                                <input type="datetime-local" name="endAt" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors [color-scheme:dark]" />
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Contenu du message</label>
                            <textarea name="text" rows="4" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors resize-none" placeholder="Saisissez votre annonce ici... (Markdown supporté)"></textarea>
                        </div>

                        <div class="flex items-center gap-3 p-4 rounded-xl bg-slate-950/50 border border-slate-800">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="dismissible" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
                            </label>
                            <span class="text-sm text-slate-300">Autoriser les utilisateurs à masquer ce message</span>
                        </div>

                        <div class="border-t border-slate-800 pt-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-white">Ciblage</h3>
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-slate-400">Mode Global</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" name="global" id="globalToggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                    </label>
                                </div>
                            </div>

                            <div id="targetsPanel" class="grid grid-cols-1 md:grid-cols-2 gap-8 transition-all duration-300">
                                <div class="space-y-4">
                                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider">Par Rôle</label>
                                    <div class="grid grid-cols-2 gap-3" id="rolesGroup">
                                        <% if (typeof roles !== 'undefined' && roles.length > 0) { %>
                                            <% roles.forEach(role => { %>
                                                <label class="flex items-center gap-3 p-3 rounded-xl bg-slate-950 border border-slate-800 cursor-pointer hover:border-slate-700 transition-colors">
                                                    <input type="checkbox" value="<%= role.id %>" class="roleBox w-4 h-4 rounded border-slate-700 text-violet-600 focus:ring-violet-600 bg-slate-900" />
                                                    <span class="text-sm font-medium text-slate-300"><%= role.name %></span>
                                                </label>
                                            <% }) %>
                                        <% } else { %>
                                            <p class="text-sm text-slate-500 col-span-2">Aucun rôle disponible.</p>
                                        <% } %>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider">Par Utilisateur</label>
                                    <div class="relative">
                                        <input type="text" id="userMentions" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors" placeholder="Rechercher @pseudo, email..." />
                                        <div id="userSuggestions" class="absolute z-20 mt-2 w-full rounded-xl border border-slate-800 bg-slate-900 shadow-2xl hidden max-h-60 overflow-y-auto"></div>
                                    </div>
                                    <div id="selectedUsers" class="flex flex-wrap gap-2 min-h-[40px]"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 pt-4 border-t border-slate-800">
                            <button type="submit" class="flex-1 px-6 py-3 rounded-xl bg-violet-600 hover:bg-violet-500 text-white font-medium shadow-lg shadow-violet-900/20 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                Publier le message
                            </button>
                            <button type="button" id="clearBtn" class="px-6 py-3 rounded-xl bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 font-medium border border-rose-500/20 transition-colors">
                                Supprimer
                            </button>
                        </div>
                        <div id="status" class="text-center text-sm font-medium min-h-[20px]"></div>
                    </form>
                </div>
            </div>

            <!-- Preview -->
            <div class="xl:col-span-1 space-y-6">
                <div class="sticky top-6">
                    <h3 class="text-lg font-bold text-white mb-4 px-2">Aperçu en direct</h3>
                    <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6 relative overflow-hidden group">
                        <div class="absolute inset-0 bg-grid-slate-800/[0.2] [mask-image:linear-gradient(0deg,white,rgba(255,255,255,0.6))] pointer-events-none"></div>
                        
                        <!-- Mock Header -->
                        <div class="relative z-10 space-y-4">
                            <div class="h-4 w-1/3 bg-slate-800 rounded-full mb-6"></div>
                            
                            <div id="preview" class="rounded-xl p-4 border transition-all duration-300">
                                <div class="flex items-start gap-3">
                                    <div class="preview-icon mt-0.5"></div>
                                    <div class="preview-content text-sm leading-relaxed"></div>
                                </div>
                            </div>

                            <div class="space-y-3 pt-4 opacity-50">
                                <div class="h-32 bg-slate-800 rounded-2xl w-full"></div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="h-24 bg-slate-800 rounded-2xl"></div>
                                    <div class="h-24 bg-slate-800 rounded-2xl"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-4 px-2 text-center">
                        L'apparence réelle peut varier légèrement selon le thème de l'utilisateur.
                    </p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" id="modalBackdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-900 border border-slate-800 rounded-3xl shadow-2xl transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-rose-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Supprimer le message ?</h3>
                <p class="text-slate-400 text-sm mb-6">Cette action retirera immédiatement le message pour tous les utilisateurs. Cette action est irréversible.</p>
                <div class="flex gap-3">
                    <button id="dlgCancel" class="flex-1 px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium transition-colors">Annuler</button>
                    <button id="dlgConfirm" class="flex-1 px-4 py-2.5 rounded-xl bg-rose-600 hover:bg-rose-500 text-white font-medium transition-colors">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    const form = document.getElementById('siteMessageForm');
    const status = document.getElementById('status');
    const clearBtn = document.getElementById('clearBtn');
    const globalToggle = document.getElementById('globalToggle');
    const targetsPanel = document.getElementById('targetsPanel');
    const rolesBoxes = Array.from(document.querySelectorAll('#rolesGroup .roleBox'));
    const userInput = document.getElementById('userMentions');
    const sugg = document.getElementById('userSuggestions');
    const selectedUsers = document.getElementById('selectedUsers');
    const picked = new Map();

    // UI Logic
    function setTargetsDisabled(disabled){
        if(disabled) {
            targetsPanel.classList.add('opacity-30', 'pointer-events-none', 'grayscale');
        } else {
            targetsPanel.classList.remove('opacity-30', 'pointer-events-none', 'grayscale');
        }
    }
    globalToggle.addEventListener('change', () => setTargetsDisabled(globalToggle.checked));
    setTargetsDisabled(false); // Default state

    // User Selection Logic
    function renderPicked(){
        selectedUsers.innerHTML = '';
        for (const u of picked.values()){
            const chip = document.createElement('div');
            chip.className = 'flex items-center gap-2 px-3 py-1.5 rounded-lg bg-violet-500/10 border border-violet-500/20 text-violet-200 text-xs font-medium animate-fade-in';
            chip.innerHTML = `
                <span>@${escapeHtml(u.userName || u.id)}</span>
                <button type="button" class="text-violet-400 hover:text-white transition-colors">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            chip.querySelector('button').addEventListener('click', () => { picked.delete(u.id); renderPicked(); });
            selectedUsers.appendChild(chip);
        }
    }

    let lastQ = ''; let lastCtl = 0;
    async function searchUsers(q){
        if (!q || q.length < 1) { sugg.classList.add('hidden'); sugg.innerHTML=''; return; }
        const ctl = ++lastCtl;
        try {
            const res = await fetch(`/dashboard/admin/users/search?q=${encodeURIComponent(q)}&limit=5`);
            if (!res.ok) return; 
            const json = await res.json(); 
            if (ctl !== lastCtl) return;
            
            const users = Array.isArray(json.users) ? json.users : [];
            if (!users.length) { sugg.classList.add('hidden'); return; }
            
            sugg.innerHTML = users.map(u => `
                <button type="button" data-id="${u.id}" class="w-full text-left px-4 py-3 hover:bg-slate-800 flex items-center gap-3 transition-colors border-b border-slate-800 last:border-0">
                    <div class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-xs font-bold text-white border border-slate-700">
                        ${(u.userName||u.id).slice(0,1).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-slate-200 text-sm truncate">@${escapeHtml(u.userName || u.id)}</div>
                        <div class="text-xs text-slate-500 truncate">${escapeHtml(u.email || '')}</div>
                    </div>
                </button>
            `).join('');
            sugg.classList.remove('hidden');
            
            Array.from(sugg.querySelectorAll('button[data-id]')).forEach(b => b.addEventListener('click', () => {
                const id = b.getAttribute('data-id');
                const u = users.find(x => x.id === id); 
                if (u) { picked.set(u.id, u); renderPicked(); }
                sugg.classList.add('hidden'); 
                userInput.value = ''; 
                userInput.focus();
            }));
        } catch(e) { sugg.classList.add('hidden'); }
    }

    userInput.addEventListener('input', () => {
        const v = userInput.value.trim();
        const q = v.startsWith('@') ? v.slice(1) : v;
        if (q !== lastQ) { lastQ = q; searchUsers(q); }
    });
    
    // Close suggestions on click outside
    document.addEventListener('click', (e) => {
        if (!sugg.contains(e.target) && e.target !== userInput) sugg.classList.add('hidden');
    });

    // Preview Logic
    function renderPreview(data){
        const p = document.getElementById('preview');
        const iconEl = p.querySelector('.preview-icon');
        const contentEl = p.querySelector('.preview-content');
        
        if (!data || !data.text) {
            p.className = 'rounded-xl p-4 border border-slate-800 bg-slate-900/50 text-slate-500 text-center italic';
            p.innerHTML = 'Aucun message actif';
            return;
        }

        const lvl = String(data.level||'info').toLowerCase();
        const styles = {
            info: { bg:'bg-sky-500/10', border:'border-sky-500/20', text:'text-sky-200', icon:'text-sky-400' },
            success: { bg:'bg-emerald-500/10', border:'border-emerald-500/20', text:'text-emerald-200', icon:'text-emerald-400' },
            warning: { bg:'bg-amber-500/10', border:'border-amber-500/20', text:'text-amber-200', icon:'text-amber-400' },
            error: { bg:'bg-rose-500/10', border:'border-rose-500/20', text:'text-rose-200', icon:'text-rose-400' },
            maintenance: { bg:'bg-violet-500/10', border:'border-violet-500/20', text:'text-violet-200', icon:'text-violet-400' }
        };
        const s = styles[lvl] || styles.info;

        p.className = `rounded-xl p-4 border ${s.bg} ${s.border} ${s.text} transition-all duration-300`;
        
        const icons = {
            info: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',
            success: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            warning: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
            error: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
            maintenance: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>'
        };

        p.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="${s.icon} mt-0.5 shrink-0">${icons[lvl] || icons.info}</div>
                <div class="text-sm leading-relaxed font-medium">${escapeHtml(data.text)}</div>
            </div>
        `;
    }

    // Live preview update
    ['level', 'text'].forEach(f => {
        form.elements[f].addEventListener('input', () => {
            renderPreview({
                level: form.elements['level'].value,
                text: form.elements['text'].value
            });
        });
    });

    // Data Loading
    async function load(){
        try {
            const res = await fetch('/api/admin/message');
            if (!res.ok) return;
            const json = await res.json();
            const m = (json && Array.isArray(json.messages) && json.messages.length) ? json.messages[0] : null;
            
            if (m) {
                form.elements['level'].value = m.level || 'info';
                form.elements['text'].value = m.text || '';
                if (m.startAt) form.elements['startAt'].value = new Date(m.startAt).toISOString().slice(0,16);
                if (m.endAt) form.elements['endAt'].value = new Date(m.endAt).toISOString().slice(0,16);
                form.elements['dismissible'].checked = !!m.dismissible;
                
                // Restore targeting
                if (m.global) {
                    globalToggle.checked = true;
                    setTargetsDisabled(true);
                } else {
                    globalToggle.checked = false;
                    setTargetsDisabled(false);
                    if (m.targetRoles) {
                        m.targetRoles.forEach(r => {
                            const cb = rolesBoxes.find(b => b.value === r);
                            if(cb) cb.checked = true;
                        });
                    }
                    // Note: restoring specific users would require fetching their details if not provided in message object
                    // For now we skip restoring user chips to avoid complexity, or assume backend sends minimal user info
                }
                
                renderPreview(m);
            } else {
                renderPreview(null);
            }
        } catch(e) { console.error(e); }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Submit
    form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Enregistrement...';
        status.textContent = '';

        try {
            const data = { 
                level: form.elements['level'].value, 
                text: form.elements['text'].value, 
                dismissible: !!form.elements['dismissible'].checked 
            };
            if (form.elements['startAt'].value) data.startAt = new Date(form.elements['startAt'].value).toISOString();
            if (form.elements['endAt'].value) data.endAt = new Date(form.elements['endAt'].value).toISOString();
            
            data.global = !!globalToggle.checked;
            if (!data.global) {
                const rolesSel = rolesBoxes.filter(b => b.checked).map(b => b.value);
                const userIds = Array.from(picked.keys());
                if (rolesSel.length) data.targetRoles = rolesSel;
                if (userIds.length) data.targetUserIds = userIds;
            }

            const res = await fetch('/api/admin/message', { 
                method: 'POST', 
                headers: { 'Content-Type':'application/json' }, 
                body: JSON.stringify(data) 
            });
            
            if (res.ok) {
                status.className = 'text-center text-sm font-medium text-emerald-400';
                status.textContent = 'Message publié avec succès !';
                renderPreview(data);
            } else {
                throw new Error('Erreur serveur');
            }
        } catch(err) {
            status.className = 'text-center text-sm font-medium text-rose-400';
            status.textContent = 'Erreur lors de l\'enregistrement.';
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
            setTimeout(() => status.textContent = '', 3000);
        }
    });

    // Delete Modal
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('modalContent');
    const modalBackdrop = document.getElementById('modalBackdrop');
    
    function openModal() {
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        });
    }
    
    function closeModal() {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    clearBtn.addEventListener('click', openModal);
    document.getElementById('dlgCancel').addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', closeModal);

    document.getElementById('dlgConfirm').addEventListener('click', async () => {
        let ok = false; let id = null;
        try { 
            const res = await fetch('/api/admin/message'); 
            if (res.ok){ 
                const j = await res.json(); 
                if (j && Array.isArray(j.messages) && j.messages.length) id = j.messages[0].id; 
            } 
        } catch(e){}
        
        try {
            const url = id ? (`/api/admin/message?id=${encodeURIComponent(id)}`) : '/api/admin/message';
            const resDb = await fetch(url, { method: 'DELETE' });
            ok = resDb.ok;
        } catch(e) {}

        if (ok) {
            form.reset();
            renderPreview(null);
            status.className = 'text-center text-sm font-medium text-emerald-400';
            status.textContent = 'Message supprimé.';
            picked.clear();
            renderPicked();
            setTargetsDisabled(false);
        } else {
            status.className = 'text-center text-sm font-medium text-rose-400';
            status.textContent = 'Erreur lors de la suppression.';
        }
        closeModal();
        setTimeout(() => status.textContent = '', 3000);
    });

    load();
})();
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>

<%- include('partials/footer.ejs') %>
