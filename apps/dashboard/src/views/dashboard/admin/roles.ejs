<%- include('../../partials/head.ejs', { title: 'Admin - Rôles & Permissions', description: 'Gestion des rôles et permissions', robots: 'noindex,nofollow' }) %>
<%- include('../../partials/header-dash.ejs', { user: user }) %>
<%- include('../../partials/admin-nav.ejs', { user: user }) %>
<main class="max-w-7xl mx-auto p-4">
  <style>
    /* UI & Drag indicators */
    #rolesList .draggable{position:relative; cursor:move}
    #rolesList .dragging{opacity:.6}
    #rolesList .drag-over-top::before,#rolesList .drag-over-bottom::after{content:"";position:absolute;left:0;right:0;height:2px;background:#6366F1}
    #rolesList .drag-over-top::before{top:0}
    #rolesList .drag-over-bottom::after{bottom:0}
  </style>
  <div class="mb-4">
    <h1 class="text-2xl font-bold tracking-tight">Rôles & Permissions</h1>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
    <!-- Colonne gauche: liste des rôles + création -->
    <aside class="md:col-span-3 rounded-lg border border-slate-800/70 bg-slate-900/60 overflow-hidden">
      <div class="p-3 border-b border-slate-800/70">
        <form id="createRoleForm" class="flex items-center gap-2">
          <input name="name" placeholder="Nouveau rôle (ex: PARTNER)" class="flex-1 px-2 py-1 rounded bg-slate-900/60 border border-slate-700 text-sm" />
          <button type="submit" class="px-2 py-1 rounded bg-indigo-600 text-white text-xs whitespace-nowrap">Créer</button>
          <!-- Bouton rafraîchir retiré: rechargement automatique inutile -->
        </form>
        <div class="mt-2 flex items-center gap-2">
          <input id="roleSearch" placeholder="Rechercher un rôle..." class="w-full px-2 py-1 rounded bg-slate-900/60 border border-slate-700 text-xs" />
        </div>
        <div class="flex items-center justify-between mt-1">
          <div id="createRoleStatus" class="text-[11px] text-slate-400"></div>
          <div id="rolesCount" class="text-[11px] text-slate-500">Glissez-déposez pour réordonner</div>
        </div>
      </div>
      <div id="rolesList" class="max-h-[70vh] overflow-auto">
        <!-- items -->
      </div>
      <div id="rolesEmpty" class="hidden p-3 text-xs text-slate-400">Aucun rôle.</div>
      <div id="rolesError" class="hidden p-3 text-xs text-rose-400"></div>
    </aside>

    <!-- Colonne droite: permissions du rôle sélectionné -->
    <section class="md:col-span-9 rounded-lg border border-slate-800/70 bg-slate-900/60 p-4" id="rightPane">
      <div id="roleHeader" class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-800/70 pb-3 mb-4">
        <div>
          <div class="text-xs text-slate-400">Rôle sélectionné</div>
          <h2 id="selRoleName" class="text-lg font-semibold">—</h2>
        </div>
        <div class="flex items-center gap-2 text-xs">
          <label class="inline-flex items-center gap-2"><input id="selRoleIsStaff" type="checkbox" class="h-4 w-4 rounded border-slate-600" /> Staff</label>
          <label class="inline-flex items-center gap-2">Priorité <input id="selRolePriority" type="number" class="w-16 px-2 py-1 rounded bg-slate-900/60 border border-slate-700" /></label>
          <label class="inline-flex items-center gap-2">Max Plinkks <input id="selRoleMaxPlinkks" type="number" class="w-16 px-2 py-1 rounded bg-slate-900/60 border border-slate-700" /></label>
          <label class="inline-flex items-center gap-2">Max Thèmes <input id="selRoleMaxThemes" type="number" class="w-16 px-2 py-1 rounded bg-slate-900/60 border border-slate-700" /></label>
          <button id="btnSaveRole" class="px-2 py-1 rounded bg-indigo-600 text-white">Enregistrer</button>
          <button id="btnDeleteRole" class="px-2 py-1 rounded bg-rose-600 text-white">Supprimer</button>
        </div>
      </div>

      <!-- Contrôles globaux permissions -->
      <div class="flex flex-wrap items-center gap-2 mb-3 text-xs">
        <button id="btnEnableAll" class="px-2 py-1 rounded bg-emerald-600/90 text-white hover:bg-emerald-600">Tout activer</button>
        <button id="btnDisableAll" class="px-2 py-1 rounded bg-slate-700 text-slate-100 hover:bg-slate-600">Tout désactiver</button>
        <div class="flex items-center gap-2 ml-auto">
          <select id="importRoleSelect" class="px-2 py-1 rounded bg-slate-900/60 border border-slate-700">
            <option value="">Importer depuis…</option>
          </select>
          <button id="btnImportPerms" class="px-2 py-1 rounded bg-indigo-600 text-white">Importer</button>
        </div>
      </div>

      <div id="permissionsPanel" class="grid md:grid-cols-2 gap-4">
        <% Object.keys(permissionsGrouped).forEach(cat => { %>
          <div class="rounded border border-slate-800/60 bg-slate-900/50" data-category="<%= cat %>">
            <div class="px-3 py-2 text-xs font-semibold text-slate-300 border-b border-slate-800/60 flex items-center justify-between">
              <span><%= cat %></span>
              <span class="flex items-center gap-2">
                <button type="button" class="btn-cat-enable px-2 py-0.5 rounded bg-emerald-700/80 text-white">Activer tout</button>
                <button type="button" class="btn-cat-disable px-2 py-0.5 rounded bg-slate-700 text-slate-100">Désactiver tout</button>
              </span>
            </div>
            <div class="p-2 space-y-1">
              <% permissionsGrouped[cat].forEach(p => { %>
                <div class="flex items-center justify-between gap-2 text-xs px-2 py-2 rounded hover:bg-slate-800/40">
                  <div class="flex items-center gap-2">
                    <code class="px-1 py-0.5 bg-slate-800/80 rounded text-[10px] text-indigo-300"><%= p.key %></code>
                    <span class="text-slate-400"><%= p.description || '' %></span>
                  </div>
                  <label class="inline-flex items-center cursor-pointer select-none">
                    <input type="checkbox" class="perm-toggle sr-only" data-key="<%= p.key %>">
                    <span class="w-9 h-5 bg-slate-700 rounded-full relative transition">
                      <span class="dot absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition"></span>
                    </span>
                  </label>
                </div>
              <% }) %>
            </div>
          </div>
        <% }) %>
      </div>
      <div id="noRoleHint" class="text-xs text-slate-400">Sélectionnez un rôle pour voir et modifier ses permissions.</div>
    </section>
  </div>
  <script id="rolesPayloadB64" type="text/plain"><%= rolesB64 || '' %></script>
</main>

<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  let rolesDataRawB64 = document.getElementById('rolesPayloadB64')?.textContent || '';
  let rolesDataRaw = '';
  if(rolesDataRawB64){
    try { rolesDataRaw = atob(rolesDataRawB64.trim()); } catch(e){ console.error('[roles] atob failed', e); rolesDataRaw = '[]'; }
  } else { rolesDataRaw = '[]'; }
  let rolesData = [];
  try {
    rolesData = JSON.parse(rolesDataRaw);
  } catch(parseErr){
    console.error('[roles] JSON parse error', parseErr, rolesDataRaw);
    // Affiche un message explicite dans l'UI pour que l'utilisateur sache quoi faire
    const errBox = document.getElementById('rolesError');
    if(errBox){
      errBox.textContent = 'Erreur de parsing des rôles côté client. Relancez le seed (node scripts/seed-permissions.js) ou vérifiez le template. Contenu brut: '+rolesDataRaw.slice(0,120)+'...';
      errBox.classList.remove('hidden');
    }
    rolesData = [];
  }
  let selectedRoleId = rolesData[0]?.id || null;
  let searchTerm = '';

  // Rendu colonne gauche
  function renderRolesList(){
    const list = $('#rolesList'); list.innerHTML='';
    const visible = searchTerm ? rolesData.filter(r=>String(r.name||'').toLowerCase().includes(searchTerm)) : rolesData.slice();
    if(!visible.length){ $('#rolesEmpty').classList.remove('hidden'); return; } else { $('#rolesEmpty').classList.add('hidden'); }
    $('#rolesCount').textContent = visible.length+" rôle"+(visible.length>1?'s':'')+" affichés"+(searchTerm?" (filtré)":"");
    visible.forEach(r=>{
      const a = document.createElement('button');
      a.type='button';
      a.className = 'w-full text-left px-3 py-2 text-sm border-b border-slate-800/60 hover:bg-slate-800/50 draggable ' + (r.id===selectedRoleId?'bg-slate-800/60':'');
      a.setAttribute('data-id', r.id);
      a.setAttribute('draggable','true');
      a.innerHTML = `<div class='flex items-center justify-between'>
        <span class='font-medium text-slate-200 flex items-center gap-2'><span class='opacity-60'>☰</span>${r.name}</span>
        ${r.isStaff?"<span class='text-[10px] px-1 py-0.5 rounded bg-amber-600/30 border border-amber-600 text-amber-300'>STAFF</span>":''}
      </div>`;
      list.appendChild(a);
    });
  }

  // Rendu panneau droit selon rôle
  function renderRight(){
    const role = rolesData.find(r=>r.id===selectedRoleId);
    const hint = $('#noRoleHint');
    if(!role){ hint.classList.remove('hidden'); $('#roleHeader').classList.add('opacity-50'); return; }
    hint.classList.add('hidden'); $('#roleHeader').classList.remove('opacity-50');
    $('#selRoleName').textContent = role.name;
    $('#selRoleIsStaff').checked = !!role.isStaff;
    $('#selRolePriority').value = Number(role.priority||0);
    $('#selRoleMaxPlinkks').value = Number(role.maxPlinkks||1);
    $('#selRoleMaxThemes').value = Number(role.maxThemes||0);
    const current = new Set(role.permissions || []);
    $$('.perm-toggle').forEach(chk=>{
      const key = chk.getAttribute('data-key');
      const on = current.has(key);
      chk.checked = on;
      // style du switch
      const wrap = chk.parentElement.querySelector('span');
      const dot = wrap.querySelector('.dot');
      applySwitchStyle(wrap, dot, on);
    });
  }

  function applySwitchStyle(track, dot, on){
    if(on){
      track.classList.remove('bg-slate-700');
      track.classList.add('bg-indigo-600');
      dot.style.transform = 'translateX(1rem)';
    } else {
      track.classList.add('bg-slate-700');
      track.classList.remove('bg-indigo-600');
      dot.style.transform = 'translateX(0)';
    }
  }

  // Helpers permissions
  function collectAllKeys(){ return $$('.perm-toggle').map(chk=>chk.getAttribute('data-key')); }
  function collectCategoryKeys(catEl){ return $$('[data-key]', catEl).map(chk=>chk.getAttribute('data-key')); }
  async function patchPermissions(roleId, add, remove){
    const body = { addPermissions: add||[], removePermissions: remove||[] };
    const res = await fetch('/api/admin/roles/'+roleId, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok) throw new Error('patch_failed_'+res.status);
  }
  function updateLocalPerms(roleId, newSet){
    const r = rolesData.find(x=>x.id===roleId); if(!r) return;
    r.permissions = Array.from(newSet);
  }

  // Events
  $('#rolesList').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button[data-id]');
    if(!btn) return;
    selectedRoleId = btn.getAttribute('data-id');
    renderRolesList();
    renderRight();
  });
  $('#roleSearch').addEventListener('input', (ev)=>{
    searchTerm = String(ev.currentTarget.value||'').toLowerCase();
    renderRolesList();
  });

  // Drag & drop pour réordonner
  let dragId = null;
  $('#rolesList').addEventListener('dragstart', (ev)=>{
    const btn = ev.target.closest('button[data-id]');
    if(!btn) return;
    dragId = btn.getAttribute('data-id');
    ev.dataTransfer?.setData('text/plain', dragId);
    btn.classList.add('dragging');
  });
  $('#rolesList').addEventListener('dragover', (ev)=>{
    ev.preventDefault();
    const btn = ev.target.closest('button[data-id]');
    $$('#rolesList .drag-over-top, #rolesList .drag-over-bottom').forEach(b=>b.classList.remove('drag-over-top','drag-over-bottom'));
    if(!btn) return;
    const rect = btn.getBoundingClientRect();
    const before = ev.clientY < rect.top + rect.height/2;
    btn.classList.add(before?'drag-over-top':'drag-over-bottom');
  });
  $('#rolesList').addEventListener('drop', async (ev)=>{
    ev.preventDefault();
    const target = ev.target.closest('button[data-id]');
    $$('#rolesList .drag-over-top, #rolesList .drag-over-bottom').forEach(b=>b.classList.remove('drag-over-top','drag-over-bottom'));
    if(!target || !dragId) return;
    const targetId = target.getAttribute('data-id');
    if(!targetId || dragId===targetId) return;
    const fromIdx = rolesData.findIndex(r=>r.id===dragId);
    let toIdx = rolesData.findIndex(r=>r.id===targetId);
    if(fromIdx<0 || toIdx<0) return;
    const rect = target.getBoundingClientRect();
    const before = ev.clientY < rect.top + rect.height/2;
    // calcul insert index en tenant compte du déplacement
    let insertIndex = before ? toIdx : toIdx + 1;
    if(fromIdx < insertIndex) insertIndex--; // correction si on retire avant d'insérer
    const [moved] = rolesData.splice(fromIdx,1);
    rolesData.splice(insertIndex,0,moved);
    renderRolesList();
    // Persistance ordre => haut = priorité max
    try{
      const ids = rolesData.map(r=>r.id);
      const res = await fetch('/api/admin/roles/reorder',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids})});
      if(!res.ok){ throw new Error('persist failed'); }
      // mettre à jour priorités locales (n -> 1)
      const n = ids.length;
      rolesData.forEach((r,i)=>{ r.priority = (n - i); });
      $('#rolesCount').textContent = rolesData.length+" rôle"+(rolesData.length>1?'s':'')+" chargés (ordre enregistré)";
    }catch(e){
      $('#rolesError').textContent = 'Échec de l\'enregistrement de l\'ordre';
      $('#rolesError').classList.remove('hidden');
    }
  });
  $('#rolesList').addEventListener('dragend', ()=>{
    $$('#rolesList .dragging').forEach(b=>b.classList.remove('dragging'));
    $$('#rolesList .drag-over-top, #rolesList .drag-over-bottom').forEach(b=>b.classList.remove('drag-over-top','drag-over-bottom'));
  });

  $('#createRoleForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(ev.currentTarget);
    const payload = { name: fd.get('name') };
    const res = await fetch('/api/admin/roles', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const status = $('#createRoleStatus');
    if(res.ok){
      const j = await res.json();
      rolesData.push({ id: j.roleId, name: String(payload.name).toUpperCase(), isStaff:false, priority:0, color:null, maxPlinkks:1, maxThemes:0, permissions:[] });
      selectedRoleId = j.roleId;
      renderRolesList(); renderRight();
      status.textContent = 'Créé ✔'; status.className='text-emerald-400 text-[11px] mt-1';
      ev.currentTarget.reset();
    } else {
      status.textContent = 'Erreur '+res.status; status.className='text-rose-400 text-[11px] mt-1';
    }
  });

  // Sauvegarde infos du rôle sélectionné
  $('#btnSaveRole').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    const payload = {
      isStaff: $('#selRoleIsStaff').checked,
      priority: Number($('#selRolePriority').value||0),
      maxPlinkks: Number($('#selRoleMaxPlinkks').value||1),
      maxThemes: Number($('#selRoleMaxThemes').value||0),
    };
    const res = await fetch('/api/admin/roles/'+roleId, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(res.ok){
      const r = rolesData.find(x=>x.id===roleId); if(r) Object.assign(r, payload);
      renderRolesList();
    } else alert('Échec de la sauvegarde');
  });

  // Suppression du rôle
  $('#btnDeleteRole').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    if(!confirm('Supprimer ce rôle ?')) return;
    const res = await fetch('/api/admin/roles/'+roleId, { method:'DELETE' });
    if(res.ok){
      const idx = rolesData.findIndex(r=>r.id===roleId);
      if(idx>=0) rolesData.splice(idx,1);
      selectedRoleId = rolesData[0]?.id || null;
      renderRolesList(); renderRight();
    } else alert('Impossible de supprimer (rôle utilisé ?)');
  });

  // Bascules permissions
  $('#permissionsPanel').addEventListener('change', async (ev)=>{
    const chk = ev.target.closest('.perm-toggle'); if(!chk) return;
    const key = chk.getAttribute('data-key'); const roleId = selectedRoleId; if(!roleId) return;
    const on = chk.checked;
    const track = chk.parentElement.querySelector('span');
    const dot = track.querySelector('.dot');
    applySwitchStyle(track, dot, on);
    const body = on ? { addPermissions:[key] } : { removePermissions:[key] };
    const res = await fetch('/api/admin/roles/'+roleId, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(res.ok){
      const r = rolesData.find(x=>x.id===roleId); if(!r) return;
      if(on){ if(!r.permissions.includes(key)) r.permissions.push(key); }
      else { r.permissions = r.permissions.filter(p=>p!==key); }
    } else {
      // revert
      chk.checked = !on; applySwitchStyle(track, dot, !on);
      alert('Échec de mise à jour de la permission');
    }
  });

  // Remplir le select d'import
  function refreshImportSelect(){
    const sel = $('#importRoleSelect'); if(!sel) return;
    const current = selectedRoleId;
    sel.innerHTML = '<option value="">Importer depuis…</option>' + rolesData.filter(r=>r.id!==current).map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
  }

  // Global enable/disable
  $('#btnEnableAll').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    const keys = collectAllKeys();
    const current = new Set((rolesData.find(r=>r.id===roleId)?.permissions)||[]);
    const add = keys.filter(k=>!current.has(k));
    if(!add.length) return;
    try{ await patchPermissions(roleId, add, []); updateLocalPerms(roleId, new Set([...current, ...add])); renderRight(); }
    catch{ $('#rolesError').textContent = 'Échec: activer toutes les permissions'; $('#rolesError').classList.remove('hidden'); }
  });
  $('#btnDisableAll').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    const keys = collectAllKeys();
    const current = new Set((rolesData.find(r=>r.id===roleId)?.permissions)||[]);
    const remove = keys.filter(k=>current.has(k));
    if(!remove.length) return;
    try{ await patchPermissions(roleId, [], remove); updateLocalPerms(roleId, new Set()); renderRight(); }
    catch{ $('#rolesError').textContent = 'Échec: désactiver toutes les permissions'; $('#rolesError').classList.remove('hidden'); }
  });

  // Per-category enable/disable using event delegation
  $('#permissionsPanel').addEventListener('click', async (ev)=>{
    const btnEnable = ev.target.closest('.btn-cat-enable');
    const btnDisable = ev.target.closest('.btn-cat-disable');
    if(!btnEnable && !btnDisable) return;
    const panel = ev.target.closest('[data-category]'); if(!panel) return;
    const roleId = selectedRoleId; if(!roleId) return;
    const keys = collectCategoryKeys(panel);
    const current = new Set((rolesData.find(r=>r.id===roleId)?.permissions)||[]);
    if(btnEnable){
      const add = keys.filter(k=>!current.has(k)); if(!add.length) return;
      try{ await patchPermissions(roleId, add, []); updateLocalPerms(roleId, new Set([...current, ...add])); renderRight(); }
      catch{ $('#rolesError').textContent = 'Échec: activer la catégorie'; $('#rolesError').classList.remove('hidden'); }
    } else if(btnDisable){
      const remove = keys.filter(k=>current.has(k)); if(!remove.length) return;
      const next = new Set(current); keys.forEach(k=>next.delete(k));
      try{ await patchPermissions(roleId, [], remove); updateLocalPerms(roleId, next); renderRight(); }
      catch{ $('#rolesError').textContent = 'Échec: désactiver la catégorie'; $('#rolesError').classList.remove('hidden'); }
    }
  });

  // Import from role
  $('#btnImportPerms').addEventListener('click', async ()=>{
    const sel = $('#importRoleSelect'); const srcId = sel?.value || '';
    const roleId = selectedRoleId; if(!roleId || !srcId) return;
    const src = rolesData.find(r=>r.id===srcId); const dst = rolesData.find(r=>r.id===roleId); if(!src||!dst) return;
    const srcSet = new Set(src.permissions||[]);
    const dstSet = new Set(dst.permissions||[]);
    const add = [...srcSet].filter(k=>!dstSet.has(k));
    const remove = [...dstSet].filter(k=>!srcSet.has(k));
    try{ await patchPermissions(roleId, add, remove); updateLocalPerms(roleId, srcSet); renderRight(); sel.value=''; }
    catch{ $('#rolesError').textContent = 'Échec: import de permissions'; $('#rolesError').classList.remove('hidden'); }
  });

  // Init (affichage uniquement des données pré-rendues serveur)
  if(!rolesData.length){
    $('#rolesEmpty').classList.remove('hidden');
    $('#rolesError').textContent = 'Aucun rôle préchargé. Vérifiez le script de seed (node scripts/seed-permissions.js) ou vos droits staff.';
    $('#rolesError').classList.remove('hidden');
  }
  renderRolesList();
  renderRight();
  refreshImportSelect();
})();
</script>
</body>
</html>
