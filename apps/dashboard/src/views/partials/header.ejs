<% if (typeof dashboardUrl === 'undefined' || !dashboardUrl) { dashboardUrl = '/'; } %>
<header class="fixed top-0 left-0 right-0 z-50 border-b border-white/5 bg-[#0B1020]/80 backdrop-blur-md transition-all duration-300" id="mainHeader">
  <style>
    #spaTopLoader { position: fixed; top: 0; left: 0; width: 100%; height: 2px; z-index: 10000; pointer-events: none; opacity: 0; transition: opacity .2s ease; }
    #spaTopLoader.active { opacity: 1; }
    #spaTopLoader .prog { width: 0%; height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); transition: width .2s ease; }
  </style>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 items-center justify-between gap-4">
      <div class="flex items-center gap-8">
        <a href="/" class="flex items-center gap-2.5 transition-opacity hover:opacity-80">
          <img src="/public/images/logo.svg" alt="Plinkk" class="h-8 w-8" />
          <span class="text-lg font-bold tracking-tight text-white">Plinkk</span>
        </a>
        
        <nav class="hidden md:flex items-center gap-1">
          <a href="/about" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">À propos</a>
          <a href="/users" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Utilisateurs</a>
          <a href="<%= dashboardUrl %>" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Dashboard</a>
        </nav>
      </div>

      <div class="flex items-center gap-3">
        <% const __SMS__ = (typeof __SITE_MESSAGES__ !== 'undefined' && Array.isArray(__SITE_MESSAGES__)) ? __SITE_MESSAGES__ : ((typeof __SITE_MESSAGE__ !== 'undefined' && __SITE_MESSAGE__ && __SITE_MESSAGE__.message) ? [__SITE_MESSAGE__.message] : []); %>
        <% if (__SMS__.length) { %>
          <% __SMS__.slice(0,3).forEach(function(__SM__, idx){ %>
            <% const lvl = (__SM__.level || 'info').toLowerCase();
               let bg='bg-slate-700/20', br='border-slate-600/40', tx='text-slate-100', icon='info';
               if (lvl==='info') { bg='bg-sky-500/10'; br='border-sky-500/20'; tx='text-sky-200'; icon='info'; }
               else if (lvl==='success') { bg='bg-emerald-500/10'; br='border-emerald-500/20'; tx='text-emerald-200'; icon='check'; }
               else if (lvl==='warning') { bg='bg-amber-500/10'; br='border-amber-500/20'; tx='text-amber-200'; icon='warn'; }
               else if (lvl==='error' || lvl==='critical') { bg='bg-rose-500/10'; br='border-rose-500/20'; tx='text-rose-200'; icon='error'; }
            %>
            <div class="hidden lg:flex items-center gap-2 px-3 py-1 rounded-full border <%= br %> <%= bg %> <%= tx %> text-xs font-medium" id="siteMessageWrap_<%- idx %>" data-msg='<%- JSON.stringify(__SM__ || null).replace(/'/g, "&#39;") %>'>
              <span><%= __SM__.text %></span>
              <% if (__SM__.dismissible) { %>
                <button id="dismissSiteMessage_<%- idx %>" class="ml-1 hover:opacity-70"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"/></svg></button>
              <% } %>
            </div>
          <% }) %>
        <% } %>

        <div class="hidden md:flex items-center gap-3">
          <% if (typeof user !== 'undefined' && user) { %>
            <% if (isAdmin) { %>
              <a href="/admin" class="inline-flex items-center justify-center rounded-full bg-rose-500/10 px-4 py-1.5 text-sm font-medium text-rose-400 ring-1 ring-inset ring-rose-500/20 transition-colors hover:bg-rose-500/20 hover:text-rose-300">Admin</a>
            <% } %>
            
            <div class="relative" id="accountMenuRoot">
              <button id="accountBtn" class="group flex items-center gap-2 rounded-full bg-white/5 pl-1 pr-3 py-1 ring-1 ring-white/10 transition-all hover:bg-white/10 hover:ring-white/20 focus:outline-none">
                <div class="h-7 w-7 overflow-hidden rounded-full bg-indigo-600 ring-2 ring-[#0B1020]">
                   <%- include('avatar.ejs', { user: user }) %>
                </div>
                <span class="max-w-[100px] truncate text-sm font-medium text-slate-200 group-hover:text-white"><%= user.userName || user.id %></span>
                <svg class="h-4 w-4 text-slate-500 transition-transform group-hover:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
              </button>

              <div id="accountPanel" class="absolute right-0 top-full mt-2 w-64 origin-top-right rounded-xl border border-white/10 bg-[#161b2e] p-1 shadow-2xl hidden">
                <div class="px-3 py-3">
                  <p class="truncate text-sm font-medium text-white"><%= user.userName || user.id %></p>
                  <% if (user.email) { %>
                    <p class="truncate text-xs text-slate-500"><%= user.email %></p>
                  <% } %>
                </div>
                <div class="h-px bg-white/5 my-1"></div>
                <a href="<%= dashboardUrl %>" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                  <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                  Dashboard
                </a>
                <a href="/account" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                  <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                  Paramètres
                </a>
                <div class="h-px bg-white/5 my-1"></div>
                <a href="/logout" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-rose-400 transition-colors hover:bg-rose-500/10">
                  <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                  Se déconnecter
                </a>
              </div>
            </div>
          <% } else { %>
            <a href="/login" class="text-sm font-medium text-slate-300 transition-colors hover:text-white">Se connecter</a>
            <a href="/login#signup" class="rounded-full bg-white px-4 py-2 text-sm font-semibold text-black transition-transform hover:scale-105 hover:bg-slate-200">S'inscrire</a>
          <% } %>
        </div>

        <button id="menuBtn" class="md:hidden inline-flex items-center justify-center rounded-lg p-2 text-slate-400 hover:bg-white/5 hover:text-white focus:outline-none">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
      </div>
    </div>
  </div>

  <div id="mobileMenu" class="hidden border-t border-white/5 bg-[#0B1020]/95 backdrop-blur-xl md:hidden">
    <div class="space-y-1 px-4 py-4">
      <a href="/about" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">À propos</a>
      <a href="/users" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Utilisateurs</a>
      <a href="<%= dashboardUrl %>" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Dashboard</a>
    </div>
    
    <div class="border-t border-white/5 px-4 py-4">
      <% if (typeof user !== 'undefined' && user) { %>
        <div class="flex items-center gap-3 mb-4">
          <div class="h-10 w-10 overflow-hidden rounded-full bg-indigo-600">
            <%- include('avatar.ejs', { user: user }) %>
          </div>
          <div>
            <div class="text-base font-medium text-white"><%= user.userName || user.id %></div>
            <div class="text-sm text-slate-500"><%= user.email %></div>
          </div>
        </div>
        <div class="space-y-1">
          <a href="<%= dashboardUrl %>" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Mon Dashboard</a>
          <a href="/account" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Paramètres</a>
          <a href="/logout" class="block rounded-lg px-3 py-2 text-base font-medium text-rose-400 hover:bg-rose-500/10">Se déconnecter</a>
        </div>
      <% } else { %>
        <div class="grid grid-cols-2 gap-4">
          <a href="/login" class="flex items-center justify-center rounded-lg border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-medium text-white hover:bg-white/10">Connexion</a>
          <a href="/login#signup" class="flex items-center justify-center rounded-lg bg-white px-4 py-2.5 text-sm font-bold text-black hover:bg-slate-200">Inscription</a>
        </div>
      <% } %>
    </div>
  </div>

  <div id="spaTopLoader" aria-hidden="true"><div class="prog" id="spaTopLoaderProg"></div></div>
</header>

<script>
  (function(){
    const el = document.getElementById('spaTopLoader');
    const bar = document.getElementById('spaTopLoaderProg');
    let _active = false, _timer = null, _val = 0, _t0 = 0;
    const MIN_VISIBLE = 300;
    function setProgress(p){ if (!bar) return; _val = Math.max(0, Math.min(100, p)); bar.style.width = _val + '%'; }
    function tick(){ if (!_active) return; const target = 80; const delta = Math.max(0.5, (target - _val) * 0.1); setProgress(_val + delta); _timer = setTimeout(tick, 200); }
    function start(){ if (!el || !bar) return; if (_active) return; _active = true; _t0 = Date.now(); el.classList.add('active'); setProgress(5); clearTimeout(_timer); _timer = setTimeout(tick, 160); }
    function end(){ if (!el || !bar) return; clearTimeout(_timer); setProgress(100); const elapsed = Date.now() - _t0; const extra = Math.max(0, MIN_VISIBLE - elapsed); setTimeout(()=>{ el.classList.remove('active'); setProgress(0); _active = false; }, 250 + extra); }
    if (!window.__spaLoadingStart) window.__spaLoadingStart = start;
    if (!window.__spaLoadingEnd) window.__spaLoadingEnd = end;
    window.addEventListener('spa:loading-start', start);
    window.addEventListener('spa:loading-end', end);
    window.addEventListener('beforeunload', ()=>{ try { sessionStorage.setItem('spa_nav','1'); start(); } catch{} });
    try { if (sessionStorage.getItem('spa_nav') === '1') { sessionStorage.removeItem('spa_nav'); start(); const fin = ()=> setTimeout(end, 120); if (document.readyState === 'complete') fin(); else window.addEventListener('load', fin, { once: true }); } } catch {}
    function isModifiedClick(e){ return e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0; }
    function isSameOrigin(url){ try { const u=new URL(url, location.href); return u.origin===location.origin; } catch { return false; } }
    function looksLikeHtmlRequest(url){ return isSameOrigin(url) && !/\.(?:png|jpe?g|webp|gif|svg|ico|css|js|map|json|txt|woff2?|ttf|otf)(?:[?#].*)?$/i.test(url); }
    document.addEventListener('click', (e)=>{ const a = e.target && (e.target.closest ? e.target.closest('a') : null); if (!a) return; const href = a.getAttribute('href') || ''; if (!href || href.startsWith('#')) return; if (a.target === '_blank' || a.download != null) return; if (isModifiedClick(e)) return; if (!looksLikeHtmlRequest(href)) return; try { window.dispatchEvent(new Event('spa:loading-start')); } catch {} setTimeout(()=>{ try { window.dispatchEvent(new Event('spa:loading-end')); } catch {} }, 8000); }, true);
    try { const origFetch = window.fetch.bind(window); let inflight = 0; const onBegin=()=>{ if (inflight++===0) window.dispatchEvent(new Event('spa:loading-start')); }; const onEnd=()=>{ if (inflight>0 && --inflight===0) window.dispatchEvent(new Event('spa:loading-end')); }; window.fetch = function(input, init){ try { const url = typeof input === 'string' ? input : (input && input.url) || ''; const method = (init && (init.method||'GET')) || (typeof input!=='string' && input && input.method) || 'GET'; const headers = new Headers((init && init.headers) || (typeof input!=='string' && input && input.headers) || undefined); const accept = (headers.get('Accept') || headers.get('accept') || '').toLowerCase(); const isHtmlAccept = accept.includes('text/html') || accept === ''; const qualifies = method.toUpperCase()==='GET' && looksLikeHtmlRequest(url) && !url.startsWith('/api'); if (qualifies && isHtmlAccept) onBegin(); const p = origFetch(input, init); if (qualifies && isHtmlAccept) { p.finally(()=>{ setTimeout(onEnd, 80); }); } return p; } catch { return origFetch(input, init); } }; } catch {}
  })();
</script>
<script>
  (function(){
    const postVisibility = (on) => fetch('/api/me/visibility', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ isPublic: !!on })});
    const t = document.getElementById('visibilityToggle');
    const tm = document.getElementById('visibilityToggleMobile');
    if (t) t.addEventListener('change', () => postVisibility(t.checked).catch(()=>{ t.checked=!t.checked; }));
    if (tm) tm.addEventListener('change', () => postVisibility(tm.checked).catch(()=>{ tm.checked=!tm.checked; }));
    
    const accountBtn = document.getElementById('accountBtn');
    const accountPanel = document.getElementById('accountPanel');
    const root = document.getElementById('accountMenuRoot');
    const closeMenu = () => { accountPanel?.classList.add('hidden'); accountBtn?.setAttribute('aria-expanded','false'); };
    const openMenu = () => { accountPanel?.classList.remove('hidden'); accountBtn?.setAttribute('aria-expanded','true'); };
    if (accountBtn && accountPanel && root) {
      accountBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const isOpen = !accountPanel.classList.contains('hidden'); if (isOpen) closeMenu(); else openMenu(); });
      document.addEventListener('click', (e)=>{ if (!root.contains(e.target)) closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMenu(); });
    }
  })();
</script>
<script>
  (function(){
    try {
      const nodes = Array.from(document.querySelectorAll('[id^="siteMessageWrap_"], #siteMessageWrap'));
      nodes.forEach((wrap) => {
        const raw = wrap.getAttribute('data-msg');
        if (!raw) return;
        const safe = raw.replace(/&#39;/g, "'");
        let msg = null; try { msg = JSON.parse(safe); } catch(e) {}
        if (!msg || !msg.id) return;
        const key = 'dismissed_site_message_' + msg.id;
        if (localStorage.getItem(key)) { wrap.style.display = 'none'; return; }
        const btn = wrap.querySelector('button[id^="dismissSiteMessage"]');
        if (btn) btn.addEventListener('click', ()=>{ localStorage.setItem(key,'1'); wrap.style.display='none'; });
      });
    } catch(e){}
  })();
</script>
