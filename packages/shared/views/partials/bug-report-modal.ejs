<div id="globalBugReportModal"
    class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm"
    aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div
        class="relative w-full max-w-lg transform overflow-hidden rounded-2xl bg-[#0B1020] border border-white/10 text-left shadow-xl transition-all">
        <form id="globalBugReportForm" onsubmit="submitGlobalBugReport(event)">
            <input type="hidden" id="bugReportContextUrl" value="">
            <input type="hidden" id="bugReportContextStack" value="">
            <input type="hidden" id="bugReportContextBrowser" value="">
            <div class="px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                <h3 class="text-lg font-semibold leading-6 text-white mb-4">Signaler un bug</h3>
                <p class="text-sm text-slate-400 mb-4">Décrivez le problème que vous rencontrez. Plus vous donnerez de
                    détails, plus il sera facile de le corriger.</p>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Message</label>
                    <textarea id="bugReportMessage" required rows="4"
                        class="block w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-white placeholder-slate-500 hover:border-white/20 focus:border-violet-500 focus:outline-none focus:ring-1 focus:ring-violet-500 transition-colors sm:text-sm"
                        placeholder="Que s'est-il passé ?"></textarea>
                </div>
            </div>
            <div class="bg-white/5 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2">
                <button type="submit" id="submitBugReportBtn"
                    class="inline-flex w-full justify-center rounded-xl bg-rose-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-rose-500 sm:w-auto transition-colors">Envoyer</button>
                <button type="button" onclick="closeGlobalBugReportModal()"
                    class="mt-3 inline-flex w-full justify-center rounded-xl px-3 py-2 text-sm font-semibold text-slate-300 shadow-sm ring-1 ring-inset ring-white/10 hover:bg-white/5 sm:mt-0 sm:w-auto transition-colors">Annuler</button>
            </div>
        </form>
    </div>
</div>

<script>
    window.openGlobalBugReportModal = function (e, defaultMessage, context) {
        if (e) e.preventDefault();
        const modal = document.getElementById('globalBugReportModal');
        if (!modal) return;

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        const msgEl = document.getElementById('bugReportMessage');
        if (msgEl) {
            msgEl.value = defaultMessage || '';
            msgEl.focus();
        }

        // Set context
        document.getElementById('bugReportContextUrl').value = (context && context.url) || window.location.href;
        document.getElementById('bugReportContextStack').value = (context && context.stack) || '';

        // Capture browser info
        const browserInfo = {
            ua: navigator.userAgent,
            screen: `${window.screen.width}x${window.screen.height}`,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            lang: navigator.language,
            platform: navigator.platform
        };
        document.getElementById('bugReportContextBrowser').value = JSON.stringify(browserInfo);
    };

    window.closeGlobalBugReportModal = function () {
        const modal = document.getElementById('globalBugReportModal');
        if (!modal) return;

        modal.classList.add('hidden');
        modal.classList.remove('flex');

        const msgEl = document.getElementById('bugReportMessage');
        if (msgEl) msgEl.value = '';
        document.getElementById('bugReportContextUrl').value = '';
        document.getElementById('bugReportContextStack').value = '';
        document.getElementById('bugReportContextBrowser').value = '';
    };

    window.submitGlobalBugReport = async function (e) {
        e.preventDefault();
        const btn = document.getElementById('submitBugReportBtn');
        const msgEl = document.getElementById('bugReportMessage');
        if (!btn || !msgEl) return;

        const msg = msgEl.value;
        const originalText = btn.textContent;
        const url = document.getElementById('bugReportContextUrl').value;
        const stack = document.getElementById('bugReportContextStack').value;
        const browser = document.getElementById('bugReportContextBrowser').value;

        btn.disabled = true;
        btn.textContent = 'Envoi...';

        try {
            const res = await fetch('/api/bug-reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: msg,
                    url: url || window.location.href,
                    stack: stack || null,
                    browser: browser ? JSON.parse(browser) : null
                })
            });

            if (res.ok) {
                alert("Merci ! Votre signalement a bien été envoyé.");
                window.closeGlobalBugReportModal();
            } else {
                alert("Une erreur est survenue lors de l'envoi.");
            }
        } catch (err) {
            alert("Erreur réseau.");
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    };
</script>