<%- include('../../partials/head.ejs', { title: 'Tableau de bord - Mon compte' ,
  description: 'Gère ton email, mot de passe et confidentialité du profil.' , robots: 'noindex,nofollow' }) %>
  <%- include('../../partials/header-dash.ejs') %>
    <main class="max-w-7xl mx-auto grid grid-cols-12 gap-4 px-4 py-4">

      <%- include('../../partials/asside_dash.ejs', { active: 'account' }) %>

        <section class="col-span-12 lg:col-span-9 space-y-4">
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <h1 class="text-2xl font-semibold">Mon compte</h1>
              <a href="/dashboard/cosmetics"
                class="px-3 py-2 text-sm rounded-md bg-slate-800/80 hover:bg-slate-800 border border-slate-700 text-slate-200">Cosmétiques
                ➜</a>
            </div>
          </div>
          <div id="accountRoot"
            data-twofactor="<%= !!(user && ((user.totpSecret && user.totpSecret !== '') || user.twoFactorEnabled)) %>"
            data-user-email="<%= user.email %>">
            <div class="rounded-xl border border-slate-800/60 bg-slate-900/60 p-0">
              <div class="flex items-center gap-2 px-4 py-3 border-b border-slate-800/40 bg-transparent">
                <nav class="flex gap-2 w-full" role="tablist" aria-label="Sections du compte">
                  <button class="tab-btn px-3 py-2 rounded-md text-sm font-medium bg-transparent text-slate-300"
                    data-tab="profile" aria-selected="true">Profil</button>
                  <button class="tab-btn px-3 py-2 rounded-md text-sm font-medium bg-transparent text-slate-300"
                    data-tab="security" aria-selected="false">Confidentialité &amp; Sécurité</button>
                  <button class="tab-btn px-3 py-2 rounded-md text-sm font-medium bg-transparent text-slate-300"
                    data-tab="settings" aria-selected="false">Paramètres</button>
                </nav>
              </div>

              <div class="p-4">
                <div id="panel-profile" class="tab-panel">
                  <div class="flex items-start gap-4">
                    <div
                      class="h-20 w-20 rounded-full overflow-hidden border border-slate-700 bg-slate-800 grid place-items-center text-xl font-semibold text-slate-200"
                      id="avatarPreview" data-avatar>
                      <%- include('../../partials/avatar.ejs', { user: user }) %>
                    </div>
                    <div class="flex-1">
                      <h4 class="font-medium mb-1">Photo de profil</h4>
                      <p class="text-xs text-slate-400 mb-2">PNG, JPG ou WebP (max 2 Mo).</p>
                      <input id="avatarInput" type="file" accept="image/*"
                        class="block text-xs text-slate-200 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-slate-800 file:text-slate-200 hover:file:bg-slate-700" />
                      <p id="avatarMsg" class="mt-2 text-xs"></p>
                    </div>
                  </div>
                </div>

                <div id="panel-security" class="tab-panel hidden">
                  <% const tfEnabled=(user && (user.twoFactorEnabled)) %>
                    <% const hostEnabled=(user && (user.host !==null)) %>
                      <div class="space-y-4">
                        <div>
                          <h4 class="text-lg font-semibold mb-2">Confidentialité</h4>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                            <div>
                              <label class="block text-xs mb-1">Sélectionne le Plinkk</label>
                              <select id="privacyPlinkkSelect"
                                class="w-full h-9 px-2 rounded-md bg-slate-900/60 border border-slate-700 text-sm"></select>
                            </div>
                          </div>
                          <div class="flex items-center justify-between py-2">
                            <div>
                              <p class="text-sm font-medium">Profil public</p>
                              <p class="text-xs text-slate-400">Autoriser l'apparition dans la page Utilisateurs.</p>
                            </div>
                            <label class="inline-flex items-center cursor-pointer relative">
                              <input id="togglePublic" type="checkbox" class="sr-only peer" <%=user.isPublic ? 'checked'
                                : '' %> />
                              <span
                                class="w-10 h-6 bg-slate-700/80 rounded-full p-1 peer-checked:bg-emerald-600 transition"></span>
                              <span
                                class="absolute top-1 left-1 size-4 rounded-full bg-white transition peer-checked:translate-x-4"></span>
                            </label>
                          </div>
                          <div class="flex items-center justify-between py-2">
                            <div>
                              <p class="text-sm font-medium">Afficher mon email</p>
                              <p class="text-xs text-slate-400">Rendre l'email visible sur la page Utilisateurs.</p>
                            </div>
                            <label class="inline-flex items-center cursor-pointer relative">
                              <input id="toggleEmailPublic" type="checkbox" class="sr-only peer" <%=isEmailPublic
                                ? 'checked' : '' %> />
                              <span
                                class="w-10 h-6 bg-slate-700/80 rounded-full p-1 peer-checked:bg-emerald-600 transition"></span>
                              <span
                                class="absolute top-1 left-1 size-4 rounded-full bg-white transition peer-checked:translate-x-4"></span>
                            </label>
                          </div>
                        </div>

                        <div class="border-t border-slate-800/40 my-2"></div>

                        <div>
                          <h4 class="text-lg font-semibold mb-2">Sécurité</h4>
                          <div class="space-y-2">
                            <h4 class="font-medium mb-1">Authentification à 2 facteurs (A2F)</h4>
                            <p class="text-xs text-slate-400 mb-2">État: <span class="font-medium">
                                <%= tfEnabled ? 'Activée' : 'Désactivée' %>
                              </span></p>
                            <div class="flex items-center gap-2">
                              <% if (!tfEnabled) { %>
                                <button id="btnEnable2fa"
                                  class="px-3 py-2 text-sm rounded-md bg-emerald-600 hover:bg-emerald-500 text-white">Activer
                                  la A2F</button>
                                <% } else { %>
                                  <button id="btnDisable2fa"
                                    class="px-3 py-2 text-sm rounded-md bg-amber-600 hover:bg-amber-500 text-white">Désactiver
                                    la A2F</button>
                                  <% } %>
                                    <button id="btnLearn2fa"
                                      class="px-3 py-2 text-sm rounded-md bg-slate-800 hover:bg-slate-700 text-white">Comment
                                      ça marche</button>
                            </div>
                          </div>
                          <div class="space-y-3 mt-4">
                            <h4 class="font-medium mb-1">Domaines (par Plinkk)</h4>
                            <p class="text-xs text-slate-400">Associe un CNAME à l'un de tes Plinkks. 1 domaine par
                              Plinkk.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                              <div>
                                <label class="block text-xs mb-1">Sélectionne le Plinkk</label>
                                <select id="domainPlinkkSelect"
                                  class="w-full h-9 px-2 rounded-md bg-slate-900/60 border border-slate-700 text-sm"></select>
                              </div>
                              <div>
                                <label class="block text-xs mb-1">Nom de domaine (ex: plinkk.example.fr)</label>
                                <input id="domainHostname"
                                  class="w-full h-9 px-3 rounded-md bg-slate-900/60 border border-slate-700 text-sm"
                                  placeholder="plinkk.example.fr" />
                              </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                              <button id="btnDomainSave"
                                class="px-3 py-2 text-sm rounded-md bg-emerald-600 hover:bg-emerald-500 text-white">Activer
                                / Mettre à jour</button>
                              <button id="btnDomainVerify"
                                class="px-3 py-2 text-sm rounded-md bg-indigo-600 hover:bg-indigo-500 text-white">Vérifier</button>
                              <button id="btnDomainDelete"
                                class="px-3 py-2 text-sm rounded-md bg-amber-600 hover:bg-amber-500 text-white">Désactiver</button>
                            </div>
                            <div id="domainDnsHints" class="hidden space-y-3 mt-2">
                              <div>
                                <label class="block text-xs mb-1">Enregistrement TXT (vérification)</label>
                                <input id="domainTXT" readonly
                                  class="w-full h-9 px-3 rounded-md bg-slate-900/60 border border-slate-700 text-xs text-slate-300" />
                              </div>
                              <div>
                                <label class="block text-xs mb-1">Enregistrement CNAME</label>
                                <input id="domainCNAME" readonly
                                  class="w-full h-9 px-3 rounded-md bg-slate-900/60 border border-slate-700 text-xs text-slate-300" />
                              </div>
                              <p class="text-[11px] text-slate-400">Après avoir ajouté ces enregistrements, patiente ~15
                                minutes puis clique sur "Vérifier".</p>
                            </div>
                          </div>
                        </div>

                        <div>
                          <h4 class="font-medium mb-1 text-red-200">Supprimer le compte</h4>
                          <p class="text-xs text-red-300 mb-2">Cette action est définitive.</p>
                          <div id="deleteAction">
                            <button id="btnShowDelete"
                              class="w-full px-3 py-2 text-sm rounded-md bg-red-700 hover:bg-red-600 text-white border border-red-500/60"
                              type="button">Supprimer le compte</button>
                          </div>
                        </div>
                      </div>
                </div>

                <div id="panel-settings" class="tab-panel hidden">
                  <div class="space-y-4">
                    <form id="formEmail">
                      <h4 class="font-medium mb-2">Email</h4>
                      <label class="block text-xs text-slate-300 mb-1">Adresse email</label>
                      <div class="flex items-center gap-2 ">
                        <input name="email" type="email" value="<%= user.email %>"
                          class="flex-1 min-w-0 rounded-md bg-slate-900/60 border border-slate-700 px-3 py-2 text-sm" />
                        <button
                          class="px-3 py-2 text-sm rounded-md bg-indigo-600 hover:bg-indigo-500 text-white whitespace-nowrap"
                          type="submit">Mettre à jour l'email</button>
                      </div>
                    </form>

                    <div class="border-t border-slate-800/40 my-2"></div>

                    <form id="formPassword">
                      <h4 class="font-medium mb-2">Mot de passe</h4>
                      <label class="block text-xs text-slate-300 mb-1">Mot de passe actuel</label>
                      <input name="currentPassword" type="password"
                        class="w-full rounded-md bg-slate-900/60 border border-slate-700 px-3 py-2 text-sm mb-2" />
                      <label class="block text-xs text-slate-300 mb-1">Nouveau mot de passe</label>
                      <input name="newPassword" type="password"
                        class="w-full rounded-md bg-slate-900/60 border border-slate-700 px-3 py-2 text-sm mb-2" />
                      <label class="block text-xs text-slate-300 mb-1">Confirmer le mot de passe</label>
                      <input name="confirmPassword" type="password"
                        class="w-full rounded-md bg-slate-900/60 border border-slate-700 px-3 py-2 text-sm mb-3" />
                      <div class="flex items-center justify-end">
                        <button class="px-3 py-2 text-sm rounded-md bg-indigo-600 hover:bg-indigo-500 text-white"
                          type="submit">Changer le mot de passe</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
        </section>
    </main>
    <div id="deleteModal" class="fixed inset-0 hidden z-50 grid place-items-center">
      <div class="absolute inset-0 bg-black/60 modal-overlay"></div>
      <div class="relative w-full max-w-lg mx-4">
        <div class="rounded-lg bg-slate-900/95 border border-slate-800/60 p-6 shadow-lg">
          <h3 class="text-lg font-semibold mb-2 text-red-200">Confirmer la suppression du compte</h3>
          <p class="text-xs text-red-300 mb-4">Cette action est définitive et irréversible. Entrez votre mot de passe
            pour confirmer.</p>

          <div id="deleteError" class="hidden mb-3 text-sm text-amber-300"></div>

          <form id="formDeleteAccount" autocomplete="off">
            <label class="block text-xs text-red-100 mb-1">Mot de passe</label>
            <input id="deletePassword" name="password" type="password" required
              class="w-full rounded-md bg-slate-950/40 border border-red-800 px-3 py-2 text-sm mb-3 text-red-50 placeholder:text-red-300/60"
              placeholder="Votre mot de passe" />

            <% if (user && user.twoFactorEnabled) { %>
              <label class="block text-xs text-red-100 mb-1">Code A2F</label>
              <input id="deleteOtp" name="otp" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" required
                class="w-full rounded-md bg-slate-950/40 border border-red-800 px-3 py-2 text-sm mb-3 text-red-50 placeholder:text-red-300/60"
                placeholder="123456" />
              <% } %>

                <div class="flex items-center justify-end gap-2 mt-4">
                  <button id="btnCancelDelete"
                    class="px-3 py-2 text-sm rounded-md bg-slate-800 hover:bg-slate-700 text-white border border-slate-700"
                    type="button">Annuler</button>
                  <button id="btnConfirmDelete"
                    class="px-3 py-2 text-sm rounded-md bg-red-700 hover:bg-red-600 text-white border border-red-500/60"
                    type="submit">Supprimer définitivement</button>
                </div>
          </form>
        </div>
      </div>
    </div>

    <div id="twoFactorModal" class="fixed inset-0 hidden z-50 grid place-items-center">
      <div id="twoFactorOverlay" class="absolute inset-0 bg-black/60"></div>
      <div class="relative w-full max-w-md mx-4">
        <div class="rounded-lg bg-slate-900/95 border border-slate-800/60 p-6 shadow-lg">
          <h3 class="text-lg font-semibold mb-2">Activer la A2F</h3>
          <p class="text-sm text-slate-300 mb-3">Scannez le QR avec votre application d'authentification ou copiez la
            clé.</p>

          <div id="twoFactorQrWrap" class="mb-4 text-center"></div>
          <div class="mb-3">
            <label class="block text-xs text-slate-400 mb-1">Clé / otpauth</label>
            <input id="twoFactorOtpauth" readonly
              class="w-full rounded-md bg-slate-800/60 border border-slate-700 px-3 py-2 text-sm text-slate-200" />
          </div>

          <div class="mb-4">
            <label class="block text-xs text-slate-400 mb-1">Code de confirmation (6 chiffres)</label>
            <input id="twoFactorConfirmOtp" inputmode="numeric" pattern="[0-9]*" maxlength="6"
              class="w-full rounded-md bg-slate-800/60 border border-slate-700 px-3 py-2 text-sm text-slate-200"
              placeholder="123456" />
          </div>

          <div class="flex items-center justify-end gap-2">
            <button id="btnClose2faModal"
              class="px-3 py-2 text-sm rounded-md bg-slate-800 hover:bg-slate-700 text-white border border-slate-700">Fermer</button>
            <button id="btnConfirm2fa"
              class="px-3 py-2 text-sm rounded-md bg-emerald-600 hover:bg-emerald-500 text-white">Confirmer
              l'activation</button>
            <button id="btnReloadAfter2fa"
              class="px-3 py-2 text-sm rounded-md bg-emerald-500/30 hover:bg-emerald-500/40 text-white hidden">J'ai
              scanné — Recharger</button>
          </div>
        </div>
      </div>
    </div>

    <div id="disable2faModal" class="fixed inset-0 hidden z-50 grid place-items-center">
      <div class="absolute inset-0 bg-black/60" data-disable-overlay></div>
      <div class="relative w-full max-w-md mx-4">
        <div class="rounded-lg bg-slate-900/95 border border-slate-800/60 p-6 shadow-lg">
          <h3 class="text-lg font-semibold mb-2">Désactiver la A2F</h3>
          <p class="text-sm text-slate-300 mb-3">Saisis le code A2F pour confirmer la désactivation.</p>
          <div id="disable2faError" class="hidden mb-3 text-sm text-amber-300"></div>
          <label class="block text-xs text-slate-400 mb-1">Code A2F (6 chiffres)</label>
          <input id="disable2faOtp" inputmode="numeric" pattern="[0-9]*" maxlength="6"
            class="w-full rounded-md bg-slate-800/60 border border-slate-700 px-3 py-2 text-sm text-slate-200 mb-4"
            placeholder="123456" />
          <div class="flex items-center justify-end gap-2">
            <button id="btnCancelDisable2fa"
              class="px-3 py-2 text-sm rounded-md bg-slate-800 hover:bg-slate-700 text-white border border-slate-700">Annuler</button>
            <button id="btnConfirmDisable2fa"
              class="px-3 py-2 text-sm rounded-md bg-amber-600 hover:bg-amber-500 text-white">Confirmer la
              désactivation</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toasts" class="fixed top-4 right-4 z-50 flex flex-col items-end gap-2 pointer-events-none"></div>

    <script>
      function showAlert(message, type = 'info', opts = {}) {
        const container = document.getElementById('toasts');
        if (!container) return console.log(message);
        const el = document.createElement('div');
        el.className = 'pointer-events-auto max-w-sm w-full rounded-md px-4 py-2 text-sm shadow';
        const bg = type === 'success' ? 'bg-emerald-600 text-white' : type === 'error' ? 'bg-rose-600 text-white' : 'bg-slate-800 text-slate-200';
        el.classList.add(...bg.split(' '));
        el.textContent = message;
        el.style.opacity = '0';
        el.style.transition = 'opacity .2s, transform .2s';
        container.appendChild(el);
        void el.offsetWidth;
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
        const timeout = opts.timeout || 3500;
        const remove = () => { el.style.opacity = '0'; setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 220); };
        el.addEventListener('click', remove);
        setTimeout(remove, timeout);
        return el;
      }
    </script>

    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const input = $('#avatarInput');
        const preview = $('#avatarPreview');
        const msg = $('#avatarMsg');

        function setMsg(text, ok) {
          if (!msg) return;
          msg.textContent = text || '';
          msg.className = 'mt-2 text-xs ' + (ok ? 'text-emerald-300' : 'text-amber-300');
        }

        async function uploadAvatar() {
          if (!input || !input.files || !input.files[0]) {
            setMsg('Choisis une image.', false);
            return;
          }

          const file = input.files[0];
          if (!/^image\//i.test(file.type)) { setMsg('Fichier non valide (image requise).', false); return; }
          if (file.size > 2 * 1024 * 1024) { setMsg('Image trop lourde (max 2 Mo).', false); return; }
          try {
            const fileToDataUrl = (f) => new Promise((resolve, reject) => {
              const fr = new FileReader();
              fr.onload = () => resolve(fr.result);
              fr.onerror = () => reject(fr.error || new Error('Lecture du fichier échouée'));
              fr.readAsDataURL(f);
            });
            const dataUrl = await fileToDataUrl(file);

            const formData = new FormData();
            formData.append("file", input.files[0]);

            const res = await fetch("/api/me/avatar", {
              method: "POST",
              body: formData,
            });
            if (!res.ok) {
              if (res.status === 413) {
                setMsg('Image trop lourde (max 128 Ko)', false);
                return;
              }
              throw new Error('HTTP ' + res.status);
            }
            const json = await res.json();
            if (json && (json.url || json.file) && preview) {
              const raw = json.url || ('/public/uploads/avatars/' + json.file);
              const url = raw + '?v=' + Date.now();
              preview.innerHTML = `<img src="${url}" alt="Avatar" class="h-full w-full object-cover" />`;

              const currentId = '<%= user.id %>';
              document.querySelectorAll('[data-avatar]').forEach(el => {
                const elUser = el.getAttribute && el.getAttribute('data-avatar-user');
                if (elUser && elUser === currentId) {
                  if (el.tagName === 'IMG') {
                    el.setAttribute('src', url);
                  } else {
                    el.innerHTML = `<img data-avatar data-avatar-user="${currentId}" src="${url}" alt="Avatar" class="h-full w-full object-cover" />`;
                  }
                }
              });
            }

            setMsg('Avatar mis à jour.', true);
          } catch (err) {
            console.error(err);
            setMsg('Échec de l’upload.', false);
          }
        }


        input?.addEventListener('change', uploadAvatar);
      })();
    </script>

    <script>
      (function () {
        const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
        const panels = {
          profile: document.getElementById('panel-profile'),
          security: document.getElementById('panel-security'),
          settings: document.getElementById('panel-settings')
        };

        function setActive(key) {
          tabButtons.forEach(btn => {
            const t = btn.getAttribute('data-tab');
            const selected = t === key;
            btn.setAttribute('aria-selected', selected ? 'true' : 'false');
            btn.classList.toggle('bg-slate-800/50', selected);
            btn.classList.toggle('text-white', selected);
            btn.classList.toggle('text-slate-300', !selected);
          });
          Object.keys(panels).forEach(k => {
            const el = panels[k];
            if (!el) return;
            if (k === key) el.classList.remove('hidden'); else el.classList.add('hidden');
          });
        }

        setActive('profile');

        tabButtons.forEach(btn => btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-tab'); if (!key) return; setActive(key);
        }));
      })();
    </script>

    <script>
      const accountRoot = document.getElementById('accountRoot');
      const twoFactorEnabled = accountRoot ? accountRoot.getAttribute('data-twofactor') === 'true' : false;
      document.getElementById('formEmail')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const payload = Object.fromEntries(fd.entries());
        const res = await fetch('/api/me/email', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const j = await res.json().catch(() => ({}));
        if (res.ok) {
          showAlert('Email mis à jour', 'success');
          try {
            const newEmail = (j && j.email) ? j.email : payload.email;
            if (newEmail) {
              document.querySelectorAll('[data-current-email]').forEach(el => {
                el.textContent = newEmail;
              });
            }
          } catch (err) {}
        } else {
          showAlert(j.error || 'Erreur', 'error');
        }
      });

      window.addEventListener('load', () => {
        const accountRoot = document.getElementById('accountRoot');
        const userEmail = accountRoot?.getAttribute('data-user-email') || '';
        const select = document.getElementById('privacyPlinkkSelect');
        const chkPublic = document.getElementById('togglePublic');
        const chkEmail = document.getElementById('toggleEmailPublic');

        let plinkkList = [];
        try {
          const tpl = document.getElementById('account-plinkks-data');
          const raw = tpl ? tpl.innerHTML : '[]';
          plinkkList = JSON.parse(raw || '[]');
        } catch (_) { plinkkList = []; }

        function populateOptions() {
          if (!select) return;
          select.innerHTML = '';
          if (!plinkkList.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Aucun plinkk';
            select.appendChild(opt);
            chkPublic && (chkPublic.disabled = true);
            chkEmail && (chkEmail.disabled = true);
            return;
          }
          let defaultId = null;
          plinkkList.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.name || p.slug || p.id} (${p.slug || p.id})`;
            if (p.isDefault) defaultId = p.id;
            select.appendChild(opt);
          });
          if (defaultId) select.value = defaultId;
        }

        async function refreshToggles() {
          const id = select?.value || '';
          const p = plinkkList.find(x => x.id === id) || null;
          if (!p) { if (chkPublic) chkPublic.checked = false; if (chkEmail) chkEmail.checked = false; return; }
          if (typeof p.isPublic === 'boolean' && chkPublic) chkPublic.checked = !!p.isPublic;
          try {
            const res = await fetch(`/api/me/plinkks/${encodeURIComponent(id)}/config`);
            const j = await res.json().catch(() => ({}));
            if (chkEmail) chkEmail.checked = j && j.email !== null;
          } catch (_) { if (chkEmail) chkEmail.checked = false; }
        }

        populateOptions();
        refreshToggles();
        select?.addEventListener('change', refreshToggles);

        chkPublic?.addEventListener('change', async (e) => {
          const id = select?.value || '';
          if (!id) return;
          const checked = e.currentTarget.checked;
          const res = await fetch(`/api/me/plinkks/${encodeURIComponent(id)}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isPublic: !!checked })
          });
          if (!res.ok) showAlert('Erreur lors du changement de visibilité', 'error');
          else {
            const p = plinkkList.find(x => x.id === id); if (p) p.isPublic = !!checked;
          }
        });

        chkEmail?.addEventListener('change', async (e) => {
          const id = select?.value || '';
          if (!id) return;
          const checked = e.currentTarget.checked;
          const payload = { affichageEmail: checked ? (userEmail || null) : null };
          const res = await fetch(`/api/me/plinkks/${encodeURIComponent(id)}/config/plinkk`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) showAlert('Erreur lors du changement visibilité email', 'error');
        });
      });

      document.getElementById('formPassword')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const payload = Object.fromEntries(fd.entries());
        const res = await fetch('/api/me/password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const j = await res.json().catch(() => ({}));
        if (res.ok) showAlert('Mot de passe mis à jour', 'success'); else showAlert(j.error || 'Erreur', 'error');
      });

      (function () {
        const btnShow = document.getElementById('btnShowDelete');
        const modal = document.getElementById('deleteModal');
        const form = document.getElementById('formDeleteAccount');
        const btnCancel = document.getElementById('btnCancelDelete');
        const btnConfirm = document.getElementById('btnConfirmDelete');
        const errorMsg = document.getElementById('deleteError');

        if (!btnShow || !modal || !form) return;

        btnShow.addEventListener('click', () => {
          modal.classList.remove('hidden');
          setTimeout(() => {
            const pwd = document.getElementById('deletePassword');
            pwd && pwd.focus();
          }, 100);
        });

        btnCancel?.addEventListener('click', () => {
          form.reset();
          modal.classList.add('hidden');
          if (errorMsg) { errorMsg.classList.add('hidden'); errorMsg.textContent = ''; }
        });

        modal.querySelector('.modal-overlay')?.addEventListener('click', () => {
          form.reset();
          modal.classList.add('hidden');
          if (errorMsg) { errorMsg.classList.add('hidden'); errorMsg.textContent = ''; }
        });

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (btnConfirm) btnConfirm.disabled = true;
          if (errorMsg) { errorMsg.classList.add('hidden'); errorMsg.textContent = ''; }

          const fd = new FormData(form);
          const payload = Object.fromEntries(fd.entries());

          if (!payload.password || String(payload.password).trim() === '') {
            if (errorMsg) { errorMsg.textContent = 'Entrez votre mot de passe.'; errorMsg.classList.remove('hidden'); }
            btnConfirm && (btnConfirm.disabled = false);
            return;
          }
          if (twoFactorEnabled) {
            if (!payload.otp || String(payload.otp).trim().length < 6) {
              if (errorMsg) { errorMsg.textContent = 'Entrez votre code A2F (6 chiffres).'; errorMsg.classList.remove('hidden'); }
              btnConfirm && (btnConfirm.disabled = false);
              return;
            }
          }

          try {
            const res = await fetch('/api/me/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) {
              if (errorMsg) { errorMsg.textContent = j.error || 'Suppression impossible'; errorMsg.classList.remove('hidden'); }
              btnConfirm && (btnConfirm.disabled = false);
              return;
            }
            modal.classList.add('hidden');
            showAlert('Compte supprimé. Redirection...', 'success');
            setTimeout(() => { window.location.href = '/'; }, 1400);
          } catch (err) {
            console.error(err);
            if (errorMsg) { errorMsg.textContent = 'Erreur réseau'; errorMsg.classList.remove('hidden'); }
          } finally {
            btnConfirm && (btnConfirm.disabled = false);
          }
        });
      })();

      (function () {
        const disableModal = document.getElementById('disable2faModal');
        const btnCancel = document.getElementById('btnCancelDisable2fa');
        const btnConfirm = document.getElementById('btnConfirmDisable2fa');
        const inputOtp = document.getElementById('disable2faOtp');
        const errEl = document.getElementById('disable2faError');

        if (!disableModal) return;

        const close = () => { disableModal.classList.add('hidden'); if (errEl) { errEl.classList.add('hidden'); errEl.textContent = ''; } };

        btnCancel?.addEventListener('click', () => { close(); });
        disableModal.querySelector('[data-disable-overlay]')?.addEventListener('click', () => { close(); });

        btnConfirm?.addEventListener('click', async () => {
          const val = inputOtp?.value?.trim();
          if (!val || val.length < 6) { if (errEl) { errEl.textContent = 'Entrez un code A2F valide (6 chiffres)'; errEl.classList.remove('hidden'); } return; }
          try {
            btnConfirm.disabled = true;
            const res = await fetch('/api/me/2fa', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ otp: val }) });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) {
              if (errEl) { errEl.textContent = j.error || 'Erreur lors de la désactivation'; errEl.classList.remove('hidden'); }
              else showAlert(j.error || 'Erreur lors de la désactivation', 'error');
              return;
            }
            if (j.successful) {
              showAlert('A2F désactivée', 'success');
              close();
              setTimeout(() => location.reload(), 600);
            } else {
              if (errEl) { errEl.textContent = 'Erreur lors de la désactivation'; errEl.classList.remove('hidden'); } else showAlert('Erreur lors de la désactivation', 'error');
            }
          } catch (err) { console.error(err); showAlert('Erreur réseau', 'error'); } finally { btnConfirm.disabled = false; }
        });
      })();

      (function () {
        const btnEnable = document.getElementById('btnEnable2fa');
        const btnDisable = document.getElementById('btnDisable2fa');
        console.debug('A2F buttons found', { btnEnable: !!btnEnable, btnDisable: !!btnDisable });
        const btnLearn = document.getElementById('btnLearn2fa');
        const modal = document.getElementById('twoFactorModal');
        const overlay = document.getElementById('twoFactorOverlay');
        const qrWrap = document.getElementById('twoFactorQrWrap');
        const otpauthEl = document.getElementById('twoFactorOtpauth');
        const btnClose = document.getElementById('btnClose2faModal');
        const btnReload = document.getElementById('btnReloadAfter2fa');

        async function open2faModalWith(data) {
          if (!modal) return;
          qrWrap.innerHTML = '';
          if (otpauthEl) otpauthEl.value = '';
          if (data.qrCode) {
            const img = document.createElement('img');
            img.src = data.qrCode;
            img.alt = 'QR A2F';
            img.className = 'mx-auto';
            qrWrap.appendChild(img);
          }
          if (data.otpauth) {
            if (otpauthEl) otpauthEl.value = data.otpauth;
          }
          modal.classList.remove('hidden');
          setTimeout(() => { btnClose?.focus(); }, 50);
        }

        btnLearn?.addEventListener('click', () => {
          let tips = document.getElementById('twoFactorTipsModal');
          if (!tips) {
            tips = document.createElement('div');
            tips.id = 'twoFactorTipsModal';
            tips.className = 'fixed inset-0 hidden z-50 grid place-items-center';
            tips.innerHTML = `
            <div class="absolute inset-0 bg-black/60" data-tips-overlay></div>
            <div class="relative w-full max-w-lg mx-4">
              <div class="rounded-lg bg-slate-900/95 border border-slate-800/60 p-6 shadow-lg">
                <h3 class="text-lg font-semibold mb-2">Comment fonctionne la A2F</h3>
                <p class="text-sm text-slate-300 mb-3">Installe une application d'authentification (Google Authenticator, Authy, etc.). Pour activer : clique sur "Activer la A2F", scanne le QR et entre le code généré pour confirmer.</p>
                <ul class="text-xs text-slate-400 mb-4 list-disc list-inside space-y-1">
                  <li>Télécharge une app d'authentification sur ton téléphone.</li>
                  <li>Scanne le QR fourni lors de l'activation.</li>
                  <li>Saisis le code à 6 chiffres pour terminer l'activation.</li>
                </ul>
                <div class="flex items-center justify-end gap-2 mt-4">
                  <button data-tips-close class="px-3 py-2 text-sm rounded-md bg-slate-800 hover:bg-slate-700 text-white border border-slate-700">Fermer</button>
                  <button data-tips-open-A2F class="px-3 py-2 text-sm rounded-md bg-emerald-600 hover:bg-emerald-500 text-white">Activer la A2F</button>
                </div>
              </div>
            </div>
          `;
            document.body.appendChild(tips);

            const overlayEl = tips.querySelector('[data-tips-overlay]');
            const closeBtn = tips.querySelector('[data-tips-close]');
            const open2faBtn = tips.querySelector('[data-tips-open-2fa]');

            const closeTips = () => { tips.classList.add('hidden'); };

            overlayEl?.addEventListener('click', closeTips);
            closeBtn?.addEventListener('click', closeTips);
            open2faBtn?.addEventListener('click', () => { closeTips(); btnEnable?.click(); });

            if (!tips.dataset.bound) {
              const escHandler = (e) => { if (e.key === 'Escape') closeTips(); };
              document.addEventListener('keydown', escHandler);
              tips.dataset.bound = 'true';
            }
          }

          tips.classList.remove('hidden');
          setTimeout(() => {
            const cb = tips.querySelector('[data-tips-open-2fa]');
            cb?.focus();
          }, 50);
        });

        btnEnable?.addEventListener('click', async () => {
          try {
            btnEnable.disabled = true;
            const res = await fetch('/api/me/2fa', { method: 'POST' });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) {
              (function () {
                const inputConfirmOtp = document.getElementById('twoFactorConfirmOtp');
                let errEl = document.getElementById('twoFactorError');
                if (!errEl) {
                  errEl = document.createElement('div');
                  errEl.id = 'twoFactorError';
                  errEl.className = 'mt-2 text-xs text-red-300';
                  if (inputConfirmOtp && inputConfirmOtp.parentNode) {
                    inputConfirmOtp.parentNode.insertBefore(errEl, inputConfirmOtp.nextSibling);
                  } else {
                    const modal = document.getElementById('twoFactorModal');
                    modal && modal.querySelector('.p-6')?.appendChild(errEl);
                  }
                }
                errEl.textContent = j.error || 'Erreur lors de la génération de la A2F';
              })();
              return;
            }
            if (j.qrCode || j.otpauth) {
              await open2faModalWith(j);
            } else if (j.successful) {
              location.reload();
            } else {
              showAlert('Réponse inattendue', 'error');
            }
          } catch (err) {
            console.error(err);
            showAlert('Erreur réseau lors de la génération du QR', 'error');
          } finally {
            btnEnable.disabled = false;
          }
        });

        btnDisable?.addEventListener('click', async () => {
          const disableModal = document.getElementById('disable2faModal');
          const disableOtp = document.getElementById('disable2faOtp');
          const disableErr = document.getElementById('disable2faError');
          if (!disableModal) return;
          if (disableErr) { disableErr.classList.add('hidden'); disableErr.textContent = ''; }
          disableOtp && (disableOtp.value = '');
          disableModal.classList.remove('hidden');
          setTimeout(() => { disableOtp && disableOtp.focus(); }, 50);
        });

        const btnConfirm2fa = document.getElementById('btnConfirm2fa');
        const inputConfirmOtp = document.getElementById('twoFactorConfirmOtp');
        btnConfirm2fa?.addEventListener('click', async () => {
          const value = inputConfirmOtp?.value?.trim();
          if (!value || value.length < 6) { showAlert('Entrez un code A2F valide (6 chiffres)', 'error'); return; }
          try {
            btnConfirm2fa.disabled = true;
            const res = await fetch('/api/me/2fa/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ otp: value }) });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) { showAlert(j.error || 'Code invalide', 'error'); return; }
            if (j.successful) {
              showAlert('A2F activée avec succès', 'success');
              document.getElementById('btnReloadAfter2fa')?.classList.remove('hidden');
              btnConfirm2fa.classList.add('hidden');
            } else {
              showAlert('Erreur lors de la confirmation', 'error');
            }
          } catch (err) { console.error(err); showAlert('Erreur réseau', 'error'); } finally { btnConfirm2fa.disabled = false; }
        });

        btnClose?.addEventListener('click', () => { modal.classList.add('hidden'); });
        overlay?.addEventListener('click', () => { modal.classList.add('hidden'); });
        btnReload?.addEventListener('click', () => { location.reload(); });
      })();
    </script>

    <template id="account-plinkks-data"><%- JSON.stringify((typeof plinkks !=='undefined' ) ? plinkks : ((typeof pages
        !=='undefined' ) ? pages : [])) %></template>

    <script>
      (function () {
        const selectPlinkk = document.getElementById('domainPlinkkSelect');
        const inputHost = document.getElementById('domainHostname');
        const btnSave = document.getElementById('btnDomainSave');
        const btnVerify = document.getElementById('btnDomainVerify');
        const btnDelete = document.getElementById('btnDomainDelete');
        const hints = document.getElementById('domainDnsHints');
        const txt = document.getElementById('domainTXT');
        const cname = document.getElementById('domainCNAME');

        if (!selectPlinkk || !inputHost) return;

        let list = [];
        try {
          const tpl = document.getElementById('account-plinkks-data');
          const raw = tpl ? tpl.innerHTML : '[]';
          list = JSON.parse(raw || '[]');
        } catch (_) { list = []; }
        selectPlinkk.innerHTML = '';
        if (!list.length) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Aucun plinkk';
          selectPlinkk.appendChild(opt);
        } else {
          list.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.name || p.slug || p.id} (${p.slug || p.id})`;
            selectPlinkk.appendChild(opt);
          });
        }

        function buildTxtRecord(hostname, token) {
          return `_plinkk-verification.${hostname} IN TXT "plinkk-verify=${token}"`;
        }
        function buildCnameRecord(hostname) {
          return `${hostname} CNAME page.plinkk.fr`;
        }

        btnSave?.addEventListener('click', async () => {
          const hostname = (inputHost.value || '').trim();
          if (!hostname) { showAlert('Entre un nom de domaine', 'error'); return; }
          try {
            btnSave.disabled = true;
            const res = await fetch('/api/me/host', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ hostname }) });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) { showAlert(j.error || 'Erreur lors de la configuration du domaine', 'error'); return; }
            if (j.token || (j.verified === false)) {
              hints?.classList.remove('hidden');
              if (txt) txt.value = buildTxtRecord(hostname, j.token || 'TOKEN');
              if (cname) cname.value = buildCnameRecord(hostname);
              showAlert('Ajoute les enregistrements DNS puis clique sur Vérifier', 'success');
            } else {
              showAlert('Domaine enregistré', 'success');
            }
          } catch (e) {
            console.error(e);
            showAlert('Erreur réseau', 'error');
          } finally {
            btnSave.disabled = false;
          }
        });

        btnVerify?.addEventListener('click', async () => {
          try {
            btnVerify.disabled = true;
            const res = await fetch('/api/me/host/verify', { method: 'POST' });
            const j = await res.json().catch(() => ({}));
            if (j.verified) {
              showAlert('Domaine vérifié ✓', 'success');
            } else {
              showAlert('TXT non détecté, réessaye dans quelques minutes', 'error');
            }
          } catch (e) { console.error(e); showAlert('Erreur réseau', 'error'); }
          finally { btnVerify.disabled = false; }
        });

        btnDelete?.addEventListener('click', async () => {
          try {
            btnDelete.disabled = true;
            const res = await fetch('/api/me/host', { method: 'DELETE' });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) { showAlert(j.error || 'Suppression impossible', 'error'); return; }
            showAlert('Domaine désactivé', 'success');
          } catch (e) { console.error(e); showAlert('Erreur réseau', 'error'); }
          finally { btnDelete.disabled = false; }
        });
      })();
    </script>