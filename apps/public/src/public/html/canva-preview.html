<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { height: 100%; margin: 0; background: transparent; }
      .wrap { position: relative; width: 100%; height: 100%; overflow: hidden; background: #0b1220; }
      canvas { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <canvas id="previewCanvas"></canvas>
    </div>
    <script>
      (function(){
        function getAll(name){
          const url = new URL(location.href);
          return url.searchParams.getAll(name);
        }
        function get(name){
          const url = new URL(location.href);
          return url.searchParams.get(name);
        }
        const file = get('file');
        if(!file){ console.error('Missing ?file='); return; }
        const exts = getAll('ext');

        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');

        function resize(){
          // fit to iframe size
          canvas.width = canvas.clientWidth;
          canvas.height = canvas.clientHeight;
        }
        const ro = new ResizeObserver(resize); ro.observe(canvas);
        resize();

        function loadScript(src){
          return new Promise(function(resolve, reject){
            const s = document.createElement('script');
            s.src = src; s.async = true; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
          });
        }

        async function start(){
          try {
            // load external libs first
            for (const e of exts){ await loadScript(e); }
            // special-case matrix app: needs extra local files
            if (file === 'matrix-effect/app.js'){
              await loadScript('/public/canvaAnimation/matrix-effect/effect.js');
              await loadScript('/public/canvaAnimation/matrix-effect/symbol.js');
            }
            await loadScript('/public/canvaAnimation/' + file);
            if (typeof window.runCanvasAnimation === 'function'){
              window.runCanvasAnimation(ctx, canvas);
            } else {
              console.error('runCanvasAnimation not found');
            }
          } catch(err){
            console.error('Preview load error', err);
          }
        }
        start();
      })();
    </script>
  </body>
  </html>
