<%- include('../../partials/head.ejs', 
{   title: 'Tableau de bord - Administration' , 
    description: 'Tableau de bord d\'administration — actions rapides, statistiques et modération.' ,
    robots: 'noindex,nofollow' }) %>

<%- include('../../partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
    <%- include('../../partials/admin-nav.ejs', { user: user, active: 'dashboard' }) %>

    <%
    pendingCount=(typeof totals !=='undefined' && totals && totals.pendingThemes !=null) ?
    totals.pendingThemes : (typeof pendingThemes !=='undefined' && pendingThemes ? pendingThemes.length :
    0); const totalUsersCount=(typeof totals !=='undefined' && totals && totals.totalUsers !=null) ?
    totals.totalUsers : users.length; const totalPublicCount=(typeof totals !=='undefined' && totals &&
    totals.totalPublic !=null) ? totals.totalPublic : 0; const moderatorsCount=(typeof totals !=='undefined'
    && totals && totals.moderators !=null) ? totals.moderators : 0; const privateCount=(typeof totals
    !=='undefined' && totals && totals.totalPrivate !=null) ? totals.totalPrivate : (Array.isArray(users) ?
    users.filter(u=>
    !u.isPublic).length : 0);
    %>

    <main class="col-span-12 lg:col-span-10 space-y-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-gradient-to-r from-slate-900 to-slate-800 p-6 rounded-3xl border border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-violet-600/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="relative z-10">
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Administration</h1>
                <p class="text-slate-400 text-base">Gérez les utilisateurs, les thèmes et la modération.</p>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-slate-900 border border-slate-800 p-5 rounded-3xl hover:border-violet-500/50 transition-all group">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-2.5 bg-violet-500/10 rounded-2xl text-violet-400 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </div>
                </div>
                <p class="text-slate-400 text-sm font-medium">Utilisateurs</p>
                <h3 class="text-2xl font-bold text-white mt-1"><%= totalUsersCount %></h3>
            </div>
            <div class="bg-slate-900 border border-slate-800 p-5 rounded-3xl hover:border-amber-500/50 transition-all group">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-2.5 bg-amber-500/10 rounded-2xl text-amber-400 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </div>
                </div>
                <p class="text-slate-400 text-sm font-medium">Thèmes en attente</p>
                <h3 class="text-2xl font-bold text-white mt-1"><%= pendingCount %></h3>
            </div>
            <div class="bg-slate-900 border border-slate-800 p-5 rounded-3xl hover:border-emerald-500/50 transition-all group">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-2.5 bg-emerald-500/10 rounded-2xl text-emerald-400 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </div>
                </div>
                <p class="text-slate-400 text-sm font-medium">Profils Publics</p>
                <h3 class="text-2xl font-bold text-white mt-1"><%= totalPublicCount %></h3>
            </div>
            <div class="bg-slate-900 border border-slate-800 p-5 rounded-3xl hover:border-slate-600 transition-all group">
                <div class="flex items-center justify-between mb-3">
                    <div class="p-2.5 bg-slate-800 rounded-2xl text-slate-400 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                </div>
                <p class="text-slate-400 text-sm font-medium">Profils Privés</p>
                <h3 class="text-2xl font-bold text-white mt-1"><%= privateCount %></h3>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Users List -->
            <section class="xl:col-span-2 bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden flex flex-col">
                <div class="p-5 border-b border-slate-800 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div>
                        <h2 class="font-bold text-white text-lg">Utilisateurs</h2>
                        <p class="text-sm text-slate-400 mt-1">Total: <span id="totalCount" class="text-white font-medium"><%= users.length %></span></p>
                    </div>
                    
                    <div class="flex gap-2 flex-wrap">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="Rechercher..." class="pl-10 pr-4 py-2.5 rounded-xl bg-slate-950 border border-slate-800 text-slate-200 text-sm focus:border-violet-500 outline-none w-full sm:w-64 transition-colors" />
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <button id="resetBtn" class="p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors" title="Réinitialiser">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex gap-2 overflow-x-auto">
                    <select id="roleFilter" class="rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 text-sm text-slate-300 focus:border-violet-500 outline-none">
                        <option value="all">Tous rôles</option>
                    </select>
                    <select id="visibilityFilter" class="rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 text-sm text-slate-300 focus:border-violet-500 outline-none">
                        <option value="all">Toutes Visibilités</option>
                        <option value="public">Public</option>
                        <option value="private">Privé</option>
                    </select>
                    <select id="sortSelect" class="rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 text-sm text-slate-300 focus:border-violet-500 outline-none">
                        <option value="date-desc">Plus récents</option>
                        <option value="date-asc">Plus anciens</option>
                        <option value="name-asc">Nom (A→Z)</option>
                        <option value="name-desc">Nom (Z→A)</option>
                    </select>
                </div>

                <div class="flex-1 overflow-y-auto max-h-[800px] p-4">
                    <% if (users.length===0) { %>
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-500">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            </div>
                            <p class="text-slate-400">Aucun utilisateur trouvé.</p>
                        </div>
                    <% } else { %>
                        <ul id="usersGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <% users.forEach(u=> { 
                                const plCount = Array.isArray(u.plinkks) ? u.plinkks.length : 0;
                                const plActive = Array.isArray(u.plinkks) ? u.plinkks.filter(p=>p.isActive).length : 0;
                                const uViews = typeof u.views === 'number' ? u.views : 0;
                                const mustChange = !!u.mustChangePassword;
                            %>
                                <li class="relative rounded-2xl border border-slate-800 p-3.5 bg-slate-950/50 hover:border-violet-500/30 transition-all group"
                                    data-name="<%- (u.userName||'').toLowerCase() %>"
                                    data-id="<%- (u.id||'').toLowerCase() %>"
                                    data-role="<%- (u.role && (u.role.id || u.role.name)) ? (u.role.id || u.role.name) : 'USER' %>"
                                    data-role-name="<%- (u.role && (u.role.name || u.role.id)) ? (u.role.name || u.role.id) : 'USER' %>"
                                    data-visible="<%- u.isPublic ? 'public' : 'private' %>"
                                    data-email-public="<%- u.publicEmail ? '1' : '0' %>"
                                    data-twofa="<%- u.twoFactorEnabled ? '1' : '0' %>"
                                    data-views="<%- uViews %>"
                                    data-plinkks-count="<%- plCount %>"
                                    data-plinkks-active="<%- plActive %>"
                                    data-must-change="<%- mustChange ? '1' : '0' %>"
                                    data-created="<%- +new Date(u.createdAt) %>"
                                    data-search="<%- (u.userName+' '+u.id+' '+(u.publicEmail||u.email||'')).toLowerCase() %>">
                                    
                                    <div class="flex items-start gap-4">
                                        <div class="w-10 h-10 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-white font-bold text-base shadow-lg shadow-black/20">
                                            <%= (u.userName||u.id||'?').charAt(0).toUpperCase() %>
                                        </div>
                                        
                                        <div class="min-w-0 flex-1">
                                            <div class="flex items-center justify-between mb-1">
                                                <div class="font-bold text-white truncate pr-2 flex items-center gap-1" title="<%= u.userName || u.id %>">
                                                    <%= u.userName %>
                                                    <% if (u.isVerified) { %>
                                                        <svg class="w-3.5 h-3.5 text-blue-400" viewBox="0 0 24 24" fill="currentColor" title="Vérifié"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                                                    <% } %>
                                                    <% if (u.isPartner) { %>
                                                        <svg class="w-3.5 h-3.5 text-violet-400" viewBox="0 0 24 24" fill="currentColor" title="Partenaire"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                                    <% } %>
                                                </div>
                                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-800 text-slate-300 border border-slate-700 uppercase tracking-wider">
                                                    <%= (typeof u.role !== 'undefined' && u.role) ? (u.role.name || u.role.id) : 'USER' %>
                                                </span>
                                            </div>
                                            
                                            <div class="text-xs text-slate-400 mb-2 flex items-center gap-2">
                                                <span class="bg-slate-900 px-1.5 py-0.5 rounded border border-slate-800">@<%= u.id %></span>
                                                <% if (u.isPublic) { %>
                                                    <span class="text-emerald-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>Public</span>
                                                <% } else { %>
                                                    <span class="text-slate-500 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>Privé</span>
                                                <% } %>
                                            </div>

                                            <% const isEmailPublic=Boolean(u.publicEmail); %>
                                            <% const publicEmail=u.publicEmail || u.email; %>
                                            <% const canReveal=(user.role && (user.role.id==='ADMIN' || user.role.id==='DEVELOPER' || user.role.id==='MODERATOR')); %>
                                            
                                            <div class="mb-3">
                                                <% if (isEmailPublic) { %>
                                                    <span class="text-xs text-slate-400 truncate block"><%= publicEmail %></span>
                                                <% } else { %>
                                                    <span class="emailContainer inline-flex items-center gap-2 text-xs w-full">
                                                        <span class="text-xs text-slate-500 italic privateEmailLabel">Email privé</span>
                                                        <% if (canReveal) { %>
                                                            <span class="privateEmailWrap ml-auto inline-flex items-center gap-2 text-xs">
                                                                <button type="button" class="revealEmailBtn inline-flex items-center gap-1.5 px-2 py-1 rounded-lg bg-violet-600 hover:bg-violet-500 text-white text-xs font-medium transition-colors shadow-lg shadow-violet-900/20">
                                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                                                    Afficher
                                                                </button>
                                                                <span class="emailValue hidden"><%= u.email %></span>
                                                            </span>
                                                        <% } %>
                                                    </span>
                                                <% } %>
                                            </div>

                                            <div class="flex items-center justify-between pt-3 border-t border-slate-800">
                                                <div class="flex -space-x-2 overflow-hidden">
                                                    <% if (Array.isArray(u.plinkks) && u.plinkks.length > 0) { 
                                                        const def = u.plinkks.find(p=>p.isDefault) || null;
                                                        const others = u.plinkks.filter(p=>!p.isDefault).slice(0, 3);
                                                    %>
                                                        <% if (def) { %>
                                                            <a href="<%= frontendUrl %>/<%= u.id %>" target="_blank" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-violet-900 ring-2 ring-slate-900 text-[10px] text-violet-200 font-bold" title="Par défaut: <%= def.name || def.slug %>">D</a>
                                                        <% } %>
                                                        <% others.forEach(p => { %>
                                                            <a href="<%= frontendUrl %>/<%= u.id %>/<%= p.slug %>" target="_blank" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 ring-2 ring-slate-900 text-[10px] text-slate-400" title="<%= p.name || p.slug %>"><%= (p.name||p.slug).charAt(0).toUpperCase() %></a>
                                                        <% }) %>
                                                        <% if (u.plinkks.length > 4) { %>
                                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 ring-2 ring-slate-900 text-[10px] text-slate-400">+<%= u.plinkks.length - 4 %></span>
                                                        <% } %>
                                                    <% } else { %>
                                                        <span class="text-[10px] text-slate-600 italic">Aucun Plinkk</span>
                                                    <% } %>
                                                </div>
                                                
                                                <button type="button" class="userManageBtn px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-xs font-medium transition-colors flex items-center gap-1.5">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                                                    Gérer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            <% }) %>
                        </ul>
                    <% } %>
                </div>
            </section>

            <!-- Sidebar -->
            <aside class="space-y-6">
                <!-- Pending Themes -->
                <div class="bg-slate-900 border border-slate-800 rounded-3xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold text-white text-base">Thèmes en attente</h2>
                        <a href="/dashboard/admin/themes" class="text-xs font-medium text-violet-400 hover:text-violet-300">Voir tout →</a>
                    </div>
                    
                    <% if (typeof pendingThemes==='undefined' || !pendingThemes || pendingThemes.length===0) { %>
                        <div class="text-center py-8 border border-dashed border-slate-800 rounded-2xl">
                            <p class="text-sm text-slate-500">Aucun thème en attente.</p>
                        </div>
                    <% } else { %>
                        <ul class="space-y-3">
                            <% pendingThemes.forEach(t=> { %>
                                <li class="bg-slate-950/50 border border-slate-800 rounded-2xl p-3 flex items-center gap-3 hover:border-violet-500/30 transition-colors">
                                    <div class="w-12 h-12 rounded-xl overflow-hidden previewMini shadow-sm"></div>
                                    <div class="min-w-0 flex-1">
                                        <div class="font-semibold text-white text-sm truncate"><%= t.name %></div>
                                        <div class="text-xs text-slate-500 truncate">Par @<%= t.authorId %></div>
                                    </div>
                                    <div class="flex flex-col gap-1.5">
                                        <a href="/dashboard/admin/themes/validate/<%= t.id %>" class="px-2.5 py-1 rounded-lg bg-violet-600 hover:bg-violet-500 text-white text-[10px] font-medium text-center transition-colors">Valider</a>
                                        <a href="/dashboard/admin/themes/<%= t.id %>" class="px-2.5 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-[10px] font-medium text-center transition-colors">Voir</a>
                                    </div>
                                </li>
                            <% }) %>
                        </ul>
                    <% } %>
                </div>
            </aside>
        </div>
    </main>
</div>

<!-- Preview Modal -->
<div id="plinkkPreviewModalAdmin" class="fixed inset-0 hidden z-50 items-center justify-center backdrop-blur-sm">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="relative w-full max-w-4xl h-[80vh] bg-slate-900 border border-slate-700 rounded-3xl overflow-hidden shadow-2xl shadow-black/50 animate-scale-in mx-4">
        <div class="flex items-center justify-between p-4 border-b border-slate-800 bg-slate-900/95">
            <div id="plinkkPreviewTitleAdmin" class="text-sm text-white font-bold">Prévisualisation</div>
            <button id="closePlinkkPreviewAdmin" class="p-2 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <iframe id="plinkkPreviewFrameAdmin" src="about:blank" class="w-full h-full bg-white"></iframe>
    </div>
</div>

<!-- User Management Modal -->
<div id="userManageModal" class="fixed inset-0 hidden z-[2147483600] items-center justify-center backdrop-blur-sm">
    <div class="absolute inset-0 bg-black/60 transition-opacity duration-200" data-close></div>
    <div class="relative w-full max-w-3xl bg-slate-900 border border-slate-700 rounded-3xl shadow-2xl shadow-black/50 animate-scale-in mx-4 max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 z-10 flex items-center justify-between p-6 border-b border-slate-800 bg-slate-900/95 backdrop-blur">
            <div class="min-w-0 flex-1">
                <div id="umUserName" class="text-xl font-bold text-white truncate">Utilisateur</div>
                <div class="text-sm text-slate-400 truncate">@<span id="umUserId">id</span></div>
            </div>
            <button id="umClose" class="p-2 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-6">
                <!-- Role & Stats -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Rôle</label>
                        <select id="umRole" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors"></select>
                    </div>
                    
                    <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4">
                        <div class="text-xs font-medium text-slate-400 mb-3 uppercase tracking-wider">Statistiques</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-900 rounded-xl p-3 text-center border border-slate-800">
                                <div class="text-[10px] text-slate-500 uppercase">Plinkks</div>
                                <div id="umStatPlCount" class="text-xl font-bold text-white">0</div>
                            </div>
                            <div class="bg-slate-900 rounded-xl p-3 text-center border border-slate-800">
                                <div class="text-[10px] text-slate-500 uppercase">Actifs</div>
                                <div id="umStatPlActive" class="text-xl font-bold text-emerald-400">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Badges -->
                    <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4">
                        <div class="text-xs font-medium text-slate-400 mb-3 uppercase tracking-wider">Badges</div>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 rounded-xl bg-slate-900 border border-slate-800 cursor-pointer hover:border-slate-700 transition-colors">
                                <input id="umBadgeVerified" type="checkbox" class="w-4 h-4 rounded border-slate-700 bg-slate-950 text-blue-500 focus:ring-blue-500 focus:ring-offset-0">
                                <span class="text-sm text-slate-300 flex items-center gap-2">
                                    Vérifié
                                    <svg class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                                </span>
                                <svg id="umBadgeVerifiedSpin" class="plinkk-spinner hidden ml-auto text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                            </label>
                            <label class="flex items-center gap-3 p-3 rounded-xl bg-slate-900 border border-slate-800 cursor-pointer hover:border-slate-700 transition-colors">
                                <input id="umBadgePartner" type="checkbox" class="w-4 h-4 rounded border-slate-700 bg-slate-950 text-violet-500 focus:ring-violet-500 focus:ring-offset-0">
                                <span class="text-sm text-slate-300 flex items-center gap-2">
                                    Partenaire
                                    <svg class="w-4 h-4 text-violet-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                </span>
                                <svg id="umBadgePartnerSpin" class="plinkk-spinner hidden ml-auto text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Security -->
                <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4">
                    <div class="text-xs font-medium text-slate-400 mb-3 uppercase tracking-wider">Sécurité</div>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-3 rounded-xl bg-slate-900 border border-slate-800 cursor-pointer hover:border-slate-700 transition-colors">
                            <input id="umForcePwd" type="checkbox" class="w-4 h-4 rounded border-slate-700 bg-slate-950 text-violet-600 focus:ring-violet-500 focus:ring-offset-0">
                            <span class="text-sm text-slate-300">Forcer le reset du mot de passe</span>
                            <svg id="umForcePwdSpin" class="plinkk-spinner hidden ml-auto text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                        </label>
                        
                        <button id="umDisable2fa" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-amber-500/10 text-amber-500 hover:bg-amber-500/20 border border-amber-500/20 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed has-spinner">
                            <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                            <span>Désactiver la 2FA</span>
                        </button>
                    </div>
                </div>

                <!-- Moderation -->
                <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4">
                    <div class="text-xs font-medium text-slate-400 mb-3 uppercase tracking-wider">Modération</div>
                    
                    <div id="umBanState" class="p-3 rounded-xl bg-rose-500/10 border border-rose-500/20 text-rose-400 text-sm mb-3 hidden"></div>
                    
                    <div id="umBanForm" class="space-y-3">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Raison</label>
                            <input id="umBanReason" type="text" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm text-white focus:border-rose-500 outline-none" placeholder="ex: spam massif" />
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">Durée (min)</label>
                                <input id="umBanMinutes" type="number" step="1" min="-1" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm text-white focus:border-rose-500 outline-none" placeholder="-1 (perm)" />
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center gap-2 text-xs text-slate-300 cursor-pointer">
                                    <input id="umBanDeletePlinkk" type="checkbox" class="rounded border-slate-700 bg-slate-900 text-rose-600"> Supprimer Plinkks
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button id="umBanApply" class="flex-1 px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm font-medium shadow-lg shadow-rose-900/20 transition-colors has-spinner">
                                <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                                <span>Bannir</span>
                            </button>
                            <button id="umBanRevoke" class="flex-1 px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium border border-slate-700 transition-colors hidden has-spinner">
                                <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                                <span>Révoquer</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="bg-rose-950/10 border border-rose-900/20 rounded-2xl p-4">
                    <div class="text-xs font-medium text-rose-400 mb-3 uppercase tracking-wider">Zone dangereuse</div>
                    <button id="umImpersonate" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-slate-300 hover:text-white border border-slate-800 hover:border-slate-700 transition-colors text-sm font-medium mb-3 has-spinner">
                        <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>Se connecter en tant que</span>
                    </button>
                    <button id="umDelete" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm font-medium shadow-lg shadow-rose-900/20 transition-colors has-spinner">
                        <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                        <span>Supprimer le compte</span>
                    </button>
                </div>
            </div>

            <!-- Plinkk Management -->
            <div class="space-y-6">
                <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider">Gestion des Plinkks</div>
                        <div id="umPlMeta" class="text-[10px] font-mono text-slate-500 bg-slate-900 px-2 py-1 rounded-lg border border-slate-800"></div>
                    </div>
                    
                    <div class="space-y-4 flex-1">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Sélectionner une page</label>
                            <select id="umPlSelect" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2.5 text-sm text-white focus:border-violet-500 outline-none"></select>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Slug (URL)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs">/</span>
                                <input id="umPlSlug" type="text" class="w-full pl-6 pr-3 py-2.5 rounded-xl bg-slate-900 border border-slate-800 text-sm text-white focus:border-violet-500 outline-none" placeholder="slug" />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2 p-3 rounded-xl bg-slate-900 border border-slate-800 cursor-pointer hover:border-slate-700">
                                <input id="umPlPublic" type="checkbox" class="rounded border-slate-700 bg-slate-950 text-violet-600">
                                <span class="text-xs text-slate-300">Public</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 rounded-xl bg-slate-900 border border-slate-800 cursor-pointer hover:border-slate-700">
                                <input id="umPlActive" type="checkbox" class="rounded border-slate-700 bg-slate-950 text-violet-600">
                                <span class="text-xs text-slate-300">Actif</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 rounded-xl bg-slate-900 border border-slate-800 cursor-pointer hover:border-slate-700">
                                <input id="umPlDefault" type="checkbox" class="rounded border-slate-700 bg-slate-950 text-violet-600">
                                <span class="text-xs text-slate-300">Par défaut</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 rounded-xl bg-slate-900 border border-slate-800 cursor-pointer hover:border-slate-700">
                                <input id="umPlEmailVisible" type="checkbox" class="rounded border-slate-700 bg-slate-950 text-violet-600">
                                <span class="text-xs text-slate-300">Email visible</span>
                            </label>
                        </div>

                        <div class="bg-slate-900 rounded-xl p-3 text-center border border-slate-800">
                            <div class="text-[10px] text-slate-500 uppercase">Vues totales</div>
                            <div id="umPlViews" class="text-xl font-bold text-white">0</div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 pt-2">
                            <a id="umPlPreview" target="_blank" class="flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-xs font-medium transition-colors">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                Aperçu
                            </a>
                            <a id="umViewProfile" target="_blank" class="flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-xs font-medium transition-colors">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                                Profil
                            </a>
                            <button id="umCopyLink" class="col-span-2 flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-xs font-medium transition-colors">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                                Copier le lien
                            </button>
                        </div>
                    </div>

                    <div class="pt-4 mt-4 border-t border-slate-800 flex gap-2">
                        <button id="umPlDelete" class="px-4 py-2.5 rounded-xl bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 text-xs font-medium transition-colors has-spinner">
                            <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                            <span>Supprimer</span>
                        </button>
                        <button id="umPlSave" class="flex-1 px-4 py-2.5 rounded-xl bg-violet-600 hover:bg-violet-500 text-white text-xs font-medium shadow-lg shadow-violet-900/20 transition-colors has-spinner">
                            <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                            <span>Enregistrer</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const search = $('#searchInput');
        const sort = $('#sortSelect');
        const roleFilter = $('#roleFilter');
        const visFilter = $('#visibilityFilter');
        const grid = $('#usersGrid');
        const resetBtn = $('#resetBtn');

        function applyFilter() {
            if (!grid) return;
            const q = (search?.value || '').trim().toLowerCase();
            const rf = (roleFilter?.value || 'all');
            const vf = (visFilter?.value || 'all');
            const items = Array.from(grid.children);
            let visible = 0;
            items.forEach(li => {
                const hay = (li.dataset.search || '');
                const role = li.dataset.role || 'USER';
                const vis = li.dataset.visible || 'private';
                const okQ = !q || hay.includes(q);
                const okR = rf === 'all' || role === rf;
                const okV = vf === 'all' || vis === vf;
                const show = okQ && okR && okV;
                li.style.display = show ? '' : 'none';
                if (show) visible++;
            });
            const totalCount = document.getElementById('totalCount'); if (totalCount) totalCount.textContent = String(visible);
        }
        function applySort() {
            if (!grid) return;
            const val = sort?.value || 'date-desc';
            const arr = Array.from(grid.children);
            arr.sort((a, b) => {
                if (val === 'name-asc') return a.dataset.name.localeCompare(b.dataset.name, 'fr');
                if (val === 'name-desc') return b.dataset.name.localeCompare(a.dataset.name, 'fr');
                if (val === 'date-asc') return Number(a.dataset.created) - Number(b.dataset.created);
                return Number(b.dataset.created) - Number(a.dataset.created);
            });
            arr.forEach(n => grid.appendChild(n));
        }

        [search, roleFilter, visFilter].forEach(el => el?.addEventListener('input', applyFilter));
        sort?.addEventListener('change', () => { applySort(); applyFilter(); });
        resetBtn?.addEventListener('click', () => { if (search) search.value = ''; if (sort) sort.value = 'date-desc'; if (roleFilter) roleFilter.value = 'all'; if (visFilter) visFilter.value = 'all'; applySort(); applyFilter(); });

        (function renderPendingPreviews() {
            document.querySelectorAll('aside .previewMini').forEach(el => {
                const li = el.closest('li');
                const raw = li?.getAttribute('data-json') || '';
                let parsed = {};
                try { parsed = raw ? JSON.parse(raw) : {}; } catch (e) { }
                let c = { bg: '#111827', button: '#4f46e5', hover: '#22c55e' };
                if (parsed.light) c = { bg: parsed.light.bg || c.bg, button: parsed.light.button || c.button, hover: parsed.light.hover || c.hover };
                el.innerHTML = `<div style="width:100%;height:100%;background:${c.bg};display:flex;flex-direction:column;justify-content:center;gap:6px;padding:6px">` +
                    `<div style="height:28px;background:${c.button};border-radius:6px;width:70%"></div>` +
                    `<div style="height:20px;background:${c.hover};border-radius:6px;width:50%"></div>` +
                    `</div>`;
            });
        })();
    })();
</script>

</body>

<script src="/public/js/pagination.js"></script>
<script>
    (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const search = $('#searchInput');
        const sort = $('#sortSelect');
        const roleFilter = $('#roleFilter');
        const visFilter = $('#visibilityFilter');
        const grid = $('#usersGrid');
        const totalCount = $('#totalCount');
        const visibleCount = $('#visibleCount');
        const resetBtn = $('#resetBtn');

        if (!grid || !window.__PlinkkPaginator) return;

        const paginator = window.__PlinkkPaginator.createPaginator(grid, {
            pageSize: 21, selectors: { items: 'li' }, onRender: (pageItems, meta) => {
                if (visibleCount) visibleCount.textContent = String(meta.totalItems);
            }
        });

        if (totalCount) totalCount.textContent = String(paginator.getAll().length);

        function applyFilter() {
            const q = (search?.value || '').trim().toLowerCase();
            const rf = (roleFilter?.value || 'all');
            const vf = (visFilter?.value || 'all');
            const all = paginator.getAll();
            const filtered = all.filter(li => {
                const hay = (li.dataset.search || '').toString();
                const role = (li.dataset.role || 'USER');
                const vis = (li.dataset.visible || 'private');
                const okQ = !q || hay.includes(q);
                const okR = rf === 'all' || role === rf;
                const okV = vf === 'all' || vis === vf;
                return okQ && okR && okV;
            });
            paginator.setFiltered(filtered);
        }

        function applySort() {
            const val = sort?.value;
            const collator = new Intl.Collator('fr', { sensitivity: 'base' });
            const getKey = (li, key) => (li.dataset[key] || '').toString();
            paginator.sort((a, b) => {
                switch (val) {
                    case 'date-desc': return (Number(getKey(b, 'created')) - Number(getKey(a, 'created')));
                    case 'date-asc': return (Number(getKey(a, 'created')) - Number(getKey(b, 'created')));
                    case 'name-asc': return collator.compare(getKey(a, 'name'), getKey(b, 'name'));
                    case 'name-desc': return collator.compare(getKey(b, 'name'), getKey(a, 'name'));
                    case 'id-asc': return collator.compare(getKey(a, 'id'), getKey(b, 'id'));
                    case 'id-desc': return collator.compare(getKey(b, 'id'), getKey(a, 'id'));
                    default: return 0;
                }
            });
        }

        search?.addEventListener('input', () => applyFilter());
        sort?.addEventListener('change', () => applySort());
        roleFilter?.addEventListener('change', () => applyFilter());
        visFilter?.addEventListener('change', () => applyFilter());
        resetBtn?.addEventListener('click', () => {
            if (search) search.value = '';
            if (sort) sort.value = 'date-desc';
            if (roleFilter) roleFilter.value = 'all';
            if (visFilter) visFilter.value = 'all';
            applySort();
            applyFilter();
        });

        const style = document.createElement('style');
        style.textContent = `
            .copy-anim { position: relative; }
            .copy-anim::after {
            content: 'Copié !';
            position: absolute; left: 50%; top: -10px; transform: translate(-50%, -100%);
            background: rgba(16,185,129,.95); color: #fff; font-size: 10px; border-radius: 6px; padding: 4px 6px;
            opacity: 0; pointer-events: none; transition: opacity .25s ease, transform .25s ease;
            box-shadow: 0 8px 24px rgba(16,185,129,.35);
            }
            .copy-anim.copied::after { opacity: 1; transform: translate(-50%, -120%); }
            .copy-anim.copied { box-shadow: 0 0 0 1px rgba(16,185,129,.35) inset; }
            `;
        document.head.appendChild(style);

        const toastStyle = document.createElement('style');
        toastStyle.textContent = `
            .plinkk-toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2147483200; display:flex; flex-direction:column; gap:8px; }
            .plinkk-toast { background: rgba(17,24,39,0.95); color: #fff; padding: 8px 12px; border-radius: 8px; box-shadow: 0 8px 24px rgba(2,6,23,.6); font-size: 13px; opacity:0; transform: translateY(-6px); transition: opacity .18s ease, transform .18s ease; }
            .plinkk-toast.show { opacity:1; transform: translateY(0); }
            `;
        document.head.appendChild(toastStyle);

        const uxStyle = document.createElement('style');
        uxStyle.textContent = `
            [data-tip]{ position: relative; cursor: help; }
            [data-tip]::after{ content: attr(data-tip); position: absolute; left: 0; top: 100%; transform: translateY(6px); background: rgba(2,6,23,0.96); color: #e5e7eb; border:1px solid #334155; font-size: 11px; line-height:1.2; padding: 6px 8px; border-radius: 6px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity .15s ease; z-index: 50; }
            [data-tip]:hover::after{ opacity: 1; }
            .has-spinner{ position: relative; }
            .has-spinner .plinkk-spinner{ width: 14px; height: 14px; margin-right: 6px; animation: plk-spin 1s linear infinite; }
            .plinkk-spinner{ width: 14px; height: 14px; animation: plk-spin 1s linear infinite; opacity:.9 }
            @keyframes plk-spin { from{ transform: rotate(0deg);} to{ transform: rotate(360deg);} }
            `;
        document.head.appendChild(uxStyle);

        function getToastContainer() {
            let c = document.querySelector('.plinkk-toast-container');
            if (!c) { c = document.createElement('div'); c.className = 'plinkk-toast-container'; document.body.appendChild(c); }
            return c;
        }

        function showToast(message, ms = 2000) {
            try {
                const c = getToastContainer();
                const t = document.createElement('div');
                t.className = 'plinkk-toast';
                t.textContent = message;
                c.appendChild(t);
                void t.offsetWidth;
                t.classList.add('show');
                setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 180); }, ms);
            } catch (e) {}
        }

        function confirmWithInput(displayName, userId) {
            return new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 z-[2147483800] flex items-center justify-center bg-black/50 backdrop-blur-sm';
                overlay.innerHTML = `
                    <div class="w-full max-w-md mx-4 bg-slate-900 border border-slate-700 rounded-3xl p-6 text-sm shadow-2xl animate-scale-in">
                        <div class="mb-4 text-slate-300">Pour confirmer la suppression du compte "<strong>${displayName}</strong>" (@${userId}), tapez <strong>${userId}</strong> ci‑dessous :</div>
                        <input type="text" class="w-full mb-4 px-4 py-3 rounded-xl bg-slate-950 border border-slate-800 text-sm text-white focus:border-rose-500 outline-none" aria-label="Confirmation input" />
                        <div class="flex justify-end gap-3">
                        <button class="cancel px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-sm transition-colors">Annuler</button>
                        <button class="ok px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm transition-colors">Supprimer</button>
                        </div>
                    </div>`;
                const input = overlay.querySelector('input');
                const btnOk = overlay.querySelector('.ok');
                const btnCancel = overlay.querySelector('.cancel');

                document.body.appendChild(overlay);
                input.focus();

                function onKey(ev){
                    if (ev.key === 'Enter') { ev.preventDefault(); btnOk.click(); }
                    if (ev.key === 'Escape') { ev.preventDefault(); btnCancel.click(); }
                    if (ev.key === 'Echap') { ev.preventDefault(); btnCancel.click(); }
                }

                const cleanup = (res) => {
                    document.removeEventListener('keydown', onKey);
                    overlay.remove();
                    resolve(res);
                };

                btnCancel.addEventListener('click', () => cleanup(false));
                overlay.addEventListener('click', (ev) => { if (ev.target === overlay) cleanup(false); });
                btnOk.addEventListener('click', () => cleanup((input.value || '').trim() === String(userId)));
                input.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') { ev.preventDefault(); btnOk.click(); }
                    if (ev.key === 'Escape') { ev.preventDefault(); btnCancel.click(); }
                });
                document.addEventListener('keydown', onKey);
            });
        }

        function confirmSimple(message = 'Confirmer ?', { confirmText = 'Confirmer', cancelText = 'Annuler' } = {}) {
            return new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 z-[2147483800] flex items-center justify-center bg-black/50 backdrop-blur-sm';
                overlay.innerHTML = `
                    <div class="w-full max-w-md mx-4 bg-slate-900 border border-slate-700 rounded-3xl p-6 text-sm shadow-2xl animate-scale-in">
                        <div class="mb-4 text-slate-200 text-lg font-medium">${message}</div>
                        <div class="flex justify-end gap-3">
                            <button class="cancel px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-sm transition-colors">${cancelText}</button>
                            <button class="ok px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm transition-colors">${confirmText}</button>
                        </div>
                    </div>`;
                const btnOk = overlay.querySelector('.ok');
                const btnCancel = overlay.querySelector('.cancel');
                document.body.appendChild(overlay);
                function cleanup(val){ overlay.remove(); resolve(val); }
                btnOk.addEventListener('click', () => cleanup(true));
                btnCancel.addEventListener('click', () => cleanup(false));
                overlay.addEventListener('click', (ev) => { if (ev.target === overlay) cleanup(false); });
                const onKey = (ev) => { if (ev.key === 'Escape') { ev.preventDefault(); cleanup(false); } if (ev.key === 'Enter') { ev.preventDefault(); cleanup(true); } };
                document.addEventListener('keydown', onKey, { once: true });
            });
        }

        grid.addEventListener('click', (e) => {
            const btn = e.target.closest('.revealEmailBtn');
            if (!btn) return;
            const container = btn.closest('.emailContainer');
            if (!container) return;
            const wrap = container.querySelector('.privateEmailWrap');
            if (!wrap) return;
            const emailEl = wrap.querySelector('.emailValue');
            if (!emailEl) return;
            const email = emailEl.textContent || '';
            if (!container.classList.contains('revealed')) {
                container.classList.add('revealed');
                container.innerHTML = `<span class="text-xs text-slate-300 truncate emailShown font-mono select-all" title="${email}">${email}</span>
                    <div class="inline-flex items-center gap-1 ml-2">
                        <button class="copySmall p-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-emerald-400 transition-colors" title="Copier">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                        </button>
                        <button class="hideEmailBtn p-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors" title="Cacher">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.44 0 .87-.03 1.28-.08"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>
                        </button>
                    </div>`;
                const copyBtn = container.querySelector('.copySmall');
                copyBtn?.addEventListener('click', () => {
                    navigator.clipboard?.writeText(email).then(() => {
                        const originalHTML = copyBtn.innerHTML;
                        copyBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                        copyBtn.classList.add('text-emerald-400');
                        copyBtn.classList.remove('text-slate-400');
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                            copyBtn.classList.remove('text-emerald-400');
                            copyBtn.classList.add('text-slate-400');
                        }, 1000);
                    }).catch(() => { });
                });
                const hideBtn = container.querySelector('.hideEmailBtn');
                hideBtn?.addEventListener('click', () => {
                    container.classList.remove('revealed');
                    container.innerHTML = `<span class="text-xs text-slate-500 italic privateEmailLabel">Email privé</span>` +
                        `<span class="privateEmailWrap ml-auto inline-flex items-center gap-2 text-xs">` +
                        `<button type="button" class="revealEmailBtn inline-flex items-center gap-1.5 px-2 py-1 rounded-lg bg-violet-600 hover:bg-violet-500 text-white text-xs font-medium transition-colors shadow-lg shadow-violet-900/20">` +
                        `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>` +
                        `Afficher` +
                        `</button>` +
                        `<span class="emailValue hidden">${email}</span>` +
                        `</span>`;
                });
            }
        });

        if (sort) sort.value = 'date-desc';
        applySort();
        applyFilter();

        document.addEventListener('keydown', (ev) => {
            const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
            const meta = isMac ? ev.metaKey : ev.ctrlKey;
            if (meta && ev.key.toLowerCase() === 'k') { ev.preventDefault(); search?.focus(); }
        });

        const myRole = "<%= (user && user.role && (user.role.id || user.role.name)) ? (user.role.id || user.role.name) : 'USER' %>";
        const rolesCache = { list: [] };
        async function loadRoles() {
            try {
                const res = await fetch('/api/roles');
                if (!res.ok) return;
                const json = await res.json();
                const roles = Array.isArray(json.roles) ? json.roles : [];
                rolesCache.list = roles;
                const rf = document.getElementById('roleFilter');
                if (rf) {
                    const current = rf.value;
                    rf.innerHTML = '<option value="all">Tous rôles</option>' + roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                    rf.value = current || 'all';
                }
                const umRoleSel = document.getElementById('umRole');
                if (umRoleSel) {
                    umRoleSel.innerHTML = roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                }
            } catch {}
        }
        loadRoles();
        const um = {
            root: document.getElementById('userManageModal'),
            close: document.getElementById('umClose'),
            name: document.getElementById('umUserName'),
            id: document.getElementById('umUserId'),
            role: document.getElementById('umRole'),
            view: document.getElementById('umViewProfile'),
            copy: document.getElementById('umCopyLink'),
            disable2fa: document.getElementById('umDisable2fa'),
            del: document.getElementById('umDelete'),
            impersonate: document.getElementById('umImpersonate'),
            badgeVerified: document.getElementById('umBadgeVerified'),
            badgePartner: document.getElementById('umBadgePartner')
        };
        let currentLI = null;
        let currentUserDetails = null;
        let currentPlinkks = [];

        async function fetchUserDetails(userId){
            try { const res = await fetch('/api/users/' + encodeURIComponent(userId)); if (!res.ok) throw new Error('HTTP '+res.status); return await res.json(); } catch(e){ console.error(e); return null; }
        }

        async function openUserModal(li){
            currentLI = li;
            const displayName = li.querySelector('.font-bold')?.textContent?.trim() || li.dataset.id;
            const id = li.dataset.id;
            const role = li.dataset.role || 'USER';
            const twofa = (li.dataset.twofa === '1');
            const views = Number(li.dataset.views || 0) || 0;
            const plCount = Number(li.dataset.plinkksCount || 0) || 0;
            const plActiveCount = Number(li.dataset.plinkksActive || 0) || 0;
            const mustChange = (li.dataset.mustChange === '1');

            um.name.textContent = displayName || id;
            um.id.textContent = id;
            um.role.value = role;
            um.view.href = "<%= frontendUrl %>" + '/' + id;
            um.disable2fa.disabled = !twofa;
            // Stats
            const v = document.getElementById('umStatViews'); if (v) v.textContent = String(views);
            const pc = document.getElementById('umStatPlCount'); if (pc) pc.textContent = String(plCount);
            const pa = document.getElementById('umStatPlActive'); if (pa) pa.textContent = String(plActiveCount);
            const fp = document.getElementById('umForcePwd'); if (fp) fp.checked = !!mustChange;

            currentUserDetails = await fetchUserDetails(id);
            
            // Badges
            if (um.badgeVerified) um.badgeVerified.checked = !!currentUserDetails?.isVerified;
            if (um.badgePartner) um.badgePartner.checked = !!currentUserDetails?.isPartner;

            const plSelect = document.getElementById('umPlSelect');
            const plSlug = document.getElementById('umPlSlug');
            const plPublic = document.getElementById('umPlPublic');
            const plActiveChk = document.getElementById('umPlActive');
            const plDefault = document.getElementById('umPlDefault');
            const plMeta = document.getElementById('umPlMeta');
            const plPreview = document.getElementById('umPlPreview');
            const plEmailVisible = document.getElementById('umPlEmailVisible');
            const plViews = document.getElementById('umPlViews');
            currentPlinkks = Array.isArray(currentUserDetails?.plinkks) ? currentUserDetails.plinkks : [];
            const opts = currentPlinkks.map(p => ({
                id: p.id, slug: (p.slug||''), label: (p.isDefault ? (p.name||p.slug||'Par défaut')+ ' (Par défaut)' : (p.name||p.slug||'Sans nom')),
                isDefault: !!p.isDefault, isPublic: !!p.isPublic, isActive: !!p.isActive,
                url: p.isDefault ? ('/'+id) : ('/'+p.slug), views: (p.views||0), emailVisible: !!(p.settings && p.settings.affichageEmail)
            }));
            if (plSelect){ plSelect.innerHTML = opts.map((o,i)=>`<option value="${i}">${o.label}${o.slug?` (${o.slug})`:''}</option>`).join(''); }
            function applyPl(i){
                const o = opts[i|0]||opts[0]; if (!o) return;
                if (plSlug) plSlug.value = o.slug || '';
                if (plPublic) plPublic.checked = !!o.isPublic;
                if (plActiveChk) plActiveChk.checked = !!o.isActive;
                if (plDefault) plDefault.checked = !!o.isDefault;
                if (plEmailVisible) plEmailVisible.checked = !!o.emailVisible;
                if (plPreview) plPreview.href = "<%= frontendUrl %>" + o.url;
                if (plViews) plViews.textContent = String(o.views||0);
                if (plMeta) plMeta.textContent = o.slug ? `/${id}/${o.slug}` : `/${id}`;
                if (um.view) um.view.href = "<%= frontendUrl %>" + o.url;
                um.copy?.setAttribute('data-url', "<%= frontendUrl %>" + o.url);
            }
            if (plSelect){ plSelect.value = '0'; applyPl(0); plSelect.onchange = ()=> applyPl(Number(plSelect.value||0)); }

            const baseRanks = { USER:0, MODERATOR:1, DEVELOPER:2, ADMIN:3 };
            const ranks = { ...baseRanks };
            const dyn = (rolesCache.list || []).map(r => r.name).filter(n => !(n in ranks) && n !== 'ADMIN').sort();
            dyn.forEach((name, i) => { ranks[name] = 1 + i; });
            ranks['ADMIN'] = Math.max(...Object.values(ranks)) + 1;
            Array.from(um.role.options).forEach(opt => {
                const target = opt.textContent || opt.value;
                let disabled = false;
                if (myRole === 'ADMIN') disabled = false;
                else if (myRole === 'DEVELOPER') disabled = (target === 'ADMIN');
                else disabled = (ranks[target] ?? 0) >= (ranks[myRole]||0);
                opt.disabled = !!disabled;
            });

            um.root.classList.remove('hidden');
            um.root.classList.add('flex');
            document.body.style.overflow = 'hidden';
            requestAnimationFrame(()=>{
                const overlay = um.root.querySelector('[data-close]');
                const panel = um.root.querySelector('.relative.w-full.max-w-3xl');
                overlay && overlay.classList.add('opacity-100');
                if (panel){ panel.classList.remove('translate-y-2','opacity-0'); panel.classList.add('translate-y-0','opacity-100'); }
            });
        }
        function closeUserModal(){
            const overlay = um.root.querySelector('[data-close]');
            const panel = um.root.querySelector('.relative.w-full.max-w-3xl');
            if (overlay) overlay.classList.remove('opacity-100');
            if (panel){ panel.classList.add('translate-y-2'); panel.classList.remove('opacity-100'); panel.classList.add('opacity-0'); }
            setTimeout(()=>{
                um.root.classList.add('hidden');
                um.root.classList.remove('flex');
                document.body.style.overflow = '';
                currentLI = null;
            }, 180);
        }

        grid.addEventListener('click', (e)=>{
            const btn = e.target.closest('.userManageBtn');
            if (!btn) return;
            const li = btn.closest('li');
            if (!li) return;
            openUserModal(li);
        });
        um.close?.addEventListener('click', closeUserModal);
        um.root?.querySelector('[data-close]')?.addEventListener('click', closeUserModal);
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !um.root.classList.contains('hidden')) closeUserModal(); });

        um.copy?.addEventListener('click', async ()=>{
            if (!currentLI) return;
            const fallback = "<%= frontendUrl %>" + '/' + currentLI.dataset.id;
            const raw = um.copy.getAttribute('data-url') || fallback;
            let url = raw;
            if (!raw.startsWith('http')) {
                 url = (window.location && window.location.origin ? window.location.origin : '') + raw;
            }
            try { await navigator.clipboard?.writeText(url); showToast('Lien copié'); } catch(e){ showToast('Copie échouée'); }
        });

        um.role?.addEventListener('change', async ()=>{
            if (!currentLI) return;
            const id = currentLI.dataset.id;
            const newRole = um.role.value;
            const prev = currentLI.dataset.role;
            try{
                const res = await fetch('/api/users/' + encodeURIComponent(id) + '/role', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role: newRole })
                });
                if (!res.ok) throw new Error('HTTP '+res.status);
                currentLI.dataset.role = newRole;
                const badge = currentLI.querySelector('.roleDisplay');
                if (badge) badge.textContent = newRole;
                applyFilter();
                showToast('Rôle mis à jour');
            } catch(err){
                console.error(err); showToast('Erreur de mise à jour du rôle'); um.role.value = prev;
            }
        });

        um.disable2fa?.addEventListener('click', async ()=>{
            if (!currentLI || um.disable2fa.disabled) return; const id = currentLI.dataset.id;
            const ok = window.confirm("Désactiver la 2FA pour @"+id+" ?\nL'utilisateur devra la reconfigurer pour la réactiver.");
            if (!ok) return;
            const btn = um.disable2fa; const spinner = btn.querySelector('.plinkk-spinner'); const label = btn.querySelector('span'); const prevLabel = label ? label.textContent : btn.textContent;
            btn.disabled = true; if (spinner) spinner.classList.remove('hidden'); if (label) label.textContent = 'Désactivation...';
            try{
                const res = await fetch(`/api/users/${encodeURIComponent(id)}/2fa/disable`, { method:'POST' });
                if (!res.ok) throw new Error('HTTP '+res.status);
                currentLI.dataset.twofa = '0';
                if (label) label.textContent = 'A2F désactivée';
                showToast('2FA désactivée');
            }catch(err){ console.error(err); showToast('Erreur: 2FA'); if (label) label.textContent = prevLabel; btn.disabled = false; }
            finally { if (spinner) spinner.classList.add('hidden'); }
        });

        um.del?.addEventListener('click', async ()=>{
            if (!currentLI) return; const id = currentLI.dataset.id; const name = currentLI.querySelector('.font-bold')?.textContent?.trim() || id;
            const ok = await confirmWithInput(name, id); if (!ok) return;
            const btn = um.del; const spinner = btn.querySelector('.plinkk-spinner'); const label = btn.querySelector('span'); const prev = label ? label.textContent : btn.textContent; btn.disabled = true; if (spinner) spinner.classList.remove('hidden'); if (label) label.textContent = 'Suppression...';
            try{
                const res = await fetch(`/api/users/${encodeURIComponent(id)}`, { method:'DELETE' });
                if (!res.ok) throw new Error('HTTP '+res.status);
                currentLI.remove(); paginator.setFiltered(paginator.getAll()); if (totalCount) totalCount.textContent = String(paginator.getAll().length);
                closeUserModal(); showToast('Utilisateur supprimé');
            }catch(err){ console.error(err); showToast('Suppression impossible'); if (label) label.textContent = prev; btn.disabled = false; }
            finally { if (spinner) spinner.classList.add('hidden'); }
        });

        um.impersonate?.addEventListener('click', async () => {
            if (!currentLI) return;
            const id = currentLI.dataset.id;
            const ok = await confirmSimple(`Se connecter en tant que @${id} ?`, { confirmText: 'Se connecter', cancelText: 'Annuler' });
            if (!ok) return;
            
            const btn = um.impersonate;
            const spinner = btn.querySelector('.plinkk-spinner');
            const icon = btn.querySelector('svg:not(.plinkk-spinner)');
            const label = btn.querySelector('span');
            const prevLabel = label ? label.textContent : '';
            
            btn.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (icon) icon.classList.add('hidden');
            if (label) label.textContent = 'Connexion...';

            try {
                const res = await fetch(`/api/admin/users/${encodeURIComponent(id)}/impersonate`, { method: 'POST' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                if (data.redirectUrl) {
                    window.location.href = data.redirectUrl;
                } else {
                    showToast('Erreur: pas de redirection');
                    btn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                showToast('Erreur lors de l\'impersonation');
                btn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (icon) icon.classList.remove('hidden');
                if (label) label.textContent = prevLabel;
            }
        });

        const handleBadgeChange = async (type, checkbox, spinId) => {
            if (!currentLI) return;
            const id = currentLI.dataset.id;
            const checked = checkbox.checked;
            const spinner = document.getElementById(spinId);
            
            checkbox.disabled = true;
            if (spinner) spinner.classList.remove('hidden');

            try {
                const res = await fetch(`/api/users/${encodeURIComponent(id)}/badges`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, value: checked })
                });
                
                if (!res.ok) throw new Error('HTTP ' + res.status);
                
                // Update local state
                if (currentUserDetails) {
                    if (type === 'VERIFIED') currentUserDetails.isVerified = checked;
                    if (type === 'PARTNER') currentUserDetails.isPartner = checked;
                }
                showToast(`Badge ${type === 'VERIFIED' ? 'Vérifié' : 'Partenaire'} ${checked ? 'activé' : 'désactivé'}`);
            } catch (err) {
                console.error(err);
                showToast('Erreur lors de la mise à jour du badge');
                checkbox.checked = !checked; // Revert
            } finally {
                checkbox.disabled = false;
                if (spinner) spinner.classList.add('hidden');
            }
        };

        um.badgeVerified?.addEventListener('change', () => handleBadgeChange('VERIFIED', um.badgeVerified, 'umBadgeVerifiedSpin'));
        um.badgePartner?.addEventListener('change', () => handleBadgeChange('PARTNER', um.badgePartner, 'umBadgePartnerSpin'));

        (function(){
                const plSelect = document.getElementById('umPlSelect');
                const plSlug = document.getElementById('umPlSlug');
                const plPublic = document.getElementById('umPlPublic');
                const plActiveChk = document.getElementById('umPlActive');
                const plDefault = document.getElementById('umPlDefault');
                const plEmailVisible = document.getElementById('umPlEmailVisible');
            const plSave = document.getElementById('umPlSave');
            const plDelete = document.getElementById('umPlDelete');
            const plMeta = document.getElementById('umPlMeta');

            function getSelectedPlinkkId(userId){
                const idx = Number(plSelect && plSelect.value || 0);
                const p = Array.isArray(currentPlinkks) ? currentPlinkks[idx|0] : null;
                return p ? p.id : null;
            }

                                        plSave?.addEventListener('click', async ()=>{
                if (!currentLI) return; const userId = currentLI.dataset.id;
                const pId = await getSelectedPlinkkId(userId);
                if (!pId) { showToast('Impossible de trouver la page'); return; }
                                            const payload = { };
                                            const newSlug = plSlug && plSlug.value ? plSlug.value.trim() : '';
                if (newSlug !== '') payload.slug = newSlug;
                                            payload.isPublic = !!(plPublic && plPublic.checked);
                                            if (plDefault && plDefault.checked) payload.isDefault = true;
                                            const saveBtn = document.getElementById('umPlSave'); const s1 = saveBtn?.querySelector('.plinkk-spinner'); const l1 = saveBtn?.querySelector('span'); const prev = l1 ? l1.textContent : '';
                                            if (saveBtn) saveBtn.disabled = true; if (s1) s1.classList.remove('hidden'); if (l1) l1.textContent = 'Enregistrement...';
                try{
                    const res = await fetch('/api/admin/plinkks/' + encodeURIComponent(pId), { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error('HTTP '+res.status);
                    const active = !!(plActiveChk && plActiveChk.checked);
                    await fetch('/api/admin/plinkks/' + encodeURIComponent(pId) + '/active', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ isActive: active }) });
                    if (plEmailVisible){
                        const checked = !!plEmailVisible.checked;
                        const uEmail = currentUserDetails?.publicEmail || currentUserDetails?.email || '';
                        await fetch('/api/admin/plinkks/' + encodeURIComponent(pId) + '/config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ affichageEmail: checked ? uEmail : null }) });
                    }
                    showToast('Plinkk mis à jour');
                                            }catch(err){ console.error(err); showToast('Erreur: mise à jour Plinkk'); }
                                            finally{ if (saveBtn) saveBtn.disabled = false; if (s1) s1.classList.add('hidden'); if (l1) l1.textContent = prev || 'Enregistrer'; }
            });

            plDelete?.addEventListener('click', async ()=>{
                if (!currentLI) return; const userId = currentLI.dataset.id;
                const pId = await getSelectedPlinkkId(userId);
                if (!pId) { showToast('Impossible de trouver la page'); return; }
                const ok = await confirmSimple('Supprimer cette page Plinkk ? Cette action est irréversible.', { confirmText: 'Supprimer', cancelText: 'Annuler' });
                if (!ok) return;
                const delBtn = document.getElementById('umPlDelete'); const s2 = delBtn?.querySelector('.plinkk-spinner'); const l2 = delBtn?.querySelector('span'); const prev2 = l2 ? l2.textContent : '';
                if (delBtn) delBtn.disabled = true; if (s2) s2.classList.remove('hidden'); if (l2) l2.textContent = 'Suppression...';
                try{
                    const res = await fetch('/api/admin/plinkks/' + encodeURIComponent(pId), { method:'DELETE' });
                    if (!res.ok) throw new Error('HTTP '+res.status);
                    showToast('Plinkk supprimé');
                }catch(err){ console.error(err); showToast('Suppression impossible'); }
                finally { if (delBtn) delBtn.disabled = false; if (s2) s2.classList.add('hidden'); if (l2) l2.textContent = prev2 || 'Supprimer'; }
            });
        })();

        const umForcePwd = document.getElementById('umForcePwd');
        const umForcePwdSpin = document.getElementById('umForcePwdSpin');
        umForcePwd?.addEventListener('change', async ()=>{
            if (!currentLI) return;
            const id = currentLI.dataset.id;
            const next = umForcePwd.checked;
            const prev = currentLI.dataset.mustChange === '1';
            umForcePwd.disabled = true; umForcePwdSpin?.classList.remove('hidden');
            try{
                const res = await fetch('/api/users/' + encodeURIComponent(id) + '/force-password-reset', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mustChange: next }) });
                if (!res.ok) throw new Error('HTTP '+res.status);
                currentLI.dataset.mustChange = next ? '1' : '0';
                showToast(next ? 'Reset MDP forcé activé' : 'Reset MDP forcé désactivé');
            }catch(err){
                console.error(err);
                showToast('Erreur: reset MDP');
                umForcePwd.checked = !!prev;
            } finally { umForcePwd.disabled = false; umForcePwdSpin?.classList.add('hidden'); }
        });

        (function(){
            const banState = document.getElementById('umBanState');
            const banForm = document.getElementById('umBanForm');
            const banReason = document.getElementById('umBanReason');
            const banMinutes = document.getElementById('umBanMinutes');
            const banDelete = document.getElementById('umBanDeletePlinkk');
            const banApply = document.getElementById('umBanApply');
            const banRevoke = document.getElementById('umBanRevoke');

            async function loadBanState(userId){
                try{
                    const res = await fetch('/api/users/' + encodeURIComponent(userId) + '/ban-email');
                    if (!res.ok) throw new Error('HTTP '+res.status);
                    const json = await res.json();
                    const active = !!json.active;
                    if (active){
                        banState.classList.remove('hidden');
                        banForm.classList.add('hidden');
                        banRevoke.classList.remove('hidden');
                        banState.innerHTML = `Email banni: <strong>${json?.ban?.email||''}</strong> — Raison: ${json?.ban?.reason||''}${json?.until?` — Jusqu’au ${new Date(json.until).toLocaleString()}`:''}`;
                    } else {
                        banState.classList.add('hidden');
                        banForm.classList.remove('hidden');
                        banRevoke.classList.add('hidden');
                    }
                } catch (e){
                    banState.classList.add('hidden');
                    banForm.classList.remove('hidden');
                    banRevoke.classList.add('hidden');
                }
            }

            const observer = new MutationObserver(()=>{
                if (!currentLI) return;
                const id = currentLI.dataset.id; loadBanState(id);
            });
            observer.observe(document.body, { attributes:true, subtree:false, attributeFilter:['style'] });

            banApply?.addEventListener('click', async ()=>{
                if (!currentLI) return; const id = currentLI.dataset.id;
                const btn = banApply; const s = btn.querySelector('.plinkk-spinner'); const l = btn.querySelector('span'); const prev = l?l.textContent:'';
                btn.disabled=true; s?.classList.remove('hidden'); if(l) l.textContent='Application...';
                try{
                    const payload = { reason: (banReason.value||'').trim(), time: Number(banMinutes.value||'-1'), deletePlinkk: !!banDelete.checked };
                    const res = await fetch('/api/users/' + encodeURIComponent(id) + '/ban-email', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                    if (!res.ok) {
                        let msg = 'Erreur: ban';
                        try {
                            const e = await res.json();
                            const code = e?.error || '';
                            const map = {
                              cannot_self_ban: "Vous ne pouvez pas vous bannir vous‑même.",
                              cannot_ban_admin: "Vous ne pouvez pas bannir un administrateur.",
                              forbidden_role: "Vous ne pouvez pas bannir un utilisateur d’un rôle égal ou supérieur au vôtre.",
                              already_banned: "Cet email est déjà banni.",
                              invalid_email: "Email invalide.",
                              unauthorized: "Non autorisé.",
                              forbidden: "Accès interdit."
                            };
                            msg = map[code] || msg;
                        } catch {}
                        showToast(msg);
                        return;
                    }
                    showToast('Ban appliqué');
                    await loadBanState(id);
                } catch(e){ console.error(e); showToast('Erreur: ban'); }
                finally{ btn.disabled=false; s?.classList.add('hidden'); if(l) l.textContent = prev || 'Bannir'; }
            });
            banRevoke?.addEventListener('click', async ()=>{
                if (!currentLI) return; const id = currentLI.dataset.id;
                if (!confirm('Révoquer le ban de cet email ?')) return;
                const btn = banRevoke; const s = btn.querySelector('.plinkk-spinner'); const l = btn.querySelector('span'); const prev = l?l.textContent:'';
                btn.disabled=true; s?.classList.remove('hidden'); if(l) l.textContent='Révocation...';
                try{
                    const res = await fetch('/api/users/' + encodeURIComponent(id) + '/ban-email', { method:'DELETE' });
                    if (!res.ok) {
                        let msg = 'Erreur: révocation';
                        try{ const e = await res.json(); const code = e?.error || ''; const map = { no_active_ban: 'Aucun ban actif pour cet email.' }; msg = map[code] || msg; }catch{}
                        showToast(msg);
                        return;
                    }
                    showToast('Ban révoqué');
                    await loadBanState(id);
                } catch(e){ console.error(e); showToast('Erreur: révocation'); }
                finally{ btn.disabled=false; s?.classList.add('hidden'); if(l) l.textContent = prev || 'Révoquer le ban'; }
            });
        })();
    })();
</script>

</html>
