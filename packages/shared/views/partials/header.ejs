<% 
  if (typeof dashboardUrl === 'undefined' || !dashboardUrl) { dashboardUrl = '/dashboard'; } 
  // Détecter si on est sur le dashboard (via path ou variable)
  const _isDash = (typeof isDashboard !== 'undefined' && isDashboard) || (typeof currentPath !== 'undefined' && currentPath.startsWith('/admin'));
  const _user = (typeof user !== 'undefined' && user) ? user : null;
  const _roleName = _user && _user.role ? (_user.role.id || _user.role.name) : null;
  const _isPremiumUser = !!(_user && (_user.isPremium || _user.isPartner || (_roleName && ['ADMIN','DEVELOPER','MODERATOR'].includes(_roleName))));
  const _showPremiumUi = !!(_user && _user.showPremiumUi !== false);
%>
<header class="sticky top-0 z-50 border-b border-white/5 bg-[#0B1020]/80 backdrop-blur-md transition-all duration-300" id="mainHeader">
  <style>
    #spaTopLoader { position: fixed; top: 0; left: 0; width: 100%; height: 2px; z-index: 10000; pointer-events: none; opacity: 0; transition: opacity .2s ease; }
    #spaTopLoader.active { opacity: 1; }
    #spaTopLoader .prog { width: 0%; height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); transition: width .2s ease; }
  </style>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 items-center justify-between gap-4">
      <div class="flex items-center gap-8">
        <a href="/" class="flex items-center gap-2.5 transition-opacity hover:opacity-80">
          <img src="https://s3.marvideo.fr/plinkk-image/logo.svg" alt="Plinkk" class="h-8 w-8" />
          <span class="text-lg font-bold tracking-tight text-white">Plinkk</span>
        </a>
        
        <nav class="hidden md:flex items-center gap-1">
          <% if (_isDash) { %>
            <a href="/" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Dashboard</a>
            <a href="/edit" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Éditeur</a>
            <a href="/stats" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Stats</a>
            <a href="/users" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Liste des Utilisateurs</a>
          <% } else { %>
            <a href="/about" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">À propos</a>
            <a href="/pricing" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Tarifs</a>
            <a href="/users" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Utilisateurs</a>
            <a href="<%= dashboardUrl %>" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Dashboard</a>
          <% } %>
        </nav>
      </div>

      <div class="flex items-center gap-3">
        <div class="hidden md:flex items-center gap-3">
          <% if (typeof user !== 'undefined' && user) { %>
            <% if ((typeof isAdmin !== 'undefined' && isAdmin) || (user.role && (user.role.id === 'ADMIN' || user.role.id === 'DEVELOPER' || user.role.id === 'MODERATOR'))) { %>
              <a href="<%= dashboardUrl %>/admin" class="inline-flex items-center justify-center rounded-full bg-rose-500/10 px-4 py-1.5 text-sm font-medium text-rose-400 ring-1 ring-inset ring-rose-500/20 transition-colors hover:bg-rose-500/20 hover:text-rose-300">Admin</a>
            <% } %>
            
            <div class="relative" id="accountMenuRoot">
              <button id="accountBtn" class="group flex items-center gap-2 rounded-full bg-white/5 pl-1.5 pr-3 py-1 ring-1 ring-white/10 transition-all hover:bg-white/10 hover:ring-white/20 focus:outline-none">
                 <div class="relative h-8 w-8 shrink-0">
                   <%- include('avatar.ejs', { user: user }) %>
                </div>
                <span class="max-w-[100px] truncate text-sm font-medium text-slate-200 group-hover:text-white"><%= user.userName || user.id %></span>
                <svg class="h-4 w-4 text-slate-500 transition-transform group-hover:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
              </button>

              <div id="accountPanel" class="absolute right-0 top-full mt-2 w-64 origin-top-right rounded-xl border border-white/10 bg-[#161b2e] p-1 shadow-2xl hidden">
                <div class="px-3 py-3">
                  <p class="truncate text-sm font-medium text-white"><%= user.userName || user.id %></p>
                  <% if (user.email) { %>
                    <p class="truncate text-xs text-slate-500"><%= user.email %></p>
                  <% } %>
                </div>
                <div class="h-px bg-white/5 my-1"></div>
                
                <a href="<%= dashboardUrl %>" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                  <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                  Dashboard
                </a>
                <a href="/<%= user.id %>" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                  <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                  Mon profil
                </a>
                <a href="<%= dashboardUrl %>/edit" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                    <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    Éditer ma page
                </a>
                <a href="<%= dashboardUrl %>/stats" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                    <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    Statistiques
                </a>
                <a href="<%= dashboardUrl %>/account" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                  <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                  Paramètres
                </a>
                <div class="h-px bg-white/5 my-1"></div>
                <a href="<%= dashboardUrl %>/logout" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-rose-400 transition-colors hover:bg-rose-500/10">
                  <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                  Se déconnecter
                </a>
              </div>
            </div>
          <% } else { %>
            <a href="<%= dashboardUrl %>/login" class="text-sm font-medium text-slate-300 transition-colors hover:text-white">Se connecter</a>
            <a href="<%= dashboardUrl %>/login#signup" class="rounded-full bg-white px-4 py-2 text-sm font-semibold text-black transition-transform hover:scale-105 hover:bg-slate-200">S'inscrire</a>
          <% } %>
        </div>

        <button id="menuBtn" class="md:hidden inline-flex items-center justify-center rounded-lg p-2 text-slate-400 hover:bg-white/5 hover:text-white focus:outline-none">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
      </div>
    </div>
  </div>

  <div id="mobileMenu" class="hidden border-t border-white/5 bg-[#0B1020]/95 backdrop-blur-xl md:hidden">
    <div class="space-y-1 px-4 py-4">
        <% if (_isDash) { %>
            <a href="/" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Dashboard</a>
            <a href="/edit" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Éditeur</a>
            <a href="/stats" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Stats</a>
            <a href="/cosmetics" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Cosmétiques</a>
        <% } else { %>
            <a href="/about" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">À propos</a>
            <a href="/pricing" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Tarifs</a>
            <a href="/users" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Utilisateurs</a>
            <a href="<%= dashboardUrl %>" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Dashboard</a>
        <% } %>
    </div>
    
    <div class="border-t border-white/5 px-4 py-4">
      <% if (typeof user !== 'undefined' && user) { %>
        <div class="flex items-center gap-3 mb-4">
          <div class="relative h-11 w-11 shrink-0">
            <%- include('avatar.ejs', { user: user }) %>
          </div>
          <div>
            <div class="text-base font-medium text-white"><%= user.userName || user.id %></div>
            <div class="text-sm text-slate-500"><%= user.email %></div>
          </div>
        </div>
        <div class="space-y-1">
          <a href="<%= dashboardUrl %>" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Mon Dashboard</a>
          <a href="/<%= user.id %>" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Mon Profil</a>
          <a href="<%= dashboardUrl %>/account" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Paramètres</a>
          <a href="<%= dashboardUrl %>/logout" class="block rounded-lg px-3 py-2 text-base font-medium text-rose-400 hover:bg-rose-500/10">Se déconnecter</a>
        </div>
      <% } else { %>
        <div class="grid grid-cols-2 gap-4">
          <a href="<%= dashboardUrl %>/login" class="flex items-center justify-center rounded-lg border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-medium text-white hover:bg-white/10">Connexion</a>
          <a href="<%= dashboardUrl %>/login#signup" class="flex items-center justify-center rounded-lg bg-white px-4 py-2.5 text-sm font-bold text-black hover:bg-slate-200">Inscription</a>
        </div>
      <% } %>
    </div>
  </div>

  <div id="spaTopLoader" aria-hidden="true"><div class="prog" id="spaTopLoaderProg"></div></div>
</header>

<style>
@keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
@keyframes popupIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.animate-slide-in-right { animation: slideInRight 0.35s ease-out both; }
.animate-popup-in { animation: popupIn 0.25s ease-out both; }
</style>

<% const __SMS__ = (typeof __SITE_MESSAGES__ !== 'undefined' && Array.isArray(__SITE_MESSAGES__)) ? __SITE_MESSAGES__ : ((typeof __SITE_MESSAGE__ !== 'undefined' && __SITE_MESSAGE__ && __SITE_MESSAGE__.message) ? [__SITE_MESSAGE__.message] : []); %>
<% const __BANNERS__ = __SMS__.filter(function(m){ return !m.displayType || m.displayType === 'banner'; }); %>
<% const __NOTIFS__  = __SMS__.filter(function(m){ return m.displayType === 'notification'; }); %>
<% const __POPUPS__  = __SMS__.filter(function(m){ return m.displayType === 'popup'; }); %>

<%/* ── BANNERS (sticky below header) ── */%>
<% if (__BANNERS__.length) { %>
  <div class="sticky top-16 z-40 border-b border-white/5 bg-[#0B1020]/90 backdrop-blur-md" id="siteBannersWrap">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-2 space-y-2">
      <% __BANNERS__.slice(0,3).forEach(function(__SM__, idx){ %>
        <% const lvl = (__SM__.level || 'info').toLowerCase();
           const maintenanceLevel = lvl === 'maintenance';
           let bg='bg-slate-700/20', br='border-slate-600/40', tx='text-slate-100', ic='text-slate-300';
           if (lvl==='info')          { bg='bg-sky-500/10';     br='border-sky-500/20';     tx='text-sky-200';     ic='text-sky-400'; }
           else if (lvl==='success')  { bg='bg-emerald-500/10'; br='border-emerald-500/20'; tx='text-emerald-200'; ic='text-emerald-400'; }
           else if (lvl==='warning')  { bg='bg-amber-500/10';   br='border-amber-500/20';   tx='text-amber-200';   ic='text-amber-400'; }
           else if (lvl==='error' || lvl==='critical') { bg='bg-rose-500/10'; br='border-rose-500/20'; tx='text-rose-200'; ic='text-rose-400'; }
           else if (maintenanceLevel) { bg='bg-violet-500/10';  br='border-violet-500/20';  tx='text-violet-200';  ic='text-violet-400'; }
        %>
        <div class="flex items-center gap-3 px-4 py-2.5 rounded-xl border <%= br %> <%= bg %> <%= tx %> text-sm site-msg-item" data-msg-id="<%- __SM__.id %>" data-msg='<%- JSON.stringify(__SM__ || null).replace(/'/g, "&#39;") %>'>
          <div class="<%= ic %> shrink-0">
            <% if (lvl === 'success') { %>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            <% } else if (lvl === 'warning') { %>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <% } else if (lvl === 'error' || lvl === 'critical') { %>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            <% } else if (maintenanceLevel) { %>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
            <% } else { %>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            <% } %>
          </div>
          <p class="flex-1 leading-relaxed font-medium"><%= __SM__.text %></p>
          <% if (__SM__.dismissible) { %>
            <button class="site-msg-dismiss ml-2 shrink-0 text-white/60 hover:text-white transition-colors" aria-label="Fermer">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"/></svg>
            </button>
          <% } %>
        </div>
      <% }) %>
    </div>
  </div>
<% } %>

<%/* ── NOTIFICATIONS (top-right toasts) ── */%>
<% if (__NOTIFS__.length) { %>
  <div class="fixed top-20 right-4 z-[60] flex flex-col gap-3 w-80 pointer-events-none" id="siteNotifsWrapPub">
    <% __NOTIFS__.slice(0,3).forEach(function(__SM__, idx){ %>
      <% const lvl = (__SM__.level || 'info').toLowerCase();
         const maintenanceLevel = lvl === 'maintenance';
         let bg='bg-slate-800', br='border-slate-700', tx='text-slate-100', ic='text-slate-300';
         if (lvl==='info')          { bg='bg-[#0f1a30]'; br='border-sky-500/30';     tx='text-sky-200';     ic='text-sky-400'; }
         else if (lvl==='success')  { bg='bg-[#0f1a30]'; br='border-emerald-500/30'; tx='text-emerald-200'; ic='text-emerald-400'; }
         else if (lvl==='warning')  { bg='bg-[#0f1a30]'; br='border-amber-500/30';   tx='text-amber-200';   ic='text-amber-400'; }
         else if (lvl==='error' || lvl==='critical') { bg='bg-[#0f1a30]'; br='border-rose-500/30'; tx='text-rose-200'; ic='text-rose-400'; }
         else if (maintenanceLevel) { bg='bg-[#0f1a30]'; br='border-violet-500/30';  tx='text-violet-200';  ic='text-violet-400'; }
      %>
      <div class="pointer-events-auto rounded-xl border <%= br %> <%= bg %> shadow-2xl backdrop-blur-xl overflow-hidden site-msg-item animate-slide-in-right" data-msg-id="<%- __SM__.id %>" data-msg='<%- JSON.stringify(__SM__ || null).replace(/'/g, "&#39;") %>'>
        <div class="flex items-start gap-3 p-4 <%= tx %>">
          <div class="<%= ic %> shrink-0 mt-0.5">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold mb-1 capitalize"><%= (__SM__.level || 'info') %></p>
            <p class="text-sm leading-relaxed text-slate-300"><%= __SM__.text %></p>
          </div>
          <% if (__SM__.dismissible) { %>
            <button class="site-msg-dismiss shrink-0 text-white/60 hover:text-white transition-colors" aria-label="Fermer">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"/></svg>
            </button>
          <% } %>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>

<%/* ── POPUPS (center modal) ── */%>
<% if (__POPUPS__.length) { %>
  <% const __POP__ = __POPUPS__[0]; %>
  <% const pLvl = (__POP__.level || 'info').toLowerCase();
     let pBg='bg-sky-500/10', pBr='border-sky-500/20', pTx='text-sky-200', pIc='text-sky-400';
     if (pLvl==='success')       { pBg='bg-emerald-500/10'; pBr='border-emerald-500/20'; pTx='text-emerald-200'; pIc='text-emerald-400'; }
     else if (pLvl==='warning')  { pBg='bg-amber-500/10';   pBr='border-amber-500/20';   pTx='text-amber-200';   pIc='text-amber-400'; }
     else if (pLvl==='error' || pLvl==='critical') { pBg='bg-rose-500/10'; pBr='border-rose-500/20'; pTx='text-rose-200'; pIc='text-rose-400'; }
     else if (pLvl==='maintenance') { pBg='bg-violet-500/10'; pBr='border-violet-500/20'; pTx='text-violet-200'; pIc='text-violet-400'; }
  %>
  <div class="fixed inset-0 z-[70] flex items-center justify-center p-4 site-msg-item" id="sitePopupWrapPub" data-msg-id="<%- __POP__.id %>" data-msg='<%- JSON.stringify(__POP__ || null).replace(/'/g, "&#39;") %>'>
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="sitePopupBackdropPub"></div>
    <div class="relative w-full max-w-md rounded-2xl border <%= pBr %> bg-[#161b2e] shadow-2xl overflow-hidden animate-popup-in">
      <div class="px-6 py-5 <%= pBg %> border-b <%= pBr %>">
        <div class="flex items-center gap-3 <%= pTx %>">
          <div class="<%= pIc %>">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          </div>
          <span class="text-lg font-bold">Annonce</span>
          <button class="site-msg-dismiss ml-auto -mr-1 rounded-md p-1 text-white/70 hover:text-white hover:bg-white/10 transition-colors" aria-label="Fermer">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"/></svg>
          </button>
        </div>
      </div>
      <div class="px-6 py-5">
        <p class="text-sm text-slate-200 leading-relaxed"><%= __POP__.text %></p>
      </div>
      <div class="px-6 pb-5 flex flex-col gap-2">
        <button class="site-msg-snooze w-full py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-sm font-medium text-slate-300 transition-colors border border-white/10" data-snooze-days="1" id="sitePopupSnoozePub">Me le rappeler dans 1j</button>
        <% if (__POP__.dismissible) { %>
          <button class="site-msg-dismiss w-full py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-sm font-medium text-slate-300 transition-colors border border-white/10" id="sitePopupDismissPub">Compris</button>
        <% } %>
      </div>
    </div>
  </div>
<% } %>

<script>
  (function(){
    const el = document.getElementById('spaTopLoader');
    const bar = document.getElementById('spaTopLoaderProg');
    let _active = false, _timer = null, _val = 0, _t0 = 0;
    const MIN_VISIBLE = 300;
    function setProgress(p){ if (!bar) return; _val = Math.max(0, Math.min(100, p)); bar.style.width = _val + '%'; }
    function tick(){ if (!_active) return; const target = 80; const delta = Math.max(0.5, (target - _val) * 0.1); setProgress(_val + delta); _timer = setTimeout(tick, 200); }
    function start(){ if (!el || !bar) return; if (_active) return; _active = true; _t0 = Date.now(); el.classList.add('active'); setProgress(5); clearTimeout(_timer); _timer = setTimeout(tick, 160); }
    function end(){ if (!el || !bar) return; clearTimeout(_timer); setProgress(100); const elapsed = Date.now() - _t0; const extra = Math.max(0, MIN_VISIBLE - elapsed); setTimeout(()=>{ el.classList.remove('active'); setProgress(0); _active = false; }, 250 + extra); }
    if (!window.__spaLoadingStart) window.__spaLoadingStart = start;
    if (!window.__spaLoadingEnd) window.__spaLoadingEnd = end;
    window.addEventListener('spa:loading-start', start);
    window.addEventListener('spa:loading-end', end);
    window.addEventListener('beforeunload', ()=>{ try { sessionStorage.setItem('spa_nav','1'); start(); } catch{} });
    try { if (sessionStorage.getItem('spa_nav') === '1') { sessionStorage.removeItem('spa_nav'); start(); const fin = ()=> setTimeout(end, 120); if (document.readyState === 'complete') fin(); else window.addEventListener('load', fin, { once: true }); } } catch {}
    function isModifiedClick(e){ return e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0; }
    function isSameOrigin(url){ try { const u=new URL(url, location.href); return u.origin===location.origin; } catch { return false; } }
    function looksLikeHtmlRequest(url){ return isSameOrigin(url) && !/\.(?:png|jpe?g|webp|gif|svg|ico|css|js|map|json|txt|woff2?|ttf|otf)(?:[?#].*)?$/i.test(url); }
    document.addEventListener('click', (e)=>{ const a = e.target && (e.target.closest ? e.target.closest('a') : null); if (!a) return; const href = a.getAttribute('href') || ''; if (!href || href.startsWith('#')) return; if (a.target === '_blank' || a.download != null) return; if (isModifiedClick(e)) return; if (!looksLikeHtmlRequest(href)) return; try { window.dispatchEvent(new Event('spa:loading-start')); } catch {} setTimeout(()=>{ try { window.dispatchEvent(new Event('spa:loading-end')); } catch {} }, 8000); }, true);
  })();
</script>
<script>
  (function(){
    const accountBtn = document.getElementById('accountBtn');
    const accountPanel = document.getElementById('accountPanel');
    const root = document.getElementById('accountMenuRoot');
    const closeMenu = () => { accountPanel?.classList.add('hidden'); accountBtn?.setAttribute('aria-expanded','false'); };
    const openMenu = () => { accountPanel?.classList.remove('hidden'); accountBtn?.setAttribute('aria-expanded','true'); };
    if (accountBtn && accountPanel && root) {
      accountBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const isOpen = !accountPanel.classList.contains('hidden'); if (isOpen) closeMenu(); else openMenu(); });
      document.addEventListener('click', (e)=>{ if (!root.contains(e.target)) closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMenu(); });
    }
    const mBtn = document.getElementById('menuBtn');
    const mMenu = document.getElementById('mobileMenu');
    if (mBtn && mMenu && mBtn.dataset.bound !== '1') {
      mBtn.dataset.bound = '1';
      const open = () => { mMenu.classList.remove('hidden'); mBtn.setAttribute('aria-expanded','true'); };
      const close = () => { mMenu.classList.add('hidden'); mBtn.setAttribute('aria-expanded','false'); };
      mBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if (mMenu.classList.contains('hidden')) open(); else close(); });
      document.addEventListener('click', (e)=>{ if (!mMenu.contains(e.target) && e.target !== mBtn) close(); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); });
    }
    try {
      /* ── Dismiss logic for all message types (banner, notification, popup) ── */
      document.querySelectorAll('.site-msg-item').forEach(function(wrap) {
        var raw = wrap.getAttribute('data-msg');
        if (!raw) return;
        var safe = raw.replace(/&#39;/g, "'");
        var msg = null; try { msg = JSON.parse(safe); } catch(e) {}
        if (!msg || !msg.id) return;
        var key = 'dismissed_site_message_' + msg.id;
        var snoozeKey = 'snooze_site_message_' + msg.id;
        var snoozeUntil = Number(localStorage.getItem(snoozeKey) || 0);
        if (snoozeUntil && Date.now() < snoozeUntil) { wrap.style.display = 'none'; return; }
        if (snoozeUntil && Date.now() >= snoozeUntil) { localStorage.removeItem(snoozeKey); }
        if (localStorage.getItem(key)) { wrap.style.display = 'none'; return; }
        wrap.querySelectorAll('.site-msg-dismiss').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (msg.dismissible) localStorage.setItem(key, '1');
            wrap.style.display = 'none';
          });
        });
        wrap.querySelectorAll('.site-msg-snooze').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var days = Number(btn.getAttribute('data-snooze-days') || '1');
            var until = Date.now() + days * 24 * 60 * 60 * 1000;
            localStorage.setItem(snoozeKey, String(until));
            wrap.style.display = 'none';
          });
        });
      });
      /* Popup backdrop dismiss */
      var popupBg = document.getElementById('sitePopupBackdropPub');
      var popupWrap = document.getElementById('sitePopupWrapPub');
      if (popupBg && popupWrap) {
        var popData = popupWrap.getAttribute('data-msg');
        if (popData) {
          var popSafe = popData.replace(/&#39;/g, "'");
          var popMsg = null; try { popMsg = JSON.parse(popSafe); } catch(e) {}
          popupBg.addEventListener('click', function() {
            if (popMsg && popMsg.dismissible && popMsg.id) {
              localStorage.setItem('dismissed_site_message_' + popMsg.id, '1');
            }
            popupWrap.style.display = 'none';
          });
        }
      }
      /* Auto-dismiss notifications after 8s */
      var notifWrap = document.getElementById('siteNotifsWrapPub');
      if (notifWrap) {
        notifWrap.querySelectorAll('.site-msg-item').forEach(function(item, i) {
          setTimeout(function() {
            item.style.transition = 'opacity 0.4s, transform 0.4s';
            item.style.opacity = '0';
            item.style.transform = 'translateX(100%)';
            setTimeout(function() { item.style.display = 'none'; }, 500);
          }, 6000 + i * 2000);
        });
      }
    } catch(e){}
  })();
</script>
