<%- include('partials/head', { title: 'Utilisateurs', description: 'Tous les profils hÃ©bergÃ©s sur Plinkk.' }) %>
<%- include('partials/header', { user: (typeof user !== 'undefined' ? user : null) }) %>

  <main class="max-w-[1600px] mx-auto p-6 space-y-8">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 animate-slide-up">
      <div class="space-y-1">
        <h1 class="text-2xl font-bold tracking-tight text-white">Tous les profils hÃ©bergÃ©s</h1>
        <p class="text-sm text-slate-400">DÃ©couvrez les comptes publics Plinkk.</p>
      </div>

      <% if (plinkks.length > 0) { %>
      <div class="w-full md:w-auto flex flex-col sm:flex-row gap-3">
        <div class="relative flex-1 min-w-[300px]">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input id="searchInput" type="text" placeholder="Rechercher (nom, @id, email)" 
            class="block w-full pl-10 pr-12 py-2.5 bg-slate-900 border border-slate-800 rounded-xl text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all sm:text-sm" />
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
            <span class="text-slate-600 text-xs font-medium border border-slate-700 rounded px-1.5 py-0.5">âŒ˜K</span>
          </div>
        </div>
        <div class="flex gap-3">
          <select id="sortSelect" class="bg-slate-900 border border-slate-800 text-slate-200 text-sm rounded-xl focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5">
            <option value="name-asc">Nom (Aâ†’Z)</option>
            <option value="name-desc">Nom (Zâ†’A)</option>
            <option value="id-asc">@Id (Aâ†’Z)</option>
            <option value="id-desc">@Id (Zâ†’A)</option>
          </select>
          <button id="resetBtn" class="px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium rounded-xl transition-colors border border-slate-700">
            RÃ©initialiser
          </button>
        </div>
      </div>
      <% } %>
    </div>

    <div class="flex items-center justify-between animate-slide-up px-1">
      <p class="text-xs font-medium text-slate-500">Total: <span id="totalCount" class="text-slate-300"><%= plinkks.length %></span></p>
      <p class="text-xs font-medium text-slate-500 hidden sm:block"><span id="visibleCount" class="text-slate-300"><%= plinkks.length %></span> affichÃ©(s)</p>
    </div>

    <% if (plinkks.length === 0) { %>
      <div class="rounded-3xl border border-dashed border-slate-800 bg-slate-900/50 p-12 text-center space-y-3 animate-slide-up">
        <div class="text-4xl mb-2">ðŸ«¥</div>
        <h3 class="text-lg font-medium text-slate-200">Aucun Plinkks pour le moment</h3>
        <p class="text-sm text-slate-500">Les Plinkks publics sâ€™afficheront ici.</p>
      </div>
    <% } else { %>
      <ul id="usersGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
     <% plinkks.forEach(u => { 
       if (!u) return;
       const initials = (u.name || u.id || '?').trim().charAt(0).toUpperCase(); 
       const user = u.user || {};
       const roleObj = user.role;
       const role = roleObj ? roleObj.name : 'USER';
       const cosmetics = (user.cosmetics || {});
       const data = cosmetics.data || {}; 
       
       const flair = cosmetics.flair ? String(cosmetics.flair) : null;
       const frame = cosmetics.frame ? String(cosmetics.frame) : 'none';
       const bannerUrl = cosmetics.bannerUrl ? String(cosmetics.bannerUrl) : '';
       const banner = cosmetics.banner ? String(cosmetics.banner) : 'none';
       
       const primaryColor = data.primaryColor || '#1e293b';
       const accentColor = data.accentColor || '#0f172a';
       const gradientType = data.gradientType || 'linear';
       const effect = data.effect || 'none';

       const avatarUrl = (u.settings && u.settings.profileImage) ? String(u.settings.profileImage) : null;
       const avatarUser = {
         image: avatarUrl,
         profileImage: avatarUrl,
         userName: u.name,
         id: u.slug,
       };

       let bannerStyle = '';
       if (bannerUrl) {
         bannerStyle = `background-image: url('${bannerUrl}')`;
       } else if (banner && banner !== 'none') {
         if (banner === 'gradient-emerald') bannerStyle = 'background: linear-gradient(135deg, #064e3b, #10b981)';
         else if (banner === 'gradient-fuchsia') bannerStyle = 'background: linear-gradient(135deg, #701a75, #d946ef)';
         else if (banner === 'cosmos') bannerStyle = 'background: linear-gradient(to right, #0f172a, #312e81)';
         else bannerStyle = 'background: #1e293b';
       } else {
         bannerStyle = `background: linear-gradient(to right, ${primaryColor}, ${accentColor})`;
       }

       let frameStyle = '';
       if (frame === 'neon') frameStyle = 'box-shadow: 0 0 0 2px rgba(139,92,246,0.8), 0 0 15px rgba(139,92,246,0.6), inset 0 0 10px rgba(139,92,246,0.4); border-radius: 12px;';
       else if (frame === 'glow') frameStyle = 'box-shadow: 0 0 0 2px rgba(16,185,129,0.8), 0 0 15px rgba(16,185,129,0.6); border-radius: 12px;';
       else if (frame === 'gold') frameStyle = 'box-shadow: 0 0 0 2px rgba(234,179,8,0.8), 0 0 15px rgba(234,179,8,0.4); border-radius: 12px;';

       let cardBgStyle = '';
       if (gradientType === 'linear') {
         cardBgStyle = `background: linear-gradient(135deg, ${primaryColor}, ${accentColor})`;
       } else if (gradientType === 'radial') {
         cardBgStyle = `background: radial-gradient(circle at center, ${primaryColor}, ${accentColor})`;
       } else if (gradientType === 'animated') {
         cardBgStyle = `background: linear-gradient(270deg, ${primaryColor}, ${accentColor}, ${primaryColor}); background-size: 200% 200%; animation: gradient-x 3s ease infinite;`;
       }

       let effectClass = '';
       if (effect === 'sparkles') effectClass = 'effect-sparkles';
       if (effect === 'noise') effectClass = 'effect-noise';
       
       const safeCardBg = cardBgStyle ? `style="${cardBgStyle.replace(/"/g, '&quot;')}"` : '';
       let safeBanner = '';
       if (bannerStyle) {
         safeBanner = 'style="' + bannerStyle.replace(/"/g, '&quot;') + '; mask-image: linear-gradient(to bottom, black, transparent); -webkit-mask-image: linear-gradient(to bottom, black, transparent);"';
       }
       
       const safeFrameStyle = frameStyle ? 'style="' + frameStyle.replace(/"/g, '&quot;') + '"' : '';
     %>
  <% const isEmailPublic = Boolean(u.settings && (u.settings.affichageEmail !== null && u.settings.affichageEmail !== undefined)); %>
  <% const publicEmail = (u.settings && (u.settings.affichageEmail !== null && u.settings.affichageEmail !== undefined)) ? String(u.settings.affichageEmail) : ''; %>
      
      <li class="group relative flex flex-col h-full rounded-3xl overflow-hidden transition-all duration-300 ease-out hover:-translate-y-1 hover:scale-[1.02] hover:shadow-2xl hover:shadow-violet-500/20 bg-slate-950 border border-slate-800/50 hover:border-violet-500/50"
          data-name="<%- (u.name||'').toLowerCase() %>"
          data-id="<%- (u.id||'').toLowerCase() %>"
          data-search="<%- (u.name+' '+u.id + (isEmailPublic && publicEmail ? (' '+publicEmail) : '')).toLowerCase() %>">
        
        <!-- Dynamic Background Tint (User's Gradient) -->
        <div class="absolute inset-0 opacity-20 transition-opacity duration-300 group-hover:opacity-40" <%- safeCardBg %>></div>
        
        <!-- Effect Overlay -->
        <% if (effect !== 'none') { %>
          <div class="absolute inset-0 pointer-events-none z-0 opacity-50 <%= effectClass %>"></div>
        <% } %>

        <!-- Dark Glass Overlay -->
        <div class="absolute inset-0 bg-slate-950/40 backdrop-blur-sm"></div>

        <!-- Banner (Faded Top) -->
        <div class="absolute inset-x-0 top-0 h-32 bg-cover bg-center opacity-50 transition-transform duration-500 ease-out group-hover:scale-110" <%- safeBanner %>></div>

        <!-- Content -->
        <div class="relative z-10 p-5 flex flex-col h-full">
            <!-- Header: Avatar + Role -->
            <div class="flex justify-between items-start mb-2">
                <!-- Avatar Container with Centering Fix -->
                <div class="relative h-14 w-14 rounded-2xl shadow-lg group-hover:scale-105 transition-transform duration-300">
                     <!-- Centering Wrapper for Text Fallback -->
                     <div class="absolute inset-0 bg-slate-900 rounded-2xl flex items-center justify-center text-lg font-bold text-slate-400 overflow-hidden ring-2 ring-white/10">
                        <%- include('partials/avatar.ejs', { user: avatarUser, className: "w-full h-full object-cover" }) %>
                     </div>
                     <!-- Frame Overlay -->
                     <div class="absolute inset-0 pointer-events-none z-20 rounded-2xl" <%- safeFrameStyle %>></div>
                </div>
                
                <!-- Role Badge -->
                <% if (role && role !== 'USER') { %>
                    <span class="px-2 py-0.5 rounded-full text-[10px] font-bold tracking-wider uppercase border bg-white/5 border-white/10 text-slate-300 backdrop-blur-md shadow-sm">
                        <%= role %>
                    </span>
                <% } %>
            </div>

            <!-- User Info -->
            <div class="mt-auto pt-2">
                <div class="flex items-center justify-between gap-2">
                    <h3 class="text-lg font-bold text-white tracking-tight group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-white group-hover:to-slate-400 transition-all truncate flex items-center gap-1">
                        <%= u.name %>
                        <% if (user.isVerified) { %>
                            <svg class="w-3.5 h-3.5 text-blue-400 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor" title="VÃ©rifiÃ©"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                        <% } %>
                        <% if (user.isPartner) { %>
                            <svg class="w-3.5 h-3.5 text-violet-400 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor" title="Partenaire"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        <% } %>
                        <% if (flair) { %>
                            <span class="ml-1 inline-flex items-center justify-center px-1.5 py-0.5 rounded text-[10px] bg-white/10 text-white/80 align-middle transform -translate-y-0.5 border border-white/10"><%= flair %></span>
                        <% } %>
                    </h3>
                    
                    <% if (isEmailPublic) { %>
                        <div class="flex-shrink-0 flex items-center gap-1.5 text-[10px] text-slate-400 bg-white/5 rounded-lg px-2 py-1 border border-white/5 max-w-[110px]" title="<%= publicEmail %>">
                            <svg class="w-3 h-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span class="truncate"><%= publicEmail %></span>
                        </div>
                    <% } %>
                </div>
                <div class="flex items-center justify-between text-xs text-slate-500 font-medium mt-1">
                  <span>@<%= user.userName || u.slug %></span>
                  <span>/<%= u.slug %></span>
                </div>
            </div>

            <!-- Actions (Always visible) -->
            <div class="mt-4 flex items-center gap-2">
                <a href="/<%= u.slug %>" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-white text-slate-950 text-xs font-bold hover:bg-slate-200 transition-colors shadow-lg shadow-white/5">
                    <span>Voir</span>
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                </a>
                <button class="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white border border-white/10 transition-colors copyBtn backdrop-blur-md" data-id="<%= u.slug %>">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                </button>
            </div>
        </div>
      </li>
        <% }) %>
      </ul>
      <style>
        @keyframes gradient-x { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .effect-sparkles { background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0L12 8L20 10L12 12L10 20L8 12L0 10L8 8L10 0Z' fill='rgba(255,255,255,0.1)'/%3E%3C/svg%3E"); }
        .effect-noise { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E"); }
      </style>
    <% } %>
  </main>

  <script src="/public/js/pagination.js"></script>
  <script>
    (function(){
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const search = $('#searchInput');
      const sort = $('#sortSelect');
      const grid = $('#usersGrid');
      const totalCount = $('#totalCount');
      const visibleCount = $('#visibleCount');
      const resetBtn = $('#resetBtn');

      if (!grid || !window.__PlinkkPaginator) return;

      const paginator = window.__PlinkkPaginator.createPaginator(grid, { pageSize: 21, selectors: { items: 'li' }, onRender: (pageItems, meta) => {
        if (visibleCount) visibleCount.textContent = String(meta.totalItems);
      }});

      if (totalCount) totalCount.textContent = String(paginator.getAll().length);

      function applyFilter(){
        const q = (search?.value || '').trim().toLowerCase();
        const all = paginator.getAll();
        const filtered = all.filter(li => {
          const hay = li.dataset.search || '';
          return !q || hay.includes(q);
        });
        paginator.setFiltered(filtered);
      }

      function applySort(){
        const val = sort?.value;
        const collator = new Intl.Collator('fr', { sensitivity: 'base' });
        const getKey = (li, key) => (li.dataset[key] || '').toString();
        paginator.sort((a,b) => {
          switch(val){
            case 'name-asc': return collator.compare(getKey(a,'name'), getKey(b,'name'));
            case 'name-desc': return collator.compare(getKey(b,'name'), getKey(a,'name'));
            case 'id-asc': return collator.compare(getKey(a,'id'), getKey(b,'id'));
            case 'id-desc': return collator.compare(getKey(b,'id'), getKey(a,'id'));
            default: return 0;
          }
        });
      }

      search?.addEventListener('input', () => applyFilter());
      sort?.addEventListener('change', () => applySort());
      resetBtn?.addEventListener('click', () => {
        if (search) search.value = '';
        if (sort) sort.value = 'name-asc';
        applySort();
        applyFilter();
      });

      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.copyBtn');
        if (btn) {
          const url = (window.location && window.location.origin ? window.location.origin : '') + '/' + btn.dataset.id;
          navigator.clipboard?.writeText(url).catch(()=>{});
        }
      });

      const style = document.createElement('style');
      style.textContent = `
        .copy-anim { position: relative; }
        .copy-anim::after {
          content: 'CopiÃ© !';
          position: absolute; left: 50%; top: -10px; transform: translate(-50%, -100%);
          background: rgba(124, 58, 237, 0.95); color: #fff; font-size: 10px; border-radius: 6px; padding: 4px 6px;
          opacity: 0; pointer-events: none; transition: opacity .25s ease, transform .25s ease;
          box-shadow: 0 8px 24px rgba(124, 58, 237, 0.35);
        }
        .copy-anim.copied::after { opacity: 1; transform: translate(-50%, -120%); }
        .copy-anim.copied { box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.35) inset; }
      `;
      document.head.appendChild(style);

      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.copyBtn');
        if (btn) {
          btn.classList.add('copy-anim');
          setTimeout(()=>btn.classList.add('copied'), 10);
          setTimeout(()=>btn.classList.remove('copied'), 1000);
        }
      });

      applySort();
      applyFilter();

      document.addEventListener('keydown', (ev) => {
        const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
        const meta = isMac ? ev.metaKey : ev.ctrlKey;
        if (meta && ev.key.toLowerCase() === 'k') { ev.preventDefault(); search?.focus(); }
      });
    })();
  </script>
  </body>
  </html>