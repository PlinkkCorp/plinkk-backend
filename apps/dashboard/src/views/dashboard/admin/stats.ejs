<%- include('partials/head.ejs', { title: 'Admin - Statistiques', description: 'Statistiques globales de la plateforme.', robots: 'noindex,nofollow' }) %>
<%- include('partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
    <%- include('partials/admin-nav.ejs', { user: user, active: '/admin/stats' }) %>

    <main class="col-span-12 lg:col-span-10 space-y-8">

        <!--  HEADER GRADIENT  -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-gradient-to-r from-slate-900 to-slate-800 p-8 rounded-3xl border border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-violet-600/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Statistiques Globales</h1>
                    <span class="px-2.5 py-1 bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white text-[10px] font-bold rounded-lg uppercase tracking-wider">Admin</span>
                </div>
                <p class="text-slate-400 text-lg">Suivi de la croissance, de l'engagement et de la santé du réseau Plinkk.</p>
            </div>
        </div>

        <!--  TAB BAR  -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-2">
            <nav class="flex gap-1 flex-wrap lg:flex-nowrap" role="tablist" aria-label="Sections Admin Stats">
                <button class="tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="signups" aria-selected="true">Inscriptions</button>
                <button class="tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="logins" aria-selected="false">Connexions</button>
                <button class="tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="plinkks" aria-selected="false">Plinkks</button>
                <button class="tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="redirections" aria-selected="false">Redirections</button>
                <button class="tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="premium" aria-selected="false">Premium</button>
                <button class="tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="bans" aria-selected="false">Modération</button>
                <button class="tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="accounts" aria-selected="false">Comptes</button>
            </nav>
        </div>

        <!--  CONTROL BAR  -->
        <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-6">
            <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-6">
                <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-xl">
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest px-1">Date Début</label>
                        <input type="date" id="fFrom" class="w-full px-4 py-2.5 bg-slate-900 border border-slate-800 rounded-xl text-slate-200 focus:border-violet-500 transition-all outline-none" />
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest px-1">Date Fin</label>
                        <input type="date" id="fTo" class="w-full px-4 py-2.5 bg-slate-900 border border-slate-800 rounded-xl text-slate-200 focus:border-violet-500 transition-all outline-none" />
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <button class="range-btn px-4 py-2.5 rounded-xl text-sm font-medium bg-slate-900 border border-slate-800 text-slate-400 hover:text-white hover:border-slate-600 transition-all" data-days="1">24h</button>
                    <button class="range-btn px-4 py-2.5 rounded-xl text-sm font-medium bg-slate-900 border border-slate-800 text-slate-400 hover:text-white hover:border-slate-600 transition-all" data-days="7">7j</button>
                    <button class="range-btn px-4 py-2.5 rounded-xl text-sm font-medium bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white shadow-lg shadow-violet-500/20" data-days="30">30j</button>
                    <button class="range-btn px-4 py-2.5 rounded-xl text-sm font-medium bg-slate-900 border border-slate-800 text-slate-400 hover:text-white hover:border-slate-600 transition-all" data-days="90">90j</button>
                </div>
                
                <!-- EXPORT ACTIONS -->
                <div class="flex items-center gap-2 border-t lg:border-t-0 lg:border-l border-slate-800 pt-4 lg:pt-0 lg:pl-6">
                    <button id="btnExportGraph" class="px-4 py-2.5 rounded-xl text-sm font-medium bg-slate-900 border border-slate-800 text-slate-400 hover:text-white hover:border-violet-500 hover:bg-violet-500/10 transition-all flex items-center gap-2" title="Exporter le graphique">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        <span class="hidden sm:inline">Graph</span>
                    </button>
                    <button id="btnExportCSV" class="px-4 py-2.5 rounded-xl text-sm font-medium bg-slate-900 border border-slate-800 text-slate-400 hover:text-white hover:border-emerald-500 hover:bg-emerald-500/10 transition-all flex items-center gap-2" title="Exporter les données (CSV)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>
                        <span class="hidden sm:inline">CSV</span>
                    </button>
                </div>
            </div>
        </div>

        <!--  PANEL: SIGNUPS  -->
        <section id="panel-signups" class="tab-panel space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Total Inscrits</p>
                    <p id="statTotal" class="text-3xl font-bold text-white tracking-tight">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Publics</p>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                        <p id="statPub" class="text-3xl font-bold text-white tracking-tight">-</p>
                    </div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Privés</p>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-rose-500"></div>
                        <p id="statPriv" class="text-3xl font-bold text-white tracking-tight">-</p>
                    </div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Staff</p>
                    <p id="statStaff" class="text-3xl font-bold text-white tracking-tight">-</p>
                </div>
            </div>

            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-6 md:p-8">
                <div class="flex items-center gap-2 mb-8 bg-slate-900/50 p-1 rounded-xl w-fit">
                    <button class="sub-tab-btn px-4 py-2 rounded-lg text-sm font-bold bg-violet-600 text-white" data-sub="su1">Par jour</button>
                    <button class="sub-tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-slate-200" data-sub="su2">Visibilité</button>
                    <button class="sub-tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-slate-200" data-sub="su3">Rôles</button>
                    <button class="sub-tab-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-slate-200" data-sub="su4">Cumul</button>
                </div>
                <div class="h-[400px] relative">
                    <div class="chart-loader hidden absolute inset-0 z-10 flex items-center justify-center bg-slate-950/40 backdrop-blur-sm rounded-xl">
                        <div class="w-8 h-8 border-4 border-slate-800 border-t-violet-600 rounded-full animate-spin"></div>
                    </div>
                    <canvas id="chartSignups"></canvas>
                </div>
            </div>
        </section>

        <!--  PANEL: LOGINS  -->
        <section id="panel-logins" class="tab-panel hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-8 flex flex-col items-center">
                    <p class="text-sm text-slate-400 mb-1 font-medium">Connexions (période)</p>
                    <p id="statLoginTotal" class="text-5xl font-bold text-white tracking-tighter">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-8 flex flex-col items-center">
                    <p class="text-sm text-slate-400 mb-1 font-medium">Moyenne journalière</p>
                    <p id="statLoginAvg" class="text-5xl font-bold text-cyan-400 tracking-tighter">-</p>
                </div>
            </div>
            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-6 md:p-8">
                <h3 class="text-lg font-bold text-white mb-6">Activité des sessions</h3>
                <div class="h-[400px] relative">
                    <div class="chart-loader hidden absolute inset-0 z-10 flex items-center justify-center bg-slate-950/40 backdrop-blur-sm rounded-xl">
                        <div class="w-8 h-8 border-4 border-slate-800 border-t-violet-600 rounded-full animate-spin"></div>
                    </div>
                    <canvas id="chartLogins"></canvas>
                </div>
            </div>
        </section>

        <!--  PANEL: PLINKKS  -->
        <section id="panel-plinkks" class="tab-panel hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Vues Totales</p>
                    <p id="plinkkTotalViews" class="text-3xl font-bold text-white">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Total Plinkks</p>
                    <p id="plinkkTotalCount" class="text-3xl font-bold text-white">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Top Vues (Jour)</p>
                    <p id="plinkkTopDay" class="text-3xl font-bold text-violet-400">-</p>
                </div>
            </div>
            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-6 md:p-8">
                <h3 class="text-lg font-bold text-white mb-6">Vues journalières (Plinkks)</h3>
                <div class="h-[400px] relative">
                    <div class="chart-loader hidden absolute inset-0 z-10 flex items-center justify-center bg-slate-950/40 backdrop-blur-sm rounded-xl">
                        <div class="w-8 h-8 border-4 border-slate-800 border-t-violet-600 rounded-full animate-spin"></div>
                    </div>
                    <canvas id="chartPlinkks"></canvas>
                </div>
            </div>

            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-slate-800 bg-slate-900/50 flex items-center justify-between">
                    <h3 class="font-bold text-white text-xl">Top Plinkks (vues)</h3>
                    <div class="flex items-center gap-2">
                         <span class="text-xs text-slate-500 uppercase font-bold tracking-widest text-[10px]">Période :</span>
                         <span class="text-[10px] text-violet-400 font-bold uppercase tracking-widest px-2 py-1 bg-violet-400/10 rounded-lg border border-violet-500/20">Global</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-800 text-[10px] uppercase tracking-wider text-slate-500 bg-slate-950/50">
                                <th class="p-4 font-bold">Plinkk</th>
                                <th class="p-4 font-bold">Slug</th>
                                <th class="p-4 font-bold">Auteur</th>
                                <th class="p-4 font-bold text-center">Date</th>
                                <th class="p-4 font-bold text-right">Vues</th>
                            </tr>
                        </thead>
                        <tbody id="plinkksTopBody" class="divide-y divide-slate-800/50">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!--  PANEL: REDIRECTIONS  -->
        <section id="panel-redirections" class="tab-panel hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-3 mb-2 text-slate-400">
                        <i class="ph-duotone ph-mouse-left text-xl"></i>
                        <span class="text-sm font-medium">Total Clics</span>
                    </div>
                    <div class="text-3xl font-bold text-white" id="redirectTotalClicks">--</div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-3 mb-2 text-slate-400">
                        <i class="ph-duotone ph-arrows-merge text-xl"></i>
                        <span class="text-sm font-medium">Total Redirections</span>
                    </div>
                    <div class="text-3xl font-bold text-white" id="redirectTotalCount">--</div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-3 mb-2 text-slate-400">
                        <i class="ph-duotone ph-trend-up text-xl"></i>
                        <span class="text-sm font-medium">Record Journée</span>
                    </div>
                    <div class="text-3xl font-bold text-white" id="redirectTopDay">--</div>
                </div>
            </div>
            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-6 md:p-8">
                <h3 class="text-lg font-bold text-white mb-6">Clics journaliers (Redirections)</h3>
                <div class="h-[400px] relative">
                    <div class="chart-loader absolute inset-0 flex items-center justify-center bg-slate-950/50 backdrop-blur-sm z-10 transition-opacity duration-300">
                        <div class="w-8 h-8 border-2 border-violet-500 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <canvas id="chartRedirections"></canvas>
                </div>
            </div>

            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-slate-800 bg-slate-900/50 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white">Top Redirections</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-xs text-slate-400 uppercase border-b border-slate-800">
                                <th class="px-6 py-4 font-medium">Slug</th>
                                <th class="px-6 py-4 font-medium">Cible</th>
                                <th class="px-6 py-4 font-medium">Utilisateur</th>
                                <th class="px-6 py-4 font-medium text-right">Clics</th>
                                <th class="px-6 py-4 font-medium text-right">Créé le</th>
                            </tr>
                        </thead>
                        <tbody id="redirectsTopBody" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!--  PANEL: PREMIUM  -->
        <section id="panel-premium" class="tab-panel hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Total Premium</p>
                    <p id="kpiTotalPremium" class="text-2xl font-bold text-white">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Actifs</p>
                    <p id="kpiActivePremium" class="text-2xl font-bold text-emerald-400">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Achats (Période)</p>
                    <p id="kpiTotalPurchases" class="text-2xl font-bold text-white">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Revenu Total</p>
                    <p id="kpiTotalRevenue" class="text-2xl font-bold text-amber-400">-</p>
                </div>
            </div>
            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-6 md:p-8">
                <h3 class="text-lg font-bold text-white mb-6">Inscriptions Premium</h3>
                <div class="h-[400px] relative">
                    <div class="chart-loader hidden absolute inset-0 z-10 flex items-center justify-center bg-slate-950/40 backdrop-blur-sm rounded-xl">
                        <div class="w-8 h-8 border-4 border-slate-800 border-t-violet-600 rounded-full animate-spin"></div>
                    </div>
                    <canvas id="chartPremium"></canvas>
                </div>
            </div>
        </section>

        <!--  PANEL: BANS  -->
        <section id="panel-bans" class="tab-panel hidden space-y-6">
             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Actions Modération</p>
                    <p id="statBanTotal" class="text-4xl font-bold text-white tracking-tight">-</p>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <p class="text-sm text-slate-400 mb-1">Taux de Révocation</p>
                    <p id="statBanRevokeRate" class="text-4xl font-bold text-rose-400 tracking-tight">-</p>
                </div>
            </div>
            <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-6 md:p-8">
                <h3 class="text-lg font-bold text-white mb-6">Bans & Révocations</h3>
                <div class="h-[400px] relative">
                    <div class="chart-loader hidden absolute inset-0 z-10 flex items-center justify-center bg-slate-950/40 backdrop-blur-sm rounded-xl">
                        <div class="w-8 h-8 border-4 border-slate-800 border-t-violet-600 rounded-full animate-spin"></div>
                    </div>
                    <canvas id="chartBans"></canvas>
                </div>
            </div>
        </section>

        <!--  PANEL: ACCOUNTS  -->
        <section id="panel-accounts" class="tab-panel hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                <p class="text-sm text-slate-400 mb-1">Utilisateurs</p>
                <p id="kpiTotalUsersAcc" class="text-2xl font-bold text-white">-</p>
              </div>
              <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                <p class="text-sm text-slate-400 mb-1">Avec Password</p>
                <p id="kpiWithPassword" class="text-2xl font-bold text-emerald-400">-</p>
              </div>
              <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                <p class="text-sm text-slate-400 mb-1">OAuth Uni.</p>
                <p id="kpiOAuthOnly" class="text-2xl font-bold text-amber-400">-</p>
              </div>
              <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                <p class="text-sm text-slate-400 mb-1">Connections</p>
                <p id="kpiTotalConn" class="text-2xl font-bold text-cyan-400">-</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-slate-950/30 border border-slate-800 rounded-3xl p-8 flex flex-col items-center">
                    <h3 class="text-lg font-bold text-white mb-8">Méthodes de connexion</h3>
                    <div class="h-[300px] w-full relative">
                        <div class="chart-loader hidden absolute inset-0 z-10 flex items-center justify-center bg-slate-950/40 backdrop-blur-sm rounded-xl">
                            <div class="w-8 h-8 border-4 border-slate-800 border-t-violet-600 rounded-full animate-spin"></div>
                        </div>
                        <canvas id="chartDoughnut"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-slate-500 text-[10px] uppercase font-bold tracking-widest">Ratio</span>
                        </div>
                    </div>
                </div>
                <div id="providerDetails" class="grid grid-cols-1 gap-3">
                    <!-- Injected -->
                </div>
            </div>
        </section>

    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));
    const fmt = (n) => new Intl.NumberFormat('fr-FR').format(n || 0);

    const CHART_TOOLTIP = {
        backgroundColor: 'rgba(15, 23, 42, 0.95)',
        titleColor: '#fff',
        bodyColor: '#94a3b8',
        borderColor: 'rgba(255, 255, 255, 0.1)',
        borderWidth: 1,
        padding: 12,
        cornerRadius: 8,
        displayColors: true
    };

    const CHART_SCALES = {
        x: { grid: { display: false }, border: { display: false }, ticks: { color: '#64748b', maxTicksLimit: 12, font: { size: 10 } } },
        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, border: { display: false }, ticks: { color: '#64748b', precision: 0, font: { size: 10 } } }
    };

    const charts = {};
    let activeTab = 'signups';
    let currentData = null;

    function downloadCSV(filename, rows) {
        const csvContent = "data:text/csv;charset=utf-8," 
            + rows.map(e => e.join(";")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function setupDates() {
        const fromIn = qs('#fFrom');
        const toIn = qs('#fTo');
        if (fromIn && toIn && !fromIn.value) {
            const now = new Date();
            const start = new Date(now.getTime() - 29 * 86400000);
            fromIn.value = start.toISOString().slice(0, 10);
            toIn.value = now.toISOString().slice(0, 10);
        }
    }

    async function fetchAPI(url) {
        const f = qs('#fFrom');
        const t = qs('#fTo');
        const from = f ? f.value : '';
        const to = t ? t.value : '';
        const sep = url.includes('?') ? '&' : '?';
        const res = await fetch(`${url}${sep}from=${from}&to=${to}`, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('API Error: ' + res.status);
        return res.json();
    }

    function drawLine(id, labels, datasets) {
        const ctx = qs('#' + id);
        if (!ctx) return;
        if (typeof Chart === 'undefined') {
            setTimeout(() => drawLine(id, labels, datasets), 100);
            return;
        }
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: { 
                labels: labels.map(l => {
                    try {
                        return new Date(l).toLocaleDateString('fr-FR', { day:'numeric', month:'short' });
                    } catch(e) { return String(l); }
                }), 
                datasets: datasets.map(ds => ({
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: ds.borderColor || '#8b5cf6',
                    pointBorderColor: '#0f172a',
                    pointBorderWidth: 2,
                    borderWidth: 2.5,
                    ...ds
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 400 // Animation plus courte pour forcer l'affichage rapide
                },
                plugins: { 
                    legend: { display: datasets.length > 1, labels: { color: '#94a3b8', font: {size:11} } }, 
                    tooltip: CHART_TOOLTIP 
                },
                scales: CHART_SCALES
            }
        });
        
        // Force un rafraîchissement immédiat pour éviter le bug d'invisibilité
        requestAnimationFrame(() => {
            if (charts[id]) charts[id].update('none');
        });
    }

    const loaders = {
        signups: async () => {
            const d = await fetchAPI('/admin/stats/signups');
            currentData = { type: 'signups', data: d };
            qs('#statTotal').textContent = fmt(d.stats.total);
            qs('#statPub').textContent = fmt(d.stats.visible);
            qs('#statPriv').textContent = fmt(d.stats.invisible);
            qs('#statStaff').textContent = fmt(d.stats.staff);
            const sub = qs('.sub-tab-btn.bg-violet-600')?.dataset.sub || 'su1';
            updateSignupsSub(sub, d);
        },
        logins: async () => {
            const d = await fetchAPI('/admin/stats/logins');
            currentData = { type: 'logins', data: d };
            qs('#statLoginTotal').textContent = fmt(d.total);
            qs('#statLoginAvg').textContent = fmt(d.average);
            drawLine('chartLogins', d.series.map(x => x.date), [{
                label: 'Connexions', data: d.series.map(x => x.count),
                borderColor: '#22d3ee', backgroundColor: 'rgba(34, 211, 238, 0.1)'
            }]);
        },
        plinkks: async () => {
            const [d, top] = await Promise.all([
                fetchAPI('/admin/stats/plinkks'),
                fetchAPI('/admin/stats/plinkks/top')
            ]);
            currentData = { type: 'plinkks', data: d, top: top };
            qs('#plinkkTotalViews').textContent = fmt(d.totalViews);
            qs('#plinkkTotalCount').textContent = fmt(d.totalPlinkks);
            qs('#plinkkTopDay').textContent = fmt(d.topViewInPeriod);
            drawLine('chartPlinkks', d.series.map(x => x.date), [{
                label: 'Vues', data: d.series.map(x => x.count),
                borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)'
            }]);
            const body = qs('#plinkksTopBody');
            if (body && top.plinkks) {
                body.innerHTML = top.plinkks.map(p => `
                    <tr class="hover:bg-slate-800/30 transition-colors group">
                        <td class="p-4"><span class="text-white font-bold text-sm">${p.name || 'Sans titre'}</span></td>
                        <td class="p-4"><code class="text-[11px] text-violet-400 bg-violet-400/5 px-2 py-1 rounded-lg border border-violet-500/10">/${p.slug}</code></td>
                        <td class="p-4">
                             <div class="flex items-center gap-2">
                                <img src="${p.user?.image || '/images/default-avatar.png'}" class="w-5 h-5 rounded-full border border-slate-700 object-cover" />
                                <span class="text-slate-400 text-sm font-medium">@${p.user?.userName || 'inconnu'}</span>
                             </div>
                        </td>
                        <td class="p-4 text-center text-slate-500 text-xs">${new Date(p.createdAt).toLocaleDateString('fr-FR')}</td>
                        <td class="p-4 text-right font-bold text-white">${fmt(p.views)}</td>
                    </tr>`).join('');
            }
        },
        redirections: async () => {
             const [d, top] = await Promise.all([
                fetchAPI('/admin/stats/redirections'),
                fetchAPI('/admin/stats/redirections/top')
            ]);
            currentData = { type: 'redirections', data: d, top: top };
            qs('#redirectTotalClicks').textContent = fmt(d.totalClicks);
            qs('#redirectTotalCount').textContent = fmt(d.totalRedirects);
            qs('#redirectTopDay').textContent = fmt(d.topViewInPeriod);
            drawLine('chartRedirections', d.series.map(x => x.date), [{
                label: 'Clics', data: d.series.map(x => x.count),
                borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.1)'
            }]);
            const body = qs('#redirectsTopBody');
            if (body && top.redirects) {
                 body.innerHTML = top.redirects.map(r => `
                    <tr class="hover:bg-slate-800/30 transition-colors group">
                        <td class="px-6 py-4"><code class="text-[11px] text-pink-400 bg-pink-400/5 px-2 py-1 rounded-lg border border-pink-500/10">${r.slug}</code></td>
                        <td class="px-6 py-4"><a href="${r.targetUrl}" target="_blank" class="text-xs text-slate-400 hover:text-white hover:underline truncate max-w-[200px] block">${r.targetUrl}</a></td>
                        <td class="px-6 py-4">
                             <div class="flex items-center gap-2">
                                <img src="${r.user?.image || '/images/default-avatar.png'}" class="w-5 h-5 rounded-full border border-slate-700 object-cover" />
                                <span class="text-slate-400 text-sm font-medium">@${r.user?.userName || 'inconnu'}</span>
                             </div>
                        </td>
                        <td class="px-6 py-4 text-right font-bold text-white">${fmt(r.clicks)}</td>
                        <td class="px-6 py-4 text-right text-slate-500 text-xs">${new Date(r.createdAt).toLocaleDateString('fr-FR')}</td>
                    </tr>`).join('');
            }
        },
        premium: async () => {
            const d = await fetchAPI('/admin/stats/premium');
            currentData = { type: 'premium', data: d };
            qs('#kpiTotalPremium').textContent = fmt(d.totalHistory);
            qs('#kpiActivePremium').textContent = fmt(d.activeNow);
            qs('#kpiTotalPurchases').textContent = fmt(d.periodPurchases);
            qs('#kpiTotalRevenue').textContent = fmt(d.estimatedTotalRevenue) + '€';
            drawLine('chartPremium', d.series.map(x => x.date), [{
                label: 'Achats', data: d.series.map(x => x.count),
                borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)'
            }]);
        },
        bans: async () => {
            const d = await fetchAPI('/admin/stats/bans');
            currentData = { type: 'bans', data: d };
            qs('#statBanTotal').textContent = fmt(d.totalActions);
            qs('#statBanRevokeRate').textContent = d.revokeRate + '%';
            drawLine('chartBans', d.series.map(x => x.date), [
                { label: 'Bans', data: d.series.map(x => x.bans), borderColor:'#ef4444', backgroundColor:'rgba(239, 68, 68, 0.05)' },
                { label: 'Révocations', data: d.series.map(x => x.revokes), borderColor:'#10b981', backgroundColor:'transparent' }
            ]);
        },
        accounts: async () => {
            const d = await fetchAPI('/admin/stats/accounts');
            currentData = { type: 'accounts', data: d };
            qs('#kpiTotalUsersAcc').textContent = fmt(d.summary.totalUsers);
            qs('#kpiWithPassword').textContent = fmt(d.summary.withPassword);
            qs('#kpiOAuthOnly').textContent = fmt(d.summary.oauthOnly);
            qs('#kpiTotalConn').textContent = fmt(d.summary.totalConnections);
            const ctx = qs('#chartDoughnut');
            if (ctx && typeof Chart !== 'undefined') {
                if (charts.doughnut) charts.doughnut.destroy();
                charts.doughnut = new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: { 
                        labels: d.providers.map(p => p.provider), 
                        datasets: [{ data: d.providers.map(p => p.count), backgroundColor: ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'], borderColor: '#0f172a', borderWidth: 3 }] 
                    },
                    options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: CHART_TOOLTIP } }
                });
            }
            const det = qs('#providerDetails');
            if (det) {
                det.innerHTML = d.providers.map((p, i) => {
                    const colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
                    return `<div class="flex items-center justify-between bg-slate-900/40 rounded-2xl p-4 border border-slate-800/50">
                        <div class="flex items-center gap-4">
                            <div class="w-3 h-3 rounded-full" style="background:${colors[i] || '#64748b'}"></div>
                            <span class="capitalize font-medium text-slate-300 text-sm">${p.provider}</span>
                        </div>
                        <span class="text-white font-bold">${fmt(p.count)}</span>
                    </div>`;
                }).join('');
            }
        }
    };

    function updateSignupsSub(key, data) {
        if (!data) return;
        const s = data.series;
        if (key === 'su1') drawLine('chartSignups', s.map(x => x.date), [{ label: 'Nouveaux', data: s.map(x => x.count), borderColor:'#8b5cf6', backgroundColor:'rgba(139, 92, 246, 0.1)' }]);
        if (key === 'su2') drawLine('chartSignups', s.map(x => x.date), [{ label: 'Public', data: s.map(x => x.pub), borderColor:'#10b981', backgroundColor:'transparent' }, { label: 'Privé', data: s.map(x => x.priv), borderColor:'#64748b', backgroundColor:'transparent' }]);
        if (key === 'su3') drawLine('chartSignups', s.map(x => x.date), [{ label: 'User', data: s.map(x => x.user), borderColor:'#3b82f6', backgroundColor:'transparent' }, { label: 'Staff', data: s.map(x => x.staff), borderColor:'#f59e0b', backgroundColor:'transparent' }]);
        if (key === 'su4') drawLine('chartSignups', s.map(x => x.date), [{ label: 'Total cumulé', data: s.map(x => x.cumul), borderColor:'#ec4899', backgroundColor:'rgba(236, 72, 153, 0.05)' }]);
    }

    function setTab(key) {
        activeTab = key;
        qsa('.tab-btn').forEach(btn => {
            const t = btn.dataset.tab;
            const sel = t === key;
            btn.setAttribute('aria-selected', sel ? 'true' : 'false');
            btn.className = sel ? "tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white shadow-lg shadow-violet-500/25" : "tab-btn flex-1 min-w-[120px] px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-400 hover:text-slate-200 hover:bg-slate-800/50";
        });
        qsa('.tab-panel').forEach(p => p.classList.add('hidden'));
        qs('#panel-' + key)?.classList.remove('hidden');
        loadTab(key);
    }

    async function loadTab(key) {
        try { 
            if (loaders[key]) {
                const panel = qs('#panel-' + key);
                const loadersInPanel = qsa('.chart-loader', panel);
                
                if (panel) panel.classList.add('opacity-70', 'pointer-events-none');
                loadersInPanel.forEach(l => l.classList.remove('hidden'));

                await loaders[key](); 

                if (panel) panel.classList.remove('opacity-70', 'pointer-events-none');
                loadersInPanel.forEach(l => l.classList.add('hidden'));
            }
        } catch(e) { 
            console.error(e); 
            qsa('.chart-loader').forEach(l => l.classList.add('hidden'));
            qsa('.tab-panel').forEach(p => p.classList.remove('opacity-70', 'pointer-events-none'));
        }
    }

    qsa('.tab-btn').forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));
    qsa('.sub-tab-btn').forEach(btn => btn.addEventListener('click', async () => {
        qsa('.sub-tab-btn').forEach(b => { b.classList.remove('bg-violet-600','text-white'); b.classList.add('text-slate-400','hover:text-slate-200'); });
        btn.classList.add('bg-violet-600','text-white');
        btn.classList.remove('text-slate-400','hover:text-slate-200');
        
        // On déclenche manuellement le loader spécifique pour les sous-onglets
        const panel = qs('#panel-signups');
        const chartLoaders = qsa('.chart-loader', panel);
        chartLoaders.forEach(l => l.classList.remove('hidden'));
        
        try {
            const d = await fetchAPI('/admin/stats/signups');
            updateSignupsSub(btn.dataset.sub, d);
        } catch(e) { console.error(e); }
        
        chartLoaders.forEach(l => l.classList.add('hidden'));
    }));

    qsa('.range-btn').forEach(btn => btn.addEventListener('click', () => {
        const days = Number(btn.dataset.days);
        const now = new Date();
        const start = new Date(now.getTime() - (days === 1 ? 0 : (days - 1)) * 86400000);
        qs('#fFrom').value = start.toISOString().slice(0, 10);
        qs('#fTo').value = now.toISOString().slice(0, 10);
        qsa('.range-btn').forEach(b => { b.className = "range-btn px-4 py-2.5 rounded-xl text-sm font-medium bg-slate-900 border border-slate-800 text-slate-400 hover:text-white hover:border-slate-600 transition-all"; });
        btn.className = "range-btn px-4 py-2.5 rounded-xl text-sm font-medium bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white shadow-lg shadow-violet-500/20";
        loadTab(qs('.tab-btn[aria-selected="true"]').dataset.tab);
    }));

    qs('#fFrom')?.addEventListener('change', () => loadTab(qs('.tab-btn[aria-selected="true"]').dataset.tab));
    qs('#fTo')?.addEventListener('change', () => loadTab(qs('.tab-btn[aria-selected="true"]').dataset.tab));

    // Export Logic
    function exportGraph() {
        // Map tab to its main chart ID
        const chartIdMap = {
            'signups': 'chartSignups',
            'logins': 'chartLogins',
            'plinkks': 'chartPlinkks',
            'redirections': 'chartRedirections',
            'premium': 'chartPremium',
            'bans': 'chartBans',
            'accounts': 'chartDoughnut'
        };
        const chartId = chartIdMap[activeTab];
        
        if (chartId && charts[chartId]) {
            const link = document.createElement('a');
            link.download = `plinkk-stats-${activeTab}-${new Date().toISOString().slice(0,10)}.png`;
            link.href = charts[chartId].toBase64Image();
            link.click();
        } else {
            alert('Aucun graphique disponible pour cet onglet ou pas encore chargé.');
        }
    }

    function exportCSV() {
        if (!currentData || !currentData.data) {
            alert('Aucune donnée chargée à exporter.');
            return;
        }
        
        let rows = [];
        const today = new Date().toISOString().slice(0, 10);
        const type = currentData.type;
        const d = currentData.data;

        if (type === 'signups') {
            rows = [['Date', 'Total Cumule', 'Nouveaux', 'Staff', 'Public', 'Prive']];
            if(d.series) {
                d.series.forEach(x => {
                    rows.push([x.date, x.cumul, x.count, x.staff, x.pub, x.priv]);
                });
            }
        }
        else if (type === 'logins') {
            rows = [['Date', 'Connexions']];
            if(d.series) {
                d.series.forEach(x => {
                    rows.push([x.date, x.count]);
                });
            }
        }
        else if (type === 'plinkks') {
            rows = [['Date', 'Vues']];
            if(d.series) {
                d.series.forEach(x => {
                    rows.push([x.date, x.count]);
                });
            }
            // Add top plinkks if available (as a separate block below)
            if(currentData.top && currentData.top.plinkks) {
                rows.push([]);
                rows.push(['TOP PLINKKS (PERIODE)']);
                rows.push(['Nom', 'Slug', 'Vues', 'Date Creation']);
                currentData.top.plinkks.forEach(p => {
                    rows.push([p.name || 'Sans titre', p.slug, p.views, p.createdAt]);
                });
            }
        }
        else if (type === 'redirections') {
            rows = [['Date', 'Clics']];
            if(d.series) {
                d.series.forEach(x => {
                    rows.push([x.date, x.count]);
                });
            }
            if(currentData.top && currentData.top.redirects) {
                rows.push([]);
                rows.push(['TOP REDIRECTIONS (PERIODE)']);
                rows.push(['Slug', 'Cible', 'Clics', 'Date Creation']);
                currentData.top.redirects.forEach(r => {
                    rows.push([r.slug, r.targetUrl, r.clicks, r.createdAt]);
                });
            }
        }
        else if (type === 'premium') {
            rows = [['Date', 'Achats']];
            if(d.series) {
                d.series.forEach(x => {
                    rows.push([x.date, x.count]);
                });
            }
        }
        else if (type === 'bans') {
            rows = [['Date', 'Bans', 'Revocations']];
            if(d.series) {
                d.series.forEach(x => {
                    rows.push([x.date, x.bans, x.revokes]);
                });
            }
        }
        else if (type === 'accounts') {
            rows = [['Provider', 'Count']];
            if(d.providers) {
                d.providers.forEach(p => {
                    rows.push([p.provider, p.count]);
                });
            }
            rows.push([]);
            rows.push(['KPI']);
            rows.push(['Total Users', d.summary.totalUsers]);
            rows.push(['With Password', d.summary.withPassword]);
            rows.push(['OAuth Only', d.summary.oauthOnly]);
        }
        
        if (rows.length > 0) {
            downloadCSV(`plinkk-data-${type}-${today}.csv`, rows);
        }
    }

    qs('#btnExportGraph')?.addEventListener('click', exportGraph);
    qs('#btnExportCSV')?.addEventListener('click', exportCSV);

    function init() { setupDates(); setTab('signups'); }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>

<%- include('partials/footer.ejs') %>
