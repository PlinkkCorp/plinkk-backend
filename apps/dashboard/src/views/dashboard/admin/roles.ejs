<%- include('../../partials/head.ejs', { title: 'Admin - Rôles & Permissions', description: 'Gestion des rôles et permissions', robots: 'noindex,nofollow' }) %>
<%- include('../../partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
  <%- include('../../partials/admin-nav.ejs', { user: user, active: 'roles' }) %>

  <main class="col-span-12 lg:col-span-10 space-y-6">
    <style>
    /* UI & Drag indicators */
    #rolesList .draggable{position:relative; cursor:move}
    #rolesList .dragging{opacity:.6}
    #rolesList .drag-over-top::before,#rolesList .drag-over-bottom::after{content:"";position:absolute;left:0;right:0;height:2px;background:#8b5cf6}
    #rolesList .drag-over-top::before{top:0}
    #rolesList .drag-over-bottom::after{bottom:0}
  </style>

  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white tracking-tight">Rôles & Permissions</h1>
    <p class="text-slate-400 mt-2">Gérez les rôles utilisateurs et leurs permissions d'accès.</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Colonne gauche: liste des rôles + création -->
    <aside class="lg:col-span-3 flex flex-col gap-4">
      <div class="bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden flex flex-col h-[calc(100vh-200px)] sticky top-6">
        <div class="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm">
          <form id="createRoleForm" class="flex flex-col gap-3">
            <div class="flex gap-2">
              <input name="name" placeholder="Nouveau rôle (ex: PARTNER)" class="flex-1 px-3 py-2 rounded-xl bg-slate-950 border border-slate-800 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-violet-500/50 focus:ring-1 focus:ring-violet-500/50 transition-all" />
              <button type="submit" class="px-3 py-2 rounded-xl bg-violet-600 hover:bg-violet-500 text-white text-sm font-medium transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              </button>
            </div>
          </form>
          <div class="mt-3 relative">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input id="roleSearch" placeholder="Rechercher un rôle..." class="w-full pl-9 pr-3 py-2 rounded-xl bg-slate-950 border border-slate-800 text-xs text-white placeholder-slate-500 focus:outline-none focus:border-violet-500/50 transition-all" />
          </div>
          <div class="flex items-center justify-between mt-2 px-1">
            <div id="createRoleStatus" class="text-[10px] font-medium text-slate-400"></div>
            <div id="rolesCount" class="text-[10px] text-slate-500">Glissez pour réordonner</div>
          </div>
        </div>
        
        <div id="rolesList" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
          <!-- items -->
        </div>
        
        <div id="rolesEmpty" class="hidden p-8 text-center">
          <p class="text-sm text-slate-400">Aucun rôle trouvé.</p>
        </div>
        <div id="rolesError" class="hidden p-3 m-2 rounded-lg bg-rose-500/10 border border-rose-500/20 text-xs text-rose-400"></div>
      </div>
    </aside>

    <!-- Colonne droite: permissions du rôle sélectionné -->
    <section class="lg:col-span-9 space-y-6" id="rightPane">
      <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
        <div id="roleHeader" class="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-slate-800 pb-6 mb-6">
          <div>
            <div class="text-xs font-medium text-violet-400 mb-1">RÔLE SÉLECTIONNÉ</div>
            <h2 id="selRoleName" class="text-3xl font-bold text-white tracking-tight">—</h2>
          </div>
          
          <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-3 bg-slate-950 rounded-xl p-1 border border-slate-800">
              <label class="flex items-center gap-2 px-3 py-1.5 cursor-pointer hover:bg-slate-900 rounded-lg transition-colors">
                <input id="selRoleIsStaff" type="checkbox" class="w-4 h-4 rounded border-slate-700 bg-slate-900 text-violet-600 focus:ring-violet-500/50 focus:ring-offset-0" />
                <span class="text-sm text-slate-300 font-medium">Staff Access</span>
              </label>
            </div>

            <div class="flex items-center gap-2 bg-slate-950 rounded-xl p-1 border border-slate-800">
              <div class="px-3 py-1.5 border-r border-slate-800">
                <span class="text-xs text-slate-500 uppercase font-bold">Priorité</span>
              </div>
              <input id="selRolePriority" type="number" class="w-16 px-2 py-1 bg-transparent text-sm text-white focus:outline-none text-center" />
            </div>

            <div class="flex items-center gap-2 bg-slate-950 rounded-xl p-1 border border-slate-800">
              <div class="px-3 py-1.5 border-r border-slate-800">
                <span class="text-xs text-slate-500 uppercase font-bold">Max Plinkks</span>
              </div>
              <input id="selRoleMaxPlinkks" type="number" class="w-16 px-2 py-1 bg-transparent text-sm text-white focus:outline-none text-center" />
            </div>

            <div class="flex items-center gap-2 bg-slate-950 rounded-xl p-1 border border-slate-800">
              <div class="px-3 py-1.5 border-r border-slate-800">
                <span class="text-xs text-slate-500 uppercase font-bold">Max Thèmes</span>
              </div>
              <input id="selRoleMaxThemes" type="number" class="w-16 px-2 py-1 bg-transparent text-sm text-white focus:outline-none text-center" />
            </div>

            <div class="flex items-center gap-2 ml-2">
              <button id="btnSaveRole" class="p-2.5 rounded-xl bg-violet-600 hover:bg-violet-500 text-white transition-colors" title="Enregistrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
              </button>
              <button id="btnDeleteRole" class="p-2.5 rounded-xl bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 border border-rose-500/20 transition-colors" title="Supprimer">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Contrôles globaux permissions -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
          <div class="flex items-center gap-2">
            <button id="btnEnableAll" class="px-3 py-1.5 rounded-lg bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-500 border border-emerald-500/20 text-xs font-medium transition-colors">Tout activer</button>
            <button id="btnDisableAll" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 text-xs font-medium transition-colors">Tout désactiver</button>
          </div>
          
          <div class="flex items-center gap-2">
            <div class="relative">
              <select id="importRoleSelect" class="appearance-none pl-3 pr-8 py-1.5 rounded-lg bg-slate-950 border border-slate-800 text-xs text-slate-300 focus:outline-none focus:border-violet-500/50">
                <option value="">Importer depuis…</option>
              </select>
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"><path d="m6 9 6 6 6-6"/></svg>
            </div>
            <button id="btnImportPerms" class="px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-500 text-white text-xs font-medium transition-colors">Importer</button>
          </div>
        </div>

        <div id="permissionsPanel" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
          <% Object.keys(permissionsGrouped).forEach(cat => { %>
            <div class="bg-slate-950/50 border border-slate-800 rounded-2xl overflow-hidden" data-category="<%= cat %>">
              <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-900/50">
                <span class="text-xs font-bold text-slate-300 uppercase tracking-wider"><%= cat %></span>
                <div class="flex items-center gap-1">
                  <button type="button" class="btn-cat-enable p-1 rounded hover:bg-emerald-500/10 text-slate-500 hover:text-emerald-500 transition-colors" title="Activer tout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                  </button>
                  <button type="button" class="btn-cat-disable p-1 rounded hover:bg-rose-500/10 text-slate-500 hover:text-rose-500 transition-colors" title="Désactiver tout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                  </button>
                </div>
              </div>
              <div class="p-2 space-y-1">
                <% permissionsGrouped[cat].forEach(p => { %>
                  <div class="group flex items-center justify-between gap-3 p-2 rounded-xl hover:bg-slate-900 transition-colors">
                    <div class="flex flex-col min-w-0">
                      <div class="flex items-center gap-2">
                        <code class="text-[10px] font-mono text-violet-400 bg-violet-500/10 px-1.5 py-0.5 rounded border border-violet-500/20"><%= p.key %></code>
                      </div>
                      <span class="text-[11px] text-slate-500 truncate mt-0.5 group-hover:text-slate-400 transition-colors"><%= p.description || '' %></span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                      <input type="checkbox" class="perm-toggle sr-only peer" data-key="<%= p.key %>">
                      <div class="w-9 h-5 bg-slate-800 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-violet-500/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-600"></div>
                    </label>
                  </div>
                <% }) %>
              </div>
            </div>
          <% }) %>
        </div>
        
        <div id="noRoleHint" class="hidden flex flex-col items-center justify-center py-20 text-center">
          <div class="w-16 h-16 rounded-full bg-slate-800/50 flex items-center justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
          </div>
          <h3 class="text-lg font-medium text-white">Aucun rôle sélectionné</h3>
          <p class="text-slate-400 text-sm mt-1 max-w-xs">Sélectionnez un rôle dans la liste de gauche pour voir et modifier ses permissions.</p>
        </div>
      </div>
    </section>
  </div>
  <script id="rolesPayloadB64" type="text/plain"><%= rolesB64 || '' %></script>
</main>
</div>

<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  function showConfirm(message, actionText = 'Confirmer') {
    return new Promise(resolve => {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 z-[100000] flex items-center justify-center bg-black/70 backdrop-blur-sm';
      overlay.style.cssText = 'animation: fadeIn 0.15s ease-out';
      overlay.innerHTML = `
        <style>@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes scaleIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}</style>
        <div class="w-full max-w-sm mx-4 bg-slate-900 border border-slate-700 rounded-2xl p-6 shadow-2xl" style="animation: scaleIn 0.2s ease-out">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </div>
            <h3 class="font-semibold text-lg text-white">Confirmation</h3>
          </div>
          <p class="text-slate-300 mb-6 text-sm">${message.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>
          <div class="flex justify-end gap-3">
            <button class="cancelBtn px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-200 text-sm font-medium transition-colors">Annuler</button>
            <button class="confirmBtn px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm font-medium transition-colors">${actionText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</button>
          </div>
        </div>`;
      function cleanup(result) { overlay.remove(); document.removeEventListener('keydown', onKey); resolve(result); }
      function onKey(e) { if (e.key === 'Escape') cleanup(false); if (e.key === 'Enter') cleanup(true); }
      overlay.querySelector('.cancelBtn').addEventListener('click', () => cleanup(false));
      overlay.querySelector('.confirmBtn').addEventListener('click', () => cleanup(true));
      overlay.addEventListener('click', e => { if (e.target === overlay) cleanup(false); });
      document.body.appendChild(overlay);
      document.addEventListener('keydown', onKey);
      overlay.querySelector('.cancelBtn').focus();
    });
  }

  let rolesDataRawB64 = document.getElementById('rolesPayloadB64')?.textContent || '';
  let rolesDataRaw = '';
  if(rolesDataRawB64){
    try { rolesDataRaw = atob(rolesDataRawB64.trim()); } catch(e){ console.error('[roles] atob failed', e); rolesDataRaw = '[]'; }
  } else { rolesDataRaw = '[]'; }
  let rolesData = [];
  try {
    rolesData = JSON.parse(rolesDataRaw);
  } catch(parseErr){
    console.error('[roles] JSON parse error', parseErr, rolesDataRaw);
    const errBox = document.getElementById('rolesError');
    if(errBox){
      errBox.textContent = 'Erreur de parsing des rôles côté client. Relancez le seed (node scripts/seed-permissions.js) ou vérifiez le template. Contenu brut: '+rolesDataRaw.slice(0,120)+'...';
      errBox.classList.remove('hidden');
    }
    rolesData = [];
  }
  let selectedRoleId = rolesData[0]?.id || null;
  let searchTerm = '';

  // Rendu colonne gauche
  function renderRolesList(){
    const list = $('#rolesList'); list.innerHTML='';
    const visible = searchTerm ? rolesData.filter(r=>String(r.name||'').toLowerCase().includes(searchTerm)) : rolesData.slice();
    if(!visible.length){ $('#rolesEmpty').classList.remove('hidden'); return; } else { $('#rolesEmpty').classList.add('hidden'); }
    $('#rolesCount').textContent = visible.length+" rôle"+(visible.length>1?'s':'')+" affichés"+(searchTerm?" (filtré)":"");
    visible.forEach(r=>{
      const isSelected = r.id===selectedRoleId;
      const a = document.createElement('button');
      a.type='button';
      a.className = `w-full text-left px-3 py-3 rounded-xl text-sm transition-all draggable group relative overflow-hidden ${isSelected ? 'bg-violet-600 text-white shadow-lg shadow-violet-900/20' : 'bg-slate-950/50 text-slate-400 hover:bg-slate-800 hover:text-slate-200 border border-transparent hover:border-slate-700'}`;
      a.setAttribute('data-id', r.id);
      a.setAttribute('draggable','true');
      
      let staffBadge = '';
      if(r.isStaff) {
        staffBadge = isSelected 
          ? `<span class='text-[10px] px-1.5 py-0.5 rounded bg-white/20 text-white font-bold border border-white/20'>STAFF</span>`
          : `<span class='text-[10px] px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-500 font-bold border border-amber-500/20'>STAFF</span>`;
      }

      a.innerHTML = `
        <div class='flex items-center justify-between relative z-10'>
          <span class='font-medium flex items-center gap-3'>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50 cursor-grab active:cursor-grabbing"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            ${r.name}
          </span>
          ${staffBadge}
        </div>
      `;
      list.appendChild(a);
    });
  }

  // Rendu panneau droit selon rôle
  function renderRight(){
    const role = rolesData.find(r=>r.id===selectedRoleId);
    const hint = $('#noRoleHint');
    const content = $('#rightPane > div'); // The main content div
    
    if(!role){ 
      hint.classList.remove('hidden'); 
      content.classList.add('hidden');
      return; 
    }
    
    hint.classList.add('hidden'); 
    content.classList.remove('hidden');
    
    $('#selRoleName').textContent = role.name;
    $('#selRoleIsStaff').checked = !!role.isStaff;
    $('#selRolePriority').value = Number(role.priority||0);
    $('#selRoleMaxPlinkks').value = Number(role.maxPlinkks||1);
    $('#selRoleMaxThemes').value = Number(role.maxThemes||0);
    const current = new Set(role.permissions || []);
    $$('.perm-toggle').forEach(chk=>{
      const key = chk.getAttribute('data-key');
      const on = current.has(key);
      chk.checked = on;
    });
  }

  // Helpers permissions
  function collectAllKeys(){ return $$('.perm-toggle').map(chk=>chk.getAttribute('data-key')); }
  function collectCategoryKeys(catEl){ return $$('[data-key]', catEl).map(chk=>chk.getAttribute('data-key')); }
  async function patchPermissions(roleId, add, remove){
    const body = { addPermissions: add||[], removePermissions: remove||[] };
    const res = await fetch('/api/admin/roles/'+roleId, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok) throw new Error('patch_failed_'+res.status);
  }
  function updateLocalPerms(roleId, newSet){
    const r = rolesData.find(x=>x.id===roleId); if(!r) return;
    r.permissions = Array.from(newSet);
  }

  // Events
  $('#rolesList').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button[data-id]');
    if(!btn) return;
    selectedRoleId = btn.getAttribute('data-id');
    renderRolesList();
    renderRight();
  });
  $('#roleSearch').addEventListener('input', (ev)=>{
    searchTerm = String(ev.currentTarget.value||'').toLowerCase();
    renderRolesList();
  });

  // Drag & drop pour réordonner
  let dragId = null;
  $('#rolesList').addEventListener('dragstart', (ev)=>{
    const btn = ev.target.closest('button[data-id]');
    if(!btn) return;
    dragId = btn.getAttribute('data-id');
    ev.dataTransfer?.setData('text/plain', dragId);
    btn.classList.add('dragging');
  });
  $('#rolesList').addEventListener('dragover', (ev)=>{
    ev.preventDefault();
    const btn = ev.target.closest('button[data-id]');
    $$('#rolesList .drag-over-top, #rolesList .drag-over-bottom').forEach(b=>b.classList.remove('drag-over-top','drag-over-bottom'));
    if(!btn) return;
    const rect = btn.getBoundingClientRect();
    const before = ev.clientY < rect.top + rect.height/2;
    btn.classList.add(before?'drag-over-top':'drag-over-bottom');
  });
  $('#rolesList').addEventListener('drop', async (ev)=>{
    ev.preventDefault();
    const target = ev.target.closest('button[data-id]');
    $$('#rolesList .drag-over-top, #rolesList .drag-over-bottom').forEach(b=>b.classList.remove('drag-over-top','drag-over-bottom'));
    if(!target || !dragId) return;
    const targetId = target.getAttribute('data-id');
    if(!targetId || dragId===targetId) return;
    const fromIdx = rolesData.findIndex(r=>r.id===dragId);
    let toIdx = rolesData.findIndex(r=>r.id===targetId);
    if(fromIdx<0 || toIdx<0) return;
    const rect = target.getBoundingClientRect();
    const before = ev.clientY < rect.top + rect.height/2;
    // calcul insert index en tenant compte du déplacement
    let insertIndex = before ? toIdx : toIdx + 1;
    if(fromIdx < insertIndex) insertIndex--; // correction si on retire avant d'insérer
    const [moved] = rolesData.splice(fromIdx,1);
    rolesData.splice(insertIndex,0,moved);
    renderRolesList();
    // Persistance ordre => haut = priorité max
    try{
      const ids = rolesData.map(r=>r.id);
      const res = await fetch('/api/admin/roles/reorder',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids})});
      if(!res.ok){ throw new Error('persist failed'); }
      // mettre à jour priorités locales (n -> 1)
      const n = ids.length;
      rolesData.forEach((r,i)=>{ r.priority = (n - i); });
      $('#rolesCount').textContent = rolesData.length+" rôle"+(rolesData.length>1?'s':'')+" chargés (ordre enregistré)";
    }catch(e){
      $('#rolesError').textContent = 'Échec de l\'enregistrement de l\'ordre';
      $('#rolesError').classList.remove('hidden');
    }
  });
  $('#rolesList').addEventListener('dragend', ()=>{
    $$('#rolesList .dragging').forEach(b=>b.classList.remove('dragging'));
    $$('#rolesList .drag-over-top, #rolesList .drag-over-bottom').forEach(b=>b.classList.remove('drag-over-top','drag-over-bottom'));
  });

  $('#createRoleForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(ev.currentTarget);
    const payload = { name: fd.get('name') };
    const res = await fetch('/api/admin/roles', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const status = $('#createRoleStatus');
    if(res.ok){
      const j = await res.json();
      rolesData.push({ id: j.roleId, name: String(payload.name).toUpperCase(), isStaff:false, priority:0, color:null, maxPlinkks:1, maxThemes:0, permissions:[] });
      selectedRoleId = j.roleId;
      renderRolesList(); renderRight();
      status.textContent = 'Créé ✔'; status.className='text-emerald-400 text-[10px] font-medium';
      ev.currentTarget.reset();
      setTimeout(() => { status.textContent = ''; }, 3000);
    } else {
      status.textContent = 'Erreur '+res.status; status.className='text-rose-400 text-[10px] font-medium';
    }
  });

  // Sauvegarde infos du rôle sélectionné
  $('#btnSaveRole').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    const btn = $('#btnSaveRole');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';
    
    const payload = {
      isStaff: $('#selRoleIsStaff').checked,
      priority: Number($('#selRolePriority').value||0),
      maxPlinkks: Number($('#selRoleMaxPlinkks').value||1),
      maxThemes: Number($('#selRoleMaxThemes').value||0),
    };
    const res = await fetch('/api/admin/roles/'+roleId, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    
    setTimeout(() => {
      btn.innerHTML = originalContent;
    }, 500);

    if(res.ok){
      const r = rolesData.find(x=>x.id===roleId); if(r) Object.assign(r, payload);
      renderRolesList();
    } else alert('Échec de la sauvegarde');
  });

  // Suppression du rôle
  $('#btnDeleteRole').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    const ok = await showConfirm('Êtes-vous sûr de vouloir supprimer ce rôle ? Cette action est irréversible.', 'Supprimer');
    if(!ok) return;
    const res = await fetch('/api/admin/roles/'+roleId, { method:'DELETE' });
    if(res.ok){
      const idx = rolesData.findIndex(r=>r.id===roleId);
      if(idx>=0) rolesData.splice(idx,1);
      selectedRoleId = rolesData[0]?.id || null;
      renderRolesList(); renderRight();
    } else alert('Impossible de supprimer (rôle utilisé ?)');
  });

  // Bascules permissions
  $('#permissionsPanel').addEventListener('change', async (ev)=>{
    const chk = ev.target.closest('.perm-toggle'); if(!chk) return;
    const key = chk.getAttribute('data-key'); const roleId = selectedRoleId; if(!roleId) return;
    const on = chk.checked;
    
    const body = on ? { addPermissions:[key] } : { removePermissions:[key] };
    const res = await fetch('/api/admin/roles/'+roleId, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(res.ok){
      const r = rolesData.find(x=>x.id===roleId); if(!r) return;
      if(on){ if(!r.permissions.includes(key)) r.permissions.push(key); }
      else { r.permissions = r.permissions.filter(p=>p!==key); }
    } else {
      // revert
      chk.checked = !on;
      alert('Échec de mise à jour de la permission');
    }
  });

  // Remplir le select d'import
  function refreshImportSelect(){
    const sel = $('#importRoleSelect'); if(!sel) return;
    const current = selectedRoleId;
    sel.innerHTML = '<option value="">Importer depuis…</option>' + rolesData.filter(r=>r.id!==current).map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
  }

  // Global enable/disable
  $('#btnEnableAll').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    const keys = collectAllKeys();
    const current = new Set((rolesData.find(r=>r.id===roleId)?.permissions)||[]);
    const add = keys.filter(k=>!current.has(k));
    if(!add.length) return;
    try{ await patchPermissions(roleId, add, []); updateLocalPerms(roleId, new Set([...current, ...add])); renderRight(); }
    catch{ $('#rolesError').textContent = 'Échec: activer toutes les permissions'; $('#rolesError').classList.remove('hidden'); }
  });
  $('#btnDisableAll').addEventListener('click', async ()=>{
    const roleId = selectedRoleId; if(!roleId) return;
    const keys = collectAllKeys();
    const current = new Set((rolesData.find(r=>r.id===roleId)?.permissions)||[]);
    const remove = keys.filter(k=>current.has(k));
    if(!remove.length) return;
    try{ await patchPermissions(roleId, [], remove); updateLocalPerms(roleId, new Set()); renderRight(); }
    catch{ $('#rolesError').textContent = 'Échec: désactiver toutes les permissions'; $('#rolesError').classList.remove('hidden'); }
  });

  // Per-category enable/disable using event delegation
  $('#permissionsPanel').addEventListener('click', async (ev)=>{
    const btnEnable = ev.target.closest('.btn-cat-enable');
    const btnDisable = ev.target.closest('.btn-cat-disable');
    if(!btnEnable && !btnDisable) return;
    const panel = ev.target.closest('[data-category]'); if(!panel) return;
    const roleId = selectedRoleId; if(!roleId) return;
    const keys = collectCategoryKeys(panel);
    const current = new Set((rolesData.find(r=>r.id===roleId)?.permissions)||[]);
    if(btnEnable){
      const add = keys.filter(k=>!current.has(k)); if(!add.length) return;
      try{ await patchPermissions(roleId, add, []); updateLocalPerms(roleId, new Set([...current, ...add])); renderRight(); }
      catch{ $('#rolesError').textContent = 'Échec: activer la catégorie'; $('#rolesError').classList.remove('hidden'); }
    } else if(btnDisable){
      const remove = keys.filter(k=>current.has(k)); if(!remove.length) return;
      const next = new Set(current); keys.forEach(k=>next.delete(k));
      try{ await patchPermissions(roleId, [], remove); updateLocalPerms(roleId, next); renderRight(); }
      catch{ $('#rolesError').textContent = 'Échec: désactiver la catégorie'; $('#rolesError').classList.remove('hidden'); }
    }
  });

  // Import from role
  $('#btnImportPerms').addEventListener('click', async ()=>{
    const sel = $('#importRoleSelect'); const srcId = sel?.value || '';
    const roleId = selectedRoleId; if(!roleId || !srcId) return;
    const src = rolesData.find(r=>r.id===srcId); const dst = rolesData.find(r=>r.id===roleId); if(!src||!dst) return;
    const srcSet = new Set(src.permissions||[]);
    const dstSet = new Set(dst.permissions||[]);
    const add = [...srcSet].filter(k=>!dstSet.has(k));
    const remove = [...dstSet].filter(k=>!srcSet.has(k));
    try{ await patchPermissions(roleId, add, remove); updateLocalPerms(roleId, srcSet); renderRight(); sel.value=''; }
    catch{ $('#rolesError').textContent = 'Échec: import de permissions'; $('#rolesError').classList.remove('hidden'); }
  });

  // Init (affichage uniquement des données pré-rendues serveur)
  if(!rolesData.length){
    $('#rolesEmpty').classList.remove('hidden');
    $('#rolesError').textContent = 'Aucun rôle préchargé. Vérifiez le script de seed (node scripts/seed-permissions.js) ou vos droits staff.';
    $('#rolesError').classList.remove('hidden');
  }
  renderRolesList();
  renderRight();
  refreshImportSelect();
})();
</script>
</body>
</html>

