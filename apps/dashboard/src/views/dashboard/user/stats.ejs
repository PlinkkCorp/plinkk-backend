<%- include('partials/head.ejs', { title: 'Statistiques', description: 'Statistiques d√©taill√©es de votre profil Plinkk.', robots: 'noindex,nofollow' }) %>
<%- include('partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
    <%- include('partials/asside_dash.ejs', { active: 'stats' }) %>

    <main class="col-span-12 lg:col-span-10 space-y-8">

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER GRADIENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-gradient-to-r from-slate-900 to-slate-800 p-8 rounded-3xl border border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-violet-600/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Statistiques</h1>
                    <% if (typeof isPremium !== 'undefined' && isPremium) { %>
                    <span class="px-2.5 py-1 bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white text-[10px] font-bold rounded-lg uppercase tracking-wider">Premium</span>
                    <% } %>
                </div>
                <p class="text-slate-400 text-lg">
                    <% if (typeof plinkk !== 'undefined' && plinkk) { %>
                        Vue d√©taill√©e pour <span class="text-violet-300 font-medium"><%= plinkk.name %></span>
                    <% } else { %>
                        Vue d'ensemble de votre activit√© Plinkk
                    <% } %>
                </p>
            </div>
            <div class="relative z-10 flex items-center gap-3">
                <button id="exportCsv" class="flex items-center gap-2 px-5 py-2.5 bg-slate-800 text-white font-medium rounded-xl hover:bg-slate-700 border border-slate-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    CSV
                </button>
                <%- include('partials/changePlinkkDropdown.ejs') %>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-2">
            <nav class="flex gap-1" role="tablist" aria-label="Sections stats">
                <button class="tab-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="overview" aria-selected="true">Aper√ßu</button>
                <button class="tab-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="trends" aria-selected="false">Tendances</button>
                <button class="tab-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="links" aria-selected="false">Liens</button>
                <button class="tab-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="categories" aria-selected="false">Cat√©gories</button>
                <button class="tab-btn flex-1 px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-300" data-tab="redirects" aria-selected="false">Redirections</button>
            </nav>
        </div>

        <%
            const _links = (typeof links !== 'undefined' && Array.isArray(links)) ? links : [];
            const _totalViews = (typeof totalViews !== 'undefined') ? totalViews : 0;
            const _totalClicks = (typeof totalClicks !== 'undefined') ? totalClicks : 0;
            const _viewsDaily = (typeof viewsDaily30d !== 'undefined') ? viewsDaily30d : [];
            const _redirects = (typeof redirects !== 'undefined' && Array.isArray(redirects)) ? redirects : [];
            const _totalRedirectClicks = (typeof totalRedirectClicks !== 'undefined') ? totalRedirectClicks : 0;
            const _redirectReturns = (typeof redirectReturns !== 'undefined') ? redirectReturns : [];
            const _userViews = (typeof user !== 'undefined' && user.views) ? user.views : 0;
            const _isPremium = (typeof isPremium !== 'undefined') ? isPremium : false;
            const _maxStatsDays = (typeof maxStatsDays !== 'undefined') ? maxStatsDays : 30;

            const linkTotalClicks = _links.reduce((a, l) => a + (l.clicks || 0), 0);
            const avgPerLink = _links.length ? Math.round(linkTotalClicks / _links.length) : 0;
            const viewsDailyAvg = _viewsDaily.length ? Math.round(_viewsDaily.reduce((a, v) => a + (v.count || 0), 0) / _viewsDaily.length) : 0;
            const sortedLinks = [..._links].sort((a, b) => (b.clicks || 0) - (a.clicks || 0));
            const topLink = sortedLinks[0];
        %>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section id="panel-overview" class="tab-panel space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-violet-500/10 rounded-xl">
                            <svg class="w-6 h-6 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-white"><%= _totalViews %></p>
                            <p class="text-sm text-slate-400">Vues profil</p>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-emerald-500/10 rounded-xl">
                            <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-white"><%= _totalClicks %></p>
                            <p class="text-sm text-slate-400">Clics totaux</p>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-amber-500/10 rounded-xl">
                            <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-white"><%= avgPerLink %></p>
                            <p class="text-sm text-slate-400">Clics moy. / lien</p>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-rose-500/10 rounded-xl">
                            <svg class="w-6 h-6 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        </div>
                        <div>
                            <p class="text-lg font-bold text-white truncate max-w-[140px]"><%= topLink ? (topLink.text || topLink.name || 'Sans titre') : '‚Äî' %></p>
                            <p class="text-sm text-slate-400">Top lien<% if (topLink) { %> (<%= topLink.clicks %> clics)<% } %></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
                <h2 class="font-bold text-white text-xl mb-6">Vues des 30 derniers jours</h2>
                <div class="h-64">
                    <canvas id="overviewChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRENDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section id="panel-trends" class="tab-panel hidden space-y-6">
            <% if (!_isPremium) { %>
            <div class="relative bg-gradient-to-r from-violet-600/10 to-fuchsia-600/10 border border-violet-500/30 rounded-2xl p-5 flex items-center gap-4">
                <div class="p-3 bg-violet-500/20 rounded-xl">
                    <svg class="w-6 h-6 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                </div>
                <div class="flex-1">
                    <p class="text-white font-semibold text-sm">Passez en Premium pour d√©bloquer les statistiques au-del√† de 30 jours</p>
                    <p class="text-slate-400 text-xs mt-0.5">Acc√©dez aux tendances sur 60, 90, 180 ou 365 jours.</p>
                </div>
                <span class="px-3 py-1.5 bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white text-xs font-bold rounded-lg uppercase tracking-wider">Premium</span>
            </div>
            <% } %>
            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-bold text-white text-xl">Tendances journali√®res</h2>
                    <select id="fRange" class="px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 text-white text-sm">
                        <option value="7">7 jours</option>
                        <option value="14">14 jours</option>
                        <option value="30" selected>30 jours</option>
                        <option value="60" <%= _maxStatsDays < 60 ? 'disabled' : '' %>>60 jours<%= _maxStatsDays < 60 ? ' üîí' : '' %></option>
                        <option value="90" <%= _maxStatsDays < 90 ? 'disabled' : '' %>>90 jours<%= _maxStatsDays < 90 ? ' üîí' : '' %></option>
                        <option value="180" <%= _maxStatsDays < 180 ? 'disabled' : '' %>>180 jours<%= _maxStatsDays < 180 ? ' üîí' : '' %></option>
                        <option value="365" <%= _maxStatsDays < 365 ? 'disabled' : '' %>>1 an<%= _maxStatsDays < 365 ? ' üîí' : '' %></option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-medium text-slate-300 mb-3">Vues (journalier)</h3>
                        <div class="h-56">
                            <canvas id="trendsViewsChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-slate-300 mb-3">Clics (journalier)</h3>
                        <div class="h-56">
                            <canvas id="trendsClicksChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LINKS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section id="panel-links" class="tab-panel hidden space-y-6">
            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label class="text-sm text-slate-400 mb-1 block">Recherche</label>
                        <input id="fSearch" type="text" class="w-full px-4 py-2.5 rounded-xl bg-slate-800 border border-slate-700 text-white placeholder-slate-500" placeholder="Nom, URL, ID..." />
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 mb-1 block">Min. clics</label>
                        <input id="fMin" type="number" min="0" value="0" class="w-full px-4 py-2.5 rounded-xl bg-slate-800 border border-slate-700 text-white" />
                    </div>
                    <div>
                        <label class="text-sm text-slate-400 mb-1 block">Top N (graphique)</label>
                        <input id="fTop" type="number" min="1" value="10" class="w-full px-4 py-2.5 rounded-xl bg-slate-800 border border-slate-700 text-white" />
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
                <h2 class="font-bold text-white text-xl mb-6">Top liens par clics</h2>
                <div class="h-72">
                    <canvas id="linksChart"></canvas>
                </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-slate-800">
                    <h2 class="font-bold text-white text-xl">D√©tail des liens</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-800 text-xs uppercase text-slate-500 bg-slate-950/50">
                                <th class="p-4 font-medium">ID</th>
                                <th class="p-4 font-medium">Label</th>
                                <th class="p-4 font-medium">URL</th>
                                <th class="p-4 font-medium text-right">Clics</th>
                            </tr>
                        </thead>
                        <tbody id="tblBody" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CATEGORIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section id="panel-categories" class="tab-panel hidden space-y-6">
            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
                <h2 class="font-bold text-white text-xl mb-6">R√©partition des clics par cat√©gorie</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div class="h-72 flex items-center justify-center">
                        <canvas id="categoriesDoughnut"></canvas>
                    </div>
                    <div id="categoriesLegend" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REDIRECTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section id="panel-redirects" class="tab-panel hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-violet-500/10 rounded-xl">
                            <svg class="w-6 h-6 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-white"><%= _totalRedirectClicks %></p>
                            <p class="text-sm text-slate-400">Clics totaux</p>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-amber-500/10 rounded-xl">
                            <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-white"><%= _redirects.length %></p>
                            <p class="text-sm text-slate-400">Redirections</p>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-emerald-500/10 rounded-xl">
                            <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-white"><%= _redirects.filter(r => r.isActive).length %></p>
                            <p class="text-sm text-slate-400">Actives</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
                <h2 class="font-bold text-white text-xl mb-6">Clics redirections (30 derniers jours)</h2>
                <div class="h-64">
                    <canvas id="redirectsChart"></canvas>
                </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-slate-800">
                    <h2 class="font-bold text-white text-xl">Vos Redirections</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-800 text-xs uppercase text-slate-500 bg-slate-950/50">
                                <th class="p-4 font-medium">Slug</th>
                                <th class="p-4 font-medium">URL cible</th>
                                <th class="p-4 font-medium text-center">Statut</th>
                                <th class="p-4 font-medium text-right">Clics</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <% if (_redirects.length > 0) { %>
                                <% _redirects.forEach(r => { %>
                                    <tr class="hover:bg-slate-800/30 transition-colors">
                                        <td class="p-4">
                                            <div class="flex items-center gap-2">
                                                <code class="px-2 py-1 bg-violet-500/10 text-violet-400 rounded-lg text-sm font-mono">/r/<%= r.slug %></code>
                                                <button onclick="navigator.clipboard.writeText('<%= process.env.FRONTEND_URL || 'https://plinkk.fr' %>/r/<%= r.slug %>')" class="p-1 text-slate-500 hover:text-white transition-colors" title="Copier">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="p-4 text-slate-300 max-w-[250px] truncate" title="<%= r.targetUrl %>"><%= r.targetUrl %></td>
                                        <td class="p-4 text-center">
                                            <% if (r.isActive) { %>
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">Actif</span>
                                            <% } else { %>
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-rose-500/10 text-rose-400 border border-rose-500/20">Inactif</span>
                                            <% } %>
                                        </td>
                                        <td class="p-4 text-right font-semibold text-white"><%= r.clicks %></td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4" class="p-8 text-center text-slate-500">Aucune redirection cr√©√©e.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="application/json" id="stats-data"><%- JSON.stringify({
    views: _userViews,
    totalViews: _totalViews,
    totalClicks: _totalClicks,
    links: _links,
    viewsDaily30d: _viewsDaily,
    redirectReturns: _redirectReturns,
    redirects: _redirects,
    totalRedirectClicks: _totalRedirectClicks,
    isPremium: _isPremium,
    maxStatsDays: _maxStatsDays
}) %></script>
<script type="application/json" id="pages-data"><%- JSON.stringify(typeof pages !== 'undefined' ? pages : []) %></script>
<script type="application/json" id="autoopen-data"><%= (typeof autoOpenPlinkkModal !== 'undefined' && autoOpenPlinkkModal) ? 'true' : 'false' %></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    /* ‚îÄ‚îÄ helpers ‚îÄ‚îÄ */
    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));
    const fmt = (n) => new Intl.NumberFormat('fr-FR').format(n || 0);

    const CHART_TOOLTIP = {
        backgroundColor: 'rgba(15, 23, 42, 0.9)',
        titleColor: '#fff',
        bodyColor: '#cbd5e1',
        borderColor: 'rgba(71, 85, 105, 0.5)',
        borderWidth: 1,
        cornerRadius: 8,
        padding: 12
    };

    const CHART_SCALES = {
        x: {
            grid: { color: 'rgba(71, 85, 105, 0.2)' },
            ticks: { color: '#64748b', maxTicksLimit: 10 }
        },
        y: {
            beginAtZero: true,
            grid: { color: 'rgba(71, 85, 105, 0.2)' },
            ticks: { color: '#64748b', precision: 0 }
        }
    };

    function makeLineChart(ctx, labels, data, label, color) {
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label,
                    data,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: CHART_TOOLTIP },
                scales: CHART_SCALES
            }
        });
    }

    function fmtDateLabel(d) {
        return new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    }

    /* ‚îÄ‚îÄ data ‚îÄ‚îÄ */
    let D = {};
    try { D = JSON.parse(qs('#stats-data')?.textContent || '{}'); } catch {}
    const links = D.links || [];
    const viewsDaily = D.viewsDaily30d || [];
    const redirectReturns = D.redirectReturns || [];
    const isPremiumUser = D.isPremium || false;
    const maxStatsDays = D.maxStatsDays || 30;

    /* ‚îÄ‚îÄ category classifier ‚îÄ‚îÄ */
    function classifyUrl(url, label) {
        const hay = ((url || '') + ' ' + (label || '')).toLowerCase();
        const tests = [
            { name: 'R√©seaux sociaux', re: /(twitter|x\.com|instagram|facebook|tiktok|linkedin|threads|bluesky)/ },
            { name: 'Vid√©o', re: /(youtube|youtu\.be|vimeo|twitch|dailymotion)/ },
            { name: 'Musique', re: /(spotify|soundcloud|music\.apple|deezer|bandcamp)/ },
            { name: 'Code', re: /(github|gitlab|bitbucket|npmjs|pypi|docker\.com)/ },
            { name: 'Articles', re: /(medium\.com|dev\.to|hashnode|substack|notion\.site|ghost)/ },
            { name: 'E-commerce', re: /(gumroad|shopify|buymeacoffee|patreon|ko-fi|paypal)/ }
        ];
        for (const t of tests) { if (t.re.test(hay)) return t.name; }
        return 'Autre';
    }

    const CAT_COLORS = ['#8b5cf6','#10b981','#f59e0b','#ef4444','#3b82f6','#ec4899','#6366f1'];

    /* ‚îÄ‚îÄ CSV ‚îÄ‚îÄ */
    function makeCSV(rows) {
        const esc = (v) => '"' + String(v ?? '').replace(/"/g, '""') + '"';
        const lines = [['Link ID','Label','URL','Clicks'].map(esc).join(',')];
        rows.forEach(r => lines.push([r.id, r.label, r.url, r.clicks].map(esc).join(',')));
        return lines.join('\r\n');
    }
    function downloadBlob(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    /* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
    const tabButtons = qsa('.tab-btn');
    const panels = { overview: qs('#panel-overview'), trends: qs('#panel-trends'), links: qs('#panel-links'), categories: qs('#panel-categories'), redirects: qs('#panel-redirects') };
    function setTab(key) {
        tabButtons.forEach(btn => {
            const t = btn.getAttribute('data-tab');
            const sel = t === key;
            btn.setAttribute('aria-selected', sel ? 'true' : 'false');
            btn.classList.toggle('bg-gradient-to-r', sel);
            btn.classList.toggle('from-violet-600', sel);
            btn.classList.toggle('to-fuchsia-600', sel);
            btn.classList.toggle('text-white', sel);
            btn.classList.toggle('shadow-lg', sel);
            btn.classList.toggle('shadow-violet-500/25', sel);
            btn.classList.toggle('text-slate-300', !sel);
        });
        Object.keys(panels).forEach(k => {
            if (panels[k]) { if (k === key) panels[k].classList.remove('hidden'); else panels[k].classList.add('hidden'); }
        });
    }
    setTab('overview');
    tabButtons.forEach(btn => btn.addEventListener('click', () => { const k = btn.getAttribute('data-tab'); if (k) setTab(k); }));

    /* ‚îÄ‚îÄ‚îÄ AUTO OPEN PLINKK MODAL ‚îÄ‚îÄ‚îÄ */
    const autoOpen = String(qs('#autoopen-data')?.textContent || '').trim() === 'true';
    if (autoOpen) { const m = qs('#plinkkSelectorModal'); if (m) m.classList.remove('hidden'); }

    /* ‚îÄ‚îÄ‚îÄ OVERVIEW CHART ‚îÄ‚îÄ‚îÄ */
    if (viewsDaily.length) {
        makeLineChart(
            qs('#overviewChart').getContext('2d'),
            viewsDaily.map(d => fmtDateLabel(d.date)),
            viewsDaily.map(d => d.count),
            'Vues', 'rgb(139, 92, 246)'
        );
    }

    /* ‚îÄ‚îÄ‚îÄ TRENDS CHARTS ‚îÄ‚îÄ‚îÄ */
    let trendsViewsInstance = null;
    let trendsClicksInstance = null;

    async function fetchSeries(endpoint, days) {
        const now = new Date();
        const to = now.toISOString().slice(0, 10);
        const from = new Date(now.getTime() - (days - 1) * 86400000).toISOString().slice(0, 10);
        const res = await fetch(`/stats/${endpoint}?from=${from}&to=${to}`, { credentials: 'same-origin' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    }

    async function refreshTrends() {
        const rangeEl = qs('#fRange');
        let days = Number(rangeEl?.value || '30') || 30;
        // Bloquer c√¥t√© client si pas premium
        if (days > maxStatsDays) {
            days = maxStatsDays;
            if (rangeEl) rangeEl.value = String(maxStatsDays <= 30 ? 30 : maxStatsDays);
        }
        try {
            const vData = await fetchSeries('views', days);
            if (trendsViewsInstance) trendsViewsInstance.destroy();
            trendsViewsInstance = makeLineChart(
                qs('#trendsViewsChart').getContext('2d'),
                (vData.series || []).map(d => fmtDateLabel(d.date)),
                (vData.series || []).map(d => d.count),
                'Vues', 'rgb(139, 92, 246)'
            );
        } catch (e) {
            if (trendsViewsInstance) trendsViewsInstance.destroy();
            trendsViewsInstance = makeLineChart(
                qs('#trendsViewsChart').getContext('2d'),
                viewsDaily.map(d => fmtDateLabel(d.date)),
                viewsDaily.map(d => d.count),
                'Vues', 'rgb(139, 92, 246)'
            );
        }
        try {
            const cData = await fetchSeries('clicks', days);
            if (trendsClicksInstance) trendsClicksInstance.destroy();
            trendsClicksInstance = makeLineChart(
                qs('#trendsClicksChart').getContext('2d'),
                (cData.series || []).map(d => fmtDateLabel(d.date)),
                (cData.series || []).map(d => d.count),
                'Clics', 'rgb(16, 185, 129)'
            );
        } catch (e) {
            qs('#trendsClicksChart').parentElement.innerHTML = '<div class="flex items-center justify-center h-56 text-sm text-slate-500">Erreur de chargement des clics</div>';
        }
    }
    qs('#fRange')?.addEventListener('change', refreshTrends);
    refreshTrends();

    /* ‚îÄ‚îÄ‚îÄ LINKS CHART + TABLE ‚îÄ‚îÄ‚îÄ */
    let linksChartInstance = null;

    function applyLinksFilter() {
        const q = (qs('#fSearch')?.value || '').toLowerCase().trim();
        const min = Number(qs('#fMin')?.value || '0') || 0;
        const top = Number(qs('#fTop')?.value || '10') || 10;

        let rows = links.map(l => ({
            id: l.id,
            label: l.text || l.name || l.url || 'Sans titre',
            url: l.url || '',
            clicks: Number(l.clicks || 0)
        }));
        if (q) rows = rows.filter(x => x.label.toLowerCase().includes(q) || String(x.id).includes(q) || x.url.toLowerCase().includes(q));
        if (min > 0) rows = rows.filter(x => x.clicks >= min);
        rows.sort((a, b) => b.clicks - a.clicks);

        // Table
        const tbody = qs('#tblBody');
        if (tbody) {
            tbody.innerHTML = '';
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-800/30 transition-colors';
                tr.innerHTML = `
                    <td class="p-4 text-xs text-slate-400 font-mono">${r.id}</td>
                    <td class="p-4 text-white">${r.label}</td>
                    <td class="p-4 text-violet-300 truncate max-w-[200px]"><a class="hover:underline" href="${r.url}" target="_blank" rel="noopener">${r.url}</a></td>
                    <td class="p-4 text-right font-semibold text-white">${fmt(r.clicks)}</td>`;
                tbody.appendChild(tr);
            });
        }

        // Bar Chart
        const barRows = rows.slice(0, top);
        if (linksChartInstance) linksChartInstance.destroy();
        const ctx = qs('#linksChart');
        if (ctx && barRows.length) {
            linksChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: barRows.map(r => r.label.slice(0, 30)),
                    datasets: [{
                        label: 'Clics',
                        data: barRows.map(r => r.clicks),
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: 'rgb(139, 92, 246)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: CHART_TOOLTIP },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(71, 85, 105, 0.2)' }, ticks: { color: '#64748b', precision: 0 } },
                        y: { grid: { display: false }, ticks: { color: '#cbd5e1', font: { size: 11 } } }
                    }
                }
            });
        }

        // CSV export
        qs('#exportCsv').onclick = () => downloadBlob(makeCSV(rows), 'stats-liens.csv');
    }
    ['#fSearch', '#fMin', '#fTop'].forEach(sel => qs(sel)?.addEventListener('input', applyLinksFilter));
    applyLinksFilter();

    /* ‚îÄ‚îÄ‚îÄ CATEGORIES CHART ‚îÄ‚îÄ‚îÄ */
    const catMap = new Map();
    links.forEach(l => {
        const cat = classifyUrl(l.url, l.text || l.name);
        catMap.set(cat, (catMap.get(cat) || 0) + (Number(l.clicks) || 0));
    });
    const catEntries = Array.from(catMap.entries()).sort((a, b) => b[1] - a[1]);

    if (catEntries.length) {
        new Chart(qs('#categoriesDoughnut').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: catEntries.map(e => e[0]),
                datasets: [{
                    data: catEntries.map(e => e[1]),
                    backgroundColor: CAT_COLORS.slice(0, catEntries.length),
                    borderColor: '#0f172a',
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { display: false },
                    tooltip: CHART_TOOLTIP
                }
            }
        });
        // Legend
        const legendEl = qs('#categoriesLegend');
        if (legendEl) {
            catEntries.forEach((e, i) => {
                const total = catEntries.reduce((a, x) => a + x[1], 0);
                const pct = total ? Math.round(e[1] / total * 100) : 0;
                legendEl.innerHTML += `
                    <div class="flex items-center justify-between bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full" style="background:${CAT_COLORS[i % CAT_COLORS.length]}"></div>
                            <span class="text-sm text-slate-300">${e[0]}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-semibold text-white">${fmt(e[1])} clics</span>
                            <span class="text-xs text-slate-400">${pct}%</span>
                        </div>
                    </div>`;
            });
        }
    }

    /* ‚îÄ‚îÄ‚îÄ REDIRECTS CHART ‚îÄ‚îÄ‚îÄ */
    if (redirectReturns.length) {
        makeLineChart(
            qs('#redirectsChart').getContext('2d'),
            redirectReturns.map(d => fmtDateLabel(d.date)),
            redirectReturns.map(d => d.count),
            'Clics Redirections', 'rgb(139, 92, 246)'
        );
    }
})();
</script>

<%- include('partials/footer.ejs') %>
