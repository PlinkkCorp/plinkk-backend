<%- include('partials/head.ejs', { title: 'Admin - Statistiques' , description: 'Statistiques des utilisateurs' ,
  robots: 'noindex,nofollow' }) %>
  <%- include('partials/header-dash.ejs', { user: user }) %>

    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
      <%- include('partials/admin-nav.ejs', { active: '/admin/stats' }) %>

        <main class="col-span-12 lg:col-span-10 space-y-8">
          <div class="flex flex-col gap-2">
            <h1 class="text-3xl font-bold tracking-tight text-white">Statistiques — Utilisateurs</h1>
            <p class="text-sm text-slate-400">Analysez l'activité de la plateforme, les inscriptions et les
              bannissements.</p>
          </div>

          <nav class="flex flex-wrap items-center gap-2 text-sm mb-4" role="tablist" aria-label="Statistiques">
            <button id="tabSignups"
              class="px-4 py-2 rounded-full bg-violet-600 text-white font-medium transition-colors" role="tab"
              aria-selected="true">Inscriptions</button>
            <button id="tabLogins"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
              role="tab" aria-selected="false">Connexions</button>
            <button id="tabBans"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
              role="tab" aria-selected="false">Bans</button>
            <button id="tabPlinkks"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
              role="tab" aria-selected="false">Plinkks</button>
            <button id="tabPremium"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
              role="tab" aria-selected="false"><svg class="inline-block w-4 h-4 mr-1 -mt-0.5" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 3h12l4 6-10 13L2 9z" />
                <path d="M11 3l1 6h6" />
                <path d="M2 9h20" />
                <path d="M13 3l-1 6H6" />
              </svg> Premium</button>
            <button id="tabAccounts"
              class="px-4 py-2 rounded-full bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
              role="tab" aria-selected="false"><svg class="inline-block w-4 h-4 mr-1 -mt-0.5" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
              </svg> Comptes</button>
          </nav>

          <section class="rounded-3xl border border-slate-800 bg-slate-900 p-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4">
              <label class="text-sm font-medium text-slate-300">Du
                <input type="date" id="from"
                  class="mt-1.5 w-full px-4 py-2.5 rounded-xl bg-slate-950 border border-slate-800 text-slate-200 focus:border-violet-500 focus:ring-1 focus:ring-violet-500 outline-none transition-all" />
              </label>
              <label class="text-sm font-medium text-slate-300">Au
                <input type="date" id="to"
                  class="mt-1.5 w-full px-4 py-2.5 rounded-xl bg-slate-950 border border-slate-800 text-slate-200 focus:border-violet-500 focus:ring-1 focus:ring-violet-500 outline-none transition-all" />
              </label>
            </div>
            <div class="mt-4 flex flex-wrap items-center gap-3">
              <div class="flex items-center gap-3 text-sm bg-slate-950 px-3 py-1.5 rounded-xl border border-slate-800">
                <label for="customDays" class="text-slate-400">Durée</label>
                <input id="customDays" type="number" min="1" value="15"
                  class="w-16 px-2 py-1 rounded-lg bg-slate-900 border border-slate-700 text-center text-slate-200 focus:border-violet-500 outline-none" />
                <span class="text-slate-400">jours</span>
              </div>
              <div class="h-6 w-px bg-slate-800 mx-1"></div>
              <button id="last24h"
                class="px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 text-sm hover:bg-slate-700 transition-colors">24
                h</button>
              <button id="last7"
                class="px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 text-sm hover:bg-slate-700 transition-colors">7
                jours</button>
              <button id="last30"
                class="px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 text-sm hover:bg-slate-700 transition-colors">30
                jours</button>
              <button id="last90"
                class="px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 text-sm hover:bg-slate-700 transition-colors">90
                jours</button>
            </div>
          </section>

          <section id="panelSignups" class="rounded-3xl border border-slate-800 bg-slate-900 p-6">
            <nav class="flex flex-wrap items-center gap-2 text-sm mb-6" role="tablist"
              aria-label="Sous-stats Inscriptions">
              <button id="tabSU1" class="px-3 py-1.5 rounded-lg bg-violet-600 text-white font-medium transition-colors"
                role="tab" aria-selected="true">Par jour</button>
              <button id="tabSU2"
                class="px-3 py-1.5 rounded-lg bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
                role="tab" aria-selected="false">Visibilité</button>
              <button id="tabSU3"
                class="px-3 py-1.5 rounded-lg bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
                role="tab" aria-selected="false">Rôles</button>
              <button id="tabSU4"
                class="px-3 py-1.5 rounded-lg bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors"
                role="tab" aria-selected="false">Cumul</button>
            </nav>

            <section id="su1" class="rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Inscriptions par jour</h2>
                <div class="text-sm text-slate-400 font-mono" id="rangeLabel"></div>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-stretch">
                <div
                  class="lg:col-span-4 relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
                  id="chart1Wrap">
                  <canvas id="chart" class="w-full h-full block"></canvas>
                  <div id="tt1"
                    class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
                  </div>
                  <div id="load1"
                    class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                    <div class="animate-spin rounded-full h-6 w-6 border-2 border-violet-500 border-t-transparent mr-3">
                    </div>
                    <span class="text-sm text-slate-300 font-medium">Chargement…</span>
                  </div>
                  <div id="err1" role="alert" aria-live="assertive"
                    class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                    <div class="text-sm text-rose-400 font-medium">Erreur de chargement des inscriptions.</div>
                    <button type="button"
                      class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                      onclick="window.__retrySU1?.()">Réessayer</button>
                  </div>
                  <div id="empty1"
                    class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">Aucune
                    donnée sur cette période</div>
                </div>

                <aside class="lg:col-span-1">
                  <div class="h-full flex flex-col">
                    <div class="text-sm font-medium text-slate-400 mb-3 uppercase tracking-wider text-[10px]">Résumé
                    </div>
                    <div class="bg-slate-950 border border-slate-800 rounded-2xl overflow-hidden flex-1">
                      <div
                        class="flex flex-col justify-center px-4 py-4 border-b border-slate-800 bg-gradient-to-br from-violet-500/10 to-transparent">
                        <div class="text-sm text-slate-400 mb-1">Total</div>
                        <div id="statTotal" class="text-3xl font-bold text-white tracking-tight">–</div>
                      </div>
                      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800/50">
                        <div class="flex items-center gap-2">
                          <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                          <div class="text-sm text-slate-400">Publics</div>
                        </div>
                        <div id="statPub" class="text-sm font-semibold text-slate-200 font-mono">–</div>
                      </div>
                      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800/50">
                        <div class="flex items-center gap-2">
                          <div class="w-2 h-2 rounded-full bg-rose-500"></div>
                          <div class="text-sm text-slate-400">Privés</div>
                        </div>
                        <div id="statPriv" class="text-sm font-semibold text-slate-200 font-mono">–</div>
                      </div>
                      <div class="flex items-center justify-between px-4 py-3">
                        <div class="flex items-center gap-2">
                          <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                          <div class="text-sm text-slate-400">Staff</div>
                        </div>
                        <div id="statStaff" class="text-sm font-semibold text-slate-200 font-mono">–</div>
                      </div>
                    </div>
                  </div>
                </aside>
              </div>
            </section>

            <section id="su2" class="hidden">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Visibilité des nouvelles inscriptions</h2>
                <div class="text-sm text-slate-400 font-mono" id="rangeLabel2"></div>
              </div>
              <div class="relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
                id="chart2Wrap">
                <canvas id="chartVisibility" class="w-full h-full block"></canvas>
                <div id="tt2"
                  class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
                </div>
                <div id="load2"
                  class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                  <div class="animate-spin rounded-full h-6 w-6 border-2 border-violet-500 border-t-transparent mr-3">
                  </div>
                  <span class="text-sm text-slate-300 font-medium">Chargement…</span>
                </div>
                <div id="err2" role="alert" aria-live="assertive"
                  class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                  <div class="text-sm text-rose-400 font-medium">Erreur de chargement (visibilité).</div>
                  <button type="button"
                    class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                    onclick="window.__retrySU2?.()">Réessayer</button>
                </div>
                <div id="empty2"
                  class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">Aucune donnée
                </div>
              </div>
              <div class="mt-4 flex items-center gap-4 text-sm text-slate-400 justify-center">
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                    class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-500"></span>Public</span>
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                    class="inline-block w-2.5 h-2.5 rounded-full bg-rose-500"></span>Privé</span>
              </div>
            </section>

            <section id="su3" class="hidden">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Inscriptions par rôle</h2>
                <div class="text-sm text-slate-400 font-mono" id="rangeLabel3"></div>
              </div>
              <div class="relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
                id="chart3Wrap">
                <canvas id="chartRoles" class="w-full h-full block"></canvas>
                <div id="tt3"
                  class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
                </div>
                <div id="load3"
                  class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                  <div class="animate-spin rounded-full h-6 w-6 border-2 border-violet-500 border-t-transparent mr-3">
                  </div>
                  <span class="text-sm text-slate-300 font-medium">Chargement…</span>
                </div>
                <div id="err3" role="alert" aria-live="assertive"
                  class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                  <div class="text-sm text-rose-400 font-medium">Erreur de chargement (rôles).</div>
                  <button type="button"
                    class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                    onclick="window.__retrySU3?.()">Réessayer</button>
                </div>
                <div id="empty3"
                  class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">Aucune donnée
                </div>
              </div>
              <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-slate-400 justify-center">
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                    class="inline-block w-2.5 h-2.5 rounded-full bg-slate-400"></span>USER</span>
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                    class="inline-block w-2.5 h-2.5 rounded-full bg-amber-500"></span>MODERATOR</span>
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                    class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-500"></span>DEVELOPER</span>
                <span
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                    class="inline-block w-2.5 h-2.5 rounded-full bg-rose-500"></span>ADMIN</span>
              </div>
            </section>

            <section id="su4" class="hidden">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Cumul des inscriptions</h2>
                <div class="text-sm text-slate-400 font-mono" id="rangeLabel4"></div>
              </div>
              <div class="relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
                id="chart4Wrap">
                <canvas id="chartCumul" class="w-full h-full block"></canvas>
                <div id="tt4"
                  class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
                </div>
                <div id="load4"
                  class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                  <div class="animate-spin rounded-full h-6 w-6 border-2 border-violet-500 border-t-transparent mr-3">
                  </div>
                  <span class="text-sm text-slate-300 font-medium">Chargement…</span>
                </div>
                <div id="err4" role="alert" aria-live="assertive"
                  class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                  <div class="text-sm text-rose-400 font-medium">Erreur de chargement (cumul).</div>
                  <button type="button"
                    class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                    onclick="window.__retrySU4?.()">Réessayer</button>
                </div>
                <div id="empty4"
                  class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">Aucune donnée
                </div>
              </div>
            </section>
          </section>

          <section id="panelLogins" class="rounded-3xl border border-slate-800 bg-slate-900 p-6 hidden">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-white">Connexions par jour</h2>
              <div class="text-sm text-slate-400 font-mono" id="rangeLabelL"></div>
            </div>
            <div class="relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
              id="chartLWrap">
              <canvas id="chartLogins" class="w-full h-full block"></canvas>
              <div id="ttL"
                class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
              </div>
              <div id="loadL"
                class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-cyan-500 border-t-transparent mr-3"></div>
                <span class="text-sm text-slate-300 font-medium">Chargement…</span>
              </div>
              <div id="errL" role="alert" aria-live="assertive"
                class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                <div class="text-sm text-rose-400 font-medium">Erreur de chargement des connexions.</div>
                <button type="button"
                  class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                  onclick="window.__retryL?.()">Réessayer</button>
              </div>
              <div id="emptyL" class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">
                Aucune donnée</div>
            </div>
            <div class="mt-6">
              <h3 class="text-sm font-medium text-slate-300 mb-3 uppercase tracking-wider text-[10px]">Connexions
                récentes</h3>
              <div id="recentLogins" class="text-xs text-slate-400 grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
          </section>

          <section id="panelBans" class="rounded-3xl border border-slate-800 bg-slate-900 p-6 hidden">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-white">Bans par jour</h2>
              <div class="text-sm text-slate-400 font-mono" id="rangeLabelB"></div>
            </div>
            <div class="relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
              id="chartBWrap">
              <canvas id="chartBans" class="w-full h-full block"></canvas>
              <div id="ttB"
                class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
              </div>
              <div id="loadB"
                class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-rose-500 border-t-transparent mr-3"></div>
                <span class="text-sm text-slate-300 font-medium">Chargement…</span>
              </div>
              <div id="errB" role="alert" aria-live="assertive"
                class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                <div class="text-sm text-rose-400 font-medium">Erreur de chargement des bans.</div>
                <button type="button"
                  class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                  onclick="window.__retryB?.()">Réessayer</button>
              </div>
              <div id="emptyB" class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">
                Aucune donnée</div>
            </div>
            <div class="mt-4 text-xs text-slate-400 flex justify-center gap-4" id="banSummary"></div>
          </section>

          <section id="panelPlinkks" class="rounded-3xl border border-slate-800 bg-slate-900 p-6 hidden">
            <!-- Total Views Card -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Vues Totales (Cumul)</div>
                <div id="plinkkTotalViews" class="text-3xl font-bold text-white tracking-tight">–</div>
              </div>
            </div>

            <!-- Graph -->
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-white">Vues par jour</h2>
              <div class="text-sm text-slate-400 font-mono" id="rangeLabelP"></div>
            </div>
            <div class="relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
              id="chartPWrap">
              <canvas id="chartPlinkks" class="w-full h-full block"></canvas>
              <div id="ttP"
                class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
              </div>
              <div id="loadP"
                class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-violet-500 border-t-transparent mr-3">
                </div>
                <span class="text-sm text-slate-300 font-medium">Chargement…</span>
              </div>
              <div id="errP" role="alert" aria-live="assertive"
                class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                <div class="text-sm text-rose-400 font-medium">Erreur de chargement.</div>
                <button type="button"
                  class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                  onclick="window.__retryP?.()">Réessayer</button>
              </div>
              <div id="emptyP" class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">
                Aucune donnée</div>
            </div>

            <!-- Top Plinkks List -->
            <div class="mt-8">
              <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                <h2 class="text-lg font-semibold text-white">Top Plinkks</h2>
                <div class="flex gap-2">
                  <input type="text" id="plinkkSearch" placeholder="Rechercher..."
                    class="px-3 py-2 rounded-xl bg-slate-950 border border-slate-800 text-sm text-slate-200 focus:border-violet-500 outline-none" />
                  <select id="plinkkSort"
                    class="px-3 py-2 rounded-xl bg-slate-950 border border-slate-800 text-sm text-slate-200 focus:border-violet-500 outline-none">
                    <option value="views-desc">Vues (Desc)</option>
                    <option value="views-asc">Vues (Asc)</option>
                    <option value="name-asc">Nom (A-Z)</option>
                    <option value="name-desc">Nom (Z-A)</option>
                    <option value="createdAt-desc">Récent</option>
                    <option value="createdAt-asc">Ancien</option>
                  </select>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-slate-400">
                  <thead class="bg-slate-950 text-slate-200 uppercase font-medium text-xs">
                    <tr>
                      <th class="px-4 py-3 rounded-l-xl">Plinkk</th>
                      <th class="px-4 py-3">Propriétaire</th>
                      <th class="px-4 py-3 text-right">Vues</th>
                      <th class="px-4 py-3 rounded-r-xl text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="topPlinkksList" class="divide-y divide-slate-800">
                    <!-- Rows injected via JS -->
                  </tbody>
                </table>
              </div>
              <div class="mt-4 flex justify-center gap-2" id="plinkkPagination"></div>
            </div>
          </section>

          <!-- ═══════ PANEL PREMIUM ═══════ -->
          <section id="panelPremium" class="rounded-3xl border border-slate-800 bg-slate-900 p-6 hidden">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Total Premium</div>
                <div id="kpiTotalPremium" class="text-3xl font-bold text-white tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Actifs</div>
                <div id="kpiActivePremium" class="text-2xl font-bold text-emerald-400 tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Expirés</div>
                <div id="kpiExpiredPremium" class="text-2xl font-bold text-rose-400 tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Revenu Total</div>
                <div id="kpiTotalRevenue" class="text-2xl font-bold text-amber-400 tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Achats</div>
                <div id="kpiTotalPurchases" class="text-2xl font-bold text-cyan-400 tracking-tight">–</div>
              </div>
            </div>

            <!-- Achats par type -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4 flex items-center gap-4">
                <div class="h-10 w-10 rounded-xl bg-violet-500/20 flex items-center justify-center"><svg
                    class="w-5 h-5 text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m7.5 4.27 9 5.15" />
                    <path
                      d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                    <path d="m3.3 7 8.7 5 8.7-5" />
                    <path d="M12 22V12" />
                  </svg></div>
                <div>
                  <div class="text-sm text-slate-400">Extra Plinkks vendus</div>
                  <div id="kpiExtraPlinkks" class="text-xl font-bold text-slate-200">–</div>
                </div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4 flex items-center gap-4">
                <div class="h-10 w-10 rounded-xl bg-cyan-500/20 flex items-center justify-center"><svg
                    class="w-5 h-5 text-cyan-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="16 3 21 3 21 8" />
                    <line x1="4" y1="20" x2="21" y2="3" />
                    <polyline points="21 16 21 21 16 21" />
                    <line x1="15" y1="15" x2="21" y2="21" />
                    <line x1="4" y1="4" x2="9" y2="9" />
                  </svg></div>
                <div>
                  <div class="text-sm text-slate-400">Extra Redirections vendues</div>
                  <div id="kpiExtraRedirects" class="text-xl font-bold text-slate-200">–</div>
                </div>
              </div>
            </div>

            <!-- Graphique achats par jour -->
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-white">Achats par jour</h2>
              <div class="text-sm text-slate-400 font-mono" id="rangeLabelPR"></div>
            </div>
            <div class="relative min-h-[300px] bg-slate-950/50 rounded-2xl border border-slate-800/50 p-4"
              id="chartPRWrap">
              <canvas id="chartPremium" class="w-full h-full block"></canvas>
              <div id="ttPR"
                class="hidden absolute px-3 py-2 text-xs rounded-lg bg-slate-800/95 border border-slate-700 text-slate-100 shadow-xl z-10 backdrop-blur-sm pointer-events-none">
              </div>
              <div id="loadPR"
                class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-amber-500 border-t-transparent mr-3">
                </div>
                <span class="text-sm text-slate-300 font-medium">Chargement…</span>
              </div>
              <div id="errPR" role="alert" aria-live="assertive"
                class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                <div class="text-sm text-rose-400 font-medium">Erreur de chargement.</div>
                <button type="button"
                  class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                  onclick="window.__retryPR?.()">Réessayer</button>
              </div>
              <div id="emptyPR" class="hidden absolute inset-0 flex items-center justify-center text-sm text-slate-500">
                Aucune donnée</div>
            </div>
            <div class="mt-4 flex items-center gap-4 text-sm text-slate-400 justify-center">
              <span
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                  class="inline-block w-2.5 h-2.5 rounded-full bg-violet-500"></span>Extra Plinkks</span>
              <span
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-950 border border-slate-800"><span
                  class="inline-block w-2.5 h-2.5 rounded-full bg-cyan-500"></span>Extra Redirections</span>
            </div>
          </section>

          <!-- ═══════ PANEL COMPTES ═══════ -->
          <section id="panelAccounts" class="rounded-3xl border border-slate-800 bg-slate-900 p-6 hidden">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Total Utilisateurs</div>
                <div id="kpiTotalUsersAcc" class="text-3xl font-bold text-white tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Avec mot de passe</div>
                <div id="kpiWithPassword" class="text-2xl font-bold text-emerald-400 tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">OAuth uniquement</div>
                <div id="kpiOAuthOnly" class="text-2xl font-bold text-amber-400 tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">A2F activée</div>
                <div id="kpiWith2FA" class="text-2xl font-bold text-emerald-400 tracking-tight">–</div>
              </div>
              <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4">
                <div class="text-sm text-slate-400 mb-1">Sans A2F</div>
                <div id="kpiWithout2FA" class="text-2xl font-bold text-rose-400 tracking-tight">–</div>
              </div>
            </div>

            <!-- Doughnut chart -->
            <h2 class="text-lg font-semibold text-white mb-4">Méthodes de connexion</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div
                class="relative bg-slate-950/50 rounded-2xl border border-slate-800/50 p-6 flex items-center justify-center"
                style="min-height:320px" id="doughnutWrap">
                <canvas id="chartDoughnut" width="280" height="280"></canvas>
                <div id="loadACC"
                  class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/20 backdrop-blur-[1px] rounded-2xl">
                  <div class="animate-spin rounded-full h-6 w-6 border-2 border-violet-500 border-t-transparent mr-3">
                  </div>
                  <span class="text-sm text-slate-300 font-medium">Chargement…</span>
                </div>
                <div id="errACC" role="alert" aria-live="assertive"
                  class="hidden absolute inset-0 flex flex-col items-center justify-center gap-3 bg-slate-900/60 rounded-2xl">
                  <div class="text-sm text-rose-400 font-medium">Erreur de chargement.</div>
                  <button type="button"
                    class="px-3 py-1.5 text-xs rounded-lg bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 transition-colors"
                    onclick="window.__retryACC?.()">Réessayer</button>
                </div>
              </div>
              <div id="providerDetails" class="space-y-3">
                <!-- Filled by JS -->
              </div>
            </div>
          </section>
        </main>
    </div>

    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        function activateTab(which) {
          const tabs = { signups: $('#tabSignups'), logins: $('#tabLogins'), bans: $('#tabBans'), plinkks: $('#tabPlinkks'), premium: $('#tabPremium'), accounts: $('#tabAccounts') };
          const panels = { signups: $('#panelSignups'), logins: $('#panelLogins'), bans: $('#panelBans'), plinkks: $('#panelPlinkks'), premium: $('#panelPremium'), accounts: $('#panelAccounts') };
          Object.entries(tabs).forEach(([k, btn]) => {
            if (!btn) return; const active = k === which; btn.setAttribute('aria-selected', active ? 'true' : 'false');
            btn.classList.toggle('bg-violet-600', active); btn.classList.toggle('text-white', active);
            btn.classList.toggle('bg-slate-800', !active); btn.classList.toggle('text-slate-300', !active); btn.classList.toggle('border', !active); btn.classList.toggle('border-slate-700', !active);
          });
          Object.entries(panels).forEach(([k, el]) => { if (el) el.classList.toggle('hidden', k !== which); });
          scheduleRerender();
        }
        $('#tabSignups').addEventListener('click', () => { activateTab('signups'); });
        $('#tabLogins').addEventListener('click', () => { activateTab('logins'); applyLogins(); });
        $('#tabBans').addEventListener('click', () => { activateTab('bans'); applyBans(); });
        $('#tabPlinkks').addEventListener('click', () => { activateTab('plinkks'); applyPlinkks(); });
        $('#tabPremium').addEventListener('click', () => { activateTab('premium'); applyPremium(); });
        $('#tabAccounts').addEventListener('click', () => { activateTab('accounts'); applyAccounts(); });
        activateTab('signups');

        let currentSub = 'su1';
        function activateSub(which) {
          const tabs = { su1: $('#tabSU1'), su2: $('#tabSU2'), su3: $('#tabSU3'), su4: $('#tabSU4') };
          const sections = { su1: $('#su1'), su2: $('#su2'), su3: $('#su3'), su4: $('#su4') };
          Object.entries(tabs).forEach(([k, btn]) => {
            if (!btn) return; const active = k === which; btn.setAttribute('aria-selected', active ? 'true' : 'false');
            btn.classList.toggle('bg-violet-600', active); btn.classList.toggle('text-white', active);
            btn.classList.toggle('bg-slate-800', !active); btn.classList.toggle('text-slate-300', !active); btn.classList.toggle('border', !active); btn.classList.toggle('border-slate-700', !active);
          });
          Object.entries(sections).forEach(([k, el]) => { if (el) el.classList.toggle('hidden', k !== which); });
          currentSub = which;
          scheduleRerender();
        }
        $('#tabSU1')?.addEventListener('click', () => activateSub('su1'));
        $('#tabSU2')?.addEventListener('click', () => activateSub('su2'));
        $('#tabSU3')?.addEventListener('click', () => activateSub('su3'));
        $('#tabSU4')?.addEventListener('click', () => activateSub('su4'));
        activateSub('su1');

        function scheduleRerender() {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              const isSignupsVisible = !document.getElementById('panelSignups')?.classList.contains('hidden');
              if (isSignupsVisible) {
                rerenderCurrentSub();
              }
              const isLoginsVisible = !document.getElementById('panelLogins')?.classList.contains('hidden');
              if (isLoginsVisible) {
                if (seriesL && seriesL.length) { renderChartL({ series: seriesL }, hoverIndexL); }
              }
              const isBansVisible = !document.getElementById('panelBans')?.classList.contains('hidden');
              if (isBansVisible) {
                if (seriesB && seriesB.length) { renderChartB({ series: seriesB }, hoverIndexB); }
              }
              const isPlinkksVisible = !document.getElementById('panelPlinkks')?.classList.contains('hidden');
              if (isPlinkksVisible) {
                if (seriesP && seriesP.length) { renderChartP({ series: seriesP }, hoverIndexP); }
              }
              const isPremiumVisible = !document.getElementById('panelPremium')?.classList.contains('hidden');
              if (isPremiumVisible) {
                if (seriesPR && seriesPR.length) { renderChartPR({ series: seriesPR }, hoverIndexPR); }
              }
            });
          });
        }

        function rerenderCurrentSub() {
          switch (currentSub) {
            case 'su1':
              if (lastSeries && lastSeries.length) { renderChart(lastSeries, hoverIndex1); }
              break;
            case 'su2':
              if (series2 && series2.length) { renderChart2({ series: series2 }, hoverIndex2); }
              break;
            case 'su3':
              if (series3 && series3.length) { renderChart3({ series: series3 }, hoverIndex3); }
              break;
            case 'su4':
              if (series4 && series4.length) { renderChart4(series4, hoverIndex4); }
              break;
          }
        }

        function fmtDate(d) { const y = d.getUTCFullYear(); const m = String(d.getUTCMonth() + 1).padStart(2, '0'); const dd = String(d.getUTCDate()).padStart(2, '0'); return `${y}-${m}-${dd}`; }
        function setRange(days) { const to = new Date(); const from = new Date(to.getTime() - (days - 1) * 86400000); $('#from').value = fmtDate(from); $('#to').value = fmtDate(to); }
        if (!$('#from').value || !$('#to').value) setRange(30);

        const ctx = $('#chart').getContext('2d');
        const wrap1 = document.getElementById('chart1Wrap');
        const tt1 = document.getElementById('tt1');
        let lastSeries = [];
        let hoverIndex1 = -1;
        function renderChart(series, hoverIndex = -1) {
          lastSeries = Array.isArray(series) ? series : [];
          hoverIndex1 = hoverIndex;
          const labels = lastSeries.map(p => p.date);
          const data = lastSeries.map(p => p.count);

          const dpr = window.devicePixelRatio || 1;
          const cssW = ctx.canvas.clientWidth;
          const cssH = 260;
          ctx.canvas.width = Math.max(1, Math.floor(cssW * dpr));
          ctx.canvas.height = Math.floor(cssH * dpr);
          const w = ctx.canvas.width;
          const h = ctx.canvas.height;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          ctx.clearRect(0, 0, cssW, cssH);

          const padL = 40;
          const padB = 28;
          const padT = 10; const padR = 10;
          const innerW = cssW - padL - padR;
          const innerH = cssH - padT - padB;

          const maxVal = Math.max(1, ...data);
          const yTicks = 5;
          const stepY = Math.max(1, Math.ceil(maxVal / yTicks));
          const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = data.length > 1 ? (innerW / (data.length - 1)) : 0;
          const scaleY = innerH / maxRounded;

          ctx.strokeStyle = 'rgba(148,163,184,0.35)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(padL, padT);
          ctx.lineTo(padL, padT + innerH);
          ctx.lineTo(padL + innerW, padT + innerH);
          ctx.stroke();

          ctx.fillStyle = 'rgba(148,163,184,0.7)';
          ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          ctx.textAlign = 'right';
          ctx.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) {
            const py = padT + innerH - y * scaleY;
            ctx.strokeStyle = 'rgba(148,163,184,0.15)';
            ctx.beginPath(); ctx.moveTo(padL, py); ctx.lineTo(padL + innerW, py); ctx.stroke();
            ctx.fillStyle = 'rgba(148,163,184,0.7)';
            ctx.fillText(String(y), padL - 6, py);
          }

          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => {
            if (i % xLabelEvery !== 0 && i !== labels.length - 1) return;
            const x = padL + i * stepX;
            ctx.strokeStyle = 'rgba(148,163,184,0.15)';
            ctx.beginPath(); ctx.moveTo(x, padT + innerH); ctx.lineTo(x, padT + innerH + 4); ctx.stroke();
            const shortLab = lab?.slice(5) || '';
            ctx.fillStyle = 'rgba(148,163,184,0.7)';
            ctx.fillText(shortLab, x, padT + innerH + 6);
          });

          ctx.strokeStyle = '#7c3aed';
          ctx.lineWidth = 2;
          ctx.beginPath();
          data.forEach((v, i) => {
            const x = padL + i * stepX;
            const y = padT + innerH - v * scaleY;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
          });
          ctx.stroke();

          ctx.fillStyle = '#a78bfa';
          data.forEach((v, i) => {
            const x = padL + i * stepX;
            const y = padT + innerH - v * scaleY;
            ctx.beginPath(); ctx.arc(x, y, 2.5, 0, Math.PI * 2); ctx.fill();
          });

          if (hoverIndex >= 0 && hoverIndex < data.length) {
            const x = padL + hoverIndex * stepX;
            const y = padT + innerH - data[hoverIndex] * scaleY;
            ctx.strokeStyle = 'rgba(124, 58, 237, 0.35)';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(x, padT); ctx.lineTo(x, padT + innerH); ctx.stroke();
            ctx.fillStyle = '#c4b5fd';
            ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill();
            const rect = wrap1.getBoundingClientRect();
            tt1.textContent = `${labels[hoverIndex]} — ${data[hoverIndex]} inscrits`;
            const ttX = Math.min(rect.width - 140, Math.max(8, x + 8));
            const ttY = Math.max(8, y - 10);
            tt1.style.left = ttX + 'px';
            tt1.style.top = ttY + 'px';
            tt1.classList.remove('hidden');
          } else {
            tt1.classList.add('hidden');
          }

          ctx.fillStyle = 'rgba(148,163,184,0.9)';
          ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          ctx.textAlign = 'right'; ctx.textBaseline = 'alphabetic';
          ctx.fillText('Date', padL + innerW, padT + innerH + 24);
          ctx.save();
          ctx.translate(12, padT + innerH / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.textAlign = 'center'; ctx.textBaseline = 'top';
          ctx.fillText('Utilisateurs', 0, 0);
          ctx.restore();
        }

        async function fetchSeries() {
          const q = new URLSearchParams({
            from: $('#from').value,
            to: $('#to').value,
          });
          const res = await fetch(`/admin/stats/users/series?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        }
        async function fetchSummary() {
          const q = new URLSearchParams({ from: $('#from').value, to: $('#to').value });
          const res = await fetch(`/admin/stats/users/summary?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        }
        async function fetchLoginsSeries() {
          const q = new URLSearchParams({ from: $('#from').value, to: $('#to').value });
          const res = await fetch(`/admin/stats/logins/series?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }
        async function fetchRecentLogins() {
          const res = await fetch(`/admin/stats/logins/recent?limit=20`);
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }
        async function fetchBansSeries() {
          const q = new URLSearchParams({ from: $('#from').value, to: $('#to').value });
          const res = await fetch(`/admin/stats/bans/series?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }

        async function fetchPlinkksSeries() {
          const q = new URLSearchParams({ from: $('#from').value, to: $('#to').value });
          const res = await fetch(`/admin/stats/plinkks/series?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }
        async function fetchPlinkksTotal() {
          const res = await fetch(`/admin/stats/plinkks/total`);
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }
        async function fetchTopPlinkks(page = 1, limit = 20, sort = 'views', order = 'desc', search = '') {
          const q = new URLSearchParams({ page, limit, sort, order, search });
          const res = await fetch(`/admin/stats/plinkks/top?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }


        async function fetchSeriesByVisibility() {
          const q = new URLSearchParams({ from: $('#from').value, to: $('#to').value });
          const res = await fetch(`/admin/stats/users/series/by-visibility?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        }

        async function fetchSeriesByRole() {
          const q = new URLSearchParams({ from: $('#from').value, to: $('#to').value });
          const res = await fetch(`/admin/stats/users/series/by-role?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        }

        function makeCumul(series) {
          let run = 0; return (series || []).map(p => { run += (p.count || 0); return { date: p.date, count: run }; });
        }

        const ctx2 = document.getElementById('chartVisibility').getContext('2d');
        const wrap2 = document.getElementById('chart2Wrap');
        const tt2 = document.getElementById('tt2');
        let series2 = [];
        let hoverIndex2 = -1;
        function renderChart2(payload, hoverIndex = -1) {
          series2 = Array.isArray(payload?.series) ? payload.series : [];
          hoverIndex2 = hoverIndex;
          const labels = series2.map(p => p.date);
          const pub = series2.map(p => p.public || 0);
          const pri = series2.map(p => p.private || 0);

          const dpr = window.devicePixelRatio || 1;
          const cssW = ctx2.canvas.clientWidth; const cssH = 260;
          ctx2.canvas.width = Math.max(1, Math.floor(cssW * dpr)); ctx2.canvas.height = Math.floor(cssH * dpr);
          ctx2.setTransform(dpr, 0, 0, dpr, 0, 0); ctx2.clearRect(0, 0, cssW, cssH);

          const padL = 40, padB = 28, padT = 10, padR = 10; const innerW = cssW - padL - padR, innerH = cssH - padT - padB;
          const maxVal = Math.max(1, ...pub, ...pri);
          const yTicks = 5, stepY = Math.max(1, Math.ceil(maxVal / yTicks)); const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = pub.length > 1 ? innerW / (pub.length - 1) : 0; const scaleY = innerH / maxRounded;

          ctx2.strokeStyle = 'rgba(148,163,184,0.35)'; ctx2.lineWidth = 1; ctx2.beginPath(); ctx2.moveTo(padL, padT); ctx2.lineTo(padL, padT + innerH); ctx2.lineTo(padL + innerW, padT + innerH); ctx2.stroke();
          ctx2.fillStyle = 'rgba(148,163,184,0.7)'; ctx2.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx2.textAlign = 'right'; ctx2.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) { const py = padT + innerH - y * scaleY; ctx2.strokeStyle = 'rgba(148,163,184,0.15)'; ctx2.beginPath(); ctx2.moveTo(padL, py); ctx2.lineTo(padL + innerW, py); ctx2.stroke(); ctx2.fillText(String(y), padL - 6, py); }
          ctx2.textAlign = 'center'; ctx2.textBaseline = 'top'; const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => { if (i % xLabelEvery !== 0 && i !== labels.length - 1) return; const x = padL + i * stepX; ctx2.strokeStyle = 'rgba(148,163,184,0.15)'; ctx2.beginPath(); ctx2.moveTo(x, padT + innerH); ctx2.lineTo(x, padT + innerH + 4); ctx2.stroke(); ctx2.fillText(lab?.slice(5) || '', x, padT + innerH + 6); });

          function drawLine(data, color) { ctx2.strokeStyle = color; ctx2.lineWidth = 2; ctx2.beginPath(); data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; if (i === 0) ctx2.moveTo(x, y); else ctx2.lineTo(x, y); }); ctx2.stroke(); }
          drawLine(pub, '#10b981');
          drawLine(pri, '#f43f5e');

          function drawDots(data, color) { ctx2.fillStyle = color; data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; ctx2.beginPath(); ctx2.arc(x, y, 2.5, 0, Math.PI * 2); ctx2.fill(); }); }
          drawDots(pub, '#34d399'); drawDots(pri, '#fb7185');

          if (hoverIndex >= 0 && hoverIndex < labels.length) {
            const x = padL + hoverIndex * stepX; ctx2.strokeStyle = 'rgba(148,163,184,0.35)'; ctx2.beginPath(); ctx2.moveTo(x, padT); ctx2.lineTo(x, padT + innerH); ctx2.stroke();
            const rect = wrap2.getBoundingClientRect();
            const ttX = Math.min(rect.width - 160, Math.max(8, x + 8)); const ttY = 14;
            tt2.innerHTML = `<div class="font-medium text-slate-100">${labels[hoverIndex]}</div><div><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#10b981"></span>Public: <b>${pub[hoverIndex]}</b></div><div><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#f43f5e"></span>Privé: <b>${pri[hoverIndex]}</b></div>`;
            tt2.style.left = ttX + 'px'; tt2.style.top = ttY + 'px'; tt2.classList.remove('hidden');
          } else { tt2.classList.add('hidden'); }
        }

        const ctx3 = document.getElementById('chartRoles').getContext('2d');
        const wrap3 = document.getElementById('chart3Wrap');
        const tt3 = document.getElementById('tt3');
        let series3 = []; let hoverIndex3 = -1;
        function renderChart3(payload, hoverIndex = -1) {
          series3 = Array.isArray(payload?.series) ? payload.series : [];
          hoverIndex3 = hoverIndex;
          const labels = series3.map(p => p.date);
          const roleKeys = (() => {
            const first = series3[0] || {};
            return Object.keys(first).filter(k => k !== 'date');
          })();
          const palette = ['#94a3b8', '#f59e0b', '#10b981', '#f43f5e', '#6366f1', '#06b6d4', '#22c55e', '#eab308', '#ef4444'];
          const colors = roleKeys.map((_, i) => palette[i % palette.length]);
          const dsets = roleKeys.map(r => series3.map(p => p[r] || 0));

          const dpr = window.devicePixelRatio || 1; const cssW = ctx3.canvas.clientWidth; const cssH = 280;
          ctx3.canvas.width = Math.max(1, Math.floor(cssW * dpr)); ctx3.canvas.height = Math.floor(cssH * dpr);
          ctx3.setTransform(dpr, 0, 0, dpr, 0, 0); ctx3.clearRect(0, 0, cssW, cssH);
          const padL = 40, padB = 28, padT = 10, padR = 10; const innerW = cssW - padL - padR, innerH = cssH - padT - padB;
          const maxVal = Math.max(1, ...dsets.flat());
          const yTicks = 5, stepY = Math.max(1, Math.ceil(maxVal / yTicks)); const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = labels.length > 1 ? innerW / (labels.length - 1) : 0; const scaleY = innerH / maxRounded;
          ctx3.strokeStyle = 'rgba(148,163,184,0.35)'; ctx3.lineWidth = 1; ctx3.beginPath(); ctx3.moveTo(padL, padT); ctx3.lineTo(padL, padT + innerH); ctx3.lineTo(padL + innerW, padT + innerH); ctx3.stroke();
          ctx3.fillStyle = 'rgba(148,163,184,0.7)'; ctx3.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctx3.textAlign = 'right'; ctx3.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) { const py = padT + innerH - y * scaleY; ctx3.strokeStyle = 'rgba(148,163,184,0.15)'; ctx3.beginPath(); ctx3.moveTo(padL, py); ctx3.lineTo(padL + innerW, py); ctx3.stroke(); ctx3.fillText(String(y), padL - 6, py); }
          ctx3.textAlign = 'center'; ctx3.textBaseline = 'top'; const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => { if (i % xLabelEvery !== 0 && i !== labels.length - 1) return; const x = padL + i * stepX; ctx3.strokeStyle = 'rgba(148,163,184,0.15)'; ctx3.beginPath(); ctx3.moveTo(x, padT + innerH); ctx3.lineTo(x, padT + innerH + 4); ctx3.stroke(); ctx3.fillText(lab?.slice(5) || '', x, padT + innerH + 6); });
          dsets.forEach((arr, idx) => { const color = colors[idx]; ctx3.strokeStyle = color; ctx3.lineWidth = 2; ctx3.beginPath(); arr.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; if (i === 0) ctx3.moveTo(x, y); else ctx3.lineTo(x, y); }); ctx3.stroke(); ctx3.fillStyle = color; arr.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; ctx3.beginPath(); ctx3.arc(x, y, 2.3, 0, Math.PI * 2); ctx3.fill(); }); });
          if (hoverIndex >= 0 && hoverIndex < labels.length) {
            const x = padL + hoverIndex * stepX; ctx3.strokeStyle = 'rgba(148,163,184,0.35)'; ctx3.beginPath(); ctx3.moveTo(x, padT); ctx3.lineTo(x, padT + innerH); ctx3.stroke();
            const rect = wrap3.getBoundingClientRect(); const ttX = Math.min(rect.width - 180, Math.max(8, x + 8)); const ttY = 14;
            const rows = roleKeys.map((r, i) => `<div><span class=\"inline-block w-2 h-2 rounded-full mr-1\" style=\"background:${colors[i]}\"></span>${r}: <b>${dsets[i][hoverIndex]}</b></div>`).join('');
            tt3.innerHTML = `<div class=\"font-medium text-slate-100\">${labels[hoverIndex]}</div>${rows}`;
            tt3.style.left = ttX + 'px'; tt3.style.top = ttY + 'px'; tt3.classList.remove('hidden');
          } else { tt3.classList.add('hidden'); }
        }

        const ctxL = document.getElementById('chartLogins')?.getContext('2d');
        const wrapL = document.getElementById('chartLWrap');
        const ttL = document.getElementById('ttL');
        let seriesL = []; let hoverIndexL = -1;
        function renderChartL(payload, hoverIndex = -1) {
          if (!ctxL) return; seriesL = payload?.series || []; hoverIndexL = hoverIndex;
          const labels = seriesL.map(p => p.date); const data = seriesL.map(p => p.count || 0);
          const dpr = window.devicePixelRatio || 1; const cssW = ctxL.canvas.clientWidth; const cssH = 260;
          ctxL.canvas.width = Math.max(1, Math.floor(cssW * dpr)); ctxL.canvas.height = Math.floor(cssH * dpr); ctxL.setTransform(dpr, 0, 0, dpr, 0, 0); ctxL.clearRect(0, 0, cssW, cssH);
          const padL = 40, padB = 28, padT = 10, padR = 10; const innerW = cssW - padL - padR, innerH = cssH - padT - padB;
          const maxVal = Math.max(1, ...data); const yTicks = 5, stepY = Math.max(1, Math.ceil(maxVal / yTicks)); const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = data.length > 1 ? innerW / (data.length - 1) : 0; const scaleY = innerH / maxRounded;
          ctxL.strokeStyle = 'rgba(148,163,184,0.35)'; ctxL.lineWidth = 1; ctxL.beginPath(); ctxL.moveTo(padL, padT); ctxL.lineTo(padL, padT + innerH); ctxL.lineTo(padL + innerW, padT + innerH); ctxL.stroke();
          ctxL.fillStyle = 'rgba(148,163,184,0.7)'; ctxL.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctxL.textAlign = 'right'; ctxL.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) { const py = padT + innerH - y * scaleY; ctxL.strokeStyle = 'rgba(148,163,184,0.15)'; ctxL.beginPath(); ctxL.moveTo(padL, py); ctxL.lineTo(padL + innerW, py); ctxL.stroke(); ctxL.fillText(String(y), padL - 6, py); }
          ctxL.textAlign = 'center'; ctxL.textBaseline = 'top'; const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => { if (i % xLabelEvery !== 0 && i !== labels.length - 1) return; const x = padL + i * stepX; ctxL.strokeStyle = 'rgba(148,163,184,0.15)'; ctxL.beginPath(); ctxL.moveTo(x, padT + innerH); ctxL.lineTo(x, padT + innerH + 4); ctxL.stroke(); ctxL.fillText(lab?.slice(5) || '', x, padT + innerH + 6); });
          ctxL.strokeStyle = '#3b82f6'; ctxL.lineWidth = 2; ctxL.beginPath(); data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; if (i === 0) ctxL.moveTo(x, y); else ctxL.lineTo(x, y); }); ctxL.stroke();
          ctxL.fillStyle = '#93c5fd'; data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; ctxL.beginPath(); ctxL.arc(x, y, 2.5, 0, Math.PI * 2); ctxL.fill(); });
          if (hoverIndex >= 0 && hoverIndex < labels.length) { const x = padL + hoverIndex * stepX; const y = padT + innerH - data[hoverIndex] * scaleY; ctxL.strokeStyle = 'rgba(59, 130, 246, 0.35)'; ctxL.beginPath(); ctxL.moveTo(x, padT); ctxL.lineTo(x, padT + innerH); ctxL.stroke(); ctxL.fillStyle = '#dbeafe'; ctxL.beginPath(); ctxL.arc(x, y, 4, 0, Math.PI * 2); ctxL.fill(); const rect = wrapL.getBoundingClientRect(); const ttX = Math.min(rect.width - 140, Math.max(8, x + 8)); const ttY = Math.max(8, y - 10); ttL.textContent = `${labels[hoverIndex]} — ${data[hoverIndex]} connexions`; ttL.style.left = ttX + 'px'; ttL.style.top = ttY + 'px'; ttL.classList.remove('hidden'); } else { ttL.classList.add('hidden'); }
        }


        const ctxB = document.getElementById('chartBans')?.getContext('2d');
        const wrapB = document.getElementById('chartBWrap');
        const ttB = document.getElementById('ttB');
        let seriesB = []; let hoverIndexB = -1;
        function renderChartB(payload, hoverIndex = -1) {
          if (!ctxB) return; seriesB = payload?.series || []; hoverIndexB = hoverIndex;
          const labels = seriesB.map(p => p.date); const created = seriesB.map(p => p.created || 0); const revoked = seriesB.map(p => p.revoked || 0);
          const dpr = window.devicePixelRatio || 1; const cssW = ctxB.canvas.clientWidth; const cssH = 260; ctxB.canvas.width = Math.max(1, Math.floor(cssW * dpr)); ctxB.canvas.height = Math.floor(cssH * dpr); ctxB.setTransform(dpr, 0, 0, dpr, 0, 0); ctxB.clearRect(0, 0, cssW, cssH);
          const padL = 40, padB = 28, padT = 10, padR = 10; const innerW = cssW - padL - padR, innerH = cssH - padT - padB;
          const maxVal = Math.max(1, ...created, ...revoked); const yTicks = 5, stepY = Math.max(1, Math.ceil(maxVal / yTicks)); const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = labels.length > 1 ? innerW / (labels.length - 1) : 0; const scaleY = innerH / maxRounded;
          ctxB.strokeStyle = 'rgba(148,163,184,0.35)'; ctxB.lineWidth = 1; ctxB.beginPath(); ctxB.moveTo(padL, padT); ctxB.lineTo(padL, padT + innerH); ctxB.lineTo(padL + innerW, padT + innerH); ctxB.stroke();
          ctxB.fillStyle = 'rgba(148,163,184,0.7)'; ctxB.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctxB.textAlign = 'right'; ctxB.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) { const py = padT + innerH - y * scaleY; ctxB.strokeStyle = 'rgba(148,163,184,0.15)'; ctxB.beginPath(); ctxB.moveTo(padL, py); ctxB.lineTo(padL + innerW, py); ctxB.stroke(); ctxB.fillText(String(y), padL - 6, py); }
          ctxB.textAlign = 'center'; ctxB.textBaseline = 'top'; const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => { if (i % xLabelEvery !== 0 && i !== labels.length - 1) return; const x = padL + i * stepX; ctxB.strokeStyle = 'rgba(148,163,184,0.15)'; ctxB.beginPath(); ctxB.moveTo(x, padT + innerH); ctxB.lineTo(x, padT + innerH + 4); ctxB.stroke(); ctxB.fillText(lab?.slice(5) || '', x, padT + innerH + 6); });
          function drawLine(data, color) { ctxB.strokeStyle = color; ctxB.lineWidth = 2; ctxB.beginPath(); data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; if (i === 0) ctxB.moveTo(x, y); else ctxB.lineTo(x, y); }); ctxB.stroke(); }
          drawLine(created, '#ef4444'); drawLine(revoked, '#22c55e');
          function drawDots(data, color) { ctxB.fillStyle = color; data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; ctxB.beginPath(); ctxB.arc(x, y, 2.3, 0, Math.PI * 2); ctxB.fill(); }); }
          drawDots(created, '#f87171'); drawDots(revoked, '#86efac');
          if (hoverIndex >= 0 && hoverIndex < labels.length) { const x = padL + hoverIndex * stepX; ctxB.strokeStyle = 'rgba(148,163,184,0.35)'; ctxB.beginPath(); ctxB.moveTo(x, padT); ctxB.lineTo(x, padT + innerH); ctxB.stroke(); const rect = wrapB.getBoundingClientRect(); const ttX = Math.min(rect.width - 170, Math.max(8, x + 8)); const ttY = 14; ttB.innerHTML = `<div class='font-medium text-slate-100'>${labels[hoverIndex]}</div><div><span class='inline-block w-2 h-2 rounded-full mr-1' style='background:#ef4444'></span>Créés: <b>${created[hoverIndex]}</b></div><div><span class='inline-block w-2 h-2 rounded-full mr-1' style='background:#22c55e'></span>Révoqués: <b>${revoked[hoverIndex]}</b></div>`; ttB.style.left = ttX + 'px'; ttB.style.top = ttY + 'px'; ttB.classList.remove('hidden'); } else { ttB.classList.add('hidden'); }
        }

        const ctxP = document.getElementById('chartPlinkks')?.getContext('2d');
        const wrapP = document.getElementById('chartPWrap');
        const ttP = document.getElementById('ttP');
        let seriesP = []; let hoverIndexP = -1;
        function renderChartP(payload, hoverIndex = -1) {
          if (!ctxP) return; seriesP = payload?.series || []; hoverIndexP = hoverIndex;
          const labels = seriesP.map(p => p.date); const data = seriesP.map(p => p.count || 0);
          const dpr = window.devicePixelRatio || 1; const cssW = ctxP.canvas.clientWidth; const cssH = 260;
          ctxP.canvas.width = Math.max(1, Math.floor(cssW * dpr)); ctxP.canvas.height = Math.floor(cssH * dpr); ctxP.setTransform(dpr, 0, 0, dpr, 0, 0); ctxP.clearRect(0, 0, cssW, cssH);
          const padL = 40, padB = 28, padT = 10, padR = 10; const innerW = cssW - padL - padR, innerH = cssH - padT - padB;
          const maxVal = Math.max(1, ...data); const yTicks = 5, stepY = Math.max(1, Math.ceil(maxVal / yTicks)); const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = data.length > 1 ? innerW / (data.length - 1) : 0; const scaleY = innerH / maxRounded;
          ctxP.strokeStyle = 'rgba(148,163,184,0.35)'; ctxP.lineWidth = 1; ctxP.beginPath(); ctxP.moveTo(padL, padT); ctxP.lineTo(padL, padT + innerH); ctxP.lineTo(padL + innerW, padT + innerH); ctxP.stroke();
          ctxP.fillStyle = 'rgba(148,163,184,0.7)'; ctxP.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctxP.textAlign = 'right'; ctxP.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) { const py = padT + innerH - y * scaleY; ctxP.strokeStyle = 'rgba(148,163,184,0.15)'; ctxP.beginPath(); ctxP.moveTo(padL, py); ctxP.lineTo(padL + innerW, py); ctxP.stroke(); ctxP.fillText(String(y), padL - 6, py); }
          ctxP.textAlign = 'center'; ctxP.textBaseline = 'top'; const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => { if (i % xLabelEvery !== 0 && i !== labels.length - 1) return; const x = padL + i * stepX; ctxP.strokeStyle = 'rgba(148,163,184,0.15)'; ctxP.beginPath(); ctxP.moveTo(x, padT + innerH); ctxP.lineTo(x, padT + innerH + 4); ctxP.stroke(); ctxP.fillText(lab?.slice(5) || '', x, padT + innerH + 6); });
          ctxP.strokeStyle = '#8b5cf6'; ctxP.lineWidth = 2; ctxP.beginPath(); data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; if (i === 0) ctxP.moveTo(x, y); else ctxP.lineTo(x, y); }); ctxP.stroke();
          ctxP.fillStyle = '#a78bfa'; data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; ctxP.beginPath(); ctxP.arc(x, y, 2.5, 0, Math.PI * 2); ctxP.fill(); });
          if (hoverIndex >= 0 && hoverIndex < labels.length) { const x = padL + hoverIndex * stepX; const y = padT + innerH - data[hoverIndex] * scaleY; ctxP.strokeStyle = 'rgba(139, 92, 246, 0.35)'; ctxP.beginPath(); ctxP.moveTo(x, padT); ctxP.lineTo(x, padT + innerH); ctxP.stroke(); ctxP.fillStyle = '#ddd6fe'; ctxP.beginPath(); ctxP.arc(x, y, 4, 0, Math.PI * 2); ctxP.fill(); const rect = wrapP.getBoundingClientRect(); const ttX = Math.min(rect.width - 140, Math.max(8, x + 8)); const ttY = Math.max(8, y - 10); ttP.textContent = `${labels[hoverIndex]} — ${data[hoverIndex]} vues`; ttP.style.left = ttX + 'px'; ttP.style.top = ttY + 'px'; ttP.classList.remove('hidden'); } else { ttP.classList.add('hidden'); }
        }

        let plinkkPage = 1;
        let plinkkSort = 'views-desc';
        let plinkkSearch = '';

        async function applyPlinkks() {
          try {
            document.getElementById('loadP')?.classList.remove('hidden');
            document.getElementById('errP')?.classList.add('hidden');
            document.getElementById('emptyP')?.classList.add('hidden');

            const [seriesPayload, totalPayload, topPayload] = await Promise.all([
              fetchPlinkksSeries(),
              fetchPlinkksTotal(),
              fetchTopPlinkks(plinkkPage, 20, plinkkSort.split('-')[0], plinkkSort.split('-')[1], plinkkSearch)
            ]);

            $('#rangeLabelP').textContent = `${seriesPayload.from} → ${seriesPayload.to}`;
            renderChartP(seriesPayload);

            if (!(seriesPayload.series || []).length) {
              document.getElementById('emptyP')?.classList.remove('hidden');
            }

            $('#plinkkTotalViews').textContent = totalPayload.total;

            const list = document.getElementById('topPlinkksList');
            if (list) {
              list.innerHTML = (topPayload.plinkks || []).map((p, i) => `
                  <tr class="hover:bg-slate-800/50 transition-colors">
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-3">
                        <span class="text-slate-500 font-mono text-xs w-6">${(plinkkPage - 1) * 20 + i + 1}</span>
                        <div>
                          <div class="font-medium text-slate-200">${p.name || p.slug}</div>
                          <div class="text-xs text-slate-500">/${p.slug}</div>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-2">
                        <div class="h-6 w-6 rounded-full bg-slate-800 overflow-hidden">
                          ${p.user?.image ? `<img src="${p.user.image}" class="h-full w-full object-cover">` : `<div class="h-full w-full flex items-center justify-center text-slate-500 text-[10px]">${p.user?.userName?.substring(0, 2).toUpperCase()}</div>`}
                        </div>
                        <span class="text-slate-300">${p.user?.userName}</span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-right font-mono text-slate-300">${p.views}</td>
                    <td class="px-4 py-3 text-right">
                      <a href="https://plinkk.fr/${p.slug}" target="_blank" class="text-violet-400 hover:text-violet-300 text-xs font-medium">Voir</a>
                    </td>
                  </tr>
                `).join('');
            }

            // Pagination simple
            const totalPages = Math.ceil(topPayload.total / 20);
            const pag = document.getElementById('plinkkPagination');
            if (pag) {
              pag.innerHTML = `
                  <button ${plinkkPage <= 1 ? 'disabled' : ''} onclick="window.__changePlinkkPage(${plinkkPage - 1})" class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-slate-300 disabled:opacity-50 hover:bg-slate-700">Précédent</button>
                  <span class="px-3 py-1 text-slate-400 text-sm">Page ${plinkkPage} / ${totalPages}</span>
                  <button ${plinkkPage >= totalPages ? 'disabled' : ''} onclick="window.__changePlinkkPage(${plinkkPage + 1})" class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-slate-300 disabled:opacity-50 hover:bg-slate-700">Suivant</button>
                `;
            }

          } catch (e) {
            console.error(e);
            document.getElementById('errP')?.classList.remove('hidden');
          } finally {
            document.getElementById('loadP')?.classList.add('hidden');
          }
        }

        window.__changePlinkkPage = (p) => {
          plinkkPage = p;
          applyPlinkks();
        };

        $('#plinkkSort')?.addEventListener('change', (e) => {
          plinkkSort = e.target.value;
          plinkkPage = 1;
          applyPlinkks();
        });

        let searchTimeout;
        $('#plinkkSearch')?.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            plinkkSearch = e.target.value;
            plinkkPage = 1;
            applyPlinkks();
          }, 300);
        });

        const presetIds = ['last24h', 'last7', 'last30', 'last90'];
        const presetButtons = presetIds.map(id => document.getElementById(id));
        function setActive(btn) {
          presetButtons.forEach(b => {
            if (!b) return;
            b.classList.remove('bg-violet-600', 'text-white', 'border-violet-500');
            b.classList.add('bg-slate-800', 'text-slate-300', 'border-slate-700');
          });
          if (btn) {
            btn.classList.remove('bg-slate-800', 'text-slate-300', 'border-slate-700');
            btn.classList.add('bg-violet-600', 'text-white', 'border-violet-500');
          }
        }

        presetIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('click', (e) => {
            const val = id === 'last24h' ? 1 : (id === 'last7' ? 7 : (id === 'last30' ? 30 : 90));
            setRange(val);
            setActive(e.currentTarget);
            apply();
            if (document.getElementById('tabLogins')?.getAttribute('aria-selected') === 'true') applyLogins();
            if (document.getElementById('tabBans')?.getAttribute('aria-selected') === 'true') applyBans();
            if (document.getElementById('tabPlinkks')?.getAttribute('aria-selected') === 'true') applyPlinkks();
            if (document.getElementById('tabPremium')?.getAttribute('aria-selected') === 'true') applyPremium();
          });
        });

        const customEl = document.getElementById('customDays');
        if (customEl) {
          customEl.addEventListener('input', () => {
            const n = Math.max(1, parseInt(customEl.value, 10) || 1);
            setRange(n);
            setActive(null);
            apply();
            if (document.getElementById('tabLogins')?.getAttribute('aria-selected') === 'true') applyLogins();
            if (document.getElementById('tabBans')?.getAttribute('aria-selected') === 'true') applyBans();
            if (document.getElementById('tabPlinkks')?.getAttribute('aria-selected') === 'true') applyPlinkks();
            if (document.getElementById('tabPremium')?.getAttribute('aria-selected') === 'true') applyPremium();
          });
          customEl.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
              ev.preventDefault();
              const n = Math.max(1, parseInt(customEl.value, 10) || 1);
              setRange(n);
              setActive(null);
              apply();
              if (document.getElementById('tabLogins')?.getAttribute('aria-selected') === 'true') applyLogins();
              if (document.getElementById('tabBans')?.getAttribute('aria-selected') === 'true') applyBans();
              if (document.getElementById('tabPlinkks')?.getAttribute('aria-selected') === 'true') applyPlinkks();
              if (document.getElementById('tabPremium')?.getAttribute('aria-selected') === 'true') applyPremium();
            }
          });
        }

        const fromEl = document.getElementById('from');
        const toEl = document.getElementById('to');
        if (fromEl) {
          fromEl.addEventListener('change', () => { setActive(null); apply(); if (document.getElementById('tabLogins')?.getAttribute('aria-selected') === 'true') applyLogins(); if (document.getElementById('tabBans')?.getAttribute('aria-selected') === 'true') applyBans(); if (document.getElementById('tabPlinkks')?.getAttribute('aria-selected') === 'true') applyPlinkks(); if (document.getElementById('tabPremium')?.getAttribute('aria-selected') === 'true') applyPremium(); });
        }
        if (toEl) {
          toEl.addEventListener('change', () => { setActive(null); apply(); if (document.getElementById('tabLogins')?.getAttribute('aria-selected') === 'true') applyLogins(); if (document.getElementById('tabBans')?.getAttribute('aria-selected') === 'true') applyBans(); if (document.getElementById('tabPlinkks')?.getAttribute('aria-selected') === 'true') applyPlinkks(); if (document.getElementById('tabPremium')?.getAttribute('aria-selected') === 'true') applyPremium(); });
        }

        apply();

        function bindHover(canvas, render, getCount) {
          const rectWrap = canvas.parentElement;
          canvas.addEventListener('mousemove', (ev) => {
            const rect = canvas.getBoundingClientRect();
            const x = ev.clientX - rect.left; const y = ev.clientY - rect.top;
            const cssW = canvas.clientWidth; const padL = 40, padR = 10; const count = getCount();
            const innerW = Math.max(1, cssW - padL - padR);
            const stepX = count > 1 ? innerW / (count - 1) : 0;
            const idx = stepX > 0 ? Math.round((x - padL) / stepX) : -1;
            const clamped = Math.max(0, Math.min(count - 1, idx));
            if (count > 0) render(clamped);
          });
          canvas.addEventListener('mouseleave', () => { render(-1); });
        }

        bindHover(document.getElementById('chart'), (hi) => renderChart(lastSeries, hi), () => lastSeries.length);
        bindHover(document.getElementById('chartVisibility'), (hi) => renderChart2({ series: series2 }, hi), () => series2.length);
        bindHover(document.getElementById('chartRoles'), (hi) => renderChart3({ series: series3 }, hi), () => series3.length);
        bindHover(document.getElementById('chartCumul'), (hi) => renderChart4(series4, hi), () => series4.length);
        bindHover(document.getElementById('chartLogins'), (hi) => renderChartL({ series: seriesL }, hi), () => seriesL.length);
        bindHover(document.getElementById('chartBans'), (hi) => renderChartB({ series: seriesB }, hi), () => seriesB.length);
        bindHover(document.getElementById('chartPlinkks'), (hi) => renderChartP({ series: seriesP }, hi), () => seriesP.length);

        window.addEventListener('resize', () => {
          if (lastSeries && lastSeries.length) renderChart(lastSeries, hoverIndex1);
          if (series2 && series2.length) renderChart2({ series: series2 }, hoverIndex2);
          if (series3 && series3.length) renderChart3({ series: series3 }, hoverIndex3);
          if (series4 && series4.length) renderChart4(series4, hoverIndex4);
          if (seriesL && seriesL.length) renderChartL({ series: seriesL }, hoverIndexL);
          if (seriesB && seriesB.length) renderChartB({ series: seriesB }, hoverIndexB);
          if (seriesP && seriesP.length) renderChartP({ series: seriesP }, hoverIndexP);
          if (seriesPR && seriesPR.length) renderChartPR({ series: seriesPR }, hoverIndexPR);
        });

        const ctx4 = document.getElementById('chartCumul').getContext('2d');
        const wrap4 = document.getElementById('chart4Wrap');
        const tt4 = document.getElementById('tt4');
        let series4 = [];
        let hoverIndex4 = -1;
        function renderChart4(series, hoverIndex = -1) {
          series4 = Array.isArray(series) ? series : [];
          hoverIndex4 = hoverIndex;
          const labels = series4.map(p => p.date);
          const data = series4.map(p => p.count);

          const dpr = window.devicePixelRatio || 1;
          const cssW = ctx4.canvas.clientWidth;
          const cssH = 260;
          ctx4.canvas.width = Math.max(1, Math.floor(cssW * dpr));
          ctx4.canvas.height = Math.floor(cssH * dpr);
          const w = ctx4.canvas.width;
          const h = ctx4.canvas.height;
          ctx4.setTransform(dpr, 0, 0, dpr, 0, 0);
          ctx4.clearRect(0, 0, cssW, cssH);

          const padL = 40;
          const padB = 28;
          const padT = 10; const padR = 10;
          const innerW = cssW - padL - padR;
          const innerH = cssH - padT - padB;

          const maxVal = Math.max(1, ...data);
          const yTicks = 5;
          const stepY = Math.max(1, Math.ceil(maxVal / yTicks));
          const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = data.length > 1 ? (innerW / (data.length - 1)) : 0;
          const scaleY = innerH / maxRounded;

          ctx4.strokeStyle = 'rgba(148,163,184,0.35)';
          ctx4.lineWidth = 1;
          ctx4.beginPath();
          ctx4.moveTo(padL, padT);
          ctx4.lineTo(padL, padT + innerH);
          ctx4.lineTo(padL + innerW, padT + innerH);
          ctx4.stroke();

          ctx4.fillStyle = 'rgba(148,163,184,0.7)';
          ctx4.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          ctx4.textAlign = 'right';
          ctx4.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) {
            const py = padT + innerH - y * scaleY;
            ctx4.strokeStyle = 'rgba(148,163,184,0.15)';
            ctx4.beginPath(); ctx4.moveTo(padL, py); ctx4.lineTo(padL + innerW, py); ctx4.stroke();
            ctx4.fillStyle = 'rgba(148,163,184,0.7)';
            ctx4.fillText(String(y), padL - 6, py);
          }

          ctx4.textAlign = 'center';
          ctx4.textBaseline = 'top';
          const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => {
            if (i % xLabelEvery !== 0 && i !== labels.length - 1) return;
            const x = padL + i * stepX;
            ctx4.strokeStyle = 'rgba(148,163,184,0.15)';
            ctx4.beginPath(); ctx4.moveTo(x, padT + innerH); ctx4.lineTo(x, padT + innerH + 4); ctx4.stroke();
            const shortLab = lab?.slice(5) || '';
            ctx4.fillStyle = 'rgba(148,163,184,0.7)';
            ctx4.fillText(shortLab, x, padT + innerH + 6);
          });

          ctx4.strokeStyle = '#10b981';
          ctx4.lineWidth = 2;
          ctx4.beginPath();
          data.forEach((v, i) => {
            const x = padL + i * stepX;
            const y = padT + innerH - v * scaleY;
            if (i === 0) ctx4.moveTo(x, y); else ctx4.lineTo(x, y);
          });
          ctx4.stroke();

          ctx4.fillStyle = '#34d399';
          data.forEach((v, i) => {
            const x = padL + i * stepX;
            const y = padT + innerH - v * scaleY;
            ctx4.beginPath(); ctx4.arc(x, y, 2.5, 0, Math.PI * 2); ctx4.fill();
          });

          if (hoverIndex >= 0 && hoverIndex < data.length) {
            const x = padL + hoverIndex * stepX;
            const y = padT + innerH - data[hoverIndex] * scaleY;
            ctx4.strokeStyle = 'rgba(16, 185, 129, 0.35)';
            ctx4.lineWidth = 1;
            ctx4.beginPath(); ctx4.moveTo(x, padT); ctx4.lineTo(x, padT + innerH); ctx4.stroke();
            ctx4.fillStyle = '#6ee7b7';
            ctx4.beginPath(); ctx4.arc(x, y, 4, 0, Math.PI * 2); ctx4.fill();
            const rect = wrap4.getBoundingClientRect();
            tt4.textContent = `${labels[hoverIndex]} — ${data[hoverIndex]} total`;
            const ttX = Math.min(rect.width - 140, Math.max(8, x + 8));
            const ttY = Math.max(8, y - 10);
            tt4.style.left = ttX + 'px';
            tt4.style.top = ttY + 'px';
            tt4.classList.remove('hidden');
          } else {
            tt4.classList.add('hidden');
          }
        }

        async function apply() {
          const load1 = document.getElementById('load1');
          const err1 = document.getElementById('err1');
          const empty1 = document.getElementById('empty1');
          const load2 = document.getElementById('load2');
          const err2 = document.getElementById('err2');
          const empty2 = document.getElementById('empty2');
          const load3 = document.getElementById('load3');
          const err3 = document.getElementById('err3');
          const empty3 = document.getElementById('empty3');
          const load4 = document.getElementById('load4');
          const err4 = document.getElementById('err4');
          const empty4 = document.getElementById('empty4');

          try {
            load1?.classList.remove('hidden'); err1?.classList.add('hidden'); empty1?.classList.add('hidden');
            load2?.classList.remove('hidden'); err2?.classList.add('hidden'); empty2?.classList.add('hidden');
            load3?.classList.remove('hidden'); err3?.classList.add('hidden'); empty3?.classList.add('hidden');
            load4?.classList.remove('hidden'); err4?.classList.add('hidden'); empty4?.classList.add('hidden');

            const [series, summary, vis, roles] = await Promise.all([
              fetchSeries(),
              fetchSummary(),
              fetchSeriesByVisibility(),
              fetchSeriesByRole()
            ]);

            // SU1
            lastSeries = series.series || [];
            $('#rangeLabel').textContent = `${series.from} → ${series.to}`;
            renderChart(lastSeries);
            if (!lastSeries.length) empty1?.classList.remove('hidden');

            // Summary
            $('#statTotal').textContent = summary.total;
            $('#statPub').textContent = summary.public;
            $('#statPriv').textContent = summary.private;
            $('#statStaff').textContent = summary.staff;

            // SU2
            series2 = vis.series || [];
            $('#rangeLabel2').textContent = `${vis.from} → ${vis.to}`;
            renderChart2({ series: series2 });
            if (!series2.length) empty2?.classList.remove('hidden');

            // SU3
            series3 = roles.series || [];
            $('#rangeLabel3').textContent = `${roles.from} → ${roles.to}`;
            renderChart3({ series: series3 });
            if (!series3.length) empty3?.classList.remove('hidden');

            // SU4
            series4 = makeCumul(lastSeries);
            $('#rangeLabel4').textContent = `${series.from} → ${series.to}`;
            renderChart4(series4);
            if (!series4.length) empty4?.classList.remove('hidden');

          } catch (e) {
            console.error(e);
            err1?.classList.remove('hidden');
            err2?.classList.remove('hidden');
            err3?.classList.remove('hidden');
            err4?.classList.remove('hidden');
          } finally {
            load1?.classList.add('hidden');
            load2?.classList.add('hidden');
            load3?.classList.add('hidden');
            load4?.classList.add('hidden');
          }
        }

        async function applyLogins() {
          try {
            document.getElementById('loadL')?.classList.remove('hidden');
            document.getElementById('errL')?.classList.add('hidden');
            document.getElementById('emptyL')?.classList.add('hidden');

            const [series, recent] = await Promise.all([
              fetchLoginsSeries(),
              fetchRecentLogins()
            ]);

            seriesL = series.series || [];
            $('#rangeLabelL').textContent = `${series.from} → ${series.to}`;
            renderChartL({ series: seriesL });
            if (!seriesL.length) document.getElementById('emptyL')?.classList.remove('hidden');

            const recDiv = document.getElementById('recentLogins');
            if (recDiv) {
              recDiv.innerHTML = (recent.logins || []).map(l => `
                        <div class="flex items-center gap-3 p-2 rounded-lg bg-slate-950 border border-slate-800">
                            <div class="h-8 w-8 rounded-full bg-slate-800 flex items-center justify-center text-xs text-slate-400 font-medium">
                                ${l.user?.userName?.substring(0, 2).toUpperCase() || '??'}
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="truncate text-slate-200 font-medium">${l.user?.userName || 'Inconnu'}</div>
                                <div class="text-[10px] text-slate-500">${new Date(l.createdAt).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('');
            }

          } catch (e) {
            console.error(e);
            document.getElementById('errL')?.classList.remove('hidden');
          } finally {
            document.getElementById('loadL')?.classList.add('hidden');
          }
        }

        async function applyBans() {
          try {
            document.getElementById('loadB')?.classList.remove('hidden');
            document.getElementById('errB')?.classList.add('hidden');
            document.getElementById('emptyB')?.classList.add('hidden');

            const series = await fetchBansSeries();
            seriesB = series.series || [];
            $('#rangeLabelB').textContent = `${series.from} → ${series.to}`;
            renderChartB({ series: seriesB });
            if (!seriesB.length) document.getElementById('emptyB')?.classList.remove('hidden');

          } catch (e) {
            console.error(e);
            document.getElementById('errB')?.classList.remove('hidden');
          } finally {
            document.getElementById('loadB')?.classList.add('hidden');
          }
        }

        window.__retrySU1 = apply;
        window.__retrySU2 = apply;
        window.__retrySU3 = apply;
        window.__retrySU4 = apply;
        window.__retryL = applyLogins;
        window.__retryB = applyBans;
        window.__retryP = applyPlinkks;
        window.__retryPR = applyPremium;
        window.__retryACC = applyAccounts;

        // ═══════════════════════════════════════════════════════════════
        // PREMIUM — fetch + chart + apply
        // ═══════════════════════════════════════════════════════════════
        async function fetchPremiumSummary() {
          const res = await fetch('/admin/stats/premium/summary');
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }
        async function fetchPremiumSeries() {
          const q = new URLSearchParams({ from: $('#from').value, to: $('#to').value });
          const res = await fetch(`/admin/stats/premium/series?${q.toString()}`);
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }

        const ctxPR = document.getElementById('chartPremium')?.getContext('2d');
        const wrapPR = document.getElementById('chartPRWrap');
        const ttPR = document.getElementById('ttPR');
        let seriesPR = []; let hoverIndexPR = -1;
        function renderChartPR(payload, hoverIndex = -1) {
          if (!ctxPR) return; seriesPR = payload?.series || []; hoverIndexPR = hoverIndex;
          const labels = seriesPR.map(p => p.date);
          const d1 = seriesPR.map(p => p.extra_plinkk || 0);
          const d2 = seriesPR.map(p => p.extra_redirects || 0);
          const dpr = window.devicePixelRatio || 1; const cssW = ctxPR.canvas.clientWidth; const cssH = 260;
          ctxPR.canvas.width = Math.max(1, Math.floor(cssW * dpr)); ctxPR.canvas.height = Math.floor(cssH * dpr);
          ctxPR.setTransform(dpr, 0, 0, dpr, 0, 0); ctxPR.clearRect(0, 0, cssW, cssH);
          const padL = 40, padB = 28, padT = 10, padR = 10; const innerW = cssW - padL - padR, innerH = cssH - padT - padB;
          const maxVal = Math.max(1, ...d1, ...d2); const yTicks = 5, stepY = Math.max(1, Math.ceil(maxVal / yTicks)); const maxRounded = Math.max(stepY, stepY * yTicks);
          const stepX = labels.length > 1 ? innerW / (labels.length - 1) : 0; const scaleY = innerH / maxRounded;
          ctxPR.strokeStyle = 'rgba(148,163,184,0.35)'; ctxPR.lineWidth = 1; ctxPR.beginPath(); ctxPR.moveTo(padL, padT); ctxPR.lineTo(padL, padT + innerH); ctxPR.lineTo(padL + innerW, padT + innerH); ctxPR.stroke();
          ctxPR.fillStyle = 'rgba(148,163,184,0.7)'; ctxPR.font = '11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; ctxPR.textAlign = 'right'; ctxPR.textBaseline = 'middle';
          for (let y = 0; y <= maxRounded; y += stepY) { const py = padT + innerH - y * scaleY; ctxPR.strokeStyle = 'rgba(148,163,184,0.15)'; ctxPR.beginPath(); ctxPR.moveTo(padL, py); ctxPR.lineTo(padL + innerW, py); ctxPR.stroke(); ctxPR.fillStyle = 'rgba(148,163,184,0.7)'; ctxPR.fillText(String(y), padL - 6, py); }
          ctxPR.textAlign = 'center'; ctxPR.textBaseline = 'top'; const xLabelEvery = Math.max(1, Math.ceil(labels.length / 6));
          labels.forEach((lab, i) => { if (i % xLabelEvery !== 0 && i !== labels.length - 1) return; const x = padL + i * stepX; ctxPR.strokeStyle = 'rgba(148,163,184,0.15)'; ctxPR.beginPath(); ctxPR.moveTo(x, padT + innerH); ctxPR.lineTo(x, padT + innerH + 4); ctxPR.stroke(); ctxPR.fillText(lab?.slice(5) || '', x, padT + innerH + 6); });
          function drawLine(data, color) { ctxPR.strokeStyle = color; ctxPR.lineWidth = 2; ctxPR.beginPath(); data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; if (i === 0) ctxPR.moveTo(x, y); else ctxPR.lineTo(x, y); }); ctxPR.stroke(); }
          drawLine(d1, '#8b5cf6'); drawLine(d2, '#06b6d4');
          function drawDots(data, color) { ctxPR.fillStyle = color; data.forEach((v, i) => { const x = padL + i * stepX; const y = padT + innerH - v * scaleY; ctxPR.beginPath(); ctxPR.arc(x, y, 2.5, 0, Math.PI * 2); ctxPR.fill(); }); }
          drawDots(d1, '#a78bfa'); drawDots(d2, '#67e8f9');
          if (hoverIndex >= 0 && hoverIndex < labels.length) {
            const x = padL + hoverIndex * stepX; ctxPR.strokeStyle = 'rgba(148,163,184,0.35)'; ctxPR.beginPath(); ctxPR.moveTo(x, padT); ctxPR.lineTo(x, padT + innerH); ctxPR.stroke();
            const rect = wrapPR.getBoundingClientRect(); const ttX = Math.min(rect.width - 180, Math.max(8, x + 8)); const ttY = 14;
            ttPR.innerHTML = `<div class='font-medium text-slate-100'>${labels[hoverIndex]}</div><div><span class='inline-block w-2 h-2 rounded-full mr-1' style='background:#8b5cf6'></span>Plinkks: <b>${d1[hoverIndex]}</b></div><div><span class='inline-block w-2 h-2 rounded-full mr-1' style='background:#06b6d4'></span>Redirections: <b>${d2[hoverIndex]}</b></div>`;
            ttPR.style.left = ttX + 'px'; ttPR.style.top = ttY + 'px'; ttPR.classList.remove('hidden');
          } else { ttPR.classList.add('hidden'); }
        }

        bindHover(document.getElementById('chartPremium'), (hi) => renderChartPR({ series: seriesPR }, hi), () => seriesPR.length);

        async function applyPremium() {
          try {
            document.getElementById('loadPR')?.classList.remove('hidden');
            document.getElementById('errPR')?.classList.add('hidden');
            document.getElementById('emptyPR')?.classList.add('hidden');
            const [summary, series] = await Promise.all([fetchPremiumSummary(), fetchPremiumSeries()]);
            // KPI
            $('#kpiTotalPremium').textContent = summary.totalPremium;
            $('#kpiActivePremium').textContent = summary.activePremium;
            $('#kpiExpiredPremium').textContent = summary.expiredPremium;
            $('#kpiTotalRevenue').textContent = (summary.totalRevenue / 100).toFixed(2) + ' €';
            $('#kpiTotalPurchases').textContent = summary.totalPurchases;
            const ep = summary.purchasesByType?.extra_plinkk;
            const er = summary.purchasesByType?.extra_redirects;
            $('#kpiExtraPlinkks').textContent = ep ? ep.count : 0;
            $('#kpiExtraRedirects').textContent = er ? er.count : 0;
            // Chart
            seriesPR = series.series || [];
            $('#rangeLabelPR').textContent = `${series.from} → ${series.to}`;
            renderChartPR({ series: seriesPR });
            if (!seriesPR.length) document.getElementById('emptyPR')?.classList.remove('hidden');
          } catch (e) { console.error(e); document.getElementById('errPR')?.classList.remove('hidden'); }
          finally { document.getElementById('loadPR')?.classList.add('hidden'); }
        }

        // ═══════════════════════════════════════════════════════════════
        // COMPTES — doughnut + KPI
        // ═══════════════════════════════════════════════════════════════
        async function fetchConnectionsSummary() {
          const res = await fetch('/admin/stats/connections/summary');
          if (!res.ok) throw new Error('HTTP ' + res.status); return res.json();
        }

        const ctxD = document.getElementById('chartDoughnut')?.getContext('2d');
        function renderDoughnut(dataMap) {
          if (!ctxD) return;
          const providerColors = { google: '#ea4335', discord: '#5865f2', github: '#f0f0f0', spotify: '#1db954', email: '#8b5cf6' };
          const providerLabels = { google: 'Google', discord: 'Discord', github: 'GitHub', spotify: 'Spotify', email: 'Email seul' };
          const entries = Object.entries(dataMap).filter(([_, v]) => v > 0);
          if (!entries.length) return;
          const total = entries.reduce((s, [_, v]) => s + v, 0);
          const canvas = ctxD.canvas;
          const dpr = window.devicePixelRatio || 1;
          const size = 280;
          canvas.width = size * dpr; canvas.height = size * dpr;
          canvas.style.width = size + 'px'; canvas.style.height = size + 'px';
          ctxD.setTransform(dpr, 0, 0, dpr, 0, 0);
          ctxD.clearRect(0, 0, size, size);
          const cx = size / 2, cy = size / 2, r = 110, innerR = 65;
          let startAngle = -Math.PI / 2;
          entries.forEach(([key, val]) => {
            const slice = (val / total) * Math.PI * 2;
            ctxD.beginPath();
            ctxD.arc(cx, cy, r, startAngle, startAngle + slice);
            ctxD.arc(cx, cy, innerR, startAngle + slice, startAngle, true);
            ctxD.closePath();
            ctxD.fillStyle = providerColors[key] || '#64748b';
            ctxD.fill();
            // Label
            const mid = startAngle + slice / 2;
            const labelR = r + 18;
            const lx = cx + Math.cos(mid) * (r - 20);
            const ly = cy + Math.sin(mid) * (r - 20);
            const pct = ((val / total) * 100).toFixed(1);
            if (parseFloat(pct) > 5) {
              ctxD.fillStyle = key === 'github' ? '#111' : '#fff';
              ctxD.font = 'bold 12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
              ctxD.textAlign = 'center'; ctxD.textBaseline = 'middle';
              ctxD.fillText(pct + '%', lx, ly);
            }
            startAngle += slice;
          });
          // Center text
          ctxD.fillStyle = '#f8fafc'; ctxD.font = 'bold 24px system-ui'; ctxD.textAlign = 'center'; ctxD.textBaseline = 'middle';
          ctxD.fillText(String(total), cx, cy - 6);
          ctxD.fillStyle = '#94a3b8'; ctxD.font = '11px system-ui'; ctxD.fillText('connexions', cx, cy + 14);

          // Legend in providerDetails
          const detailsEl = document.getElementById('providerDetails');
          if (detailsEl) {
            detailsEl.innerHTML = entries.map(([key, val]) => {
              const pct = ((val / total) * 100).toFixed(1);
              const color = providerColors[key] || '#64748b';
              const label = providerLabels[key] || key;
              return `<div class="flex items-center gap-4 bg-slate-950 border border-slate-800 rounded-2xl p-4">
                  <div class="h-10 w-10 rounded-xl flex items-center justify-center" style="background:${color}20">
                    <div class="w-4 h-4 rounded-full" style="background:${color}"></div>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center justify-between">
                      <span class="text-sm font-medium text-slate-200">${label}</span>
                      <span class="text-sm font-mono text-slate-400">${val}</span>
                    </div>
                    <div class="mt-1.5 h-1.5 rounded-full bg-slate-800 overflow-hidden">
                      <div class="h-full rounded-full" style="width:${pct}%;background:${color}"></div>
                    </div>
                    <div class="text-xs text-slate-500 mt-1">${pct}% des connexions</div>
                  </div>
                </div>`;
            }).join('');
          }
        }

        async function applyAccounts() {
          try {
            document.getElementById('loadACC')?.classList.remove('hidden');
            document.getElementById('errACC')?.classList.add('hidden');
            const data = await fetchConnectionsSummary();
            // KPIs
            $('#kpiTotalUsersAcc').textContent = data.totalUsers;
            $('#kpiWithPassword').textContent = data.withPassword;
            $('#kpiOAuthOnly').textContent = data.withoutPassword;
            $('#kpiWith2FA').textContent = data.with2FA;
            $('#kpiWithout2FA').textContent = data.without2FA;
            // Doughnut data
            const doughnutData = {};
            for (const [provider, info] of Object.entries(data.byProvider)) {
              doughnutData[provider] = info.total;
            }
            // Add email-only (hasPassword && no identity connection)
            const oauthTotal = Object.values(data.byProvider).reduce((s, v) => s + v.identity, 0);
            const emailOnly = data.totalUsers - oauthTotal;
            if (emailOnly > 0) doughnutData['email'] = emailOnly;
            renderDoughnut(doughnutData);
          } catch (e) { console.error(e); document.getElementById('errACC')?.classList.remove('hidden'); }
          finally { document.getElementById('loadACC')?.classList.add('hidden'); }
        }

      })();
    </script>
    </body>

    </html>