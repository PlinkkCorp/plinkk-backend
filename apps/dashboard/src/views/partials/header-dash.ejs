<header class="sticky top-0 z-50 border-b border-white/5 bg-[#0B1020]/80 backdrop-blur-md transition-all duration-300" id="dashboardHeader">
    <style>
        #spaTopLoaderDash { position: fixed; top: 0; left: 0; width: 100%; height: 2px; z-index: 10000; pointer-events: none; opacity: 0; transition: opacity .2s ease; }
        #spaTopLoaderDash.active { opacity: 1; }
        #spaTopLoaderDash .prog { width: 0%; height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); transition: width .2s ease; }
    </style>

    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between gap-4">
            <div class="flex items-center gap-8">
                <a href="/" class="flex items-center gap-2.5 transition-opacity hover:opacity-80">
                    <img src="/public/images/logo.svg" alt="Plinkk" class="h-8 w-8" />
                    <span class="text-lg font-bold tracking-tight text-white">Plinkk</span>
                </a>
                
                <nav class="hidden md:flex items-center gap-1">
                    <a href="/" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Dashboard</a>
                    <a href="/edit" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Éditeur</a>
                    <a href="/stats" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Stats</a>
                    <a href="<%= frontendUrl %>/users" class="rounded-full px-4 py-1.5 text-sm font-medium text-slate-400 transition-colors hover:bg-white/5 hover:text-white">Liste des Utilisateurs</a>
                </nav>
            </div>

            <div class="flex items-center gap-3">
                <% const __SMS__ = (typeof __SITE_MESSAGES__ !== 'undefined' && Array.isArray(__SITE_MESSAGES__)) ? __SITE_MESSAGES__ : ((typeof __SITE_MESSAGE__ !== 'undefined' && __SITE_MESSAGE__ && __SITE_MESSAGE__.message) ? [__SITE_MESSAGE__.message] : []); %>
                <% if (__SMS__.length) { %>
                    <% __SMS__.slice(0,3).forEach(function(__SM__, idx){ %>
                        <% const lvl = (__SM__.level || 'info').toLowerCase();
                           let bg='bg-slate-700/20', br='border-slate-600/40', tx='text-slate-100', icon='info';
                           if (lvl==='info') { bg='bg-sky-500/10'; br='border-sky-500/20'; tx='text-sky-200'; icon='info'; }
                           else if (lvl==='success') { bg='bg-emerald-500/10'; br='border-emerald-500/20'; tx='text-emerald-200'; icon='check'; }
                           else if (lvl==='warning') { bg='bg-amber-500/10'; br='border-amber-500/20'; tx='text-amber-200'; icon='warn'; }
                           else if (lvl==='error' || lvl==='critical') { bg='bg-rose-500/10'; br='border-rose-500/20'; tx='text-rose-200'; icon='error'; }
                        %>
                        <div class="hidden lg:flex items-center gap-2 px-3 py-1 rounded-full border <%= br %> <%= bg %> <%= tx %> text-xs font-medium" id="siteMessageWrapDash_<%- idx %>" data-msg='<%- JSON.stringify(__SM__ || null).replace(/'/g, "&#39;") %>'>
                            <span><%= __SM__.text %></span>
                            <% if (__SM__.dismissible) { %>
                                <button id="dismissSiteMessageDash_<%- idx %>" class="ml-1 hover:opacity-70"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"/></svg></button>
                            <% } %>
                        </div>
                    <% }) %>
                <% } %>

                <div class="hidden md:flex items-center gap-3">
                    <% if (user.role && (user.role.id === 'ADMIN' || user.role.id === 'DEVELOPER' || user.role.id === 'MODERATOR')) { %>
                        <a href="/admin" class="inline-flex items-center justify-center rounded-full bg-rose-500/10 px-4 py-1.5 text-sm font-medium text-rose-400 ring-1 ring-inset ring-rose-500/20 transition-colors hover:bg-rose-500/20 hover:text-rose-300">Admin</a>
                    <% } %>
                    
                    <div class="relative" id="profileMenu">
                        <button id="profileMenuBtn" class="group flex items-center gap-2 rounded-full bg-white/5 pl-1 pr-3 py-1 ring-1 ring-white/10 transition-all hover:bg-white/10 hover:ring-white/20 focus:outline-none">
                            <div class="h-7 w-7 overflow-hidden rounded-full bg-indigo-600 ring-2 ring-[#0B1020]">
                                <%- include('avatar.ejs', { user }) %>
                            </div>
                            <span class="max-w-[100px] truncate text-sm font-medium text-slate-200 group-hover:text-white"><%= user.userName %></span>
                            <svg class="h-4 w-4 text-slate-500 transition-transform group-hover:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </button>

                        <div id="profileMenuPanel" class="absolute right-0 top-full mt-2 w-64 origin-top-right rounded-xl border border-white/10 bg-[#161b2e] p-1 shadow-2xl hidden">
                            <div class="px-3 py-3">
                                <p class="truncate text-sm font-medium text-white"><%= user.userName %></p>
                                <p class="truncate text-xs text-slate-500"><%= user.email %></p>
                            </div>
                            <div class="h-px bg-white/5 my-1"></div>
                            
                            <a href="/" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                                <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                                Dashboard
                            </a>
                            <a href="/edit" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                                <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                Éditer ma page
                            </a>
                            <a href="/stats" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                                <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                Statistiques
                            </a>
                            <a href="/cosmetics" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                                <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                                Cosmétiques
                            </a>
                            
                            <div class="h-px bg-white/5 my-1"></div>
                            
                            <a href="/account" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 transition-colors hover:bg-white/5 hover:text-white">
                                <svg class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                Paramètres
                            </a>
                            <a href="/logout" class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm text-rose-400 transition-colors hover:bg-rose-500/10">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                Se déconnecter
                            </a>
                        </div>
                    </div>
                </div>

                <button id="menuBtn" class="md:hidden inline-flex items-center justify-center rounded-lg p-2 text-slate-400 hover:bg-white/5 hover:text-white focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="mobileMenu" class="hidden border-t border-white/5 bg-[#0B1020]/95 backdrop-blur-xl md:hidden">
        <div class="space-y-1 px-4 py-4">
            <a href="/" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Dashboard</a>
            <a href="/edit" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Éditeur</a>
            <a href="/stats" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Stats</a>
            <a href="/cosmetics" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Cosmétiques</a>
        </div>
        
        <div class="border-t border-white/5 px-4 py-4">
            <div class="flex items-center gap-3 mb-4">
                <div class="h-10 w-10 overflow-hidden rounded-full bg-indigo-600">
                    <%- include('avatar.ejs', { user }) %>
                </div>
                <div>
                    <div class="text-base font-medium text-white"><%= user.userName %></div>
                    <div class="text-sm text-slate-500"><%= user.email %></div>
                </div>
            </div>
            <div class="space-y-1">
                <a href="/account" class="block rounded-lg px-3 py-2 text-base font-medium text-slate-300 hover:bg-white/5 hover:text-white">Paramètres</a>
                <a href="/logout" class="block rounded-lg px-3 py-2 text-base font-medium text-rose-400 hover:bg-rose-500/10">Se déconnecter</a>
            </div>
        </div>
    </div>

    <div id="spaTopLoaderDash" aria-hidden="true"><div class="prog" id="spaTopLoaderDashProg"></div></div>
</header>

<script>
    (function(){
        const el = document.getElementById('spaTopLoaderDash');
        const bar = document.getElementById('spaTopLoaderDashProg');
        let _active = false, _timer = null, _val = 0, _t0 = 0;
        const MIN_VISIBLE = 300;
        function setProgress(p){ if (!bar) return; _val = Math.max(0, Math.min(100, p)); bar.style.width = _val + '%'; }
        function tick(){ if (!_active) return; const target = 80; const delta = Math.max(0.5, (target - _val) * 0.1); setProgress(_val + delta); _timer = setTimeout(tick, 200); }
        function start(){ if (!el || !bar) return; if (_active) return; _active = true; _t0 = Date.now(); el.classList.add('active'); setProgress(5); clearTimeout(_timer); _timer = setTimeout(tick, 160); }
        function end(){ if (!el || !bar) return; clearTimeout(_timer); setProgress(100); const elapsed = Date.now() - _t0; const extra = Math.max(0, MIN_VISIBLE - elapsed); setTimeout(()=>{ el.classList.remove('active'); setProgress(0); _active = false; }, 250 + extra); }
        if (!window.__spaLoadingStart) window.__spaLoadingStart = start;
        if (!window.__spaLoadingEnd) window.__spaLoadingEnd = end;
        window.addEventListener('spa:loading-start', start);
        window.addEventListener('spa:loading-end', end);
        window.addEventListener('beforeunload', ()=>{ try { sessionStorage.setItem('spa_nav','1'); start(); } catch{} });
        try { if (sessionStorage.getItem('spa_nav') === '1') { sessionStorage.removeItem('spa_nav'); start(); const fin = ()=> setTimeout(end, 120); if (document.readyState === 'complete') fin(); else window.addEventListener('load', fin, { once: true }); } } catch {}
        function isModifiedClick(e){ return e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0; }
        function isSameOrigin(url){ try { const u=new URL(url, location.href); return u.origin===location.origin; } catch { return false; } }
        function looksLikeHtmlRequest(url){ return isSameOrigin(url) && !/\.(?:png|jpe?g|webp|gif|svg|ico|css|js|map|json|txt|woff2?|ttf|otf)(?:[?#].*)?$/i.test(url); }
        document.addEventListener('click', (e)=>{ const a = e.target && (e.target.closest ? e.target.closest('a') : null); if (!a) return; const href = a.getAttribute('href') || ''; if (!href || href.startsWith('#')) return; if (a.target === '_blank' || a.download != null) return; if (isModifiedClick(e)) return; if (!looksLikeHtmlRequest(href)) return; try { window.dispatchEvent(new Event('spa:loading-start')); } catch {} setTimeout(()=>{ try { window.dispatchEvent(new Event('spa:loading-end')); } catch {} }, 8000); }, true);
        try { const origFetch = window.fetch.bind(window); let inflight = 0; const onBegin=()=>{ if (inflight++===0) window.dispatchEvent(new Event('spa:loading-start')); }; const onEnd=()=>{ if (inflight>0 && --inflight===0) window.dispatchEvent(new Event('spa:loading-end')); }; window.fetch = function(input, init){ try { const url = typeof input === 'string' ? input : (input && input.url) || ''; const method = (init && (init.method||'GET')) || (typeof input!=='string' && input && input.method) || 'GET'; const headers = new Headers((init && init.headers) || (typeof input!=='string' && input && input.headers) || undefined); const accept = (headers.get('Accept') || headers.get('accept') || '').toLowerCase(); const isHtmlAccept = accept.includes('text/html') || accept === ''; const qualifies = method.toUpperCase()==='GET' && looksLikeHtmlRequest(url) && !url.startsWith('/api'); if (qualifies && isHtmlAccept) onBegin(); const p = origFetch(input, init); if (qualifies && isHtmlAccept) { p.finally(()=>{ setTimeout(onEnd, 80); }); } return p; } catch { return origFetch(input, init); } }; } catch {}
    })();
</script>
<script>
    (function(){
        const btn = document.getElementById('profileMenuBtn');
        const panel = document.getElementById('profileMenuPanel');
        const root = document.getElementById('profileMenu');
        const close = () => { panel?.classList.add('hidden'); btn?.setAttribute('aria-expanded','false'); };
        const open = () => { panel?.classList.remove('hidden'); btn?.setAttribute('aria-expanded','true'); };
        if (btn && panel && root) {
            btn.addEventListener('click', (e)=>{ e.stopPropagation(); if (panel.classList.contains('hidden')) open(); else close(); });
            document.addEventListener('click', (e)=>{ if (!root.contains(e.target)) close(); });
            document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); });
        }
        const mBtn = document.getElementById('menuBtn');
        const mMenu = document.getElementById('mobileMenu');
        if (mBtn && mMenu) {
            mBtn.addEventListener('click', (e)=>{ e.stopPropagation(); mMenu.classList.toggle('hidden'); });
            document.addEventListener('click', (e)=>{ if (!mMenu.contains(e.target) && e.target !== mBtn) mMenu.classList.add('hidden'); });
        }
        try {
            const nodes = Array.from(document.querySelectorAll('[id^="siteMessageWrapDash_"]'));
            nodes.forEach((wrap) => {
                const raw = wrap.getAttribute('data-msg');
                if (!raw) return;
                const safe = raw.replace(/&#39;/g, "'");
                let msg = null; try { msg = JSON.parse(safe); } catch(e) {}
                if (!msg || !msg.id) return;
                const key = 'dismissed_site_message_' + msg.id;
                if (localStorage.getItem(key)) { wrap.style.display = 'none'; return; }
                const btn = wrap.querySelector('button[id^="dismissSiteMessageDash"]');
                if (btn) btn.addEventListener('click', ()=>{ localStorage.setItem(key,'1'); wrap.style.display='none'; });
            });
        } catch(e){}
    })();
</script>
