<%- include('partials/head.ejs', { title: 'Plinkk - Partenaires & Plinkk Gems' ,
    description: 'Découvrez nos partenaires et gagnez des Plinkk Gems !' , robots: 'index,follow' }) %>
    <%- include('partials/header.ejs', { currentUser: locals.currentUser }) %>

        <!-- Particles background base -->
        <div class="fixed inset-0 z-[-1] bg-slate-950">
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_0%,rgba(139,92,246,0.15),transparent_50%)]">
            </div>
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_80%_80%,rgba(236,72,153,0.1),transparent_50%)]">
            </div>
        </div>

        <main class="min-h-screen pt-24 pb-20 px-4 max-w-7xl mx-auto">
            <div class="text-center mb-16 relative">
                <!-- Gems Badge if logged in -->
                <% if (locals.currentUser) { %>
                    <div
                        class="absolute top-0 right-0 inline-flex items-center gap-2 px-4 py-2 bg-slate-900/80 backdrop-blur-md border border-slate-800 rounded-2xl shadow-xl shadow-violet-900/20 transform hover:scale-105 transition-transform cursor-default">
                        <div
                            class="w-8 h-8 rounded-xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center shadow-inner">
                            <img src="/public/images/gems.svg" alt="Gems" class="w-5 h-5 shrink-0" />
                        </div>
                        <div class="text-left">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Vos Plinkk Gems
                            </div>
                            <div class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-400 leading-none"
                                id="userGemsDisplay">
                                ...
                            </div>
                        </div>
                    </div>
                    <% } %>

                        <div
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-violet-500/10 border border-violet-500/20 text-violet-400 text-sm font-medium mb-6">
                            <img src="/public/images/gems.svg" alt="Gems" class="w-4 h-4 shrink-0" />
                            Partenaires & Récompenses
                        </div>
                        <h1 class="text-4xl md:text-6xl font-black text-white mb-6 tracking-tight">
                            Soutenez nos <span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-400">partenaires</span>
                        </h1>
                        <p class="text-lg text-slate-400 max-w-2xl mx-auto leading-relaxed">
                            Accomplissez des quêtes en interagissant avec nos partenaires et gagnez des <strong
                                class="text-violet-400 font-semibold">Plinkk Gems</strong>. Échangez-les ensuite contre
                            du temps Premium ou d'autres avantages exclusifs.
                        </p>

                        <% if (!locals.currentUser) { %>
                            <div class="mt-8">
                                <a href="/login"
                                    class="inline-flex items-center gap-2 px-6 py-3 bg-white text-slate-900 hover:bg-slate-100 rounded-xl font-bold transition-all shadow-xl shadow-white/10 hover:shadow-white/20 hover:-translate-y-0.5">
                                    Se connecter pour gagner des Gems
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M5 12h14"></path>
                                        <path d="m12 5 7 7-7 7"></path>
                                    </svg>
                                </a>
                            </div>
                            <% } %>
            </div>

            <!-- Skeleton Loading State -->
            <div id="loadingState" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 py-8">
                <% for(let i=0; i < 6; i++) { %>
                    <div class="glass-card rounded-[2.5rem] overflow-hidden flex flex-col h-[400px]">
                        <div class="h-32 skeleton"></div>
                        <div class="p-8 pt-12 flex-1">
                            <div class="h-8 w-3/4 skeleton rounded-lg mb-4"></div>
                            <div class="h-4 w-full skeleton rounded-lg mb-2"></div>
                            <div class="h-4 w-5/6 skeleton rounded-lg mb-8"></div>
                            <div class="space-y-4">
                                <div class="h-12 w-full skeleton rounded-2xl"></div>
                                <div class="h-12 w-full skeleton rounded-2xl"></div>
                            </div>
                        </div>
                    </div>
                    <% } %>
            </div>

            <div id="partnersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Rendered via JS -->
            </div>

        </main>

        <%- include('partials/footer.ejs') %>

            <style>
                /* Glassmorphic Cards & Animations */
                .glass-card {
                    background: rgba(15, 23, 42, 0.6);
                    backdrop-filter: blur(16px);
                    border: 1px solid rgba(255, 255, 255, 0.05);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                }

                .quest-item {
                    transition: all 0.2s ease;
                }

                .quest-item:hover {
                    background: rgba(139, 92, 246, 0.08);
                    border-color: rgba(139, 92, 246, 0.3);
                    transform: translateX(4px);
                }

                .gem-icon {
                    filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.6));
                }

                @keyframes slideUpFade {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }

                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .animate-in {
                    animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
                }

                @keyframes shimmer {
                    0% {
                        background-position: -200% 0;
                    }

                    100% {
                        background-position: 200% 0;
                    }
                }

                .skeleton {
                    background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
                    background-size: 200% 100%;
                    animation: shimmer 1.5s infinite linear;
                }
            </style>

            <script>
                document.addEventListener('DOMContentLoaded', async () => {
                    const isLoggedReified = <%- JSON.stringify(!!locals.currentUser) %>;

                    try {
                        const res = await fetch('/api/partners');
                        if (!res.ok) throw new Error('Failed to fetch data');
                        const { partners, userQuests, plinkkGems } = await res.json();

                        // Update Gems display if exists
                        const gemsDisplay = document.getElementById('userGemsDisplay');
                        if (gemsDisplay) {
                            // Small animation for gems
                            const currentVal = parseInt(gemsDisplay.innerText) || 0;
                            animateValue(gemsDisplay, currentVal, plinkkGems, 1000);
                        }

                        const grid = document.getElementById('partnersGrid');
                        const loading = document.getElementById('loadingState');

                        if (partners.length === 0) {
                            grid.innerHTML = `
        <div class="col-span-full py-20 text-center glass-card rounded-3xl">
          <div class="w-16 h-16 mx-auto rounded-full bg-slate-800/50 flex items-center justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          </div>
          <h3 class="text-xl font-bold text-white">Aucun partenaire</h3>
          <p class="text-slate-400 mt-2">Revenez plus tard pour découvrir de nouvelles quêtes !</p>
        </div>
      `;
                        } else {
                            let delay = 0;
                            partners.forEach(partner => {
                                // Observez les vues
                                fetch(`/api/partners/${partner.id}/view`, { method: 'POST' }).catch(() => { });

                                const card = document.createElement('div');
                                card.className = `glass-card rounded-3xl overflow-hidden flex flex-col group animate-in`;
                                card.style.animationDelay = `${delay}ms`;
                                card.style.opacity = '0'; // For animation
                                delay += 100;

                                let questsHtml = '';
                                if (partner.quests.length > 0) {
                                    questsHtml = partner.quests.map(quest => {
                                        const completed = userQuests.includes(quest.id);
                                        const btnClass = completed
                                            ? 'bg-slate-800 text-slate-500 border border-slate-700 cursor-default opacity-60 grayscale'
                                            : 'bg-violet-600 hover:bg-violet-500 text-white cursor-pointer hover:shadow-lg hover:shadow-violet-900/40 relative overflow-hidden group/btn';

                                        const btnIcon = completed
                                            ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                                            : `<span class="flex items-center gap-1 font-bold"><img src="/public/images/gems.svg" alt="Gems" class="w-4 h-4 shrink-0 gem-icon" /> +${quest.rewardGems}</span>`;

                                        const btnAction = completed
                                            ? `onclick="window.open('${quest.actionUrl}', '_blank')"`
                                            : `onclick="completeQuest(event, '${quest.id}')"`;

                                        const btnText = completed ? 'Quête accomplie' : 'Récupérer';

                                        return `
              <div class="quest-item p-3 mt-2 rounded-2xl bg-slate-900/50 border border-slate-800 flex items-center justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <h4 class="text-sm font-bold text-white truncate">${quest.title}</h4>
                  ${quest.description ? `<p class="text-xs text-slate-400 truncate mt-0.5">${quest.description}</p>` : ''}
                </div>
                <button ${btnAction} class="flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-xs transition-all ${btnClass}">
                  ${!completed ? '<div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover/btn:animate-[shimmer_1.5s_infinite]"></div>' : ''}
                  ${btnIcon}
                  ${btnText}
                </button>
              </div>
            `;
                                    }).join('');
                                } else {
                                    questsHtml = '<p class="text-xs text-slate-500 italic mt-2">Aucune quête pour le moment</p>';
                                }

                                const fallbackInitial = partner.name.charAt(0).toUpperCase();
                                const logoRender = partner.logoUrl
                                    ? `<img src="${partner.logoUrl}" alt="Logo" class="w-full h-full object-contain p-2">`
                                    : `<span class="text-3xl font-black text-slate-600">${fallbackInitial}</span>`;

                                const bannerRender = partner.bannerUrl
                                    ? `<img src="${partner.bannerUrl}" alt="Banner" class="w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity duration-500">`
                                    : `<div class="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900"></div>`;

                                card.innerHTML = `
          <div class="h-40 relative overflow-hidden bg-slate-900">
            ${bannerRender}
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent"></div>
            
            <div class="absolute -bottom-6 left-6 z-10">
              <div class="w-20 h-20 rounded-2xl bg-slate-950 border-2 border-slate-800 overflow-hidden flex items-center justify-center shadow-2xl relative group-hover:-translate-y-1 transition-transform duration-300">
                 ${logoRender}
              </div>
            </div>
          </div>

          <div class="p-6 pt-10 flex-1 flex flex-col z-20 relative">
            <h3 class="text-2xl font-bold text-white mb-2 group-hover:text-violet-400 transition-colors">${partner.name}</h3>
            <p class="text-sm text-slate-400 mb-6 flex-1">${partner.description || ''}</p>
                        <div class="flex items-center gap-4 mb-4">
                            <div class="text-xs text-slate-400">Vues: <span class="text-white font-bold">${(partner.stats && partner.stats.views) || 0}</span></div>
                            <div class="text-xs text-slate-400">Clics: <span class="text-white font-bold">${(partner.stats && partner.stats.clicks) || 0}</span></div>
                            <div class="text-xs text-slate-400">Gems distribués: <span class="text-white font-bold">${(partner.stats && partner.stats.gemsAwarded) || 0}</span></div>
                        </div>
            
            <div class="border-t border-slate-800/60 pt-4">
              <div class="flex items-center gap-2 mb-2">
                <img src="/public/images/gems.svg" alt="Gems" class="w-4 h-4 shrink-0" />
                <span class="text-xs font-bold text-slate-300 uppercase tracking-wider">Quêtes disponibles</span>
              </div>
              <div class="space-y-1">
                ${questsHtml}
              </div>
            </div>
          </div>
        `;
                                grid.appendChild(card);
                            });
                        }

                        loading.classList.add('hidden');
                        grid.classList.remove('hidden');

                    } catch (err) {
                        console.error(err);
                        document.getElementById('loadingState').innerHTML = `
      <div class="text-rose-400 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        <p>Erreur lors du chargement des partenaires.</p>
      </div>
    `;
                    }
                });

                // Action Quête
                async function completeQuest(event, questId) {
                    const isLogged = <%- JSON.stringify(!!locals.currentUser) %>;
                    if (!isLogged) {
                        window.location.href = '/login?alert=Pour gagner des Gems, veuillez vous connecter.';
                        return;
                    }

                    // Visual feedback on button immediately
                    const btn = event.currentTarget;
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
                    btn.classList.add('pointer-events-none');

                    try {
                        const res = await fetch(`/api/quests/${questId}/complete`, {
                            method: 'POST'
                        });
                        const data = await res.json();

                        if (res.ok) {
                            if (data.alreadyCompleted) {
                                window.open(data.actionUrl, '_blank');
                            } else {
                                // Success !
                                // Update gems visually
                                const gemsDisplay = document.getElementById('userGemsDisplay');
                                if (gemsDisplay) {
                                    const currentVal = parseInt(gemsDisplay.innerText) || 0;
                                    animateValue(gemsDisplay, currentVal, currentVal + data.rewardGems, 1500);

                                    // Pop animation
                                    gemsDisplay.parentElement.classList.add('scale-110', 'ring-2', 'ring-violet-400');
                                    setTimeout(() => {
                                        gemsDisplay.parentElement.classList.remove('scale-110', 'ring-2', 'ring-violet-400');
                                    }, 400);
                                }

                                // Open URL in new tab
                                window.open(data.actionUrl, '_blank');

                                // Mark as completed in UI immediately
                                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Quête accomplie';
                                btn.classList.remove('bg-violet-600', 'hover:bg-violet-500');
                                btn.classList.add('bg-slate-800', 'text-slate-500', 'border', 'border-slate-700', 'opacity-60', 'grayscale');

                                // Reload UI in background to reflect globally after a delay
                            }
                        } else {
                            alert(data.message || 'Erreur lors de la quête.');
                            btn.innerHTML = originalHtml;
                            btn.classList.remove('pointer-events-none');
                        }
                    } catch (err) {
                        alert('Erreur réseau');
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('pointer-events-none');
                    }
                }

                // Utility for number animation
                function animateValue(obj, start, end, duration) {
                    let startTimestamp = null;
                    const step = (timestamp) => {
                        if (!startTimestamp) startTimestamp = timestamp;
                        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                        // ease out quad
                        const easeOut = progress * (2 - progress);
                        obj.innerHTML = Math.floor(easeOut * (end - start) + start);
                        if (progress < 1) {
                            window.requestAnimationFrame(step);
                        }
                    };
                    window.requestAnimationFrame(step);
                }
            </script>