<%- include('../../partials/head.ejs', { title: 'Bannissements - Administration', description: 'Gérez les bannissements de slugs et d\'emails.', robots: 'noindex,nofollow' }) %>

<%- include('../../partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
    <%- include('../../partials/admin-nav.ejs', { user: user, active: 'bans' }) %>

    <main class="col-span-12 lg:col-span-10 space-y-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-gradient-to-r from-slate-900 to-slate-800 p-8 rounded-3xl border border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-rose-600/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="relative z-10">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Bannissements</h1>
                <p class="text-slate-400 text-lg">Gérez les restrictions d'accès par slug ou email.</p>
            </div>
            <div class="relative z-10 flex gap-2 bg-slate-950/50 p-1 rounded-xl border border-slate-800">
                <button data-tab="slugs" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-slate-800 text-white shadow-lg">Slugs</button>
                <button data-tab="emails" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800/50">Emails</button>
            </div>
        </div>

        <!-- Slugs Tab -->
        <div id="tab-slugs" class="grid grid-cols-1 xl:grid-cols-3 gap-8 animate-fade-in">
            <!-- Add Slug Form -->
            <div class="xl:col-span-1">
                <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-white mb-4">Bannir un Slug</h2>
                    <form id="add-ban-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Slug</label>
                            <input name="slug" type="text" required placeholder="ex: admin, support" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-rose-500 outline-none transition-colors" />
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Raison</label>
                            <input name="reason" type="text" placeholder="ex: Réservé système" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-rose-500 outline-none transition-colors" />
                        </div>
                        
                        <div id="formMsg" class="text-sm min-h-[20px]"></div>

                        <div class="flex gap-3 pt-2">
                            <button id="addBtn" type="submit" class="flex-1 px-4 py-2.5 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm font-medium shadow-lg shadow-rose-900/20 transition-colors has-spinner">
                                <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                                <span>Bannir</span>
                            </button>
                            <button id="clearBtn" type="button" class="px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium transition-colors">
                                Réinitialiser
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Slugs List -->
            <div class="xl:col-span-2 bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden flex flex-col">
                <div class="p-6 border-b border-slate-800 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <h2 class="font-bold text-white text-xl">Slugs Bannis</h2>
                    <div class="flex gap-2">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="Rechercher..." class="pl-10 pr-4 py-2 rounded-xl bg-slate-950 border border-slate-800 text-slate-200 text-sm focus:border-rose-500 outline-none w-full sm:w-64 transition-colors" />
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <button id="refreshBtn" class="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors" title="Rafraîchir">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 21h5v-5"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-800 bg-slate-950/50 text-xs uppercase text-slate-400">
                                <th class="px-6 py-4 font-medium">Slug</th>
                                <th class="px-6 py-4 font-medium">Raison</th>
                                <th class="px-6 py-4 font-medium">Date</th>
                                <th class="px-6 py-4 font-medium text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="bans-tbody" class="divide-y divide-slate-800 text-sm"></tbody>
                    </table>
                </div>
                <div id="loadingIndicator" class="hidden p-8 text-center text-slate-500">Chargement...</div>
            </div>
        </div>

        <!-- Emails Tab -->
        <div id="tab-emails" class="hidden grid grid-cols-1 xl:grid-cols-3 gap-8 animate-fade-in">
            <!-- Add Email Ban Form -->
            <div class="xl:col-span-1">
                <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-white mb-4">Bannir un Email</h2>
                    <form id="add-emailban-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Email</label>
                            <input name="email" type="email" required placeholder="user@example.com" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-rose-500 outline-none transition-colors" />
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Raison</label>
                            <input name="reason" type="text" placeholder="ex: Spam massif" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-rose-500 outline-none transition-colors" />
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Durée (min)</label>
                            <input name="time" type="number" step="1" min="-1" placeholder="-1 (Permanent)" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-rose-500 outline-none transition-colors" />
                        </div>

                        <div id="emailFormMsg" class="text-sm min-h-[20px]"></div>

                        <div class="flex gap-3 pt-2">
                            <button id="addEmailBanBtn" type="submit" class="flex-1 px-4 py-2.5 rounded-xl bg-rose-600 hover:bg-rose-500 text-white text-sm font-medium shadow-lg shadow-rose-900/20 transition-colors has-spinner">
                                <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                                <span>Bannir</span>
                            </button>
                            <button id="clearEmailBanBtn" type="button" class="px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium transition-colors">
                                Réinitialiser
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Emails List -->
            <div class="xl:col-span-2 bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden flex flex-col">
                <div class="p-6 border-b border-slate-800 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <h2 class="font-bold text-white text-xl">Emails Bannis</h2>
                    <div class="flex gap-2">
                        <div class="relative">
                            <input id="searchEmailInput" type="text" placeholder="Rechercher..." class="pl-10 pr-4 py-2 rounded-xl bg-slate-950 border border-slate-800 text-slate-200 text-sm focus:border-rose-500 outline-none w-full sm:w-64 transition-colors" />
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <button id="openBulkBtn" class="px-4 py-2 rounded-xl bg-rose-600/10 hover:bg-rose-600/20 text-rose-500 text-sm font-medium border border-rose-600/20 transition-colors">
                            Ban Massif
                        </button>
                        <button id="refreshEmailBtn" class="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors" title="Rafraîchir">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 21h5v-5"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-800 bg-slate-950/50 text-xs uppercase text-slate-400">
                                <th class="px-6 py-4 font-medium">Email</th>
                                <th class="px-6 py-4 font-medium">Raison</th>
                                <th class="px-6 py-4 font-medium">Date</th>
                                <th class="px-6 py-4 font-medium">Expire</th>
                                <th class="px-6 py-4 font-medium text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="emailbans-tbody" class="divide-y divide-slate-800 text-sm"></tbody>
                    </table>
                </div>
                <div id="loadingEmailIndicator" class="hidden p-8 text-center text-slate-500">Chargement...</div>
            </div>
        </div>
    </main>
</div>

<!-- Bulk Ban Drawer -->
<div id="bulkDrawer" class="fixed inset-0 z-[2147483600] hidden" aria-hidden="true">
    <div id="bulkBackdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
    <aside class="absolute right-0 top-0 h-full w-full sm:w-[600px] bg-slate-900 border-l border-slate-800 shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="flex items-center justify-between p-6 border-b border-slate-800 bg-slate-900/95 backdrop-blur">
            <h2 class="text-xl font-bold text-white">Ban Massif</h2>
            <button id="closeBulkBtn" class="p-2 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- Config -->
            <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Raison</label>
                        <input id="bulkReason" type="text" placeholder="ex: Spam" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm text-white focus:border-rose-500 outline-none" />
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1 uppercase tracking-wider">Durée (min)</label>
                        <input id="bulkTime" type="number" min="-1" step="1" value="-1" class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm text-white focus:border-rose-500 outline-none" />
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4">
                <h3 class="text-sm font-bold text-white mb-2">Rechercher des comptes</h3>
                <div class="relative">
                    <input id="userSearchInput" type="text" placeholder="Pseudo, email ou ID..." class="w-full rounded-xl bg-slate-900 border border-slate-800 px-4 py-2.5 text-sm text-white focus:border-rose-500 outline-none" />
                    <div id="userSearchDropdown" class="absolute top-full left-0 right-0 mt-2 max-h-60 overflow-y-auto bg-slate-900 border border-slate-800 rounded-xl shadow-xl z-20 hidden"></div>
                </div>
            </div>

            <!-- Import -->
            <div class="bg-slate-950/50 border border-slate-800 rounded-2xl p-4">
                <h3 class="text-sm font-bold text-white mb-2">Importer une liste</h3>
                <textarea id="bulkPasteArea" rows="4" placeholder="Collez des emails ici (séparés par virgule, espace ou retour ligne)..." class="w-full rounded-xl bg-slate-900 border border-slate-800 px-4 py-3 text-sm text-white focus:border-rose-500 outline-none mb-3"></textarea>
                <div class="flex items-center gap-3">
                    <label class="flex-1 cursor-pointer">
                        <span class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-slate-900 border border-slate-800 hover:bg-slate-800 text-slate-300 text-sm transition-colors">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            Fichier CSV/TXT
                        </span>
                        <input id="bulkFileInput" type="file" accept=".csv,.txt" class="hidden" />
                    </label>
                    <button id="bulkParseBtn" class="flex-1 px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-500 text-white text-sm font-medium transition-colors">
                        Ajouter
                    </button>
                </div>
            </div>

            <!-- Selection -->
            <div class="bg-slate-950/50 border border-slate-800 rounded-2xl overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900/50">
                    <h3 class="text-sm font-bold text-white">Sélection</h3>
                    <button id="bulkBanBtn" class="px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-500 text-white text-xs font-medium transition-colors has-spinner">
                        <svg class="plinkk-spinner hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                        <span>Bannir la sélection</span>
                    </button>
                </div>
                <div class="max-h-60 overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <tbody id="bulkSelectedTbody" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
                <div id="bulkMsg" class="p-3 text-xs text-center border-t border-slate-800 empty:hidden"></div>
            </div>
        </div>
    </aside>
</div>

<style>
    .has-spinner { position: relative; }
    .has-spinner .plinkk-spinner { width: 14px; height: 14px; margin-right: 6px; animation: plk-spin 1s linear infinite; }
    .plinkk-spinner { width: 14px; height: 14px; animation: plk-spin 1s linear infinite; opacity: .9; }
    @keyframes plk-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script src="/public/js/pagination.js"></script>
<script>
    (function () {
        const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
        const tabSlugs = document.getElementById('tab-slugs');
        const tabEmails = document.getElementById('tab-emails');
        
        tabBtns.forEach(btn => btn.addEventListener('click', () => {
            const sel = btn.getAttribute('data-tab');
            
            // Update buttons
            tabBtns.forEach(b => {
                if(b.getAttribute('data-tab') === sel) {
                    b.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-slate-800/50');
                    b.classList.add('bg-slate-800', 'text-white', 'shadow-lg');
                } else {
                    b.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-slate-800/50');
                    b.classList.remove('bg-slate-800', 'text-white', 'shadow-lg');
                }
            });

            // Switch content
            if(sel === 'slugs') {
                tabEmails.classList.add('hidden');
                tabSlugs.classList.remove('hidden');
            } else {
                tabSlugs.classList.add('hidden');
                tabEmails.classList.remove('hidden');
            }
        }));

        // --- Slugs Logic ---
        const apiList = '/api/bans';
        const tbody = document.getElementById('bans-tbody');
        const addForm = document.getElementById('add-ban-form');
        const addBtn = document.getElementById('addBtn');
        const clearBtn = document.getElementById('clearBtn');
        const formMsg = document.getElementById('formMsg');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const refreshBtn = document.getElementById('refreshBtn');
        const searchInput = document.getElementById('searchInput');
        let bansCache = [];
        let paginator = null;

        function showMessage(target, text, kind = 'info') {
            target.textContent = text;
            target.className = kind === 'error' ? 'text-sm text-rose-400' : 'text-sm text-emerald-400';
            setTimeout(() => { target.textContent = ''; target.className = 'text-sm min-h-[20px]'; }, 4000);
        }

        function setLoading(on) {
            loadingIndicator.classList.toggle('hidden', !on);
            refreshBtn.disabled = on;
            const s = addBtn.querySelector('.plinkk-spinner');
            if(on) s?.classList.remove('hidden'); else s?.classList.add('hidden');
            addBtn.disabled = on;
        }

        function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" })[c]); }

        function renderTable(list) {
            const q = (searchInput.value || '').toLowerCase().trim();
            const filtered = q ? list.filter(b => b.slug.toLowerCase().includes(q) || (b.reason || '').toLowerCase().includes(q)) : list;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td class="px-6 py-8 text-center text-slate-500" colspan="4">Aucun slug banni.</td></tr>`;
                return;
            }

            tbody.innerHTML = '';
            for (const b of filtered) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-800/30 transition-colors group';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white">${escapeHtml(b.slug)}</td>
                    <td class="px-6 py-4 text-slate-400">${escapeHtml(b.reason || '-')}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs">${new Date(b.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-right">
                        <button data-id="${b.slug}" class="del-btn p-2 rounded-lg bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" title="Supprimer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }

            if (!paginator) {
                paginator = window.__PlinkkPaginator.createPaginator(tbody, { pageSize: 10, selectors: { items: 'tr' } });
            } else {
                paginator.setFiltered(Array.from(tbody.querySelectorAll('tr')));
            }

            Array.from(document.getElementsByClassName('del-btn')).forEach(btn => btn.addEventListener('click', onDelete));
        }

        async function fetchBans() {
            try {
                setLoading(true);
                const res = await fetch(apiList);
                if (!res.ok) throw new Error('fetch_failed');
                const data = await res.json();
                bansCache = Array.isArray(data.bans) ? data.bans : [];
                renderTable(bansCache);
            } catch (e) {
                tbody.innerHTML = `<tr><td class="px-6 py-8 text-center text-rose-400" colspan="4">Erreur de chargement.</td></tr>`;
            } finally {
                setLoading(false);
            }
        }

        async function onDelete(e) {
            const id = e.currentTarget.getAttribute('data-id');
            if (!id || !confirm('Supprimer ce ban ?')) return;
            try {
                setLoading(true);
                const res = await fetch(apiList + '?id=' + encodeURIComponent(id), { method: 'DELETE' });
                if (!res.ok) throw new Error('delete_failed');
                showMessage(formMsg, 'Ban supprimé', 'ok');
                await fetchBans();
            } catch (err) {
                showMessage(formMsg, 'Erreur suppression', 'error');
            } finally { setLoading(false); }
        }

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(addForm);
            const slug = (fd.get('slug') || '').toString().trim();
            const reason = (fd.get('reason') || '').toString().trim();
            if (!slug) return showMessage(formMsg, 'Slug requis', 'error');
            try {
                setLoading(true);
                const res = await fetch(apiList, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug, reason }) });
                if (res.ok) {
                    addForm.reset();
                    showMessage(formMsg, 'Ban ajouté', 'ok');
                    await fetchBans();
                } else {
                    const body = await res.json().catch(() => ({ error: 'error' }));
                    showMessage(formMsg, body.error || 'Erreur', 'error');
                }
            } catch (err) {
                showMessage(formMsg, 'Erreur réseau', 'error');
            } finally { setLoading(false); }
        });

        clearBtn.addEventListener('click', () => addForm.reset());
        refreshBtn.addEventListener('click', () => fetchBans());
        searchInput.addEventListener('input', () => renderTable(bansCache));
        fetchBans();

        // --- Emails Logic ---
        const emailTbody = document.getElementById('emailbans-tbody');
        const refreshEmailBtn = document.getElementById('refreshEmailBtn');
        const loadingEmail = document.getElementById('loadingEmailIndicator');
        const searchEmail = document.getElementById('searchEmailInput');
        const addEmailForm = document.getElementById('add-emailban-form');
        const addEmailBtn = document.getElementById('addEmailBanBtn');
        const clearEmailBtn = document.getElementById('clearEmailBanBtn');
        const emailFormMsg = document.getElementById('emailFormMsg');
        let emailCache = [];

        function setEmailLoading(on) { 
            loadingEmail.classList.toggle('hidden', !on); 
            refreshEmailBtn.disabled = on; 
            const s = addEmailBtn.querySelector('.plinkk-spinner');
            if(on) s?.classList.remove('hidden'); else s?.classList.add('hidden');
            addEmailBtn.disabled = on; 
        }

        async function fetchEmailList() {
            try {
                setEmailLoading(true);
                const res = await fetch('/api/users/bans/emails');
                if (!res.ok) throw new Error('fetch_failed');
                const json = await res.json();
                emailCache = Array.isArray(json.bans) ? json.bans : [];
                renderEmailTable();
            } catch (e) { emailTbody.innerHTML = `<tr><td class="px-6 py-8 text-center text-rose-400" colspan="5">Erreur de chargement.</td></tr>`; }
            finally { setEmailLoading(false); }
        }

        function renderEmailTable() {
            const q = (searchEmail.value || '').toLowerCase();
            const list = q ? emailCache.filter(b => String(b.email || '').toLowerCase().includes(q) || String(b.reason || '').toLowerCase().includes(q)) : emailCache;
            
            if (list.length === 0) { emailTbody.innerHTML = `<tr><td class="px-6 py-8 text-center text-slate-500" colspan="5">Aucun email banni.</td></tr>`; return; }
            
            emailTbody.innerHTML = '';
            for (const b of list) {
                const until = (b.time == null || b.time < 0) ? null : (new Date(b.createdAt).getTime() + b.time * 60000);
                const tr = document.createElement('tr'); 
                tr.className = 'hover:bg-slate-800/30 transition-colors group';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white">${escapeHtml(b.email)}</td>
                    <td class="px-6 py-4 text-slate-400">${escapeHtml(b.reason || '-')}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs">${new Date(b.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs">${until ? new Date(until).toLocaleString() : 'Permanent'}</td>
                    <td class="px-6 py-4 text-right">
                        <button data-email="${b.email}" class="revoke-btn p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" title="Révoquer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </button>
                    </td>
                `;
                emailTbody.appendChild(tr);
            }
            Array.from(emailTbody.querySelectorAll('.revoke-btn')).forEach(btn => btn.addEventListener('click', onRevoke));
        }

        async function onRevoke(e) { 
            const email = e.currentTarget.getAttribute('data-email'); 
            if (!email || !confirm('Révoquer ce ban ?')) return; 
            try { 
                setEmailLoading(true); 
                const res = await fetch('/api/users/bans/emails?email=' + encodeURIComponent(email), { method: 'DELETE' }); 
                if (!res.ok) throw new Error('revoke_failed'); 
                showMessage(emailFormMsg, 'Ban révoqué', 'ok'); 
                await fetchEmailList(); 
            } catch (err) { showMessage(emailFormMsg, 'Erreur', 'error'); } 
            finally { setEmailLoading(false); } 
        }

        addEmailForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const fd = new FormData(addEmailForm);
            const email = String(fd.get('email') || '').trim();
            const reason = String(fd.get('reason') || '').trim();
            const time = Number(fd.get('time') || '-1');
            if (!email) return showMessage(emailFormMsg, 'Email requis', 'error');
            try {
                setEmailLoading(true);
                const res = await fetch('/api/users/bans/emails', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, reason, time }) });
                if (!res.ok) {
                    const e = await res.json().catch(() => ({}));
                    const code = e?.error || 'create_failed';
                    const map = { cannot_self_ban: "Vous ne pouvez pas vous bannir vous‑même.", cannot_ban_admin: "Vous ne pouvez pas bannir un administrateur.", forbidden_role: "Rôle insuffisant.", already_banned: "Déjà banni.", invalid_email: "Email invalide." };
                    return showMessage(emailFormMsg, map[code] || 'Échec', 'error');
                }
                addEmailForm.reset();
                showMessage(emailFormMsg, 'Ban créé', 'ok');
                await fetchEmailList();
            } catch (err) { showMessage(emailFormMsg, 'Erreur réseau', 'error'); } 
            finally { setEmailLoading(false); }
        });

        clearEmailBtn.addEventListener('click', () => addEmailForm.reset());
        refreshEmailBtn.addEventListener('click', () => fetchEmailList());
        searchEmail.addEventListener('input', () => renderEmailTable());
        document.querySelector('[data-tab="emails"]').addEventListener('click', () => { if (!emailCache.length) fetchEmailList(); });

        // --- Bulk Drawer ---
        const openBulkBtn = document.getElementById('openBulkBtn');
        const bulkDrawer = document.getElementById('bulkDrawer');
        const bulkBackdrop = document.getElementById('bulkBackdrop');
        const closeBulkBtn = document.getElementById('closeBulkBtn');
        const aside = bulkDrawer.querySelector('aside');
        
        function openDrawer() {
            bulkDrawer.classList.remove('hidden');
            requestAnimationFrame(() => {
                bulkBackdrop.classList.remove('opacity-0');
                aside.classList.remove('translate-x-full');
            });
            document.body.style.overflow = 'hidden';
        }
        
        function closeDrawer() {
            bulkBackdrop.classList.add('opacity-0');
            aside.classList.add('translate-x-full');
            setTimeout(() => {
                bulkDrawer.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        openBulkBtn.addEventListener('click', openDrawer);
        closeBulkBtn.addEventListener('click', closeDrawer);
        bulkBackdrop.addEventListener('click', closeDrawer);

        // Bulk Logic
        const userInput = document.getElementById('userSearchInput');
        const userDropdown = document.getElementById('userSearchDropdown');
        const selectedTbody = document.getElementById('bulkSelectedTbody');
        const bulkMsg = document.getElementById('bulkMsg');
        const bulkBanBtn = document.getElementById('bulkBanBtn');
        const bulkReason = document.getElementById('bulkReason');
        const bulkTime = document.getElementById('bulkTime');
        const bulkPasteArea = document.getElementById('bulkPasteArea');
        const bulkFileInput = document.getElementById('bulkFileInput');
        const bulkParseBtn = document.getElementById('bulkParseBtn');
        const selected = new Set();
        let searchTimer;

        userInput.addEventListener('input', () => {
            clearTimeout(searchTimer);
            const q = userInput.value.trim();
            if (!q) { userDropdown.classList.add('hidden'); userDropdown.innerHTML = ''; return; }
            searchTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`/dashboard/admin/users/search?q=${encodeURIComponent(q)}&limit=8`);
                    if (!res.ok) { userDropdown.classList.add('hidden'); return; }
                    const data = await res.json();
                    const users = Array.isArray(data.users) ? data.users : [];
                    if (users.length === 0) { userDropdown.classList.add('hidden'); return; }
                    userDropdown.innerHTML = users.map(u => {
                        const email = String(u.email || '');
                        const name = String(u.userName || u.id || '');
                        const disabled = selected.has(email);
                        return `<button data-email="${email}" class="flex w-full items-center gap-3 px-4 py-3 text-left hover:bg-slate-800 transition-colors border-b border-slate-800 last:border-0 ${disabled ? 'opacity-50 cursor-not-allowed' : ''}">
                            <div class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-xs font-bold text-white">${(name || 'U').charAt(0).toUpperCase()}</div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-white truncate">${escapeHtml(name)}</div>
                                <div class="text-xs text-slate-400 truncate">${escapeHtml(email)}</div>
                            </div>
                            <div class="text-xs text-violet-400 font-medium">Ajouter</div>
                        </button>`;
                    }).join('');
                    userDropdown.classList.remove('hidden');
                    Array.from(userDropdown.querySelectorAll('button')).forEach(b => b.addEventListener('click', (ev) => {
                        const email = ev.currentTarget.getAttribute('data-email');
                        if (!email || selected.has(email)) return;
                        selected.add(email);
                        renderSelected();
                        userDropdown.classList.add('hidden');
                        userInput.value = '';
                    }));
                } catch (e) { userDropdown.classList.add('hidden'); }
            }, 250);
        });

        document.addEventListener('click', (e) => { if (!userDropdown.contains(e.target) && e.target !== userInput) userDropdown.classList.add('hidden'); });

        function renderSelected() {
            const arr = Array.from(selected.values()).sort();
            if (arr.length === 0) { selectedTbody.innerHTML = `<tr><td colspan="2" class="px-4 py-4 text-center text-slate-500 text-xs">Aucune sélection.</td></tr>`; return; }
            selectedTbody.innerHTML = '';
            for (const email of arr) {
                const tr = document.createElement('tr');
                tr.className = 'group hover:bg-slate-900/50';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-slate-300">${escapeHtml(email)}</td>
                    <td class="px-4 py-3 text-right">
                        <button data-email="${email}" class="rm-btn text-slate-500 hover:text-rose-500 transition-colors">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </td>`;
                selectedTbody.appendChild(tr);
            }
            Array.from(selectedTbody.querySelectorAll('.rm-btn')).forEach(btn => btn.addEventListener('click', (ev) => {
                const email = ev.currentTarget.getAttribute('data-email'); if (!email) return; selected.delete(email); renderSelected();
            }));
        }

        function addEmailsToSelection(list) {
            let added = 0; const reEmail = /[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig;
            for (const raw of list) {
                const s = String(raw || '');
                const matches = s.match(reEmail);
                if (matches) { matches.forEach(m => { if (!selected.has(m.toLowerCase())) { selected.add(m.toLowerCase()); added++; } }); }
            }
            if (added > 0) renderSelected();
            return added;
        }

        bulkParseBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            const text = String(bulkPasteArea.value || '');
            const chunks = text.split(/[\n,;\t\s]+/).filter(Boolean);
            const added = addEmailsToSelection(chunks);
            bulkPasteArea.value = '';
            showMessage(bulkMsg, added > 0 ? `${added} email(s) ajouté(s)` : 'Aucun email détecté', added > 0 ? 'ok' : 'error');
        });

        bulkFileInput.addEventListener('change', () => {
            const f = bulkFileInput.files?.[0]; if (!f) return;
            const reader = new FileReader();
            reader.onload = () => {
                const text = String(reader.result || '');
                const rows = text.split(/[\r\n]+/);
                const cells = rows.flatMap(r => r.split(/[;,\t]+/));
                const added = addEmailsToSelection(cells);
                showMessage(bulkMsg, added > 0 ? `${added} email(s) ajouté(s)` : 'Aucun email détecté', added > 0 ? 'ok' : 'error');
            };
            reader.readAsText(f);
        });

        bulkBanBtn.addEventListener('click', async () => {
            const emails = Array.from(selected.values());
            if (emails.length === 0) return showMessage(bulkMsg, 'Sélection vide', 'error');
            
            const btn = bulkBanBtn; const s = btn.querySelector('.plinkk-spinner'); const l = btn.querySelector('span');
            btn.disabled = true; s?.classList.remove('hidden'); if(l) l.textContent = 'Traitement...';

            try {
                const payload = { emails, reason: String(bulkReason.value || ''), time: Number(bulkTime.value || '-1') };
                const res = await fetch('/api/users/bans/emails/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error('bulk_failed');
                const out = await res.json();
                const created = out?.created?.length || 0;
                const skipped = out?.alreadyBanned?.length || 0;
                
                showMessage(bulkMsg, `Succès: ${created} bannis. ${skipped} ignorés.`, 'ok');
                [...(out?.created || []), ...(out?.alreadyBanned || [])].forEach((em) => selected.delete(String(em).toLowerCase()));
                renderSelected();
                await fetchEmailList();
            } catch (err) { showMessage(bulkMsg, 'Erreur pendant le ban massif', 'error'); }
            finally { 
                btn.disabled = false; s?.classList.add('hidden'); if(l) l.textContent = 'Bannir la sélection'; 
            }
        });

    })();
</script>

<%- include('../../partials/footer.ejs') %>
