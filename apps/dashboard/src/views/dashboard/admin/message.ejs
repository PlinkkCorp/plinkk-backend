<%- include('partials/head.ejs', { title: 'Broadcast - Administration' ,
    description: 'Gérez les annonces globales du site.' , robots: 'noindex,nofollow' }) %>

    <%- include('partials/header-dash.ejs', { user: user }) %>

        <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
            <%- include('partials/admin-nav.ejs', { user: user, active: 'message' }) %>

                <main class="col-span-12 lg:col-span-10 space-y-8">
                    <!-- Header -->
                    <div
                        class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-gradient-to-r from-slate-900 to-slate-800 p-8 rounded-3xl border border-slate-800 relative overflow-hidden">
                        <div
                            class="absolute top-0 right-0 w-64 h-64 bg-violet-600/20 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none">
                        </div>
                        <div class="relative z-10">
                            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Broadcast</h1>
                            <p class="text-slate-400 text-lg">Diffusez des annonces sur le dashboard et/ou le site
                                public.</p>
                        </div>
                        <button type="button" id="newMsgBtn"
                            class="relative z-10 flex items-center gap-2 px-5 py-2.5 rounded-xl bg-violet-600 hover:bg-violet-500 text-white font-medium shadow-lg shadow-violet-900/20 transition-all hover:scale-[1.02] active:scale-[0.98] text-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Nouveau message
                        </button>
                    </div>

                    <!-- ═══ Messages existants ═══ -->
                    <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6 relative overflow-hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-white">Messages existants</h2>
                            <span id="msgCount" class="text-xs font-medium text-slate-500">0 message(s)</span>
                        </div>
                        <div id="msgList" class="space-y-3 max-h-[320px] overflow-y-auto pr-1">
                            <div class="text-sm text-slate-500 text-center py-6" id="msgListEmpty">Chargement...</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                        <!-- Form -->
                        <div class="xl:col-span-2 space-y-8">
                            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-8 relative overflow-hidden">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 id="formTitle" class="text-lg font-bold text-white">Nouveau message</h2>
                                    <span id="formBadge"
                                        class="hidden px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full bg-amber-500/10 text-amber-300 border border-amber-500/20">Modification</span>
                                </div>
                                <form id="siteMessageForm" class="space-y-6 relative z-10">

                                    <!-- ═══ Plateforme & Type d'affichage ═══ -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Plateforme -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-slate-400 mb-3 uppercase tracking-wider">Plateforme
                                                cible</label>
                                            <input type="hidden" name="platform" id="platformInput" value="all" />
                                            <div class="flex rounded-xl overflow-hidden border border-slate-800 bg-slate-950"
                                                id="platformGroup">
                                                <button type="button" data-val="all"
                                                    class="platform-btn flex-1 py-2.5 text-sm font-medium transition-all text-center">Tout</button>
                                                <button type="button" data-val="dashboard"
                                                    class="platform-btn flex-1 py-2.5 text-sm font-medium transition-all text-center border-x border-slate-800">Dashboard</button>
                                                <button type="button" data-val="public"
                                                    class="platform-btn flex-1 py-2.5 text-sm font-medium transition-all text-center">Public</button>
                                            </div>
                                        </div>
                                        <!-- Type d'affichage -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-slate-400 mb-3 uppercase tracking-wider">Type
                                                d'affichage</label>
                                            <input type="hidden" name="displayType" id="displayTypeInput"
                                                value="banner" />
                                            <div class="flex rounded-xl overflow-hidden border border-slate-800 bg-slate-950"
                                                id="displayTypeGroup">
                                                <button type="button" data-val="banner"
                                                    class="dtype-btn flex-1 py-2.5 text-sm font-medium transition-all text-center">
                                                    <span class="flex items-center justify-center gap-1.5">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <rect x="3" y="5" width="18" height="4" rx="1" />
                                                        </svg>
                                                        Bandeau
                                                    </span>
                                                </button>
                                                <button type="button" data-val="notification"
                                                    class="dtype-btn flex-1 py-2.5 text-sm font-medium transition-all text-center border-x border-slate-800">
                                                    <span class="flex items-center justify-center gap-1.5">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                                                            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                                                        </svg>
                                                        Notification
                                                    </span>
                                                </button>
                                                <button type="button" data-val="popup"
                                                    class="dtype-btn flex-1 py-2.5 text-sm font-medium transition-all text-center">
                                                    <span class="flex items-center justify-center gap-1.5">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <rect x="3" y="3" width="18" height="18" rx="2" />
                                                            <line x1="3" y1="9" x2="21" y2="9" />
                                                        </svg>
                                                        Popup
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ═══ Niveau + Dates ═══ -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Niveau</label>
                                            <div class="relative">
                                                <select name="level"
                                                    class="w-full appearance-none rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors cursor-pointer">
                                                    <option value="info">Info (Bleu)</option>
                                                    <option value="success">Succès (Vert)</option>
                                                    <option value="warning">Alerte (Jaune)</option>
                                                    <option value="error">Erreur (Rouge)</option>
                                                    <option value="maintenance">Maintenance (Violet)</option>
                                                </select>
                                                <div
                                                    class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2">
                                                        <path d="M6 9l6 6 6-6" />
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Début
                                                (Optionnel)</label>
                                            <input type="datetime-local" name="startAt"
                                                class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors [color-scheme:dark]" />
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Fin
                                                (Optionnel)</label>
                                            <input type="datetime-local" name="endAt"
                                                class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors [color-scheme:dark]" />
                                        </div>
                                    </div>

                                    <!-- ═══ Contenu ═══ -->
                                    <div>
                                        <label
                                            class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Contenu
                                            du message</label>
                                        <textarea name="text" rows="4"
                                            class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors resize-none"
                                            placeholder="Saisissez votre annonce ici..."></textarea>
                                    </div>

                                    <!-- ═══ Dismissible ═══ -->
                                    <div
                                        class="flex items-center gap-3 p-4 rounded-xl bg-slate-950/50 border border-slate-800">
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" name="dismissible" class="sr-only peer">
                                            <div
                                                class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600">
                                            </div>
                                        </label>
                                        <span class="text-sm text-slate-300">Autoriser les utilisateurs à masquer ce
                                            message</span>
                                    </div>

                                    <!-- ═══ Ciblage ═══ -->
                                    <div class="border-t border-slate-800 pt-6">
                                        <div class="flex items-center justify-between mb-6">
                                            <h3 class="text-lg font-bold text-white">Ciblage</h3>
                                            <div class="flex items-center gap-3">
                                                <span class="text-sm text-slate-400">Mode Global</span>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" name="global" id="globalToggle"
                                                        class="sr-only peer">
                                                    <div
                                                        class="w-11 h-6 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500">
                                                    </div>
                                                </label>
                                            </div>
                                        </div>

                                        <div id="targetsPanel"
                                            class="grid grid-cols-1 md:grid-cols-2 gap-8 transition-all duration-300">
                                            <div class="space-y-4">
                                                <label
                                                    class="block text-xs font-medium text-slate-400 uppercase tracking-wider">Par
                                                    Rôle</label>
                                                <div class="grid grid-cols-2 gap-3" id="rolesGroup">
                                                    <% if (typeof roles !=='undefined' && roles.length> 0) { %>
                                                        <% roles.forEach(role=> { %>
                                                            <label
                                                                class="flex items-center gap-3 p-3 rounded-xl bg-slate-950 border border-slate-800 cursor-pointer hover:border-slate-700 transition-colors">
                                                                <input type="checkbox" value="<%= role.id %>"
                                                                    class="roleBox w-4 h-4 rounded border-slate-700 text-violet-600 focus:ring-violet-600 bg-slate-900" />
                                                                <span class="text-sm font-medium text-slate-300">
                                                                    <%= role.name %>
                                                                </span>
                                                            </label>
                                                            <% }) %>
                                                                <% } else { %>
                                                                    <p class="text-sm text-slate-500 col-span-2">Aucun
                                                                        rôle disponible.</p>
                                                                    <% } %>
                                                </div>
                                            </div>

                                            <div class="space-y-4">
                                                <label
                                                    class="block text-xs font-medium text-slate-400 uppercase tracking-wider">Par
                                                    Utilisateur</label>
                                                <div class="relative">
                                                    <input type="text" id="userMentions"
                                                        class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm text-white focus:border-violet-500 outline-none transition-colors"
                                                        placeholder="Rechercher @pseudo, email..." />
                                                    <div id="userSuggestions"
                                                        class="absolute z-20 mt-2 w-full rounded-xl border border-slate-800 bg-slate-900 shadow-2xl hidden max-h-60 overflow-y-auto">
                                                    </div>
                                                </div>
                                                <div id="selectedUsers" class="flex flex-wrap gap-2 min-h-[40px]"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ═══ Actions ═══ -->
                                    <div class="flex items-center gap-4 pt-4 border-t border-slate-800">
                                        <button type="submit" id="submitBtn"
                                            class="flex-1 px-6 py-3 rounded-xl bg-violet-600 hover:bg-violet-500 text-white font-medium shadow-lg shadow-violet-900/20 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                            Publier le message
                                        </button>
                                        <button type="button" id="clearBtn"
                                            class="px-6 py-3 rounded-xl bg-rose-500/10 hover:bg-rose-500/20 text-rose-500 font-medium border border-rose-500/20 transition-colors hidden">
                                            Supprimer
                                        </button>
                                    </div>
                                    <div id="status" class="text-center text-sm font-medium min-h-[20px]"></div>
                                </form>
                            </div>
                        </div>

                        <!-- ═══ Preview Panel ═══ -->
                        <div class="xl:col-span-1 space-y-6">
                            <div class="sticky top-6">
                                <div class="flex items-center justify-between mb-4 px-2">
                                    <h3 class="text-lg font-bold text-white">Aperçu</h3>
                                    <div class="flex gap-2">
                                        <span id="previewPlatformBadge"
                                            class="px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full bg-violet-500/10 text-violet-300 border border-violet-500/20">Tout</span>
                                        <span id="previewTypeBadge"
                                            class="px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full bg-sky-500/10 text-sky-300 border border-sky-500/20">Bandeau</span>
                                    </div>
                                </div>

                                <!-- Preview: Banner -->
                                <div id="previewBanner"
                                    class="bg-slate-900 border border-slate-800 rounded-3xl p-6 relative overflow-hidden">
                                    <div
                                        class="absolute inset-0 bg-grid-slate-800/[0.2] [mask-image:linear-gradient(0deg,white,rgba(255,255,255,0.6))] pointer-events-none">
                                    </div>
                                    <div class="relative z-10 space-y-4">
                                        <div class="flex items-center gap-2 mb-4">
                                            <div class="h-3 w-3 rounded-full bg-slate-700"></div>
                                            <div class="h-3 w-20 bg-slate-800 rounded-full"></div>
                                            <div class="flex-1"></div>
                                            <div class="h-3 w-14 bg-slate-800 rounded-full"></div>
                                        </div>
                                        <div id="previewBannerContent"
                                            class="rounded-xl p-4 border border-slate-800 bg-slate-900/50 text-slate-500 text-center italic text-sm">
                                            Aucun message actif
                                        </div>
                                        <div class="space-y-3 pt-2 opacity-40">
                                            <div class="h-28 bg-slate-800 rounded-2xl w-full"></div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div class="h-20 bg-slate-800 rounded-2xl"></div>
                                                <div class="h-20 bg-slate-800 rounded-2xl"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Preview: Notification -->
                                <div id="previewNotification"
                                    class="bg-slate-900 border border-slate-800 rounded-3xl p-6 relative overflow-hidden hidden">
                                    <div
                                        class="absolute inset-0 bg-grid-slate-800/[0.2] [mask-image:linear-gradient(0deg,white,rgba(255,255,255,0.6))] pointer-events-none">
                                    </div>
                                    <div class="relative z-10">
                                        <div class="flex items-center gap-2 mb-6">
                                            <div class="h-3 w-3 rounded-full bg-slate-700"></div>
                                            <div class="h-3 w-20 bg-slate-800 rounded-full"></div>
                                            <div class="flex-1"></div>
                                            <div class="h-3 w-14 bg-slate-800 rounded-full"></div>
                                        </div>
                                        <div class="relative h-48">
                                            <div class="space-y-3 opacity-30">
                                                <div class="h-28 bg-slate-800 rounded-2xl w-full"></div>
                                                <div class="h-12 bg-slate-800 rounded-2xl w-full"></div>
                                            </div>
                                            <div class="absolute top-0 right-0 w-56" id="previewNotifCard">
                                                <div
                                                    class="rounded-xl border border-slate-700 bg-[#0f1a30] shadow-2xl overflow-hidden">
                                                    <div class="flex items-start gap-2.5 p-3">
                                                        <div class="shrink-0 mt-0.5" id="previewNotifIcon">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2"
                                                                class="text-sky-400">
                                                                <circle cx="12" cy="12" r="10" />
                                                                <line x1="12" y1="16" x2="12" y2="12" />
                                                                <line x1="12" y1="8" x2="12.01" y2="8" />
                                                            </svg>
                                                        </div>
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-[11px] font-semibold mb-0.5 capitalize"
                                                                id="previewNotifLevel">Info</p>
                                                            <p class="text-[11px] leading-relaxed text-slate-400"
                                                                id="previewNotifText">Aucun message</p>
                                                        </div>
                                                        <button class="shrink-0 text-slate-500 hover:text-white">
                                                            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24"
                                                                fill="currentColor">
                                                                <path
                                                                    d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Preview: Popup -->
                                <div id="previewPopup"
                                    class="bg-slate-900 border border-slate-800 rounded-3xl p-6 relative overflow-hidden hidden">
                                    <div
                                        class="absolute inset-0 bg-grid-slate-800/[0.2] [mask-image:linear-gradient(0deg,white,rgba(255,255,255,0.6))] pointer-events-none">
                                    </div>
                                    <div class="relative z-10">
                                        <div class="flex items-center gap-2 mb-6">
                                            <div class="h-3 w-3 rounded-full bg-slate-700"></div>
                                            <div class="h-3 w-20 bg-slate-800 rounded-full"></div>
                                            <div class="flex-1"></div>
                                            <div class="h-3 w-14 bg-slate-800 rounded-full"></div>
                                        </div>
                                        <div class="relative">
                                            <div class="space-y-3 opacity-20">
                                                <div class="h-16 bg-slate-800 rounded-2xl w-full"></div>
                                                <div class="h-16 bg-slate-800 rounded-2xl w-full"></div>
                                            </div>
                                            <div class="absolute inset-0 flex items-center justify-center">
                                                <div class="w-full max-w-[220px] rounded-xl border overflow-hidden shadow-2xl"
                                                    id="previewPopupCard">
                                                    <div class="px-4 py-3 border-b" id="previewPopupHeader">
                                                        <div class="flex items-center gap-2">
                                                            <div id="previewPopupIcon">
                                                                <svg width="16" height="16" viewBox="0 0 24 24"
                                                                    fill="none" stroke="currentColor" stroke-width="2"
                                                                    class="text-sky-400">
                                                                    <circle cx="12" cy="12" r="10" />
                                                                    <line x1="12" y1="16" x2="12" y2="12" />
                                                                    <line x1="12" y1="8" x2="12.01" y2="8" />
                                                                </svg>
                                                            </div>
                                                            <span class="text-xs font-bold">Annonce</span>
                                                        </div>
                                                    </div>
                                                    <div class="px-4 py-3 bg-[#161b2e]">
                                                        <p class="text-[11px] text-slate-300 leading-relaxed"
                                                            id="previewPopupText">Aucun message</p>
                                                    </div>
                                                    <div class="px-4 pb-3 bg-[#161b2e]">
                                                        <button
                                                            class="w-full py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-[11px] font-medium text-slate-400 border border-white/10">Compris</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-xs text-slate-500 mt-4 px-2 text-center" id="previewHint">
                                    Le bandeau est sticky sous le header.
                                </p>
                            </div>
                        </div>
                    </div>
                </main>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" id="modalBackdrop"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="w-full max-w-md bg-slate-900 border border-slate-800 rounded-3xl shadow-2xl transform transition-all scale-95 opacity-0"
                    id="modalContent">
                    <div class="p-6 text-center">
                        <div
                            class="w-16 h-16 bg-rose-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Supprimer le message ?</h3>
                        <p class="text-slate-400 text-sm mb-6">Cette action retirera immédiatement le message pour tous
                            les utilisateurs. Cette action est irréversible.</p>
                        <div class="flex gap-3">
                            <button id="dlgCancel"
                                class="flex-1 px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium transition-colors">Annuler</button>
                            <button id="dlgConfirm"
                                class="flex-1 px-4 py-2.5 rounded-xl bg-rose-600 hover:bg-rose-500 text-white font-medium transition-colors">Confirmer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            (function () {
                /* ═══════ DOM refs ═══════ */
                const form = document.getElementById('siteMessageForm');
                const status = document.getElementById('status');
                const clearBtn = document.getElementById('clearBtn');
                const submitBtn = document.getElementById('submitBtn');
                const globalToggle = document.getElementById('globalToggle');
                const targetsPanel = document.getElementById('targetsPanel');
                const rolesBoxes = Array.from(document.querySelectorAll('#rolesGroup .roleBox'));
                const userInput = document.getElementById('userMentions');
                const sugg = document.getElementById('userSuggestions');
                const selectedUsers = document.getElementById('selectedUsers');
                const formTitle = document.getElementById('formTitle');
                const formBadge = document.getElementById('formBadge');
                const msgList = document.getElementById('msgList');
                const msgListEmpty = document.getElementById('msgListEmpty');
                const msgCount = document.getElementById('msgCount');
                const newMsgBtn = document.getElementById('newMsgBtn');

                /* ═══════ State ═══════ */
                let currentId = null;   // null = new, string = editing
                let allMessages = [];    // cached from GET
                const picked = new Map(); // userId -> { id, userName, email, image }

                /* ═══════ Helpers ═══════ */
                function escapeHtml(s) {
                    return (s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
                }

                function flash(msg, ok) {
                    status.className = 'text-center text-sm font-medium ' + (ok ? 'text-emerald-400' : 'text-rose-400');
                    status.textContent = msg;
                    setTimeout(() => { status.textContent = ''; }, 3500);
                }

                function toLocalDT(iso) {
                    if (!iso) return '';
                    try { return new Date(iso).toISOString().slice(0, 16); } catch { return ''; }
                }

                /* ═══════ Platform & DisplayType Toggle Groups ═══════ */
                const platformInput = document.getElementById('platformInput');
                const displayTypeInput = document.getElementById('displayTypeInput');
                const platformBtns = document.querySelectorAll('.platform-btn');
                const dtypeBtns = document.querySelectorAll('.dtype-btn');

                const platformLabels = { all: 'Tout', dashboard: 'Dashboard', public: 'Public' };
                const dtypeLabels = { banner: 'Bandeau', notification: 'Notification', popup: 'Popup' };
                const dtypeHints = {
                    banner: 'Le bandeau est sticky sous le header.',
                    notification: 'Notification toast en haut à droite, auto-dismiss après ~8s.',
                    popup: 'Modal centré avec fond flouté. Bloque l\'interaction.'
                };

                function setPlatform(val) {
                    platformInput.value = val;
                    platformBtns.forEach(b => {
                        const active = b.getAttribute('data-val') === val;
                        b.className = 'platform-btn flex-1 py-2.5 text-sm font-medium transition-all text-center' +
                            (active ? ' bg-violet-600 text-white' : ' text-slate-400 hover:text-slate-200 hover:bg-slate-900');
                    });
                    document.getElementById('previewPlatformBadge').textContent = platformLabels[val] || val;
                    updatePreview();
                }

                function setDisplayType(val) {
                    displayTypeInput.value = val;
                    dtypeBtns.forEach(b => {
                        const active = b.getAttribute('data-val') === val;
                        b.className = 'dtype-btn flex-1 py-2.5 text-sm font-medium transition-all text-center' +
                            (active ? ' bg-sky-600 text-white' : ' text-slate-400 hover:text-slate-200 hover:bg-slate-900');
                        if (b.getAttribute('data-val') === 'notification') b.classList.add('border-x', 'border-slate-800');
                    });
                    document.getElementById('previewTypeBadge').textContent = dtypeLabels[val] || val;
                    document.getElementById('previewHint').textContent = dtypeHints[val] || '';
                    document.getElementById('previewBanner').classList.toggle('hidden', val !== 'banner');
                    document.getElementById('previewNotification').classList.toggle('hidden', val !== 'notification');
                    document.getElementById('previewPopup').classList.toggle('hidden', val !== 'popup');
                    updatePreview();
                }

                platformBtns.forEach(b => b.addEventListener('click', () => setPlatform(b.getAttribute('data-val'))));
                dtypeBtns.forEach(b => b.addEventListener('click', () => setDisplayType(b.getAttribute('data-val'))));

                /* ═══════ Targets Toggle ═══════ */
                function setTargetsDisabled(disabled) {
                    targetsPanel.classList.toggle('opacity-30', disabled);
                    targetsPanel.classList.toggle('pointer-events-none', disabled);
                    targetsPanel.classList.toggle('grayscale', disabled);
                }
                globalToggle.addEventListener('change', () => setTargetsDisabled(globalToggle.checked));

                /* ═══════ User Selection (picked chips) ═══════ */
                function renderPicked() {
                    selectedUsers.innerHTML = '';
                    for (const u of picked.values()) {
                        const chip = document.createElement('div');
                        chip.className = 'flex items-center gap-2 px-3 py-1.5 rounded-lg bg-violet-500/10 border border-violet-500/20 text-violet-200 text-xs font-medium animate-fade-in';
                        chip.innerHTML = '<span>@' + escapeHtml(u.userName || u.id) + '</span>' +
                            '<button type="button" class="text-violet-400 hover:text-white transition-colors">' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>';
                        chip.querySelector('button').addEventListener('click', () => { picked.delete(u.id); renderPicked(); });
                        selectedUsers.appendChild(chip);
                    }
                }

                let lastCtl = 0, debounceTimer = null;
                async function searchUsers(q) {
                    if (!q || q.length < 1) { sugg.classList.add('hidden'); sugg.innerHTML = ''; return; }
                    const ctl = ++lastCtl;
                    try {
                        const res = await fetch('/admin/users/search?q=' + encodeURIComponent(q) + '&limit=8');
                        if (!res.ok) { sugg.classList.add('hidden'); return; }
                        const json = await res.json();
                        if (ctl !== lastCtl) return;
                        const users = Array.isArray(json.users) ? json.users : [];
                        const filtered = users.filter(u => !picked.has(u.id));
                        if (!filtered.length) {
                            sugg.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500 text-center">Aucun résultat</div>';
                            sugg.classList.remove('hidden');
                            return;
                        }
                        sugg.innerHTML = filtered.map(u => {
                            const initials = (u.userName || u.id).slice(0, 1).toUpperCase();
                            const avatar = u.image
                                ? '<img src="' + escapeHtml(u.image) + '" class="w-8 h-8 rounded-lg object-cover" />'
                                : '<div class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-xs font-bold text-white border border-slate-700">' + initials + '</div>';
                            return '<button type="button" data-id="' + escapeHtml(u.id) + '" class="w-full text-left px-4 py-2.5 hover:bg-slate-800 flex items-center gap-3 transition-colors border-b border-slate-800/50 last:border-0">' +
                                avatar +
                                '<div class="flex-1 min-w-0">' +
                                '<div class="font-medium text-slate-200 text-sm truncate">@' + escapeHtml(u.userName || u.id) + '</div>' +
                                '<div class="text-xs text-slate-500 truncate">' + escapeHtml(u.email || '') + '</div>' +
                                '</div>' +
                                '<svg class="w-4 h-4 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
                                '</button>';
                        }).join('');
                        sugg.classList.remove('hidden');
                        sugg.querySelectorAll('button[data-id]').forEach(b => {
                            b.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const uid = b.getAttribute('data-id');
                                const u = users.find(x => x.id === uid);
                                if (u && !picked.has(u.id)) {
                                    picked.set(u.id, u);
                                    renderPicked();
                                    b.remove();
                                    if (!sugg.querySelectorAll('button[data-id]').length) sugg.classList.add('hidden');
                                }
                                userInput.value = '';
                                userInput.focus();
                            });
                        });
                    } catch (e) {
                        console.error('User search error:', e);
                        sugg.classList.add('hidden');
                    }
                }

                userInput.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    const v = userInput.value.trim();
                    const q = v.startsWith('@') ? v.slice(1) : v;
                    if (!q) { sugg.classList.add('hidden'); return; }
                    debounceTimer = setTimeout(() => searchUsers(q), 250);
                });
                userInput.addEventListener('focus', () => {
                    const v = userInput.value.trim();
                    const q = v.startsWith('@') ? v.slice(1) : v;
                    if (q.length >= 1) searchUsers(q);
                });
                document.addEventListener('click', (e) => {
                    if (!sugg.contains(e.target) && e.target !== userInput) sugg.classList.add('hidden');
                });

                /* ═══════ Preview Logic ═══════ */
                const levelStyles = {
                    info: { bg: 'bg-sky-500/10', border: 'border-sky-500/20', text: 'text-sky-200', icon: 'text-sky-400' },
                    success: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', text: 'text-emerald-200', icon: 'text-emerald-400' },
                    warning: { bg: 'bg-amber-500/10', border: 'border-amber-500/20', text: 'text-amber-200', icon: 'text-amber-400' },
                    error: { bg: 'bg-rose-500/10', border: 'border-rose-500/20', text: 'text-rose-200', icon: 'text-rose-400' },
                    maintenance: { bg: 'bg-violet-500/10', border: 'border-violet-500/20', text: 'text-violet-200', icon: 'text-violet-400' }
                };
                const levelIcons = {
                    info: '<svg width="W" height="W" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
                    success: '<svg width="W" height="W" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                    warning: '<svg width="W" height="W" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                    error: '<svg width="W" height="W" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                    maintenance: '<svg width="W" height="W" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>'
                };
                function getIcon(lvl, size) { return (levelIcons[lvl] || levelIcons.info).replace(/W/g, size || '18'); }

                function updatePreview() {
                    const lvl = (form.elements['level'].value || 'info').toLowerCase();
                    const txt = form.elements['text'].value || '';
                    const dismissible = form.elements['dismissible'].checked;
                    const s = levelStyles[lvl] || levelStyles.info;

                    // Banner preview
                    const bc = document.getElementById('previewBannerContent');
                    if (!txt) {
                        bc.className = 'rounded-xl p-4 border border-slate-800 bg-slate-900/50 text-slate-500 text-center italic text-sm';
                        bc.innerHTML = 'Aucun message actif';
                    } else {
                        bc.className = 'rounded-xl p-0 border ' + s.border + ' ' + s.text + ' transition-all duration-300';
                        bc.innerHTML = '<div class="flex items-start gap-3 px-4 py-3 ' + s.bg + '">' +
                            '<div class="' + s.icon + ' mt-0.5 shrink-0">' + getIcon(lvl) + '</div>' +
                            '<div class="text-sm leading-relaxed font-medium flex-1">' + escapeHtml(txt) + '</div>' +
                            (dismissible ? '<button class="ml-2 text-slate-200/80 hover:text-white"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"/></svg></button>' : '') +
                            '</div>';
                    }

                    // Notification preview
                    const notifCard = document.getElementById('previewNotifCard');
                    if (notifCard) {
                        const nc = notifCard.querySelector('.rounded-xl');
                        nc.className = 'rounded-xl border ' + s.border + ' bg-[#0f1a30] shadow-2xl overflow-hidden';
                        document.getElementById('previewNotifIcon').innerHTML = '<span class="' + s.icon + '">' + getIcon(lvl, '16') + '</span>';
                        document.getElementById('previewNotifLevel').className = 'text-[11px] font-semibold mb-0.5 capitalize ' + s.text;
                        document.getElementById('previewNotifLevel').textContent = lvl;
                        document.getElementById('previewNotifText').textContent = txt || 'Aucun message';
                    }

                    // Popup preview
                    const popupCard = document.getElementById('previewPopupCard');
                    if (popupCard) {
                        popupCard.className = 'w-full max-w-[220px] rounded-xl border ' + s.border + ' overflow-hidden shadow-2xl';
                        const header = document.getElementById('previewPopupHeader');
                        header.className = 'px-4 py-3 border-b ' + s.border + ' ' + s.bg;
                        header.querySelector('.flex').className = 'flex items-center gap-2 ' + s.text;
                        document.getElementById('previewPopupIcon').innerHTML = '<span class="' + s.icon + '">' + getIcon(lvl, '16') + '</span>';
                        document.getElementById('previewPopupText').textContent = txt || 'Aucun message';
                    }
                }

                // Live preview on form input changes
                ['level', 'text', 'dismissible'].forEach(f => {
                    const el = form.elements[f];
                    if (el) el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', updatePreview);
                });

                /* ═══════ Form Mode (new vs edit) ═══════ */
                function setFormMode(id) {
                    currentId = id || null;
                    if (currentId) {
                        formTitle.textContent = 'Modifier le message';
                        formBadge.classList.remove('hidden');
                        submitBtn.textContent = 'Enregistrer les modifications';
                        clearBtn.classList.remove('hidden');
                    } else {
                        formTitle.textContent = 'Nouveau message';
                        formBadge.classList.add('hidden');
                        submitBtn.textContent = 'Publier le message';
                        clearBtn.classList.add('hidden');
                    }
                }

                function resetForm() {
                    form.reset();
                    currentId = null;
                    picked.clear();
                    renderPicked();
                    rolesBoxes.forEach(b => b.checked = false);
                    setPlatform('all');
                    setDisplayType('banner');
                    setTargetsDisabled(false);
                    setFormMode(null);
                    updatePreview();
                    // Deselect in list
                    msgList.querySelectorAll('.msg-card').forEach(c => c.classList.remove('ring-2', 'ring-violet-500'));
                }

                newMsgBtn.addEventListener('click', resetForm);

                /* ═══════ Load a message into the form ═══════ */
                async function selectMessage(m) {
                    setFormMode(m.id);

                    form.elements['level'].value = m.level || 'info';
                    form.elements['text'].value = m.text || '';
                    form.elements['startAt'].value = toLocalDT(m.startAt);
                    form.elements['endAt'].value = toLocalDT(m.endAt);
                    form.elements['dismissible'].checked = !!m.dismissible;

                    setPlatform(m.platform || 'all');
                    setDisplayType(m.displayType || 'banner');

                    // Targeting
                    rolesBoxes.forEach(b => b.checked = false);
                    picked.clear();

                    if (m.global) {
                        globalToggle.checked = true;
                        setTargetsDisabled(true);
                    } else {
                        globalToggle.checked = false;
                        setTargetsDisabled(false);

                        // Roles
                        if (Array.isArray(m.targetRoles)) {
                            m.targetRoles.forEach(r => {
                                const cb = rolesBoxes.find(b => b.value === r);
                                if (cb) cb.checked = true;
                            });
                        }

                        // Users — fetch info for each userId
                        if (Array.isArray(m.targetUserIds) && m.targetUserIds.length) {
                            for (const uid of m.targetUserIds) {
                                try {
                                    const res = await fetch('/admin/users/search?q=' + encodeURIComponent(uid) + '&limit=1');
                                    if (res.ok) {
                                        const j = await res.json();
                                        const u = Array.isArray(j.users) && j.users.length ? j.users[0] : null;
                                        if (u) picked.set(u.id, u);
                                        else picked.set(uid, { id: uid, userName: uid });
                                    } else {
                                        picked.set(uid, { id: uid, userName: uid });
                                    }
                                } catch {
                                    picked.set(uid, { id: uid, userName: uid });
                                }
                            }
                            renderPicked();
                        }
                    }

                    renderPicked();
                    updatePreview();

                    // Highlight in list
                    msgList.querySelectorAll('.msg-card').forEach(c => {
                        c.classList.toggle('ring-2', c.dataset.id === m.id);
                        c.classList.toggle('ring-violet-500', c.dataset.id === m.id);
                    });

                    // Scroll to form
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                /* ═══════ Messages list rendering ═══════ */
                const levelBadgeColors = {
                    info: 'bg-sky-500/10 text-sky-300 border-sky-500/20',
                    success: 'bg-emerald-500/10 text-emerald-300 border-emerald-500/20',
                    warning: 'bg-amber-500/10 text-amber-300 border-amber-500/20',
                    error: 'bg-rose-500/10 text-rose-300 border-rose-500/20',
                    maintenance: 'bg-violet-500/10 text-violet-300 border-violet-500/20'
                };

                function renderMsgList() {
                    const msgs = allMessages;
                    msgCount.textContent = msgs.length + ' message(s)';

                    if (!msgs.length) {
                        msgList.innerHTML = '<div class="text-sm text-slate-500 text-center py-6">Aucun message. Cliquez sur « Nouveau message » pour en créer un.</div>';
                        return;
                    }

                    msgList.innerHTML = msgs.map(m => {
                        const lvlColor = levelBadgeColors[m.level] || levelBadgeColors.info;
                        const isActive = currentId === m.id;
                        const now = Date.now();
                        const started = !m.startAt || new Date(m.startAt).getTime() <= now;
                        const ended = m.endAt && new Date(m.endAt).getTime() < now;
                        let statusBadge = '';
                        if (ended) {
                            statusBadge = '<span class="px-2 py-0.5 text-[10px] font-bold uppercase rounded-full bg-slate-700/50 text-slate-400 border border-slate-600/30">Expiré</span>';
                        } else if (!started) {
                            statusBadge = '<span class="px-2 py-0.5 text-[10px] font-bold uppercase rounded-full bg-amber-500/10 text-amber-300 border border-amber-500/20">Planifié</span>';
                        } else {
                            statusBadge = '<span class="px-2 py-0.5 text-[10px] font-bold uppercase rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/20">Actif</span>';
                        }

                        const platformBadge = m.platform !== 'all'
                            ? '<span class="px-2 py-0.5 text-[10px] font-bold uppercase rounded-full bg-slate-700/50 text-slate-300 border border-slate-600/30">' + escapeHtml(m.platform) + '</span>'
                            : '';
                        const dtypeBadge = '<span class="px-2 py-0.5 text-[10px] font-bold uppercase rounded-full bg-slate-700/50 text-slate-300 border border-slate-600/30">' + escapeHtml(dtypeLabels[m.displayType] || m.displayType) + '</span>';

                        const isBugResponse = m.text.startsWith('[RÉPONSE BUG]');
                        const displayTxt = isBugResponse ? m.text.replace('[RÉPONSE BUG]', '').trim() : m.text;
                        const bugResponseBadge = isBugResponse ? '<span class="px-2 py-0.5 text-[10px] font-bold uppercase rounded-full bg-violet-600/20 text-violet-400 border border-violet-500/30">Réponse Bug</span>' : '';

                        return '<div class="msg-card group flex items-start gap-4 p-4 rounded-2xl bg-slate-950 border border-slate-800 cursor-pointer hover:border-slate-700 transition-all' +
                            (isActive ? ' ring-2 ring-violet-500' : '') + '" data-id="' + escapeHtml(m.id) + '">' +
                            '<div class="shrink-0 mt-1"><span class="' + lvlColor + ' px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full border">' + escapeHtml(m.level) + '</span></div>' +
                            '<div class="flex-1 min-w-0">' +
                            '<p class="text-sm text-white font-medium truncate mb-1">' + (isBugResponse ? '<span class="text-violet-400 font-bold mr-1">[BUG]</span>' : '') + escapeHtml(displayTxt) + '</p>' +
                            '<div class="flex flex-wrap items-center gap-2">' + statusBadge + dtypeBadge + platformBadge + bugResponseBadge +
                            '<span class="text-[10px] text-slate-500">' + new Date(m.createdAt).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) + '</span>' +
                            (m.global ? '<span class="text-[10px] text-emerald-400 font-medium">Global</span>' : '') +
                            '</div></div>' +
                            '<button type="button" class="msg-del-btn shrink-0 opacity-0 group-hover:opacity-100 p-2 rounded-lg hover:bg-rose-500/10 text-slate-500 hover:text-rose-400 transition-all" title="Supprimer">' +
                            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>' +
                            '</button></div>';
                    }).join('');

                    // Click handlers
                    msgList.querySelectorAll('.msg-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            // If click on delete button, don't select
                            if (e.target.closest('.msg-del-btn')) return;
                            const id = card.dataset.id;
                            const m = allMessages.find(x => x.id === id);
                            if (m) selectMessage(m);
                        });
                    });
                    msgList.querySelectorAll('.msg-del-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const card = btn.closest('.msg-card');
                            const id = card.dataset.id;
                            pendingDeleteId = id;
                            openModal();
                        });
                    });
                }

                /* ═══════ Data Loading ═══════ */
                async function loadMessages() {
                    try {
                        const res = await fetch('/admin/message/api');
                        if (!res.ok) { msgList.innerHTML = '<div class="text-sm text-rose-400 text-center py-6">Erreur de chargement.</div>'; return; }
                        const json = await res.json();
                        allMessages = Array.isArray(json.messages) ? json.messages : [];
                        renderMsgList();
                    } catch (e) {
                        console.error(e);
                        msgList.innerHTML = '<div class="text-sm text-rose-400 text-center py-6">Erreur de chargement.</div>';
                    }
                }

                /* ═══════ Submit (Create or Update) ═══════ */
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Enregistrement...';
                    status.textContent = '';

                    try {
                        const data = {
                            level: form.elements['level'].value,
                            text: form.elements['text'].value,
                            dismissible: form.elements['dismissible'].checked === true,
                            platform: platformInput.value,
                            displayType: displayTypeInput.value,
                            global: globalToggle.checked === true
                        };

                        // Include ID for updates
                        if (currentId) data.id = currentId;

                        if (form.elements['startAt'].value) data.startAt = new Date(form.elements['startAt'].value).toISOString();
                        if (form.elements['endAt'].value) data.endAt = new Date(form.elements['endAt'].value).toISOString();

                        if (!data.global) {
                            const rolesSel = rolesBoxes.filter(b => b.checked).map(b => b.value);
                            const userIds = Array.from(picked.keys());
                            if (rolesSel.length) data.targetRoles = rolesSel;
                            if (userIds.length) data.targetUserIds = userIds;
                        }

                        const res = await fetch('/admin/message/api', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (res.ok) {
                            const json = await res.json();
                            flash(currentId ? 'Message mis à jour !' : 'Message publié avec succès !', true);

                            // Update currentId if it was a new creation
                            if (json.message && json.message.id) {
                                currentId = json.message.id;
                                setFormMode(currentId);
                            }

                            await loadMessages();
                            updatePreview();
                        } else {
                            const errJson = await res.json().catch(() => null);
                            flash(errJson?.error || 'Erreur serveur.', false);
                        }
                    } catch (err) {
                        flash("Erreur lors de l'enregistrement.", false);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });

                /* ═══════ Delete Modal ═══════ */
                const modal = document.getElementById('deleteModal');
                const modalContent = document.getElementById('modalContent');
                const modalBackdrop = document.getElementById('modalBackdrop');
                let pendingDeleteId = null;

                function openModal() {
                    modal.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    });
                }

                function closeModal() {
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => { modal.classList.add('hidden'); pendingDeleteId = null; }, 200);
                }

                clearBtn.addEventListener('click', () => {
                    if (!currentId) return;
                    pendingDeleteId = currentId;
                    openModal();
                });
                document.getElementById('dlgCancel').addEventListener('click', closeModal);
                modalBackdrop.addEventListener('click', closeModal);

                document.getElementById('dlgConfirm').addEventListener('click', async () => {
                    const idToDelete = pendingDeleteId;
                    if (!idToDelete) { closeModal(); return; }

                    try {
                        const res = await fetch('/admin/message/api?id=' + encodeURIComponent(idToDelete), { method: 'DELETE' });
                        if (res.ok) {
                            flash('Message supprimé.', true);
                            // If we were editing this message, reset form
                            if (currentId === idToDelete) resetForm();
                            await loadMessages();
                        } else {
                            flash('Erreur lors de la suppression.', false);
                        }
                    } catch (e) {
                        flash('Erreur lors de la suppression.', false);
                    }
                    closeModal();
                });

                /* ═══════ Init ═══════ */
                setPlatform('all');
                setDisplayType('banner');
                setTargetsDisabled(false);
                setFormMode(null);
                loadMessages();
            })();
        </script>

        <style>
            .animate-fade-in {
                animation: fadeIn 0.2s ease-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
        </style>