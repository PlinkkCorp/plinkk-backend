<%
  const _av_entity = typeof user !== 'undefined' && user;
  let _av_imgUrl = null;
  if (_av_entity && _av_entity.image) {
    _av_imgUrl = String(_av_entity.image);
    if (!/^https?:\/\//i.test(_av_imgUrl) && _av_imgUrl[0] !== '/' && !/^data:/i.test(_av_imgUrl)) {
      _av_imgUrl = '/public/uploads/avatars/' + _av_imgUrl;
    }
  } else if (_av_entity) {
    // Gravatar logic
    const _av_source = _av_entity.gravatarEmailSource || 'PRIMARY';
    const _av_email = _av_source === 'PUBLIC' ? (_av_entity.publicEmail || _av_entity.email) : _av_entity.email;
    if (_av_email && typeof getGravatarUrl === 'function') {
      _av_imgUrl = getGravatarUrl(_av_email);
    }
  }
  const _av_initial = _av_entity && (_av_entity.userName || _av_entity.id) ? String(_av_entity.userName || _av_entity.id).charAt(0).toUpperCase() : 'U';

  /* ── Premium detection ── */
  const _av_rn = _av_entity && _av_entity.role ? (_av_entity.role.id || _av_entity.role.name) : null;
  const _av_staff = !!(_av_rn && ['ADMIN','DEVELOPER','MODERATOR'].includes(_av_rn));
  const _av_pu = _av_entity && _av_entity.premiumUntil ? new Date(_av_entity.premiumUntil) : null;
  const _av_activePremium = !!(_av_entity && _av_entity.isPremium && (!_av_pu || _av_pu.getTime() > Date.now()));
  const _av_isPremium = !!(_av_entity && (_av_staff || _av_entity.isPartner || _av_activePremium));
  const _av_showUi = !!(_av_entity && _av_entity.showPremiumUi !== false);
  const _av_show = _av_isPremium && _av_showUi;
%>
<%/* ── Styles (safe to duplicate, browser dedupes) ── */%>
<style>
  @keyframes _av_ring_spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
  @keyframes _av_glow_pulse { 0%,100%{opacity:.55} 50%{opacity:.9} }
  .plinkk-av { position:relative; display:inline-flex; align-items:center; justify-content:center; }
  .plinkk-av-img { width:100%; height:100%; border-radius:9999px; overflow:hidden; display:grid; place-items:center; font-weight:700; color:#fff; background:#1e293b; position:relative; z-index:2; }
  /* ── Premium ring ── */
  .plinkk-av--premium .plinkk-av-ring {
    position:absolute; inset:-3px; border-radius:9999px; z-index:1; padding:2px;
    background: conic-gradient(from 180deg, #2dd4bf, #06b6d4, #8b5cf6, #d946ef, #2dd4bf);
    animation: _av_ring_spin 3s linear infinite;
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
  }
  .plinkk-av--premium .plinkk-av-glow {
    position:absolute; inset:-6px; border-radius:9999px; z-index:0;
    background: radial-gradient(circle, rgba(6,182,212,0.3) 0%, rgba(168,85,247,0.2) 60%, transparent 80%);
    animation: _av_glow_pulse 2.5s ease-in-out infinite;
    pointer-events:none;
  }
  .plinkk-av--premium .plinkk-av-badge {
    position:absolute; bottom:-1px; right:-1px; z-index:3;
    width:40%; height:40%; max-width:18px; max-height:18px; min-width:10px; min-height:10px;
    border-radius:9999px; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(135deg, #06b6d4, #a855f7);
    box-shadow: 0 2px 8px rgba(139,92,246,0.5), 0 0 0 2px #0f172a;
  }
  .plinkk-av--premium .plinkk-av-badge svg { width:60%; height:60%; }
</style>

<div class="plinkk-av w-full h-full<%= _av_show ? ' plinkk-av--premium' : '' %>" data-avatar data-avatar-user="<%= _av_entity && _av_entity.id ? _av_entity.id : '' %>">
  <% if (_av_show) { %><div class="plinkk-av-glow"></div><div class="plinkk-av-ring"></div><% } %>
  <div class="plinkk-av-img animate-pulse bg-slate-800">
    <% if (_av_imgUrl) { %>
      <img src="<%= _av_imgUrl %>" alt="Avatar" class="h-full w-full object-cover opacity-0 transition-opacity duration-300" onload="this.classList.remove('opacity-0'); this.parentElement.classList.remove('animate-pulse', 'bg-slate-800');" onerror="this.onerror=null; this.style.display='none'; this.parentElement.classList.remove('animate-pulse', 'bg-slate-800'); if(this.parentNode) { this.parentNode.textContent = '<%= _av_initial %>'; }" />
    <% } else if (_av_entity && _av_entity.profileImage) { %>
      <img src="<%= _av_entity.profileImage %>" alt="Avatar" class="h-full w-full object-cover opacity-0 transition-opacity duration-300" onload="this.classList.remove('opacity-0'); this.parentElement.classList.remove('animate-pulse', 'bg-slate-800');" onerror="this.onerror=null; this.style.display='none'; this.parentElement.classList.remove('animate-pulse', 'bg-slate-800'); if(this.parentNode) { this.parentNode.textContent = '<%= _av_initial %>'; }" />
    <% } else { %>
      <script>document.currentScript.parentElement.classList.remove('animate-pulse', 'bg-slate-800');</script>
      <%= _av_initial %>
    <% } %>
  </div>
  <% if (_av_show) { %>
    <div class="plinkk-av-badge"><svg viewBox="0 0 24 24" fill="#fff"><path d="M2 8l4 3 4-5 4 5 4-3-2 10H4L2 8z"/><rect x="3" y="18" width="14" height="2" rx="1" transform="translate(2 0)"/></svg></div>
  <% } %>
</div>
