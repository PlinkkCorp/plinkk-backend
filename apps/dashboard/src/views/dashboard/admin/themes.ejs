<%- include('../../partials/head.ejs', { title: 'Admin - Thèmes', description: '', robots: 'noindex,nofollow' }) %>
<%- include('../../partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
  <%- include('../../partials/admin-nav.ejs', { user: user, active: 'themes' }) %>

  <main class="col-span-12 lg:col-span-10 space-y-8">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <h1 class="text-2xl font-bold text-white">Gestion des thèmes</h1>
    <a href="/themes" class="inline-flex items-center px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700 text-white text-sm font-medium transition-colors">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      Créer un thème
    </a>
  </div>

  <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6 space-y-6">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1 relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input id="themeSearch" type="search" 
          class="block w-full pl-10 pr-10 py-2.5 bg-slate-950 border border-slate-800 rounded-xl text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 transition-all sm:text-sm" 
          placeholder="Rechercher un thème ou auteur...">
        <button id="clearSearch" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-500 hover:text-slate-300 hidden">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="w-full md:w-64">
        <select id="themeCategoryFilter" class="block w-full py-2.5 px-3 bg-slate-950 border border-slate-800 rounded-xl text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-500 sm:text-sm">
          <option value="">Toutes catégories</option>
        </select>
      </div>
    </div>

    <div class="flex space-x-1 bg-slate-950 p-1 rounded-xl w-fit border border-slate-800" role="tablist">
      <button class="tabBtn flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-slate-200" data-tab="submitted" role="tab" aria-selected="true">
        À valider <span class="ml-2 px-1.5 py-0.5 rounded-md bg-slate-800 text-slate-300 text-xs tab-count">0</span>
      </button>
      <button class="tabBtn flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-slate-200" data-tab="approved" role="tab" aria-selected="false">
        Validés <span class="ml-2 px-1.5 py-0.5 rounded-md bg-slate-800 text-slate-300 text-xs tab-count">0</span>
      </button>
      <button class="tabBtn flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-slate-200" data-tab="archived" role="tab" aria-selected="false">
        Archivés <span class="ml-2 px-1.5 py-0.5 rounded-md bg-slate-800 text-slate-300 text-xs tab-count">0</span>
      </button>
    </div>

    <style>
      .tabBtn.active { background-color: rgb(124 58 237); color: white; }
      .tabBtn.active .tab-count { background-color: rgba(255,255,255,0.2); color: white; }
      .section-hidden { display:none !important; }
    </style>

    <section data-section="submitted">
      <ul id="gridSubmitted" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        <% if ((submitted||[]).length === 0) { %>
          <li class="server-empty-placeholder col-span-full text-center py-12 text-slate-500">Aucun thème en attente.</li>
        <% } else { %>
        <% submitted.forEach(t => { %>
          <li draggable="true" class="themeCard group relative flex flex-col bg-slate-950 border border-slate-800 rounded-2xl p-4 transition-all hover:border-slate-700" data-name="<%- (t.name||'').toLowerCase() %>" data-author="<%- (t.author?.userName||'').toLowerCase() %>" data-id="<%= t.id %>" data-json='<%- JSON.stringify(t.data||{}) %>'>
            <div class="flex items-start gap-4">
              <div class="w-20 h-20 rounded-xl border border-slate-800 overflow-hidden themePreview shrink-0 bg-slate-900"></div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center justify-between gap-2">
                  <h3 class="font-semibold text-slate-200 truncate"><%= t.name %></h3>
                  <% if (t.pendingUpdate) { %>
                    <span class="shrink-0 px-2 py-0.5 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-400 text-[10px] font-medium">MAJ</span>
                  <% } %>
                </div>
                <div class="text-xs text-slate-400 truncate mt-0.5">par <span class="text-slate-300">@<%= t.author.userName %></span></div>
                <% if (t.description) { %>
                  <p class="text-xs text-slate-500 mt-2 line-clamp-2"><%= t.description %></p>
                <% } %>
                <div class="text-[10px] text-slate-600 mt-2">Mis à jour <%= new Date(t.updatedAt).toLocaleString('fr-FR') %></div>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-800 flex items-center justify-end gap-2 actions">
              <% if (t.pendingUpdate) { %>
                <button class="approveUpdateBtn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors">Approuver MAJ</button>
              <% } else { %>
                <button class="approveBtn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors">Approuver</button>
                <button class="rejectBtn px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-xs font-medium transition-colors">Rejeter</button>
              <% } %>
              <button class="archiveBtn px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-medium transition-colors">Archiver</button>
              <a class="px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-700 text-white text-xs font-medium transition-colors" href="/admin/themes/<%= t.id %>">Voir</a>
            </div>
          </li>
        <% }) %>
        <% } %>
      </ul>
    </section>

    <section data-section="approved" class="section-hidden">
      <ul id="gridApproved" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        <% if ((approved||[]).length === 0) { %>
          <li class="server-empty-placeholder col-span-full text-center py-12 text-slate-500">Aucun thème validé.</li>
        <% } else { %>
        <% approved.forEach(t => { %>
          <li draggable="true" class="themeCard group relative flex flex-col bg-slate-950 border border-slate-800 rounded-2xl p-4 transition-all hover:border-slate-700" data-name="<%- (t.name||'').toLowerCase() %>" data-author="<%- (t.author?.userName||'').toLowerCase() %>" data-id="<%= t.id %>" data-json='<%- JSON.stringify(t.data||{}) %>'>
            <div class="flex items-start gap-4">
              <div class="w-20 h-20 rounded-xl border border-slate-800 overflow-hidden themePreview shrink-0 bg-slate-900"></div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center justify-between gap-2">
                  <h3 class="font-semibold text-slate-200 truncate"><%= t.name %></h3>
                  <% if (t.pendingUpdate) { %>
                    <span class="shrink-0 px-2 py-0.5 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-400 text-[10px] font-medium">MAJ</span>
                  <% } %>
                </div>
                <div class="text-xs text-slate-400 truncate mt-0.5">par <span class="text-slate-300">@<%= t.author.userName %></span></div>
                <% if (t.description) { %>
                  <p class="text-xs text-slate-500 mt-2 line-clamp-2"><%= t.description %></p>
                <% } %>
                <div class="text-[10px] text-slate-600 mt-2">Mis à jour <%= new Date(t.updatedAt).toLocaleString('fr-FR') %></div>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-800 flex items-center justify-end gap-2 actions">
              <% if (t.pendingUpdate) { %>
                <button class="approveUpdateBtn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors">Approuver MAJ</button>
              <% } %>
              <button class="archiveBtn px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-medium transition-colors">Archiver</button>
              <a class="px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-700 text-white text-xs font-medium transition-colors" href="/admin/themes/<%= t.id %>">Voir</a>
              <button class="deleteBtn px-3 py-1.5 rounded-lg bg-rose-900/50 hover:bg-rose-900 text-rose-200 text-xs font-medium transition-colors border border-rose-900/50">Supprimer</button>
            </div>
          </li>
        <% }) %>
        <% } %>
      </ul>
    </section>

    <section data-section="archived" class="section-hidden">
      <ul id="gridArchived" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        <% if ((archived||[]).length === 0) { %>
          <li class="server-empty-placeholder col-span-full text-center py-12 text-slate-500">Aucun thème archivé.</li>
        <% } else { %>
        <% archived.forEach(t => { %>
          <li draggable="true" class="themeCard group relative flex flex-col bg-slate-950 border border-slate-800 rounded-2xl p-4 transition-all hover:border-slate-700" data-name="<%- (t.name||'').toLowerCase() %>" data-author="<%- (t.author?.userName||'').toLowerCase() %>" data-id="<%= t.id %>" data-json='<%- JSON.stringify(t.data||{}) %>'>
            <div class="flex items-start gap-4">
              <div class="w-20 h-20 rounded-xl border border-slate-800 overflow-hidden themePreview shrink-0 bg-slate-900"></div>
              <div class="min-w-0 flex-1">
                <div class="font-semibold text-slate-200 truncate"><%= t.name %></div>
                <div class="text-xs text-slate-400 truncate mt-0.5">par <span class="text-slate-300">@<%= t.author.userName %></span></div>
                <% if (t.description) { %>
                  <p class="text-xs text-slate-500 mt-2 line-clamp-2"><%= t.description %></p>
                <% } %>
                <div class="text-[10px] text-slate-600 mt-2">Mis à jour <%= new Date(t.updatedAt).toLocaleString('fr-FR') %></div>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-800 flex items-center justify-end gap-2 actions">
              <button class="unarchiveBtn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors">Republier</button>
              <a class="px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-700 text-white text-xs font-medium transition-colors" href="/admin/themes/<%= t.id %>">Voir</a>
              <button class="deleteBtn px-3 py-1.5 rounded-lg bg-rose-900/50 hover:bg-rose-900 text-rose-200 text-xs font-medium transition-colors border border-rose-900/50">Supprimer</button>
            </div>
          </li>
        <% }) %>
        <% } %>
      </ul>
    </section>
  </div>

  <script>
  (function(){
    function ensureToastContainer(){
      let c = document.getElementById('toastContainer');
      if (!c) {
        c = document.createElement('div');
        c.id = 'toastContainer';
        c.style.position = 'fixed';
        c.style.right = '24px';
        c.style.top = '24px';
        c.style.zIndex = 99999;
        c.style.display = 'flex';
        c.style.flexDirection = 'column';
        c.style.gap = '12px';
        document.body.appendChild(c);
      }
      return c;
    }
    function showToast(message, type = 'info', timeout = 3500){
      const container = ensureToastContainer();
      const el = document.createElement('div');
      el.className = 'flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg border text-sm font-medium transform transition-all duration-300 translate-x-8 opacity-0';
      
      if (type === 'success') { 
        el.className += ' bg-emerald-950/90 border-emerald-800 text-emerald-200';
        el.innerHTML = `<svg class="w-5 h-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>${message}</span>`;
      } else if (type === 'error') { 
        el.className += ' bg-rose-950/90 border-rose-800 text-rose-200';
        el.innerHTML = `<svg class="w-5 h-5 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg><span>${message}</span>`;
      } else { 
        el.className += ' bg-slate-800/90 border-slate-700 text-slate-200';
        el.innerHTML = `<svg class="w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span>${message}</span>`;
      }
      
      container.appendChild(el);
      requestAnimationFrame(()=>{ el.classList.remove('translate-x-8', 'opacity-0'); });
      
      const id = setTimeout(()=>{
        try{ 
          el.classList.add('translate-x-8', 'opacity-0');
          setTimeout(()=>el.remove(), 300); 
        }catch(e){}
      }, timeout);
      
      el.addEventListener('click', ()=>{ clearTimeout(id); el.classList.add('translate-x-8', 'opacity-0'); setTimeout(()=>el.remove(), 300); });
      return el;
    }

    const grids = [
      document.getElementById('gridSubmitted'),
      document.getElementById('gridApproved'),
      document.getElementById('gridArchived')
    ].filter(Boolean);
    const search = document.getElementById('themeSearch');
    const clearBtn = document.getElementById('clearSearch');

    function norm(s){ s = String(s||'').trim(); if (!s.startsWith('#')) s = '#'+s; if (/^#[0-9a-fA-F]{3}$/.test(s)) s = '#'+s.slice(1).split('').map(c=>c+c).join(''); return /^#[0-9a-fA-F]{6}$/.test(s) ? s : '#000000'; }

    function extractColors(raw){
      try{ if(!raw) return null; const d = raw;
        let c = { bg:'#111827', button:'#4f46e5', hover:'#22c55e' };
        if (d.light && typeof d.light === 'object') c = { bg: d.light.bg||'#f5f5f5', button: d.light.button||'#4f46e5', hover: d.light.hover||'#22c55e' };
        else if (d.background) c = { bg: d.background||'#111827', button: d.buttonBackground||'#4f46e5', hover: d.hoverColor||'#22c55e' };
        else c = { bg: d.bg||'#111827', button: d.button||'#4f46e5', hover: d.hover||'#22c55e' };
        return { bg: norm(c.bg), button: norm(c.button), hover: norm(c.hover) };
      }catch(e){ return { bg:'#111827', button:'#4f46e5', hover:'#22c55e' }; }
    }
    function renderPreviews(){
      grids.forEach(grid => {
        Array.from(grid.querySelectorAll('.themeCard')).forEach(card=>{
        const box = card.querySelector('.themePreview');
        const raw = card.getAttribute('data-json');
        let parsed = {};
        try{ parsed = JSON.parse(raw||'{}'); }catch(e){ parsed = {}; }
        const c = extractColors(parsed);
        box.innerHTML = `<div style="padding:8px;background:${c.bg};height:100%;display:flex;flex-direction:column;justify-content:center;gap:8px;">`+
          `<div style=\"height:20px;width:60%;background:${c.button};border-radius:4px;margin:0 auto;\"></div>`+
          `<div style=\"height:20px;width:40%;background:${c.hover};border-radius:4px;margin:0 auto;\"></div>`+
          `</div>`;
        });
      });
    }
    function tidyServerEmptyPlaceholders(){
      ['gridSubmitted','gridApproved','gridArchived'].forEach(id => {
        const grid = document.getElementById(id);
        if (!grid) return;
        const hasItem = grid.querySelectorAll('.themeCard').length > 0;
        const serverMsg = grid.querySelector('.server-empty-placeholder');
        if (hasItem) {
          if (serverMsg) serverMsg.remove();
        } else {
          if (!serverMsg) {
            const li = document.createElement('li');
            li.className = 'server-empty-placeholder col-span-full text-center py-12 text-slate-500';
            if (id === 'gridSubmitted') li.textContent = 'Aucun thème en attente.';
            if (id === 'gridApproved') li.textContent = 'Aucun thème validé.';
            if (id === 'gridArchived') li.textContent = 'Aucun thème archivé.';
            grid.appendChild(li);
          }
        }
      });
    }

    function updateTabCounts(){
      try{
        const map = {
          submitted: document.getElementById('gridSubmitted'),
          approved: document.getElementById('gridApproved'),
          archived: document.getElementById('gridArchived')
        };
        Object.keys(map).forEach(k => {
          const root = map[k];
          const btn = tabButtons.find(tb => tb.dataset.tab === k);
          if (!btn) return;
          const span = btn.querySelector('.tab-count');
          const count = root ? Array.from(root.querySelectorAll('.themeCard')).filter(el=>el.style.display !== 'none').length : 0;
          if (span) span.textContent = String(count);
        });
      }catch(e){}
    }
    function wireActions(){
      grids.forEach(grid => {
        grid.addEventListener('click', async (e)=>{
          const li = e.target.closest('.themeCard');
          if (!li) return;
          const id = li.dataset.id;
          const approve = e.target.closest('.approveBtn');
          const reject = e.target.closest('.rejectBtn');
          const archive = e.target.closest('.archiveBtn');
          const unarchive = e.target.closest('.unarchiveBtn');
          const approveUpdate = e.target.closest('.approveUpdateBtn');
          const del = e.target.closest('.deleteBtn');
          const actBtn = approve||reject||archive||unarchive||approveUpdate||del;
          if (!actBtn) return;
          const prev = actBtn.textContent; actBtn.disabled = true; actBtn.textContent = '...';
          const originalParent = li.parentElement;
          const originalNext = li.nextElementSibling;
          let tempMoved = false;
          function transformCardForGrid(card, target){
            try{
              const id = card.dataset.id;
              const actions = card.querySelector('.actions');
              if (!actions) return;
              actions.innerHTML = '';
              if (target === 'approved'){
                const archive = document.createElement('button'); archive.className = 'archiveBtn px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-medium transition-colors'; archive.textContent = 'Archiver';
                const preview = document.createElement('a'); preview.className = 'px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-700 text-white text-xs font-medium transition-colors'; preview.href = '/admin/themes/'+encodeURIComponent(id); preview.textContent = 'Voir';
                const del = document.createElement('button'); del.className = 'deleteBtn px-3 py-1.5 rounded-lg bg-rose-900/50 hover:bg-rose-900 text-rose-200 text-xs font-medium transition-colors border border-rose-900/50'; del.textContent = 'Supprimer';
                actions.appendChild(archive); actions.appendChild(preview); actions.appendChild(del);
              } else if (target === 'submitted'){
                const pending = card.querySelector('.badge-pending-update');
                if (pending){
                  const approveUpd = document.createElement('button'); approveUpd.className = 'approveUpdateBtn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors'; approveUpd.textContent = 'Approuver MAJ';
                  actions.appendChild(approveUpd);
                } else {
                  const approve = document.createElement('button'); approve.className = 'approveBtn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors'; approve.textContent = 'Approuver';
                  const reject = document.createElement('button'); reject.className = 'rejectBtn px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-xs font-medium transition-colors'; reject.textContent = 'Rejeter';
                  actions.appendChild(approve); actions.appendChild(reject);
                }
                const archive = document.createElement('button'); archive.className = 'archiveBtn px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-medium transition-colors'; archive.textContent = 'Archiver';
                const preview = document.createElement('a'); preview.className = 'px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-700 text-white text-xs font-medium transition-colors'; preview.href = '/admin/themes/'+encodeURIComponent(id); preview.textContent = 'Voir';
                actions.appendChild(archive); actions.appendChild(preview);
              } else if (target === 'archived'){
                const unarchive = document.createElement('button'); unarchive.className = 'unarchiveBtn px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-medium transition-colors'; unarchive.textContent = 'Republier';
                const preview = document.createElement('a'); preview.className = 'px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-700 text-white text-xs font-medium transition-colors'; preview.href = '/admin/themes/'+encodeURIComponent(id); preview.textContent = 'Voir';
                const del = document.createElement('button'); del.className = 'deleteBtn px-3 py-1.5 rounded-lg bg-rose-900/50 hover:bg-rose-900 text-rose-200 text-xs font-medium transition-colors border border-rose-900/50'; del.textContent = 'Supprimer';
                actions.appendChild(unarchive); actions.appendChild(preview); actions.appendChild(del);
              }
            }catch(e){}
          }
          try{
            if (approve || reject){
              const action = approve ? 'approve' : 'reject';
              if (approve) {
                const target = document.getElementById('gridApproved');
                if (target) { const ph = target.querySelector('.server-empty-placeholder'); if (ph) ph.remove(); transformCardForGrid(li, 'approved'); target.appendChild(li); }
                li.querySelector('.badge-pending-update')?.remove?.();
                tempMoved = true;
              } else {
                li.remove();
                tempMoved = true;
              }
              const res = await fetch('/api/themes/'+encodeURIComponent(id)+'/'+action, { method: 'POST' });
              if (!res.ok) throw new Error('HTTP '+res.status);
              showToast(approve ? 'Thème approuvé' : 'Thème rejeté', 'success');
              try{ window.__refreshThemePaginators && window.__refreshThemePaginators(); }catch(e){}
            } else if (archive){
              const target = document.getElementById('gridArchived'); if (target) { const ph = target.querySelector('.server-empty-placeholder'); if (ph) ph.remove(); transformCardForGrid(li, 'archived'); target.appendChild(li); }
              tempMoved = true;
              const res = await fetch('/api/themes/'+encodeURIComponent(id)+'/archive', { method: 'POST' });
              if (!res.ok) throw new Error('HTTP '+res.status);
              showToast('Thème archivé', 'success');
              try{ window.__refreshThemePaginators && window.__refreshThemePaginators(); }catch(e){}
            } else if (unarchive){
              const target = document.getElementById('gridApproved'); if (target) { const ph = target.querySelector('.server-empty-placeholder'); if (ph) ph.remove(); transformCardForGrid(li, 'approved'); target.appendChild(li); }
              tempMoved = true;
              const res = await fetch('/api/themes/'+encodeURIComponent(id)+'/unarchive', { method: 'POST' });
              if (!res.ok) throw new Error('HTTP '+res.status);
              showToast('Thème republié', 'success');
              try{ window.__refreshThemePaginators && window.__refreshThemePaginators(); }catch(e){}
            } else if (approveUpdate){
              li.querySelector('.badge-pending-update')?.remove?.();
              const target = document.getElementById('gridApproved'); if (target) { const ph = target.querySelector('.server-empty-placeholder'); if (ph) ph.remove(); transformCardForGrid(li, 'approved'); target.appendChild(li); }
              tempMoved = true;
              const res = await fetch('/api/themes/'+encodeURIComponent(id)+'/approve-update', { method: 'POST' });
              if (!res.ok) throw new Error('HTTP '+res.status);
              showToast('MAJ approuvée', 'success');
              try{ window.__refreshThemePaginators && window.__refreshThemePaginators(); }catch(e){}
            } else if (del){
              const ok = window.confirm('Supprimer définitivement ce thème ?');
              if (!ok) { actBtn.disabled = false; actBtn.textContent = prev; return; }
              li.remove(); tempMoved = true;
              const res = await fetch('/api/themes/'+encodeURIComponent(id), { method: 'DELETE' });
              if (!res.ok) throw new Error('HTTP '+res.status);
              showToast('Thème supprimé', 'success');
              try{ window.__refreshThemePaginators && window.__refreshThemePaginators(); }catch(e){}
            }
          }catch(err){
            try{
              if (tempMoved) {
                if (!originalParent) {
                } else {
                  if (originalNext) originalParent.insertBefore(li, originalNext);
                  else originalParent.appendChild(li);
                }
              }
            }catch(e){}
            showToast('Erreur lors de l\'opération', 'error');
          }
          finally { if (document.body.contains(li)) { actBtn.disabled = false; actBtn.textContent = prev; } }
        });
      });
    }
    function applyFilter(){
      const q = (search?.value||'').trim().toLowerCase();
      if (clearBtn) clearBtn.classList.toggle('hidden', !q);
      grids.forEach(grid => {
        Array.from(grid.querySelectorAll('.themeCard')).forEach(card=>{
          const name = card.dataset.name||'';
          const author = card.dataset.author||'';
          const ok = !q || name.includes(q) || author.includes(q);
          card.style.display = ok ? '' : 'none';
        });
      });
    }
    search?.addEventListener('input', applyFilter);
    renderPreviews(); wireActions();
    function setupDragAndDrop(){}
    setupDragAndDrop();

    window.__refreshThemePaginators = function(){
      try{
        const container = window.__themeAdminPaginators || {};
        Object.keys(container).forEach(k=>{
          const p = container[k]; if (!p) return;
          const root = (k === 'submitted') ? document.getElementById('gridSubmitted') : (k === 'approved' ? document.getElementById('gridApproved') : document.getElementById('gridArchived'));
          if (!root) return;
          const items = Array.from(root.querySelectorAll('.themeCard'));
          try{ p.setFiltered(items); }catch(e){}
        });
      }catch(e){}
      try{ if (window.__onThemesUpdated) window.__onThemesUpdated(); }catch(e){}
      try{ tidyServerEmptyPlaceholders(); }catch(e){}
      try{ updateTabCounts(); }catch(e){}
    };
  })();
  </script>
  <script src="/public/js/pagination.js"></script>
  <script>
  (function(){
    const grids = {
      submitted: document.getElementById('gridSubmitted'),
      approved: document.getElementById('gridApproved'),
      archived: document.getElementById('gridArchived')
    };
    const search = document.getElementById('themeSearch');
    const catSelect = document.getElementById('themeCategoryFilter');
    function collectCategories(){
      const cats = new Set();
      Object.values(grids).forEach(g=>{
        if (!g) return;
        Array.from(g.querySelectorAll('.themeCard')).forEach(card=>{
          try{ const raw = card.getAttribute('data-json')||'{}'; const parsed = JSON.parse(raw); const cat = (parsed.chat && parsed.chat.category) || parsed.category || parsed.chatCategory || ''; if (cat) cats.add(String(cat)); }catch(e){}
        });
      });
      return Array.from(cats).sort();
    }

    function populateCategorySelect(){
      if (!catSelect) return;
      const prev = catSelect.value;
      while (catSelect.options.length > 1) catSelect.remove(1);
      const cats = collectCategories();
      cats.forEach(c=>{
        const o = document.createElement('option'); o.value = c; o.textContent = c; catSelect.appendChild(o);
      });
      try{ if (prev) catSelect.value = prev; }catch(e){}
    }

    window.__onThemesUpdated = function(){
      try{ populateCategorySelect(); }catch(e){}
      try{ renderPreviews(); }catch(e){}
      try{ applyFilter(); }catch(e){}
      try{ updateTabCounts(); }catch(e){}
    };

    function ensureEmptyMessage(grid){
      let m = grid.querySelector('.no-match-msg');
      if (!m){ m = document.createElement('div'); m.className = 'no-match-msg col-span-full text-center py-12 text-slate-500'; m.style.display='none'; m.textContent = 'Aucun thème correspondant.'; grid.appendChild(m);} return m;
    }

  const paginators = {};
  window.__themeAdminPaginators = window.__themeAdminPaginators || {};
    const tabButtons = Array.from(document.querySelectorAll('.tabBtn'));
    function showTab(name){
      ['submitted','approved','archived'].forEach(s=>{
        const sec = document.getElementById('grid'+(s==='submitted'?'Submitted': s==='approved'?'Approved':'Archived'))?.closest('section') || document.querySelector('[data-section="'+s+'"]');
        if (sec) sec.classList.toggle('section-hidden', s!==name);
      });
      tabButtons.forEach(b=>{ const is = b.dataset.tab === name; b.classList.toggle('active', is); b.setAttribute('aria-selected', String(is)); });
    }
    tabButtons.forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));

    Object.keys(grids).forEach(k=>{
      const g = grids[k]; if (!g) return;
      if (!window.__PlinkkPaginator) return;
      const p = window.__PlinkkPaginator.createPaginator(g, { pageSize: 9, selectors: { items: '.themeCard' }, onRender: (pageItems, meta) => {
        const em = ensureEmptyMessage(g);
        if (!meta || meta.totalItems === 0) { em.style.display = ''; } else { em.style.display = 'none'; }
        try{
          const btn = tabButtons.find(tb => tb.dataset.tab === k);
          if (btn) { const span = btn.querySelector('.tab-count'); if (span) span.textContent = String(meta.totalItems); }
        }catch(e){}
      }});
  paginators[k] = p;
  try{ window.__themeAdminPaginators[k] = p; }catch(e){}
      p.render();
    });

    showTab('submitted');

    function applyFilter(){
      const q = (search?.value||'').trim().toLowerCase();
      const cat = (catSelect?.value||'').trim();
      Object.keys(paginators).forEach(k=>{
        const p = paginators[k];
        const all = p.getAll();
        const filtered = all.filter(li => {
          const name = (li.dataset.name||'') + ' ' + (li.dataset.author||'');
          const matchesQ = !q || name.toLowerCase().includes(q);
          if (!matchesQ) return false;
          if (!cat) return true;
          try{ const raw = li.getAttribute('data-json')||'{}'; const parsed = JSON.parse(raw);
            const c = (parsed.chat && parsed.chat.category) || parsed.category || parsed.chatCategory || '';
            return String(c) === String(cat);
          }catch(e){ return false; }
        });
        p.setFiltered(filtered);
      });
    }

  search?.addEventListener('input', applyFilter);
  catSelect?.addEventListener('change', applyFilter);
  const clearBtn = document.getElementById('clearSearch');
  clearBtn?.addEventListener('click', (e)=>{ e.preventDefault(); if (search) search.value=''; applyFilter(); if (search) search.focus(); });

    populateCategorySelect();
    applyFilter();
  })();
  </script>
</main>
</div>
