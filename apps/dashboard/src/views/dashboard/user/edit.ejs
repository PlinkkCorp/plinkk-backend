<%- include('partials/head.ejs', { title: 'Tableau de bord - Édition' ,
    description: 'Configure les sections, apparence et arrière‑plan de ta page.' , robots: 'noindex,nofollow' ,
    extraHead: '<link rel="stylesheet" href="/public/css/button-themes.css">' }) %>

    <%- include('partials/header-dash.ejs', { user: user }) %>

        <div id="mobileEditNotice"
            class="md:hidden fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4" role="dialog"
            aria-modal="true">
            <div
                class="relative w-full max-w-lg mx-auto bg-slate-800/85 border border-slate-700 rounded-lg p-5 text-center text-white">
                <button id="mobileEditNoticeClose"
                    class="absolute right-3 top-3 size-8 rounded bg-slate-800 hover:bg-slate-700 text-white">✕</button>
                <h2 class="text-lg font-semibold mb-2">Édition indisponible sur mobile</h2>
                <p class="text-sm text-slate-300 mb-4">L'interface d'édition n'est pas accessible depuis un petit écran.
                    Utilisez un ordinateur ou activez le mode « affichage bureau » de votre navigateur pour modifier
                    votre page.</p>
                <div class="flex items-center justify-center gap-2">
                    <a href="<%= frontendUrl %><% if (typeof plinkk !== 'undefined' && plinkk && plinkk.slug) { %>/<%= plinkk.slug %><% } else { %>/<%= user.id %><% } %>"
                        target="_blank"
                        class="px-3 py-2 rounded bg-emerald-700/80 hover:bg-emerald-600 text-white">Ouvrir la page</a>
                </div>
            </div>
        </div>

        <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
            <%- include('partials/asside_dash.ejs', { active: 'edit' }) %>

                <main class="col-span-12 lg:col-span-10 grid grid-cols-1 xl:grid-cols-12 gap-8">
                    <section class="xl:col-span-7 space-y-6">
                        <div
                            class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-slate-900 border border-slate-800 p-6 rounded-3xl">
                            <div class="min-w-0">
                                <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                                    Configuration
                                    <% if (typeof plinkk !=='undefined' && plinkk) { %>
                                        <span
                                            class="text-sm font-normal text-slate-400 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                                            <%= plinkk.name %> <span class="text-slate-500">/</span> <span
                                                    class="text-violet-400">
                                                    <%= plinkk.slug %>
                                                </span>
                                        </span>
                                        <% } %>
                                </h1>
                                <div id="save-status-container"
                                    class="flex items-center gap-2 text-xs font-medium py-1 px-3 bg-slate-800/50 border border-slate-700/50 rounded-full w-fit mt-2 transition-all duration-300">
                                    <span id="status-dot"
                                        class="size-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                                    <span id="status-text" class="text-slate-300">Modifications enregistrées</span>
                                    <!-- preview chip always visible here -->
                                    <span id="statusPreviewChip"
                                        class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs opacity-50"></span>
                                </div>
                            </div>

                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-3">
                                    <%- include('partials/changePlinkkDropdown.ejs') %>
                                </div>
                            </div>
                        </div>

                        <nav
                            class="bg-slate-900 border border-slate-800 p-2 rounded-2xl overflow-x-auto scrollbar-hide">
                            <ul class="flex gap-2 min-w-max" id="tabs">
                                <li>
                                    <button data-target="#section-profile"
                                        class="tab-btn px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all aria-selected:bg-violet-600 aria-selected:text-white aria-selected:shadow-lg aria-selected:shadow-violet-900/20 flex items-center gap-2"
                                        aria-selected="true">
                                        <svg class="size-4" viewBox="0 0 24 24" fill="white">
                                            <path
                                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-3.33 0-8 1.67-8 5v1h16v-1c0-3.33-4.67-5-8-5z" />
                                        </svg>
                                        Profil
                                    </button>
                                </li>

                                <li>
                                    <button data-target="#section-appearance"
                                        class="tab-btn px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all aria-selected:bg-violet-600 aria-selected:text-white aria-selected:shadow-lg aria-selected:shadow-violet-900/20 flex items-center gap-2">
                                        <svg class="size-4" viewBox="0 0 24 24" fill="white">
                                            <path d="M12 2l4 8h8l-6 5 2 9-8-5-8 5 2-9-6-5h8z" />
                                        </svg>
                                        Apparence
                                    </button>
                                </li>
                                <li>
                                    <button data-target="#section-background"
                                        class="tab-btn px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all aria-selected:bg-violet-600 aria-selected:text-white aria-selected:shadow-lg aria-selected:shadow-violet-900/20 flex items-center gap-2">
                                        <svg class="size-4" viewBox="0 0 24 24" fill="white">
                                            <path d="M4 6h16v12H4zM7 9h10v6H7z" />
                                        </svg>
                                        Arrière-plan
                                    </button>
                                </li>
                                <li>
                                    <button data-target="#section-links"
                                        class="tab-btn px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all aria-selected:bg-violet-600 aria-selected:text-white aria-selected:shadow-lg aria-selected:shadow-violet-900/20 flex items-center gap-2">
                                        <svg class="size-4" viewBox="0 0 24 24" fill="white">
                                            <path
                                                d="M10.59 13.41L9.17 12l4.24-4.24 1.41 1.41L10.59 13.41zm2.82-2.82L14.83 12 10.59 16.24 9.17 14.83 13.41 10.59z" />
                                        </svg>
                                        Liens
                                    </button>
                                </li>
                                <li>
                                    <button data-target="#section-layout"
                                        class="tab-btn px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all aria-selected:bg-violet-600 aria-selected:text-white aria-selected:shadow-lg aria-selected:shadow-violet-900/20 flex items-center gap-2">
                                        <svg class="size-4" viewBox="0 0 24 24" fill="white">
                                            <path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h16v2H4z" />
                                        </svg>
                                        Disposition
                                    </button>
                                </li>
                                <li>
                                    <button data-target="#section-animations"
                                        class="tab-btn px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all aria-selected:bg-violet-600 aria-selected:text-white aria-selected:shadow-lg aria-selected:shadow-violet-900/20 flex items-center gap-2">
                                        <svg class="size-4" viewBox="0 0 24 24" fill="white">
                                            <path d="M2 17h20v2H2zM7 9h10v2H7zM4 13h16v2H4z" />
                                        </svg>
                                        Animations
                                    </button>
                                </li>
                                <li>
                                    <button data-target="#section-statusbar"
                                        class="tab-btn px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all aria-selected:bg-violet-600 aria-selected:text-white aria-selected:shadow-lg aria-selected:shadow-violet-900/20 flex items-center gap-2">
                                        <svg class="size-4" viewBox="0 0 24 24" fill="white">
                                            <path d="M3 5h18v2H3zM3 9h18v6H3zM3 17h18v2H3z" />
                                        </svg>
                                        Status
                                    </button>
                                </li>


                            </ul>
                        </nav>

                        <div class="space-y-6">
                            <div id="section-profile"
                                class="bg-slate-900 border border-slate-800 rounded-3xl p-6 shadow-lg animate-slide-up">
                                <%- include('./partials/editor-sections/profile.ejs') %>
                            </div>

                            <div id="section-appearance"
                                class="bg-slate-900 border border-slate-800 rounded-3xl p-6 hidden shadow-lg animate-slide-up">
                                <%- include('./partials/editor-sections/appearance.ejs') %>
                            </div>

                            <div id="section-background"
                                class="bg-slate-900 border border-slate-800 rounded-3xl p-6 hidden shadow-lg animate-slide-up">
                                <%- include('./partials/editor-sections/background.ejs') %>
                            </div>

                            <div id="section-links"
                                class="bg-slate-900 border border-slate-800 rounded-3xl p-6 hidden shadow-lg animate-slide-up">
                                <%- include('./partials/editor-sections/links.ejs') %>
                            </div>

                            <div id="section-layout"
                                class="bg-slate-900 border border-slate-800 rounded-3xl p-6 hidden shadow-lg animate-slide-up">
                                <%- include('./partials/editor-sections/layout.ejs') %>
                            </div>

                            <div id="section-animations"
                                class="bg-slate-900 border border-slate-800 rounded-3xl p-6 hidden shadow-lg animate-slide-up">
                                <%- include('./partials/editor-sections/animations.ejs') %>
                            </div>

                            <div id="section-statusbar"
                                class="bg-slate-900 border border-slate-800 rounded-3xl p-6 hidden shadow-lg animate-slide-up">
                                <%- include('./partials/editor-sections/statusbar.ejs') %>
                            </div>




                        </div>
                    </section>

                    <aside class="hidden xl:block xl:col-span-5 relative space-y-6 max-h-[100vh]">
                        <div class="sticky top-8">
                            <div id="previewCard"
                                class="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-4 shadow-2xl relative overflow-hidden">
                                <div
                                    class="absolute top-0 left-0 w-full h-full bg-slate-950 opacity-50 z-0 pointer-events-none">
                                </div>
                                <div class="flex justify-center gap-2 mb-2 z-10 relative">
                                    <button id="btnPreview"
                                        class="px-3 py-1 text-sm font-medium rounded-lg bg-violet-600 text-white">Aperçu</button>
                                    <button id="btnHistory"
                                        class="px-3 py-1 text-sm font-medium rounded-lg bg-slate-700 text-slate-200">Historique</button>
                                </div>
                                <div id="status"
                                    class="text-xs text-slate-400 opacity-0 transition-opacity mx-auto mb-2"></div>
                                <div id="previewWrapper"
                                    class="relative z-10 bg-black rounded-[2rem] overflow-hidden border-[6px] border-slate-800 shadow-inner aspect-[9/19] max-h-[80vh] mx-auto">
                                    <iframe id="preview"
                                        src="<%= (typeof frontendUrl !== 'undefined') ? frontendUrl : '' %><% if (typeof plinkk !== 'undefined' && plinkk && plinkk.slug) { %>/<%= plinkk.slug %><% } else { %>/<%= user.id %><% } %>?preview=1"
                                        class="w-full h-full bg-white" frameborder="0"></iframe>
                                    <!-- small floating controls (reload / open) shown in preview mode -->
                                    <div id="previewControls"
                                        class="absolute bottom-4 left-0 right-0 flex justify-center z-30 pointer-events-none">
                                        <div class="pointer-events-auto control-pill flex items-center gap-3 shadow-xl">
                                            <div class="control-actions flex items-center gap-2">
                                                <button id="previewReload" class="control-btn" title="Recharger"
                                                    aria-label="Recharger"
                                                    onclick="document.getElementById('preview').src = document.getElementById('preview').src">
                                                    <svg class="h-5 w-5 text-slate-300" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                        stroke-linejoin="round">
                                                        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                                        <path d="M3 3v5h5" />
                                                        <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
                                                        <path d="M16 21h5v-5" />
                                                    </svg>
                                                </button>
                                                <a id="previewOpen"
                                                    href="<%= frontendUrl %><% if (typeof plinkk !== 'undefined' && plinkk && plinkk.slug) { %>/<%= plinkk.slug %><% } else { %>/<%= user.id %><% } %>"
                                                    target="_blank" class="control-btn" title="Ouvrir"
                                                    aria-label="Ouvrir">
                                                    <svg class="h-5 w-5 text-slate-300" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2">
                                                        <path
                                                            d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                                        <polyline points="15 3 21 3 21 9" />
                                                        <line x1="10" y1="14" x2="21" y2="3" />
                                                    </svg>
                                                </a>
                                                <button id="previewReturn" class="control-btn hidden"
                                                    title="Retour à la vue originale" aria-label="Retour">
                                                    <svg class="h-5 w-5 text-slate-300" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2">
                                                        <path d="M19 12H6" />
                                                        <path d="M12 5l-7 7 7 7" />
                                                    </svg>
                                                </button>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <div id="historyWrapper" class="hidden mt-4 pointer-events-auto z-20">
                                    <div class="mb-4 flex items-center justify-between">
                                        <div>
                                            <h3 class="text-lg font-semibold text-white">Historique</h3>
                                            <p class="text-sm text-slate-400">Restaurez une version précédente.</p>
                                        </div>
                                        <div>
                                            <button id="refreshHistory"
                                                class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors"
                                                title="Actualiser">
                                                <svg class="size-5" fill="none" viewBox="0 0 24 24"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex p-1 bg-slate-950 rounded-xl mb-4 z-10 relative">
                                        <button id="tab-history-auto"
                                            class="flex-1 py-1.5 text-xs font-medium rounded-lg transition-all bg-white shadow text-slate-900">
                                            Auto
                                        </button>
                                        <button id="tab-history-manual"
                                            class="flex-1 py-1.5 text-xs font-medium rounded-lg transition-all text-slate-400 hover:bg-white/[0.12] hover:text-white">
                                            Manuelle
                                        </button>
                                    </div>

                                    <div id="manual-backup-actions"
                                        class="hidden mb-4 p-3 bg-slate-950 rounded-xl border border-slate-800 z-10 relative">
                                        <div class="flex gap-2">
                                            <input type="text" id="backupName" placeholder="Nom..."
                                                class="flex-1 px-3 py-1.5 rounded-lg bg-slate-900 border border-slate-700 text-slate-200 text-xs focus:border-violet-500 focus:ring-1 focus:ring-violet-500/50 outline-none">
                                            <button onclick="createBackup()"
                                                class="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 text-white text-xs font-medium rounded-lg transition-colors">
                                                Sauver
                                            </button>
                                        </div>
                                    </div>

                                    <div id="historyList" class="space-y-2 max-h-[400px] overflow-y-auto scrollbar-hide"
                                        style="-webkit-overflow-scrolling: touch; pointer-events: auto; z-index: 70; position: relative;">
                                    </div>
                                </div>
                            </div>
                    </aside>
                </main>
        </div>
        <%- include('./edit/link-modal.ejs') %>
            <%- include('./edit/icon-modal.ejs') %>
                <%- include('./edit/picker-modal.ejs') %>

                    <div id="statusModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden"
                        role="dialog" aria-modal="true">
                        <div class="relative w-full max-w-md bg-slate-800 rounded-lg p-6 text-center text-white">
                            <button id="statusModalClose"
                                class="absolute right-3 top-3 size-8 rounded bg-slate-800 hover:bg-slate-700 text-white">✕</button>
                            <h2 class="text-xl font-semibold mb-2">En cours de refonte</h2>
                            <p class="text-sm text-slate-300">La section <strong>Statut</strong> est actuellement en
                                cours de refonte et n'est pas disponible pour le moment.</p>
                        </div>
                    </div>

                    <script>
                        window.__PLINKK_USER_ID__ = "<%= user.id %>";
                        window.__PLINKK_SELECTED_ID__ = "<%= plinkk.id %>";
                        window.__USER_EMAIL__ = "<%= user.email %>";

                        // Auto-save Visual Feedback Functions
                        window.__PLINKK_SHOW_SAVING__ = function () {
                            const dot = document.getElementById('status-dot');
                            const text = document.getElementById('status-text');
                            if (dot && text) {
                                dot.className = 'size-1.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)] transition-all';
                                text.textContent = 'Enregistrement...';
                            }
                        };

                        window.__PLINKK_SHOW_SAVED__ = function () {
                            const dot = document.getElementById('status-dot');
                            const text = document.getElementById('status-text');
                            if (dot && text) {
                                dot.className = 'size-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)] transition-all';
                                text.textContent = 'Modifications enregistrées';
                            }
                            // Refresh preview iframe
                            const preview = document.getElementById('preview');
                            if (preview) {
                                preview.src = preview.src;
                            }
                        };

                        window.__PLINKK_SHOW_ERROR__ = function () {
                            const dot = document.getElementById('status-dot');
                            const text = document.getElementById('status-text');
                            if (dot && text) {
                                dot.className = 'size-1.5 rounded-full bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.5)] transition-all';
                                text.textContent = 'Erreur d\'enregistrement';
                            }
                        };
                    </script>

                    <script type="application/json" id="pages-data"><%- JSON.stringify(locals.pages || []) %></script>
                    <script type="application/json"
                        id="autoopen-data"><%= (typeof autoOpenPlinkkModal !== 'undefined' && autoOpenPlinkkModal) ? 'true' : 'false' %></script>

                    <script>
                        // Mobile Notice Logic
                        (function () {
                            const notice = document.getElementById('mobileEditNotice');
                            const closeBtn = document.getElementById('mobileEditNoticeClose');
                            const main = document.querySelector('main');

                            function checkMobile() {
                                if (!notice || !main) return;
                                // Only hide main content if the notice is visible (mobile)
                                if (window.getComputedStyle(notice).display !== 'none') {
                                    main.classList.add('hidden');
                                    if (notice.classList.contains('hidden')) {
                                        // If notice was manually dismissed, show main
                                        main.classList.remove('hidden');
                                    } else {
                                        notice.classList.remove('hidden'); // ensure it's shown if mobile
                                    }
                                } else {
                                    main.classList.remove('hidden');
                                    notice.classList.add('hidden'); // hide notice on desktop
                                }
                            }

                            if (closeBtn) {
                                closeBtn.addEventListener('click', () => {
                                    notice.classList.add('hidden');
                                    if (main) main.classList.remove('hidden');
                                });
                            }

                            window.addEventListener('resize', checkMobile);
                            checkMobile();
                        })();
                        // Expose a global switch to change sidebar mode (preview / history)
                        (function () {
                            window.switchSidebarMode = function (mode) {
                                const previewW = document.getElementById('previewWrapper');
                                const historyW = document.getElementById('historyWrapper');
                                const previewControls = document.getElementById('previewControls');
                                const previewCard = document.getElementById('previewCard');
                                const btnP = document.getElementById('btnPreview');
                                const btnH = document.getElementById('btnHistory');
                                if (!previewW || !historyW || !btnP || !btnH) return;
                                if (mode === 'live' || mode === 'preview') {
                                    previewW.classList.remove('hidden');
                                    historyW.classList.add('hidden');
                                    previewControls?.classList.remove('hidden');
                                    previewCard?.classList.remove('max-h-[90vh]');
                                    btnP.classList.add('bg-violet-600', 'text-white');
                                    btnP.classList.remove('bg-slate-700', 'text-slate-200');
                                    btnH.classList.add('bg-slate-700', 'text-slate-200');
                                    btnH.classList.remove('bg-violet-600', 'text-white');
                                } else if (mode === 'history') {
                                    previewW.classList.add('hidden');
                                    historyW.classList.remove('hidden');
                                    previewControls?.classList.add('hidden');
                                    previewCard?.classList.add('max-h-[90vh]');
                                    btnH.classList.add('bg-violet-600', 'text-white');
                                    btnH.classList.remove('bg-slate-700', 'text-slate-200');
                                    btnP.classList.add('bg-slate-700', 'text-slate-200');
                                    btnP.classList.remove('bg-violet-600', 'text-white');
                                    if (window.historyManager) window.historyManager.loadHistory();
                                }
                            };
                        })();

                        // Toast helper for preview actions
                        (function () {
                            const toast = document.createElement('div');
                            toast.id = 'previewToast';
                            toast.className = '';
                            toast.style.display = 'none';
                            document.body.appendChild(toast);
                            window.showPreviewToast = function (msg = 'Retour à la vue originale') {
                                try {
                                    toast.textContent = msg;
                                    toast.style.display = '';
                                    setTimeout(() => toast.classList.add('show'), 10);
                                    setTimeout(() => {
                                        toast.classList.remove('show');
                                        setTimeout(() => { toast.style.display = 'none'; toast.textContent = ''; }, 220);
                                    }, 1800);
                                } catch (e) { /* ignore */ }
                            };
                        })();

                        (function () {
                            const statusBtn = document.querySelector('[data-target="#section-statusbar"]');
                            const modal = document.getElementById('statusModal');
                            const closeBtn = document.getElementById('statusModalClose');

                            if (statusBtn && modal) {
                                statusBtn.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    modal.classList.remove('hidden');
                                });
                            }
                            if (closeBtn && modal) {
                                closeBtn.addEventListener('click', () => {
                                    modal.classList.add('hidden');
                                });
                            }
                        })();
                    </script>

                    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                    <script type="application/json" id="plinkk-data"><%- JSON.stringify(locals.plinkk || {}) %></script>
                    <script>
                        try {
                            const rawData = JSON.parse(document.getElementById('plinkk-data').textContent);
                            window.__INITIAL_STATE__ = {
                                ...rawData,
                                categories: <%- JSON.stringify(locals.categories || []) %>
                            };
                        } catch (e) {
                            console.error('Failed to parse initial state:', e);
                            window.__INITIAL_STATE__ = { categories: [] };
                        }
                    </script>

                    <script>
                        (function () {
                            const btnP = document.getElementById('btnPreview');
                            const btnH = document.getElementById('btnHistory');
                            const previewW = document.getElementById('previewWrapper');
                            const historyW = document.getElementById('historyWrapper');
                            if (btnP && btnH && previewW && historyW) {
                                function showPreview() {
                                    previewW.classList.remove('hidden');
                                    historyW.classList.add('hidden');
                                    const previewControls = document.getElementById('previewControls');
                                    previewControls?.classList.remove('hidden');
                                    const previewCard = document.getElementById('previewCard');
                                    previewCard?.classList.remove('max-h-[90vh]');
                                    btnP.classList.add('bg-violet-600', 'text-white');
                                    btnP.classList.remove('bg-slate-700', 'text-slate-200');
                                    btnH.classList.add('bg-slate-700', 'text-slate-200');
                                    btnH.classList.remove('bg-violet-600', 'text-white');
                                }
                                function showHistory() {
                                    previewW.classList.add('hidden');
                                    historyW.classList.remove('hidden');
                                    const previewControls = document.getElementById('previewControls');
                                    previewControls?.classList.add('hidden');
                                    const previewCard = document.getElementById('previewCard');
                                    previewCard?.classList.add('max-h-[90vh]');
                                    btnH.classList.add('bg-violet-600', 'text-white');
                                    btnH.classList.remove('bg-slate-700', 'text-slate-200');
                                    btnP.classList.add('bg-slate-700', 'text-slate-200');
                                    btnP.classList.remove('bg-violet-600', 'text-white');
                                    if (window.historyManager) window.historyManager.loadHistory();
                                }
                                btnP.addEventListener('click', showPreview);
                                btnH.addEventListener('click', showHistory);
                                const refreshBtn = document.getElementById('refreshHistory');
                                refreshBtn?.addEventListener('click', () => {
                                    if (window.historyManager) window.historyManager.loadHistory();
                                });
                                showPreview();
                            }
                        })();
                    </script>
                    <script src="/public/js/dashboard-ui/editor-core.js"></script>
                    <script type="module" src="/public/js/dashboard-ui/index.js"></script>

                    <style>
                        .masked-field {
                            background-color: rgba(100, 100, 100, 0.12) !important;
                            opacity: 0.65;
                            cursor: not-allowed;
                        }

                        .masked-field:disabled,
                        .masked-field[readonly] {
                            color: inherit;
                        }

                        .mask-toggle {
                            line-height: 1;
                        }

                        .info-i {
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            width: 14px;
                            height: 14px;
                            font-size: 10px;
                            line-height: 1;
                            border-radius: 9999px;
                            border: 1px solid rgba(148, 163, 184, 0.35);
                            color: #cbd5e1;
                            margin-left: 6px;
                            cursor: help;
                            background: rgba(15, 23, 42, 0.5);
                        }

                        .info-i:hover {
                            background: rgba(30, 41, 59, 0.6);
                            color: #e5e7eb;
                            border-color: rgba(148, 163, 184, 0.6);
                        }

                        .deg-dial {
                            position: relative;
                            width: 72px;
                            height: 72px;
                            border-radius: 100%;
                            border: 1px solid #334155;
                            background: radial-gradient(closest-side, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
                            box-shadow: inset 0 0 0 2px rgba(148, 163, 184, 0.1);
                            outline: none;
                            user-select: none;
                            -webkit-user-select: none;
                            touch-action: none;
                            cursor: grab;
                        }

                        .deg-dial:focus {
                            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.55), inset 0 0 0 2px rgba(148, 163, 184, 0.1);
                        }

                        .deg-dial.is-dragging {
                            cursor: grabbing;
                        }

                        .deg-dial-dot {
                            position: absolute;
                            width: 14px;
                            height: 14px;
                            border-radius: 100%;
                            background: #93c5fd;
                            border: 2px solid #1f2937;
                            top: 50%;
                            left: 50%;
                            box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.35);
                            pointer-events: auto;
                            cursor: grab;
                        }

                        .deg-dial:active .deg-dial-dot,
                        .deg-dial.is-dragging .deg-dial-dot {
                            background: #3b82f6;
                            cursor: grabbing;
                        }

                        .cursor-move {
                            cursor: move !important;
                        }

                        /* Preview controls styles */
                        .control-pill {
                            background: rgba(15, 23, 42, 0.9);
                            border: 1px solid rgba(100, 116, 139, 0.12);
                            padding: 8px 12px;
                            border-radius: 9999px;
                            backdrop-filter: blur(6px);
                            display: inline-flex;
                            align-items: center;
                            gap: 12px;
                            transform: translateY(6px);
                            opacity: 0;
                            transition: opacity .18s ease, transform .18s ease;
                        }

                        .control-pill.visible {
                            transform: translateY(0);
                            opacity: 1;
                        }

                        .control-btn {
                            width: 36px;
                            height: 36px;
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 10px;
                            background: transparent;
                            border: none;
                            cursor: pointer;
                            transition: transform .12s ease, background .12s ease, color .12s ease;
                        }

                        .control-btn:hover {
                            transform: translateY(-2px);
                            background: rgba(148, 163, 184, 0.06);
                        }

                        .control-note {
                            color: rgba(203, 213, 225, 0.9);
                            font-size: 12px;
                            padding-left: 6px;
                        }

                        #previewControls {
                            transition: opacity .12s ease;
                        }

                        #previewControls.hidden {
                            opacity: 0;
                            pointer-events: none;
                        }

                        /* Toast */
                        #previewToast {
                            position: fixed;
                            right: 18px;
                            bottom: 18px;
                            background: rgba(15, 23, 42, 0.95);
                            color: #e6eef8;
                            padding: 10px 14px;
                            border-radius: 10px;
                            box-shadow: 0 6px 22px rgba(2, 6, 23, 0.6);
                            z-index: 60;
                            transform: translateY(8px) scale(.98);
                            opacity: 0;
                            transition: opacity .18s ease, transform .18s ease;
                            font-size: 13px;
                        }

                        #previewToast.show {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    </style>
                    </body>

                    </html>