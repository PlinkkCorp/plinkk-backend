<%- include('../../partials/head.ejs', { title: 'Sessions Actives - Admin' }) %>
<%- include('../../../partials/header-dash.ejs', { user: user }) %>

<div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
  <%- include('../../../partials/asside_dash.ejs', { active: 'admin-sessions' }) %>

  <main class="col-span-12 lg:col-span-10 space-y-6">
    
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-slate-900 border border-slate-800 p-6 rounded-3xl">
      <div>
        <h1 class="text-2xl font-bold text-white">Sessions Actives</h1>
        <p class="text-sm text-slate-400 mt-1">Surveillez et gérez les connexions utilisateurs.</p>
      </div>
      <div class="flex gap-3">
        <input type="text" id="searchFilter" placeholder="Rechercher un utilisateur..." class="bg-slate-950 border border-slate-800 text-slate-300 text-sm rounded-xl focus:ring-violet-500 focus:border-violet-500 block p-2.5 w-64">
        <button onclick="loadSessions()" class="px-4 py-2 text-sm font-medium rounded-xl bg-violet-600 hover:bg-violet-500 text-white transition-colors">
          Actualiser
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-slate-400">
          <thead class="text-xs text-slate-500 uppercase bg-slate-950/50 border-b border-slate-800">
            <tr>
              <th scope="col" class="px-6 py-4">Utilisateur</th>
              <th scope="col" class="px-6 py-4">IP</th>
              <th scope="col" class="px-6 py-4">User Agent</th>
              <th scope="col" class="px-6 py-4">Créé le</th>
              <th scope="col" class="px-6 py-4">Expire le</th>
              <th scope="col" class="px-6 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="sessionsTableBody">
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-slate-500">Chargement...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="flex items-center justify-between p-4 border-t border-slate-800 bg-slate-950/30">
        <span class="text-sm text-slate-500">Total: <span id="totalCount">0</span></span>
        <div class="flex gap-2">
          <button id="prevBtn" onclick="changePage(-1)" class="px-3 py-1 text-xs font-medium rounded-lg bg-slate-800 text-slate-400 hover:bg-slate-700 disabled:opacity-50">Précédent</button>
          <span id="pageIndicator" class="px-3 py-1 text-xs font-medium text-slate-400 flex items-center">Page 1</span>
          <button id="nextBtn" onclick="changePage(1)" class="px-3 py-1 text-xs font-medium rounded-lg bg-slate-800 text-slate-400 hover:bg-slate-700 disabled:opacity-50">Suivant</button>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
let currentPage = 1;

async function loadSessions() {
  const search = document.getElementById('searchFilter').value;
  const tbody = document.getElementById('sessionsTableBody');
  
  tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">Chargement...</td></tr>';

  try {
    const res = await fetch(`/admin/sessions/api?page=${currentPage}&search=${encodeURIComponent(search)}`);
    const data = await res.json();
    
    document.getElementById('totalCount').textContent = data.total;
    document.getElementById('pageIndicator').textContent = `Page ${currentPage}`;
    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = (currentPage * 20) >= data.total;

    if (data.sessions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">Aucune session active trouvée</td></tr>';
      return;
    }

    tbody.innerHTML = data.sessions.map(s => `
      <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
        <td class="px-6 py-4 whitespace-nowrap text-white">
          <div class="flex items-center gap-2">
            <div class="h-6 w-6 rounded-full bg-slate-800 overflow-hidden">
               ${s.user.image ? `<img src="${s.user.image}" class="h-full w-full object-cover">` : ''}
            </div>
            <div>
              <div class="font-medium">${s.user.userName}</div>
              <div class="text-xs text-slate-500">${s.user.email}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs text-slate-400">
          ${s.ip || 'N/A'}
        </td>
        <td class="px-6 py-4 text-xs text-slate-500 max-w-xs truncate" title="${s.userAgent}">
          ${parseUA(s.userAgent)}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-xs text-slate-400">
          ${new Date(s.createdAt).toLocaleString()}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-xs text-slate-400">
          ${new Date(s.expiresAt).toLocaleString()}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right">
          <button onclick="revokeSession('${s.id}')" class="text-rose-400 hover:text-rose-300 font-medium text-xs bg-rose-500/10 px-3 py-1.5 rounded-lg border border-rose-500/20 transition-colors">
            Révoquer
          </button>
        </td>
      </tr>
    `).join('');
  } catch (e) {
    console.error(e);
    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-rose-500">Erreur de chargement</td></tr>';
  }
}

function parseUA(ua) {
  if (!ua) return 'Inconnu';
  if (ua.includes('Windows')) return 'Windows';
  if (ua.includes('Macintosh')) return 'Mac';
  if (ua.includes('Linux')) return 'Linux';
  if (ua.includes('Android')) return 'Android';
  if (ua.includes('iPhone')) return 'iPhone';
  return 'Autre';
}

function changePage(delta) {
  currentPage += delta;
  if (currentPage < 1) currentPage = 1;
  loadSessions();
}

async function revokeSession(id) {
  if (!confirm('Voulez-vous vraiment révoquer cette session ? L\'utilisateur sera déconnecté.')) return;
  
  try {
    const res = await fetch(`/admin/sessions/${id}`, { method: 'DELETE' });
    if (res.ok) {
      loadSessions();
    } else {
      alert('Erreur lors de la révocation');
    }
  } catch (e) {
    alert('Erreur réseau');
  }
}

document.getElementById('searchFilter').addEventListener('input', (e) => {
  // Debounce could be added here
  currentPage = 1;
  loadSessions();
});

// Initial load
loadSessions();
</script>
