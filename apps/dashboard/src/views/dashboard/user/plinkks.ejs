<%- include('../../partials/head.ejs', { title: 'Tableau de bord - Mes Plinkks' ,
  description: 'Gère tes pages Plinkk, crée-en de nouvelles et modifie-les.' , robots: 'noindex,nofollow' }) %>
  <%- include('../../partials/header-dash.ejs') %>
    
    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-6 px-4 py-8">
      <%- include('../../partials/asside_dash.ejs', { active: 'plinkks' }) %>

        <main class="col-span-12 lg:col-span-10 space-y-6">
          <!-- Header -->
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-slate-900 border border-slate-800 p-6 rounded-3xl">
            <div>
              <h1 class="text-2xl font-bold text-white">Mes Plinkks</h1>
              <p class="text-sm text-slate-400 mt-1">Gérez vos pages et créez-en de nouvelles.</p>
            </div>
            <% if (plinkks.length >= maxPages) { %>
              <a href="/premium" class="flex items-center gap-2 px-4 py-2.5 text-sm font-medium rounded-xl bg-slate-800 border border-slate-700 text-slate-400 cursor-not-allowed hover:bg-slate-800 hover:text-slate-400">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                <span>Limite atteinte (<%= maxPages %>)</span>
              </a>
            <% } else { %>
              <button id="btnCreatePlinkk" class="flex items-center gap-2 px-4 py-2.5 text-sm font-medium rounded-xl bg-violet-600 hover:bg-violet-500 text-white shadow-lg shadow-violet-900/20 transition-all hover:scale-105">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>Créer un Plinkk</span>
              </button>
            <% } %>
          </div>

          <% if (plinkks.length >= maxPages) { %>
            <div class="bg-gradient-to-r from-violet-900/40 to-fuchsia-900/40 border border-violet-500/30 rounded-2xl p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-violet-600/20 rounded-xl text-violet-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg">Débloquez plus de pages Plinkk</h3>
                        <p class="text-slate-300 text-sm">Vous avez atteint la limite de votre plan. Passez Premium pour créer plus de pages !</p>
                    </div>
                </div>
                <a href="/premium" class="px-6 py-2.5 bg-white text-violet-900 font-bold rounded-xl hover:bg-slate-200 transition-colors shadow-lg shadow-black/20 whitespace-nowrap text-sm">
                    Passer Premium
                </a>
            </div>
          <% } %>

          <!-- Plinkks Grid -->
          <% if (plinkks && plinkks.length> 0) { %>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
              <% plinkks.forEach(plinkk=> { %>
                <div class="group relative bg-slate-900 border border-slate-800 rounded-3xl p-6 hover:border-violet-500/50 transition-all duration-300 hover:shadow-xl hover:shadow-violet-900/10">
                  <div class="flex items-start justify-between mb-6">
                    <div class="flex items-center gap-4">
                      <div class="h-14 w-14 rounded-2xl bg-slate-800 border border-slate-700 overflow-hidden grid place-items-center text-2xl font-bold text-slate-400 group-hover:border-violet-500/30 transition-colors">
                        <% if (plinkk.pfp) { %>
                          <img src="/public/uploads/<%= plinkk.pfp %>" alt="<%= plinkk.slug %>" class="h-full w-full object-cover" />
                        <% } else { %>
                          <%= plinkk.slug.substring(0, 1).toUpperCase() %>
                        <% } %>
                      </div>
                      <div>
                        <h3 class="font-bold text-white text-lg group-hover:text-violet-400 transition-colors flex items-center gap-2 flex-wrap">
                          <%= plinkk.name || plinkk.slug %>
                        </h3>
                        <a href="https://plinkk.fr/<%= plinkk.slug %>" target="_blank" class="text-sm text-slate-400 hover:text-violet-400 hover:underline flex items-center gap-1 transition-colors" onclick="event.stopPropagation()">
                          plinkk.fr/<%= plinkk.slug %>
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        </a>
                      </div>
                    </div>
                    
                    <div class="relative">
                      <button class="p-2 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors" onclick="toggleMenu('<%= plinkk.id %>', event)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                      </button>
                      <!-- Dropdown Menu -->
                      <div id="menu-<%= plinkk.id %>" class="hidden absolute right-0 top-full mt-2 w-48 bg-slate-900 border border-slate-800 rounded-xl shadow-xl z-20 overflow-hidden animate-scale-in origin-top-right">
                        <a href="/edit?plinkkId=<%= plinkk.id %>" class="flex items-center gap-2 px-4 py-3 text-sm text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                          Modifier
                        </a>
                        <a href="/stats?plinkkId=<%= plinkk.id %>" class="flex items-center gap-2 px-4 py-3 text-sm text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                          Statistiques
                        </a>
                        <button onclick="exportPlinkk('<%= plinkk.id %>')" class="w-full flex items-center gap-2 px-4 py-3 text-sm text-slate-300 hover:bg-slate-800 hover:text-white transition-colors text-left">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                          Exporter
                        </button>
                        <button onclick="openDeleteModal('<%= plinkk.id %>', '<%= plinkk.slug %>')" class="w-full flex items-center gap-2 px-4 py-3 text-sm text-rose-400 hover:bg-rose-500/10 hover:text-rose-300 transition-colors text-left">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                          Supprimer
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="flex items-center justify-between pt-4 border-t border-slate-800">
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                      <span class="flex items-center gap-1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <%= plinkk.views || 0 %>
                      </span>
                      <span class="w-1 h-1 rounded-full bg-slate-700"></span>
                      <span><%= new Date(plinkk.createdAt).toLocaleDateString() %></span>
                    </div>
                    <a href="/edit?plinkkId=<%= plinkk.id %>" class="px-4 py-2 text-sm font-medium rounded-xl bg-slate-800 hover:bg-slate-700 text-white border border-slate-700 transition-colors">
                      Gérer
                    </a>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="bg-slate-900 border border-slate-800 rounded-3xl p-12 text-center">
              <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </div>
              <h3 class="text-xl font-bold text-white mb-2">Aucun Plinkk</h3>
              <p class="text-slate-400 mb-8 max-w-md mx-auto">Vous n'avez pas encore créé de page Plinkk. Commencez dès maintenant pour partager vos liens !</p>
              <button onclick="document.getElementById('btnCreatePlinkk').click()" class="px-6 py-3 text-sm font-medium rounded-xl bg-violet-600 hover:bg-violet-500 text-white shadow-lg shadow-violet-900/20 transition-all hover:scale-105">
                Créer mon premier Plinkk
              </button>
            </div>
          <% } %>
        </main>
    </div>

    <!-- Create Modal -->
    <div id="createModal" class="fixed inset-0 hidden z-50 grid place-items-center backdrop-blur-sm">
      <div class="absolute inset-0 bg-black/60 modal-overlay"></div>
      <div class="relative w-full max-w-md mx-4 animate-scale-in">
        <div class="rounded-3xl bg-slate-900 border border-slate-800 p-8 shadow-2xl shadow-black/50">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Nouveau Plinkk</h3>
            <button class="p-2 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors modal-close">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          </div>

          <form id="formCreatePlinkk" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Identifiant (slug)</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm">plinkk.fr/</span>
                <input type="text" name="slug" required pattern="[a-zA-Z0-9-_]+" class="w-full pl-20 pr-4 py-3 rounded-xl bg-slate-950 border border-slate-800 text-slate-200 focus:border-violet-500 outline-none transition-colors" placeholder="mon-super-plinkk" />
              </div>
              <p class="text-xs text-slate-500 mt-2">Lettres, chiffres, tirets et underscores uniquement.</p>
            </div>

            <div class="flex items-center justify-end gap-3">
              <button type="button" class="px-4 py-2.5 text-sm font-medium rounded-xl bg-slate-800 hover:bg-slate-700 text-white border border-slate-700 transition-colors modal-close">Annuler</button>
              <button type="submit" class="px-4 py-2.5 text-sm font-medium rounded-xl bg-violet-600 hover:bg-violet-500 text-white shadow-lg shadow-violet-900/20 transition-colors">Créer</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="fixed inset-0 hidden z-50 grid place-items-center backdrop-blur-sm">
      <div class="absolute inset-0 bg-black/60 modal-overlay"></div>
      <div class="relative w-full max-w-md mx-4 animate-scale-in">
        <div class="rounded-3xl bg-slate-900 border border-slate-800 p-8 shadow-2xl shadow-black/50">
          <div class="flex items-center gap-4 mb-6">
            <div class="p-3 rounded-full bg-rose-500/10 text-rose-500">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
            <div>
              <h3 class="text-xl font-bold text-white">Supprimer ce Plinkk ?</h3>
              <p class="text-sm text-slate-400">Cette action est irréversible.</p>
            </div>
          </div>

          <p class="text-slate-300 mb-6">Êtes-vous sûr de vouloir supprimer <span id="deleteSlug" class="font-bold text-white"></span> ? Toutes les données associées seront perdues.</p>

          <form id="formDeletePlinkk" class="flex items-center justify-end gap-3">
            <input type="hidden" name="plinkkId" id="deletePlinkkId" />
            <button type="button" class="px-4 py-2.5 text-sm font-medium rounded-xl bg-slate-800 hover:bg-slate-700 text-white border border-slate-700 transition-colors modal-close">Annuler</button>
            <button type="submit" class="px-4 py-2.5 text-sm font-medium rounded-xl bg-rose-600 hover:bg-rose-500 text-white shadow-lg shadow-rose-900/20 transition-colors">Supprimer</button>
          </form>
        </div>
      </div>
    </div>

    <div id="toasts" class="fixed top-4 right-4 z-50 flex flex-col items-end gap-2 pointer-events-none"></div>

    <script>
      function showAlert(message, type = 'info', opts = {}) {
        const container = document.getElementById('toasts');
        if (!container) return console.log(message);
        const el = document.createElement('div');
        el.className = 'pointer-events-auto max-w-sm w-full rounded-xl px-4 py-3 text-sm shadow-lg border flex items-center gap-3 animate-slide-in-right';
        
        let bg = 'bg-slate-900 text-white border-slate-800';
        let icon = '';
        
        if (type === 'success') {
          bg = 'bg-slate-900 text-emerald-400 border-emerald-500/30';
          icon = '<svg class="size-5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
        } else if (type === 'error') {
          bg = 'bg-slate-900 text-rose-400 border-rose-500/30';
          icon = '<svg class="size-5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
        }
        
        el.className += ' ' + bg;
        el.innerHTML = `${icon}<span>${message}</span>`;
        
        container.appendChild(el);
        
        const timeout = opts.timeout || 3500;
        const remove = () => { 
          el.style.opacity = '0'; 
          el.style.transform = 'translateX(100%)';
          setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 300); 
        };
        el.addEventListener('click', remove);
        setTimeout(remove, timeout);
        return el;
      }

      async function exportPlinkk(id) {
        try {
          const res = await fetch(`/api/me/plinkks/${id}/export.zip`);
          if (res.ok) {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plinkk-${id}.zip`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            showAlert('Export téléchargé', 'success');
          } else {
            showAlert('Erreur lors de l\'export', 'error');
          }
        } catch (err) {
          showAlert('Erreur réseau', 'error');
        }
      }

      // Menu handling
      function toggleMenu(id, e) {
        e.stopPropagation();
        const menu = document.getElementById(`menu-${id}`);
        const allMenus = document.querySelectorAll('[id^="menu-"]');
        
        allMenus.forEach(m => {
          if (m.id !== `menu-${id}`) m.classList.add('hidden');
        });
        
        menu.classList.toggle('hidden');
      }

      document.addEventListener('click', () => {
        document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
      });

      // Modal handling
      const createModal = document.getElementById('createModal');
      const deleteModal = document.getElementById('deleteModal');
      const btnCreate = document.getElementById('btnCreatePlinkk');

      btnCreate?.addEventListener('click', () => {
        createModal.classList.remove('hidden');
        createModal.querySelector('input').focus();
      });

      document.querySelectorAll('.modal-close, .modal-overlay').forEach(el => {
        el.addEventListener('click', () => {
          createModal.classList.add('hidden');
          deleteModal.classList.add('hidden');
        });
      });

      // Create Plinkk
      document.getElementById('formCreatePlinkk')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const slug = fd.get('slug');
        
        try {
          const res = await fetch('/api/me/plinkks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slug })
          });
          
          if (res.ok) {
            const data = await res.json();
            showAlert('Plinkk créé avec succès !', 'success');
            setTimeout(() => window.location.href = `/edit?plinkkId=${data.id}`, 1000);
          } else {
            const err = await res.json();
            if (err.error === 'max_pages_reached' && err.canUpgrade) {
               if (confirm(err.message + "\n\nVoulez-vous découvrir nos offres Premium ?")) {
                  window.location.href = '/premium';
               }
               return;
            }
            showAlert(err.error || 'Erreur lors de la création', 'error');
          }
        } catch (err) {
          showAlert('Erreur réseau', 'error');
        }
      });

      // Delete Plinkk
      function openDeleteModal(id, slug) {
        document.getElementById('deletePlinkkId').value = id;
        document.getElementById('deleteSlug').textContent = slug;
        deleteModal.classList.remove('hidden');
      }

      document.getElementById('formDeletePlinkk')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('deletePlinkkId').value;
        
        try {
          const res = await fetch(`/api/me/plinkks/${id}`, {
            method: 'DELETE'
          });
          
          if (res.ok) {
            showAlert('Plinkk supprimé', 'success');
            setTimeout(() => window.location.reload(), 1000);
          } else {
            showAlert('Erreur lors de la suppression', 'error');
          }
        } catch (err) {
          showAlert('Erreur réseau', 'error');
        }
      });
    </script>